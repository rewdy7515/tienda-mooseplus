<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Entregar servicios</title>
    <link rel="stylesheet" href="../styles/styles.css" />
    <style>
      .fecha-wrap {
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .input-inline {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        width: 100%;
        max-width: 220px;
      }
      .input-inline .form-input {
        flex: 1;
        min-width: 0;
        width: 100%;
        box-sizing: border-box;
      }
      .input-inline .input-tipo {
        appearance: none;
        background: #f5f6f8;
        border: 1px solid #d7dce3;
        border-radius: 10px;
        padding: 8px 34px 8px 12px;
        font-weight: 600;
        color: #2f3238;
        background-image: linear-gradient(45deg, transparent 50%, #5a606b 50%),
          linear-gradient(135deg, #5a606b 50%, transparent 50%),
          linear-gradient(to right, #e7ebf0, #e7ebf0);
        background-position: calc(100% - 18px) 55%, calc(100% - 12px) 55%, 100% 0;
        background-size: 6px 6px, 6px 6px, 2.5rem 100%;
        background-repeat: no-repeat;
      }
      .input-inline .input-tipo:focus {
        outline: none;
        border-color: #9aa3ad;
        box-shadow: 0 0 0 3px rgba(154, 163, 173, 0.2);
      }
      .input-inline .input-tipo option {
        color: #2f3238;
        background: #ffffff;
        font-weight: 500;
      }
      .input-inline .btn-check {
        flex: 0 0 auto;
        padding: 6px 10px;
        line-height: 1;
      }
      .copyable {
        cursor: pointer;
      }
      .copy-toast {
        position: fixed;
        top: 80px;
        right: 18px;
        background: #000;
        color: #fff;
        padding: 10px 14px;
        border-radius: 10px;
        font-size: 13px;
        font-weight: 700;
        opacity: 0;
        transform: translateY(-6px);
        transition:
          opacity 0.2s ease,
          transform 0.2s ease;
        z-index: 999;
        pointer-events: none;
      }
      .copy-toast.show {
        opacity: 1;
        transform: translateY(0);
      }
      .cliente-modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.45);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1200;
      }
      .cliente-modal.hidden {
        display: none;
      }
      .cliente-modal-card {
        width: min(92vw, 360px);
        background: #fff;
        border-radius: 12px;
        padding: 16px;
        box-shadow: 0 12px 26px rgba(0, 0, 0, 0.2);
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .cliente-modal-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
      }
      .cliente-modal-card .form-input {
        width: 100%;
        box-sizing: border-box;
      }
    </style>
  </head>
  <body>
    <div id="app-header" data-header-root="../" data-header-pages=""></div>
    <script src="../scripts/header-loader.js"></script>

    <main class="categorias-dinamicas">
      <h2>Entregar servicios</h2>
      <p id="entregar-verificacion-note" class="status">
        Al verificar su pago se mostrar√°n sus servicios en esta p√°gina. Tambi√©n recibir√° una notificaci√≥n al liberarse la orden
      </p>
      <div id="entregar-status" class="status">Cargando servicios...</div>
      <div id="entregar-tablas"></div>
    </main>
    <div id="copy-toast" class="copy-toast">Copiado al portapapeles</div>
    <div id="cliente-modal" class="cliente-modal hidden" aria-hidden="true">
      <div class="cliente-modal-card">
        <strong>Nombre del cliente:</strong>
        <input
          type="text"
          id="cliente-nombre-input"
          class="form-input"
          placeholder="Nombre y apellido"
        />
        <div class="cliente-modal-actions">
          <button type="button" class="btn-outline" id="cliente-cancel">Cancelar</button>
          <button type="button" class="btn-primary" id="cliente-guardar">Guardar</button>
        </div>
      </div>
    </div>

    <script type="module">
      import { requireSession, attachLogout, attachLogoHome } from "../scripts/session.js";
      import { clearServerSession, loadCurrentUser, supabase, fetchVentasOrden } from "../scripts/api.js";
      import { buildServiceCopyText } from "../scripts/copy-format.js";
      import { formatDDMMYYYY } from "../scripts/date-format.js";
      import { buildNotification } from "../scripts/notification-templates.js";
      import { copyTextNotify } from "../scripts/copy-toast.js";

      requireSession();
      attachLogoHome();
      attachLogout(clearServerSession);

      const statusEl = document.querySelector("#entregar-status");
      const tablasEl = document.querySelector("#entregar-tablas");
      const appHeaderEl = document.querySelector("#app-header");
      const mainEl = document.querySelector("main.categorias-dinamicas");
      const clienteModal = document.querySelector("#cliente-modal");
      const clienteNombreInput = document.querySelector("#cliente-nombre-input");
      const btnClienteCancel = document.querySelector("#cliente-cancel");
      const btnClienteGuardar = document.querySelector("#cliente-guardar");
      const FORCE_CLIENT_INPUTS = false;
      let canAnnotateCliente = false;
      let activeClienteVentaId = null;
      let reemplazosCache = null;
      let reemplazosCachePromise = null;

      const params = new URLSearchParams(window.location.search);
      const idOrdenParam = params.get("id_orden");
      let ventasById = {};
      let platById = {};
      console.log("entregar_servicios init", { idOrdenParam });

      const setStatus = (msg) => {
        if (statusEl) statusEl.textContent = msg || "";
      };

      const isTrue = (v) => v === true || v === 1 || v === "1" || v === "true" || v === "t";
      const toPositiveId = (value) => {
        const parsed = Number(value);
        if (!Number.isFinite(parsed) || parsed <= 0) return null;
        return Math.trunc(parsed);
      };
      const loadReemplazosBloqueados = async (force = false) => {
        if (force) {
          reemplazosCache = null;
          reemplazosCachePromise = null;
        }
        if (reemplazosCache) return { data: reemplazosCache };
        if (!reemplazosCachePromise) {
          reemplazosCachePromise = supabase
            .from("reemplazos")
            .select("id_cuenta, id_perfil")
            .then(({ data, error }) => {
              if (error) throw error;
              const cuentas = new Set();
              const perfiles = new Set();
              (data || []).forEach((row) => {
                const cuentaId = toPositiveId(row?.id_cuenta);
                const perfilId = toPositiveId(row?.id_perfil);
                if (cuentaId) cuentas.add(cuentaId);
                if (perfilId) perfiles.add(perfilId);
              });
              reemplazosCache = { cuentas, perfiles };
              return reemplazosCache;
            })
            .finally(() => {
              reemplazosCachePromise = null;
            });
        }
        try {
          const data = await reemplazosCachePromise;
          return { data };
        } catch (error) {
          return { error };
        }
      };
      const pickPerfilMadreByPriority = (profiles = [], bloqueados = { cuentas: new Set(), perfiles: new Set() }) => {
        const groups = new Map();
        (profiles || []).forEach((perfil) => {
          const perfilId = toPositiveId(perfil?.id_perfil);
          const cuentaId = toPositiveId(perfil?.id_cuenta);
          if (!perfilId || !cuentaId) return;
          if (bloqueados?.perfiles?.has(perfilId)) return;
          if (bloqueados?.cuentas?.has(cuentaId)) return;
          if (!groups.has(cuentaId)) groups.set(cuentaId, []);
          groups.get(cuentaId).push(perfil);
        });
        if (!groups.size) return null;

        groups.forEach((list) => {
          list.sort((a, b) => {
            const na = Number.isFinite(Number(a?.n_perfil)) ? Number(a.n_perfil) : Number.MAX_SAFE_INTEGER;
            const nb = Number.isFinite(Number(b?.n_perfil)) ? Number(b.n_perfil) : Number.MAX_SAFE_INTEGER;
            if (na !== nb) return na - nb;
            const ida = toPositiveId(a?.id_perfil) || Number.MAX_SAFE_INTEGER;
            const idb = toPositiveId(b?.id_perfil) || Number.MAX_SAFE_INTEGER;
            return ida - idb;
          });
        });

        const orderedMotherIds = Array.from(groups.keys()).sort((a, b) => {
          const freeA = groups.get(a)?.length || 0;
          const freeB = groups.get(b)?.length || 0;
          if (freeA !== freeB) return freeA - freeB;
          return a - b;
        });
        const chosenMotherId = orderedMotherIds[0];
        const chosenProfile = groups.get(chosenMotherId)?.[0] || null;
        if (!chosenProfile?.id_perfil) return null;
        return chosenProfile;
      };

      const copyToClipboard = async (text, anchor) => {
        if (!text) return;
        const ok = await copyTextNotify(text);
        if (!ok) return;
        if (anchor) {
          anchor.textContent = "Copiado";
          setTimeout(() => (anchor.textContent = "Copiar"), 1200);
        }
      };

      const escapeHtml = (val) =>
        String(val || "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;");

      const formatFechaCorte = (value) => {
        if (!value) return "";
        return formatDDMMYYYY(value);
      };

      const normalizeCopyValue = (value) => {
        if (value === null || value === undefined) return "";
        return String(value).trim();
      };

      const resolveVentaPin = (ventaRow = {}) => {
        const pinPerfil = normalizeCopyValue(ventaRow?.pin_perfil);
        if (pinPerfil) return pinPerfil;
        return normalizeCopyValue(ventaRow?.pin_cuenta);
      };

      const buildRenovacionMensaje = (item, fechaCorte, plataformaNombre) => {
        const lines = ["*‚úÖ Servicio renovado ü´°*", ""];
        if (plataformaNombre || item.id_venta) {
          lines.push(
            `*${(plataformaNombre || "").toUpperCase()}*${
              item.id_venta ? ` ü´é \`ID Venta: #${item.id_venta}\`` : ""
            }`.trim()
          );
        }
        if (item.correo) lines.push(`*Correo:* ${item.correo}`);
        lines.push(`*Clave:* ${item.clave || "-"}`);
        if (item.n_perfil) lines.push(`*Perfil:* M${item.n_perfil}`);
        if (item.pin) lines.push(`*PIN:* ${item.pin}`);
        if (fechaCorte) {
          lines.push("*Pr√≥xima fecha de pago:*", `_${formatFechaCorte(fechaCorte)}_`);
        }
        return lines.join("\n");
      };

      const normalizePlan = (plan) => String(plan || "").trim();

      const resolvePlanLabel = (venta, platInfo = {}) => {
        const planRaw = normalizePlan(venta?.precios?.plan);
        if (planRaw) return planRaw;
        const platId = venta?.id_plataforma || venta?.cuentas?.id_plataforma || venta?.precios?.id_plataforma;
        const porAcceso = isTrue(platInfo?.por_acceso);
        const ventaPerfil = isTrue(venta?.cuentas?.venta_perfil);
        const ventaMiembro = isTrue(venta?.cuentas?.venta_miembro);
        const isNetflix = Number(platId) === 1;
        const isHogar = isNetflix && (isTrue(venta?.perfiles?.perfil_hogar) || isTrue(venta?.precios?.sub_cuenta));
        if (isHogar) return "Hogar";
        if (porAcceso) return "Acceso";
        if (ventaPerfil) return "Perfil";
        if (ventaMiembro) return "Miembro";
        return "Completa";
      };

      const renderTablas = (plataformas, { title = "", isRenovacion = false } = {}) => {
        if (!tablasEl) return;
        if (!plataformas.length) {
          if (!tablasEl.innerHTML) {
            setStatus("No hay servicios para entregar.");
            tablasEl.innerHTML = "";
          }
          return;
        }
        setStatus("");
        const sectionHtml = plataformas
          .map((platObj) => {
            const rows = platObj.rows || [];
            const hasPendiente = rows.some((r) => r.pendiente);
            const platId = Number(rows?.[0]?.id_plataforma || "");
            const showClientInputs =
              FORCE_CLIENT_INPUTS ||
              platObj.correo_cliente === true ||
              platId === 9;
            const showClaveInput =
              showClientInputs && (platObj.clave_cliente === true || platId === 9);
            const showPinColumn = !isRenovacion && isTrue(platObj.usa_pines);
            const showPerfilColumn = !!(platObj.por_acceso || platObj.por_pantalla);
            const perfilHeader = platObj.por_acceso ? "Acceso" : "Perfil";
            const showTipoColumn = !isRenovacion && platId === 9;
            const body = rows
              .map((r) => {
                const perfilTxt = r.perfil || "";
                const isPendiente = r.pendiente;
                const pinPerfil = normalizeCopyValue(r.pin_perfil);
                const pinCuenta = normalizeCopyValue(r.pin_cuenta);
                const pinVenta = resolveVentaPin(r);
                const hasCorreoData = !!normalizeCopyValue(r.correo);
                const hasClaveData = !!normalizeCopyValue(r.clave);
                const hasRequiredClientData = showClaveInput
                  ? hasCorreoData && hasClaveData
                  : hasCorreoData;
                const hasEntregaData = showClientInputs
                  ? hasRequiredClientData
                  : !!(r.correo || r.clave || pinVenta || r.n_perfil);
                const requiresClientInputs =
                  showClientInputs && isPendiente && !hasRequiredClientData;
                const pinCellHtml = (() => {
                  if (pinPerfil && pinCuenta && pinPerfil !== pinCuenta) {
                    return `
                      <div>
                        <div>Perfil:
                          <span class="copyable pin-copy" data-clipboard="${escapeHtml(pinPerfil)}">${escapeHtml(pinPerfil)}</span>
                        </div>
                        <div>Cuenta:
                          <span class="copyable pin-copy" data-clipboard="${escapeHtml(pinCuenta)}">${escapeHtml(pinCuenta)}</span>
                        </div>
                      </div>
                    `;
                  }
                  if (pinVenta) {
                    return `<span class="copyable pin-copy" data-clipboard="${escapeHtml(
                      pinVenta
                    )}">${escapeHtml(pinVenta)}</span>`;
                  }
                  return "";
                })();
                const copyText = isRenovacion
                  ? buildRenovacionMensaje(r, r.fecha_corte, r.plataforma)
                  : requiresClientInputs
                    ? ""
                    : buildServiceCopyText({
                        plataforma: r.plataforma,
                        idVenta: r.id_venta,
                        correo: r.correo,
                        clave: r.clave,
                        nPerfil: r.n_perfil,
                        pin: pinVenta,
                        fechaCorte: r.fecha_corte,
                        porAcceso: r.por_acceso,
                        usaPines: r.usa_pines,
                        ventaPerfil: r.venta_perfil,
                        ventaMiembro: r.venta_miembro,
                        idPlataforma: r.id_plataforma,
                        perfilHogar: r.perfil_hogar,
                        isSubCuenta: r.es_subcuenta,
                      });
                const annotateBtn = canAnnotateCliente
                  ? `<button type="button" class="btn-outline btn-anotar-cliente" data-venta="${r.id_venta}">Anotar cliente</button>`
                  : "";
                return `
                  <tr>
                    <td>#${String(r.id_venta || "").padStart(4, "0")}</td>
                    <td>
                      ${
                        requiresClientInputs
                          ? `<div class="fecha-wrap">
                              <div class="input-inline">
                                <input type="text" class="form-input input-correo" placeholder="Correo" value="" />
                              </div>
                            </div>`
                          : r.correo
                            ? `<span class="copyable correo-copy" data-clipboard="${escapeHtml(
                                r.correo
                              )}">${escapeHtml(r.correo)}</span>`
                            : ""
                      }
                    </td>
                    ${isRenovacion ? "" : `<td>${
                      showClaveInput && requiresClientInputs
                        ? `<div class="fecha-wrap">
                            <div class="input-inline">
                              <input type="text" class="form-input input-clave" placeholder="Clave" value="" />
                            </div>
                          </div>`
                        : r.clave
                          ? `<span class="copyable clave-copy" data-clipboard="${escapeHtml(
                              r.clave
                            )}">${escapeHtml(r.clave)}</span>`
                          : ""
                    }</td>`}
                    ${showTipoColumn ? `<td>${
                      requiresClientInputs
                        ? `<div class="fecha-wrap">
                            <div class="input-inline">
                              <select class="form-input input-tipo" required>
                                <option value="" disabled selected>Selecciona tipo</option>
                                <option value="existente">Cuenta existente</option>
                                <option value="nueva">Cuenta Nueva</option>
                              </select>
                            </div>
                          </div>`
                        : ""
                    }</td>` : ""}
                    ${isRenovacion ? "" : showPerfilColumn ? `<td>${perfilTxt ? `<div>${escapeHtml(perfilTxt)}</div>` : ""}</td>` : ""}
                    ${showPinColumn ? `<td>${pinCellHtml}</td>` : ""}
                    <td>${r.fecha_corte ? formatDDMMYYYY(r.fecha_corte) : isPendiente ? "Pendiente" : ""}</td>
                    <td>
                      ${
                        isRenovacion
                          ? `<button type="button" class="btn-outline btn-copy-renew" data-copy="${encodeURIComponent(copyText)}">Copiar mensaje de renovaci√≥n</button>`
                          : requiresClientInputs
                            ? `<button type="button" class="btn-outline btn-send-datos" data-venta="${r.id_venta}">Enviar datos</button>`
                            : isPendiente && !hasEntregaData
                              ? '<span class="badge badge-warning">Pendiente</span>'
                              : `<button type="button" class="btn-outline btn-copy" data-copy="${encodeURIComponent(copyText)}">Copiar</button>`
                      }
                      ${annotateBtn}
                    </td>
                  </tr>
                `;
              })
              .join("");
            return `
              <div class="proximas-bloque">
                <h3 class="proximas-title">${platObj.nombre}</h3>
                ${showClientInputs && hasPendiente ? `<p class="status">Ingrese sus datos</p>` : ""}
                <div class="cuenta-table-wrap">
                  <table class="table-base" style="${platObj.color_1 ? `--table-header-bg:${platObj.color_1};` : ""}">
                    <thead>
                      <tr>
                        <th>ID Venta</th>
                        <th>Correo</th>
                        ${isRenovacion ? "" : "<th>Clave</th>"}
                        ${showTipoColumn ? "<th>Tipo</th>" : ""}
                        ${isRenovacion ? "" : showPerfilColumn ? `<th>${perfilHeader}</th>` : ""}
                        ${showPinColumn ? "<th>PIN</th>" : ""}
                        <th>Fecha de corte</th>
                        <th>Acci√≥n</th>
                     </tr>
                   </thead>
                   <tbody>${body}</tbody>
                 </table>
                </div>
              </div>
            `;
          })
          .join("");
        tablasEl.insertAdjacentHTML(
          "beforeend",
          `${title ? `<h3 style="margin: 16px 0 8px;">${title}</h3>` : ""}${sectionHtml}`
        );
      };

      const loadServicios = async () => {
        try {
          if (!idOrdenParam) {
            if (tablasEl) tablasEl.innerHTML = "";
            setStatus("");
            appHeaderEl?.classList.add("hidden");
            mainEl?.classList.add("hidden");
            return;
          }
          const user = await loadCurrentUser();
          canAnnotateCliente = user?.acceso_cliente === false;
          let ventas = [];
          const resp = await fetchVentasOrden(idOrdenParam);
          if (resp?.error) {
            setStatus(resp.error);
            if (tablasEl) tablasEl.innerHTML = "";
            return;
          }
          ventas = resp?.ventas || [];
          console.log("entregar_servicios ventas por orden", { idOrdenParam, total: ventas.length });

          const platIds = Array.from(
            new Set(
              (ventas || []).map((v) => v.cuentas?.id_plataforma || v.precios?.id_plataforma).filter(Boolean)
            )
          );
          let platMap = {};
          if (platIds.length) {
            const { data: plats, error: platErr } = await supabase
              .from("plataformas")
              .select(
                "id_plataforma, nombre, por_acceso, por_pantalla, usa_pines, color_1, entrega_inmediata, correo_cliente, clave_cliente, cuenta_madre"
              )
              .in("id_plataforma", platIds);
            if (platErr) throw platErr;
            platMap = (plats || []).reduce((acc, p) => {
              acc[p.id_plataforma] = p;
              return acc;
            }, {});
          }
          platById = platMap;

          const onlyFaltantes = params.get("faltantes") === "1";
          const filteredVentas = (ventas || []).filter((v) => {
            if (!onlyFaltantes) return true;
            if (!v.pendiente) return false;
            const platId = v.cuentas?.id_plataforma || v.precios?.id_plataforma;
            if (!platId) return false;
            const plat = platMap[platId] || {};
            const needsCorreo =
              plat.correo_cliente === true ||
              plat.correo_cliente === "true" ||
              plat.correo_cliente === "1";
            if (!needsCorreo) return false;
            const missingCorreo = !v.correo_miembro;
            const needsClave =
              plat.clave_cliente === true ||
              plat.clave_cliente === "true" ||
              plat.clave_cliente === "1";
            const missingClave = needsClave ? !v.clave_miembro : false;
            return missingCorreo || missingClave;
          });

          const grouped = {};
          const onlyPendientes = (filteredVentas || []).filter((v) => v.pendiente);
          const onlyNuevas = (filteredVentas || []).filter(
            (v) => !v.pendiente && !v.renovacion
          );
          console.log("entregar_servicios resumen", {
            total: filteredVentas.length,
            pendientes: onlyPendientes.length,
            nuevas: onlyNuevas.length,
          });

          (onlyPendientes || []).forEach((v) => {
            const platId = v.cuentas?.id_plataforma || v.precios?.id_plataforma;
            if (!platId) return;
            const plat = platMap[platId] || {};
            const platName = plat.nombre ? plat.nombre.toUpperCase() : `PLATAFORMA ${platId}`;
            const planLabel = resolvePlanLabel(v, plat);
            const groupKey = `${platId}::${planLabel}`;
            if (!grouped[groupKey])
              grouped[groupKey] = {
                nombre: planLabel ? `${platName} ¬∑ ${planLabel}` : platName,
                color_1: plat.color_1 || null,
                rows: [],
                entrega_inmediata: isTrue(plat.entrega_inmediata),
                correo_cliente: isTrue(plat.correo_cliente),
                clave_cliente: isTrue(plat.clave_cliente),
                cuenta_madre: isTrue(plat.cuenta_madre),
                por_acceso: isTrue(plat.por_acceso),
                por_pantalla: isTrue(plat.por_pantalla),
                usa_pines: isTrue(plat.usa_pines),
              };
            const porAcceso = !!plat.por_acceso;
            const usaPines = !!plat.usa_pines;
            const ventaPerfil = v.cuentas?.venta_perfil;
            const ventaMiembro = v.cuentas?.venta_miembro;
            const isPendienteVenta = !!v.pendiente;
            const perfilTxt = porAcceso
              ? "1 acceso"
              : v.perfiles?.n_perfil
              ? `M${v.perfiles.n_perfil}`
              : "";
            const cuentaCliente = v.cuentas_miembro || null;
            const requiresClientCorreo = isTrue(plat.correo_cliente);
            const correoCuenta = isPendienteVenta
              ? v.correo_miembro || ""
              : requiresClientCorreo
              ? v.correo_miembro || cuentaCliente?.correo || ""
              : Number(platId) === 12
              ? v.correo_miembro || ""
              : v.cuentas?.correo || "";
            const claveCuenta = isPendienteVenta
              ? v.clave_miembro || ""
              : requiresClientCorreo
              ? v.clave_miembro || cuentaCliente?.clave || ""
              : v.cuentas?.clave || "";
            grouped[groupKey].rows.push({
              id_venta: v.id_venta,
              correo: correoCuenta,
              clave: claveCuenta,
              n_perfil: v.perfiles?.n_perfil || "",
              pin_perfil: v.perfiles?.pin || "",
              pin_cuenta: v.cuentas?.pin || "",
              fecha_corte: v.fecha_corte || "",
              plataforma: platName,
              id_plataforma: platId,
              por_acceso: porAcceso,
              usa_pines: usaPines,
              venta_perfil: ventaPerfil,
              venta_miembro: ventaMiembro,
              perfil_hogar: v.perfiles?.perfil_hogar,
              perfil: perfilTxt,
              pendiente: isPendienteVenta,
            });
          });

          const groupedNuevas = {};
          (onlyNuevas || []).forEach((v) => {
            const platId = v.cuentas?.id_plataforma || v.precios?.id_plataforma;
            if (!platId) return;
            const plat = platMap[platId] || {};
            const platName = plat.nombre ? plat.nombre.toUpperCase() : `PLATAFORMA ${platId}`;
            const planLabel = resolvePlanLabel(v, plat);
            const groupKey = `${platId}::${planLabel}`;
            if (!groupedNuevas[groupKey])
              groupedNuevas[groupKey] = {
                nombre: planLabel ? `${platName} ¬∑ ${planLabel}` : platName,
                color_1: plat.color_1 || null,
                rows: [],
                entrega_inmediata: isTrue(plat.entrega_inmediata),
                correo_cliente: isTrue(plat.correo_cliente),
                clave_cliente: isTrue(plat.clave_cliente),
                cuenta_madre: isTrue(plat.cuenta_madre),
                por_acceso: isTrue(plat.por_acceso),
                por_pantalla: isTrue(plat.por_pantalla),
                usa_pines: isTrue(plat.usa_pines),
              };
            const porAcceso = !!plat.por_acceso;
            const usaPines = !!plat.usa_pines;
            const ventaPerfil = v.cuentas?.venta_perfil;
            const ventaMiembro = v.cuentas?.venta_miembro;
            const isPendienteVenta = !!v.pendiente;
            const perfilTxt = porAcceso
              ? "1 acceso"
              : v.perfiles?.n_perfil
              ? `M${v.perfiles.n_perfil}`
              : "";
            const cuentaCliente = v.cuentas_miembro || null;
            const requiresClientCorreo = isTrue(plat.correo_cliente);
            const correoCuenta = isPendienteVenta
              ? v.correo_miembro || ""
              : requiresClientCorreo
              ? v.correo_miembro || cuentaCliente?.correo || ""
              : Number(platId) === 12
              ? v.correo_miembro || ""
              : v.cuentas?.correo || "";
            const claveCuenta = isPendienteVenta
              ? v.clave_miembro || ""
              : requiresClientCorreo
              ? v.clave_miembro || cuentaCliente?.clave || ""
              : v.cuentas?.clave || "";
            groupedNuevas[groupKey].rows.push({
              id_venta: v.id_venta,
              correo: correoCuenta,
              clave: claveCuenta,
              n_perfil: v.perfiles?.n_perfil || "",
              pin_perfil: v.perfiles?.pin || "",
              pin_cuenta: v.cuentas?.pin || "",
              fecha_corte: v.fecha_corte || "",
              plataforma: platName,
              id_plataforma: platId,
              por_acceso: porAcceso,
              usa_pines: usaPines,
              venta_perfil: ventaPerfil,
              venta_miembro: ventaMiembro,
              perfil_hogar: v.perfiles?.perfil_hogar,
              perfil: perfilTxt,
              pendiente: isPendienteVenta,
            });
          });

          const ventasMap = (filteredVentas || []).reduce((acc, v) => {
            if (v?.id_venta) acc[v.id_venta] = v;
            return acc;
          }, {});
          ventasById = ventasMap;
          let renovacionesRows = [];
          if (!onlyFaltantes && (filteredVentas || []).length) {
            const idsVentas = (filteredVentas || []).map((v) => v.id_venta).filter(Boolean);
            if (idsVentas.length) {
              const { data: hist, error: hErr } = await supabase
                .from("historial_ventas")
                .select("id_historial_ventas, id_venta, id_plataforma, renovacion")
                .in("id_venta", idsVentas)
                .eq("renovacion", true);
              if (hErr) throw hErr;
              renovacionesRows = (hist || [])
                .map((h) => {
                  const venta = ventasMap[h.id_venta] || {};
                  const platId = h.id_plataforma || venta.cuentas?.id_plataforma || venta.precios?.id_plataforma;
                  if (!platId) return null;
                  const plat = platMap[platId] || {};
                  const platName = plat.nombre ? plat.nombre.toUpperCase() : `PLATAFORMA ${platId}`;
                  const isVentaMiembro = isTrue(venta?.cuentas?.venta_miembro);
                  const correoCuenta = isVentaMiembro
                    ? venta.correo_miembro || ""
                    : Number(platId) === 12
                      ? venta.correo_miembro || ""
                      : venta.cuentas?.correo || "";
                  return {
                    id_venta: h.id_venta,
                    correo: correoCuenta,
                    fecha_corte: venta.fecha_corte || "",
                    plataforma: platName,
                    id_plataforma: platId,
                    color_1: plat.color_1 || null,
                    plan_label: resolvePlanLabel(venta, plat),
                  };
                })
                .filter(Boolean);
            }
          }
          const groupedPend = Object.values(grouped);
          const groupedNew = Object.values(groupedNuevas);
          const groupedRenov = renovacionesRows.reduce((acc, r) => {
            const key = `${r.id_plataforma || "x"}::${r.plan_label || ""}`;
            if (!acc[key]) {
              acc[key] = {
                nombre: r.plan_label ? `${r.plataforma} ¬∑ ${r.plan_label}` : r.plataforma,
                color_1: r.color_1 || null,
                rows: [],
              };
            }
            acc[key].rows.push(r);
            return acc;
          }, {});

          tablasEl.innerHTML = "";
          renderTablas(groupedPend, { title: "Cuentas que necesitan correo" });
          if (Object.values(groupedRenov).length) {
            renderTablas(Object.values(groupedRenov), {
              title: "Renovaciones",
              isRenovacion: true,
            });
          }
          renderTablas(groupedNew, { title: "Cuentas nuevas" });
        } catch (err) {
          console.error("entregar servicios error", err);
          setStatus("No se pudieron cargar los servicios.");
        }
      };

      tablasEl?.addEventListener("click", (e) => {
        const copyEl = e.target.closest(".copyable");
        if (copyEl) {
          const text = copyEl.dataset.clipboard || copyEl.textContent || "";
          copyTextNotify(text.trim());
          return;
        }
        const btn = e.target.closest(".btn-copy");
        if (!btn) return;
        const text = decodeURIComponent(btn.dataset.copy || "");
        copyToClipboard(text, btn);
      });
      tablasEl?.addEventListener("click", (e) => {
        const btn = e.target.closest(".btn-copy-renew");
        if (!btn) return;
        const text = decodeURIComponent(btn.dataset.copy || "");
        copyToClipboard(text, btn);
      });
      tablasEl?.addEventListener("click", (e) => {
        const btn = e.target.closest(".btn-anotar-cliente");
        if (!btn) return;
        const ventaId = btn.dataset.venta;
        if (!ventaId || !clienteModal) return;
        activeClienteVentaId = ventaId;
        if (clienteNombreInput) {
          clienteNombreInput.value = "";
          clienteNombreInput.focus();
        }
        clienteModal.classList.remove("hidden");
        clienteModal.setAttribute("aria-hidden", "false");
      });
      tablasEl?.addEventListener("click", async (e) => {
        const btn = e.target.closest(".btn-send-datos");
        if (!btn) return;
        const row = btn.closest("tr");
        const ventaId = btn.dataset.venta;
        if (!ventaId) return;
        const correoVal = row?.querySelector(".input-correo")?.value?.trim() || "";
        const claveVal = row?.querySelector(".input-clave")?.value?.trim() || "";
        const tipoVal = row?.querySelector(".input-tipo")?.value?.trim() || "";
        const venta = ventasById[ventaId] || {};
        const platId = venta?.cuentas?.id_plataforma || venta?.precios?.id_plataforma;
        const platIdNum = Number(platId);
        const hasPlatId = Number.isFinite(platIdNum) && platIdNum > 0;
        const forceCuentaCompleta = platIdNum === 11;
        const platInfo = platById[platId] || {};
        const needsClave = isTrue(platInfo?.clave_cliente);
        if (!correoVal) {
          alert("Ingresa el correo.");
          return;
        }
        if (needsClave && !claveVal) {
          alert("Ingresa la clave.");
          return;
        }
        try {
          if (platIdNum === 9 && !tipoVal) {
            alert("Selecciona el tipo de cuenta.");
            return;
          }
          const { data: reemplazosBloqueados, error: replErr } =
            await loadReemplazosBloqueados();
          if (replErr) throw replErr;
          const needsMadre = platInfo.cuenta_madre === true && !forceCuentaCompleta;
          const requireMadreActiva = platIdNum === 9;
          let assignCuenta = null;
          let assignPerfil = null;
          let clientCuentaId = null;
          let cuentaExist = null;

          const { data: cuentasFound, error: cErr } = await supabase
            .from("cuentas")
            .select("id_cuenta, id_cuenta_madre, id_plataforma, clave")
            .eq("correo", correoVal)
            .order("id_cuenta", { ascending: true })
            .limit(1);
          if (cErr) throw cErr;
          cuentaExist = cuentasFound?.[0] || null;

          if (forceCuentaCompleta) {
            if (cuentaExist?.id_cuenta) {
              const updateCuenta = {
                id_plataforma: hasPlatId ? platIdNum : cuentaExist.id_plataforma || null,
                inactiva: false,
                ocupado: false,
                id_cuenta_madre: null,
                venta_perfil: false,
                venta_miembro: false,
              };
              if (claveVal && claveVal !== (cuentaExist.clave || "")) {
                updateCuenta.clave = claveVal;
              }
              const { error: updCuentaErr } = await supabase
                .from("cuentas")
                .update(updateCuenta)
                .eq("id_cuenta", cuentaExist.id_cuenta);
              if (updCuentaErr) throw updCuentaErr;
              clientCuentaId = cuentaExist.id_cuenta;
            } else {
              const insertCuenta = {
                correo: correoVal,
                clave: claveVal || null,
                id_plataforma: hasPlatId ? platIdNum : null,
                inactiva: false,
                ocupado: false,
                id_cuenta_madre: null,
                venta_perfil: false,
                venta_miembro: false,
              };
              const { data: newCuenta, error: newCuentaErr } = await supabase
                .from("cuentas")
                .insert(insertCuenta)
                .select("id_cuenta")
                .single();
              if (newCuentaErr) throw newCuentaErr;
              clientCuentaId = newCuenta?.id_cuenta || null;
              cuentaExist = clientCuentaId ? { id_cuenta: clientCuentaId, clave: claveVal || null } : null;
            }
          }

          if (needsMadre) {
            clientCuentaId = cuentaExist?.id_cuenta || null;
            let motherFromClient = toPositiveId(cuentaExist?.id_cuenta_madre);
            if (motherFromClient && reemplazosBloqueados.cuentas.has(motherFromClient)) {
              motherFromClient = null;
            }

            if (motherFromClient && requireMadreActiva) {
              const { data: madreActiva, error: madreActivaErr } = await supabase
                .from("cuentas")
                .select("id_cuenta, inactiva")
                .eq("id_cuenta", motherFromClient)
                .eq("id_plataforma", platIdNum)
                .eq("cuenta_madre", true)
                .maybeSingle();
              if (madreActivaErr) throw madreActivaErr;
              if (!madreActiva || isTrue(madreActiva.inactiva)) {
                motherFromClient = null;
              }
            }

            if (motherFromClient) {
              const { data: perfPrefs, error: pErr } = await supabase
                .from("perfiles")
                .select("id_perfil, id_cuenta, n_perfil")
                .eq("id_cuenta", motherFromClient)
                .or("ocupado.is.null,ocupado.eq.false")
                .order("n_perfil", { ascending: true })
                .limit(40);
              if (pErr) throw pErr;
              const perfilPreferido = (perfPrefs || []).find((perfil) => {
                const perfilId = toPositiveId(perfil?.id_perfil);
                return !!perfilId && !reemplazosBloqueados.perfiles.has(perfilId);
              });
              if (perfilPreferido?.id_perfil) {
                assignPerfil = perfilPreferido.id_perfil;
                assignCuenta = perfilPreferido.id_cuenta;
              }
            }

            if (!assignPerfil && hasPlatId) {
              let perfAltQuery = supabase
                .from("perfiles")
                .select("id_perfil, id_cuenta, n_perfil, cuentas!perfiles_id_cuenta_fkey!inner(id_plataforma, cuenta_madre, inactiva)")
                .eq("cuentas.id_plataforma", platIdNum)
                .eq("cuentas.cuenta_madre", true)
                .or("ocupado.is.null,ocupado.eq.false")
                .order("id_cuenta", { ascending: true })
                .order("n_perfil", { ascending: true });
              if (requireMadreActiva) {
                perfAltQuery = perfAltQuery.or("inactiva.is.null,inactiva.eq.false", {
                  foreignTable: "cuentas",
                });
              }
              const { data: perfAlt, error: pAltErr } = await perfAltQuery.limit(160);
              if (pAltErr) throw pAltErr;
              const perfilAlterno = pickPerfilMadreByPriority(perfAlt || [], reemplazosBloqueados);
              if (perfilAlterno?.id_perfil) {
                assignPerfil = perfilAlterno.id_perfil;
                assignCuenta = perfilAlterno.id_cuenta;
              }
            }
          }

          if (assignPerfil && clientCuentaId) {
            const { error: occErr } = await supabase
              .from("perfiles")
              .update({ ocupado: true, id_cuenta_miembro: clientCuentaId })
              .eq("id_perfil", assignPerfil);
            if (occErr) throw occErr;
          }

          if (assignCuenta && clientCuentaId) {
            const { error: linkErr } = await supabase
              .from("cuentas")
              .update({ id_cuenta_madre: assignCuenta })
              .eq("id_cuenta", clientCuentaId);
            if (linkErr) throw linkErr;
          }

          if (needsClave && cuentaExist?.id_cuenta && claveVal && claveVal !== (cuentaExist.clave || "")) {
            const { error: claveErr } = await supabase
              .from("cuentas")
              .update({ clave: claveVal })
              .eq("id_cuenta", cuentaExist.id_cuenta);
            if (claveErr) throw claveErr;
          }

          const payload = { correo_miembro: correoVal };
          if ((needsClave || forceCuentaCompleta) && claveVal) payload.clave_miembro = claveVal;
          if (forceCuentaCompleta) {
            payload.id_cuenta = clientCuentaId || null;
            payload.id_perfil = null;
            payload.id_cuenta_miembro = null;
          } else {
            if (assignCuenta) payload.id_cuenta = assignCuenta;
            if (assignPerfil) payload.id_perfil = assignPerfil;
          }
          if (platIdNum === 9) payload.cuenta_nueva = tipoVal === "nueva";

          const { error } = await supabase
            .from("ventas")
            .update(payload)
            .eq("id_venta", ventaId);
          if (error) throw error;
          btn.classList.add("hidden");
          const status = document.createElement("span");
          status.className = "badge badge-green";
          status.textContent = "Datos enviados ‚úÖ";
          btn.parentElement?.appendChild(status);
          alert("Datos enviados.");
        } catch (err) {
          console.error("enviar datos error", err);
          alert("No se pudieron enviar los datos.");
        }
      });

      loadServicios();

      const closeClienteModal = () => {
        if (!clienteModal) return;
        clienteModal.classList.add("hidden");
        clienteModal.setAttribute("aria-hidden", "true");
        activeClienteVentaId = null;
      };

      btnClienteCancel?.addEventListener("click", closeClienteModal);
      clienteModal?.addEventListener("click", (e) => {
        if (e.target === clienteModal) closeClienteModal();
      });
      btnClienteGuardar?.addEventListener("click", async () => {
        if (!activeClienteVentaId) return;
        const nombre = (clienteNombreInput?.value || "").trim();
        if (!nombre) {
          alert("Ingresa el nombre del cliente.");
          return;
        }
        try {
          const { error } = await supabase
            .from("ventas")
            .update({ nombre_cliente: nombre })
            .eq("id_venta", activeClienteVentaId);
          if (error) throw error;
          closeClienteModal();
        } catch (err) {
          console.error("anotar cliente error", err);
          alert("No se pudo guardar el nombre del cliente.");
        }
      });
    </script>
  </body>
</html>
