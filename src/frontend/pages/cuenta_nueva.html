<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cuenta nueva</title>
    <link rel="stylesheet" href="../styles/styles.css" />
    <style>
      .cuenta-nueva-form {
        max-width: 640px;
        margin-top: 12px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .cuenta-nueva-form .field {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .cuenta-nueva-form label {
        font-weight: 700;
      }
      .cuenta-nueva-form input,
      .cuenta-nueva-form select {
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 10px;
        font-size: 14px;
      }
      /* Inputs numéricos sin flechas */
      .cuenta-nueva-form input[type="number"]::-webkit-outer-spin-button,
      .cuenta-nueva-form input[type="number"]::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }
      .cuenta-nueva-form input[type="number"] {
        -moz-appearance: textfield;
      }
      .modal-qty.inline {
        margin: 0;
      }
      .sugs {
        position: relative;
        width: 100%;
      }
      .sugs-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        width: 100%;
        box-sizing: border-box;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 10px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        margin-top: 6px;
        overflow: hidden;
        z-index: 20;
      }
      .sugs-list.hidden {
        display: none;
      }
      .sugs-list button {
        width: 100%;
        border: none;
        background: transparent;
        text-align: left;
        padding: 10px 12px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
      }
      .sugs-list button:last-child {
        border-bottom: none;
      }
      .sugs-list button:hover {
        background: #f7f7f7;
      }
      .sugs-empty {
        padding: 10px 12px;
        color: #666;
        font-size: 13px;
      }
      .cn-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.4);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 999;
      }
      .cn-overlay.show {
        display: flex;
      }
      .cn-modal {
        background: #fff;
        border-radius: 12px;
        padding: 16px;
        max-width: 360px;
        width: calc(100% - 32px);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.18);
      }
      .cn-modal p {
        margin: 8px 0;
      }
      .cn-form {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 8px;
      }
      .cn-form input {
        padding: 8px 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
      }
      #cn-procesar {
        margin-top: 4px;
        align-self: flex-start;
      }
      .hidden {
        display: none !important;
      }
      .cn-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        margin-top: 12px;
      }
      .cn-btn {
        padding: 8px 12px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
      }
      .cn-primary {
        background: #111;
        color: #fff;
      }
      .cn-close {
        background: #e5e7eb;
        color: #111;
      }
    </style>
  </head>
  <body>
    <div id="app-header" data-header-root="../" data-header-pages=""></div>
    <script src="../scripts/header-loader.js"></script>

    <main class="categorias-dinamicas">
      <h2>Cuenta nueva</h2>
      <div class="cuenta-nueva-form">
        <div class="field sugs">
          <label for="cn-cliente">Cliente</label>
          <input type="text" id="cn-cliente" placeholder="Nombre del cliente" autocomplete="off" />
          <div id="cn-sugs" class="sugs-list hidden"></div>
          <p id="cn-cliente-id" class="status" style="margin:4px 0 0; font-size:12px; color:#444;">ID usuario: -</p>
          <p id="cn-cliente-acceso" class="status" style="margin:0; font-size:12px; color:#444;">Acceso: -</p>
        </div>
        <div class="field">
          <label for="cn-ref">Nro de referencia</label>
          <input type="number" id="cn-ref" step="1" min="0" inputmode="numeric" />
        </div>
        <button type="button" class="btn-primary" id="cn-procesar">Procesar</button>
      </div>
    </main>
    <div id="cn-modal" class="cn-overlay">
      <div class="cn-modal">
        <div id="cn-modal-step1">
          <p>No se encontró cliente en la base de datos.</p>
          <p>¿Añadir nuevo cliente?</p>
          <div class="cn-actions">
            <button type="button" class="cn-btn cn-primary" id="cn-modal-si">Sí</button>
            <button type="button" class="cn-btn cn-close" id="cn-modal-no">No</button>
          </div>
        </div>
        <div id="cn-modal-step2" style="display:none;">
          <p>Agregar nuevo cliente</p>
          <div class="cn-form">
            <input type="text" id="cn-nombre" placeholder="Nombre" />
            <input type="text" id="cn-apellido" placeholder="Apellido" />
            <input type="email" id="cn-correo" placeholder="Correo" />
            <input type="tel" id="cn-telefono" placeholder="Teléfono" />
          </div>
          <div class="cn-actions">
            <button type="button" class="cn-btn cn-primary" id="cn-modal-guardar">Guardar</button>
            <button type="button" class="cn-btn cn-close" id="cn-modal-cancelar">Cancelar</button>
          </div>
        </div>
      </div>
    </div>
    <script type="module">
      import { requireSession, attachLogoHome } from "../scripts/session.js";
      import { supabase, loadCurrentUser } from "../scripts/api.js";
      import { buildNotificationPayload, pickNotificationUserIds } from "../scripts/notification-templates.js";

      requireSession();
      attachLogoHome();

      const clienteInput = document.querySelector("#cn-cliente");
      const clienteSugs = document.querySelector("#cn-sugs");
      const clienteIdLabel = document.querySelector("#cn-cliente-id");
      const clienteAccesoLabel = document.querySelector("#cn-cliente-acceso");
      const modal = document.querySelector("#cn-modal");
      const modalSi = document.querySelector("#cn-modal-si");
      const modalNo = document.querySelector("#cn-modal-no");
      const modalStep1 = document.querySelector("#cn-modal-step1");
      const modalStep2 = document.querySelector("#cn-modal-step2");
      const modalGuardar = document.querySelector("#cn-modal-guardar");
      const modalCancelar = document.querySelector("#cn-modal-cancelar");
      const modalNombre = document.querySelector("#cn-nombre");
      const modalApellido = document.querySelector("#cn-apellido");
      const modalCorreo = document.querySelector("#cn-correo");
      const modalTelefono = document.querySelector("#cn-telefono");
      let sugsCounter = 0;
      let suppressBlur = false;
      let usuariosCache = null;
      let usuariosCachePromise = null;
      let checkCounter = 0;
      let adminId = null;
      let isSuperAdmin = false;
      let clienteSeleccionadoId = null;
      const toTitleCase = (str) =>
        (str || "").replace(/(\S+)/g, (w) => (w ? w[0].toUpperCase() + w.slice(1).toLowerCase() : ""));
      const normalizeText = (val) =>
        (val || "")
          .toString()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .toLowerCase()
          .trim();

      const loadUsuariosCache = async () => {
        if (usuariosCache) return usuariosCache;
        if (usuariosCachePromise) return usuariosCachePromise;
        usuariosCachePromise = supabase
          .from("usuarios")
          .select("id_usuario, nombre, apellido, acceso_cliente")
          .order("nombre", { ascending: true })
          .order("apellido", { ascending: true })
          .then(({ data, error }) => {
            usuariosCachePromise = null;
            if (error) throw error;
            usuariosCache = (data || []).map((u) => ({
              ...u,
              full_norm: normalizeText(`${u.nombre || ""} ${u.apellido || ""}`),
            }));
            return usuariosCache;
          })
          .catch((err) => {
            usuariosCachePromise = null;
            throw err;
          });
        return usuariosCachePromise;
      };

      // --- Sugerencias de clientes (rehecho) ---
      const clearSugs = () => {
        if (!clienteSugs) return;
        clienteSugs.innerHTML = "";
        clienteSugs.classList.add("hidden");
      };

      const renderClienteSugs = (items) => {
        if (!clienteSugs) return;
        if (!items.length) {
          clearSugs();
          return;
        }
        clienteSugs.innerHTML = items
          .map(
            (u) => `
              <button type="button" data-id="${u.id_usuario || ""}" data-nombre="${(u.nombre || "").trim()}" data-apellido="${(u.apellido || "").trim()}" data-acceso="${u.acceso_cliente}">
                ${(u.nombre || "")} ${(u.apellido || "")}
              </button>
            `
          )
          .join("");
        clienteSugs.classList.remove("hidden");
      };

      const buscarClientes = async (texto) => {
        const termRaw = texto || "";
        if (!termRaw.length) {
          clearSugs();
          return;
        }
        const term = normalizeText(termRaw);
        const current = ++sugsCounter;
        try {
          const data = await loadUsuariosCache();
          if (current !== sugsCounter) return;
          const filtered = (data || []).filter((u) => (u.full_norm || "").includes(term));
          const top = filtered.slice(0, 4);
          renderClienteSugs(top);
        } catch (err) {
          console.error("buscar clientes error", err);
          clearSugs();
        }
      };

      clienteInput?.addEventListener("input", (e) => {
        const el = clienteInput;
        const start = el.selectionStart;
        el.value = toTitleCase(el.value);
        if (start !== null) {
          const pos = Math.min(start, el.value.length);
          el.setSelectionRange(pos, pos);
        }
        buscarClientes(e.target.value);
      });

      clienteSugs?.addEventListener("click", (e) => {
        const btn = e.target.closest("button");
        if (!btn || !clienteInput) return;
          const nombre = btn.dataset.nombre || "";
          const apellido = btn.dataset.apellido || "";
          const acceso = btn.dataset.acceso;
          const id = btn.dataset.id || "";
          clienteInput.value = toTitleCase(`${nombre} ${apellido}`.trim());
          suppressBlur = false;
          clearSugs();
          clienteSeleccionadoId = id || null;
          if (clienteIdLabel) clienteIdLabel.textContent = `ID usuario: ${id || "-"}`;
          if (clienteAccesoLabel) {
            const accesoTxt = acceso === "false" ? "Revendedor" : "Cliente final";
            clienteAccesoLabel.textContent = `Acceso: ${accesoTxt}`;
          }
        });

      clienteSugs?.addEventListener("mousedown", () => {
        suppressBlur = true;
      });

      document.addEventListener("click", (e) => {
        if (!clienteSugs) return;
        const inside = clienteSugs.contains(e.target) || clienteInput?.contains(e.target);
        if (!inside) renderClienteSugs([], true);
      });

      const hideModal = () => modal && modal.classList.remove("show");
      const showModal = () => modal && modal.classList.add("show");

      const goStep1 = () => {
        if (modalStep1) modalStep1.style.display = "block";
        if (modalStep2) modalStep2.style.display = "none";
      };
      const goStep2 = () => {
        if (modalStep1) modalStep1.style.display = "none";
        if (modalStep2) modalStep2.style.display = "block";
      };

      modalNo?.addEventListener("click", () => {
        hideModal();
        if (clienteInput) clienteInput.value = "";
      });
      modalSi?.addEventListener("click", () => {
        if (clienteInput) {
          const parts = (clienteInput.value || "").trim().split(/\s+/);
          const nombre = toTitleCase(parts.shift() || "");
          const apellido = toTitleCase(parts.join(" ").trim());
          if (modalNombre) modalNombre.value = nombre;
          if (modalApellido) modalApellido.value = apellido;
        }
        goStep2();
      });
      modalCancelar?.addEventListener("click", () => {
        goStep1();
        hideModal();
        if (clienteInput) clienteInput.value = "";
      });

      const checkClienteExiste = async () => {
        const valRaw = clienteInput?.value || "";
        if (!valRaw) return;
        const term = normalizeText(valRaw);
        const current = ++checkCounter;
        try {
          console.log("[cuenta_nueva] buscar cliente", {
            raw: valRaw,
            term,
          });
          const data = await loadUsuariosCache();
          if (current !== checkCounter) return;
          if (normalizeText(clienteInput?.value || "") !== term) return;
          const filtered = (data || []).filter((u) => (u.full_norm || "").includes(term));
          if (!filtered.length) {
            goStep1();
            showModal();
            clienteSeleccionadoId = null;
            if (clienteIdLabel) clienteIdLabel.textContent = "ID usuario: -";
            if (clienteAccesoLabel) clienteAccesoLabel.textContent = "Acceso: -";
          } else if (clienteIdLabel && filtered[0]?.id_usuario) {
            clienteSeleccionadoId = filtered[0].id_usuario;
            console.log("[cuenta_nueva] id_usuario encontrado", clienteSeleccionadoId);
            clienteIdLabel.textContent = `ID usuario: ${clienteSeleccionadoId}`;
            if (clienteAccesoLabel) {
              const accesoTxt = filtered[0].acceso_cliente === false ? "Revendedor" : "Cliente final";
              clienteAccesoLabel.textContent = `Acceso: ${accesoTxt}`;
            }
            clearSugs();
          }
        } catch (err) {
          console.error("check cliente error", err);
          clienteSeleccionadoId = null;
        }
      };

      clienteInput?.addEventListener("blur", () => {
        if (suppressBlur) {
          setTimeout(() => {
            suppressBlur = false;
            checkClienteExiste();
            clearSugs();
          }, 120);
          return;
        }
        setTimeout(() => checkClienteExiste(), 100); // deja terminar click en sugerencias
        clearSugs();
      });

      clienteInput?.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          checkClienteExiste();
        }
      });

      const titleCaseInput = (el) => {
        if (!el) return;
        const start = el.selectionStart;
        el.value = toTitleCase(el.value);
        if (start !== null) {
          const pos = Math.min(start, el.value.length);
          el.setSelectionRange(pos, pos);
        }
      };

      modalNombre?.addEventListener("input", () => titleCaseInput(modalNombre));
      modalApellido?.addEventListener("input", () => titleCaseInput(modalApellido));

      modalGuardar?.addEventListener("click", async () => {
        const nombre = toTitleCase(modalNombre?.value || "").trim();
        const apellido = toTitleCase(modalApellido?.value || "").trim();
        const correo = (modalCorreo?.value || "").trim();
        let telefono = (modalTelefono?.value || "").trim();
        telefono = telefono.replace(/[^\d]/g, "");
        if (!nombre || !apellido || !correo) {
          alert("Nombre, apellido y correo son obligatorios.");
          return;
        }
        try {
          const { data, error } = await supabase
            .from("usuarios")
            .insert({
              nombre,
              apellido,
              correo,
              telefono,
              acceso_cliente: true,
            })
            .select("id_usuario")
            .single();
          if (error) throw error;
          const fullName = `${nombre} ${apellido}`.trim();
          if (clienteInput) clienteInput.value = fullName;
          clienteSeleccionadoId = data?.id_usuario || null;
          if (clienteIdLabel) clienteIdLabel.textContent = `ID usuario: ${clienteSeleccionadoId || "-"}`;
          if (clienteAccesoLabel) clienteAccesoLabel.textContent = "Acceso: Cliente final";
          if (usuariosCache && clienteSeleccionadoId) {
            usuariosCache.unshift({
              id_usuario: clienteSeleccionadoId,
              nombre,
              apellido,
              acceso_cliente: true,
              full_norm: normalizeText(fullName),
            });
          }
          goStep1();
          hideModal();
          modalNombre && (modalNombre.value = "");
          modalApellido && (modalApellido.value = "");
          modalCorreo && (modalCorreo.value = "");
          modalTelefono && (modalTelefono.value = "");
          alert("Cliente creado correctamente.");
        } catch (err) {
          console.error("crear cliente error", err);
          alert("No se pudo crear el cliente.");
        }
      });

      // Cargar info del admin actual
      (async () => {
        try {
          const user = await loadCurrentUser();
          adminId = user?.id_usuario || null;
          const isTrue = (v) => v === true || v === 1 || v === "1" || v === "true" || v === "t";
          const isSuper = isTrue(user?.permiso_superadmin);
          isSuperAdmin = isSuper;
          if (!isSuper) {
            alert("Acceso denegado.");
            window.location.href = "index.html";
            return;
          }
        } catch (err) {
          console.error("load current user error", err);
        }
      })();

      // Procesar pedido: intenta checkout para el cliente indicado
      document.querySelector("#cn-procesar")?.addEventListener("click", async () => {
        const idCliente = clienteSeleccionadoId || null;
        if (!idCliente) {
          alert("Selecciona un cliente válido (ID no encontrado).");
          return;
        }
        if (!isSuperAdmin) {
          alert("Acceso denegado.");
          return;
        }
        const referencia = (document.querySelector("#cn-ref")?.value || "").trim() || "N/A";
        try {
          const payload = {
            id_metodo_de_pago: 1,
            referencia,
            comprobantes: [],
            total: null,
            tasa_bs: 400,
            id_usuario_override: idCliente,
            bypass_verificacion: isSuperAdmin === true,
            id_admin: adminId,
          };
          console.log("[cuenta_nueva] payload checkout", {
            idCliente,
            adminId,
            isSuperAdmin,
            payload,
          });
          const { submitCheckout } = await import("../scripts/api.js");
          const resp = await submitCheckout(payload);
          console.log("[cuenta_nueva] checkout resp", resp);
          if (resp?.error) {
            alert(`Error al procesar: ${resp.error}`);
            return;
          }
          // Marca el admin que procesó la venta en ventas via id_orden
          if (adminId && resp?.id_orden) {
            const { error: updVentaErr } = await supabase
              .from("ventas")
              .update({ id_admin_venta: adminId })
              .eq("id_orden", resp.id_orden);
          if (updVentaErr) {
            console.error("set id_admin_venta error", updVentaErr);
          }
        }

        // Notificaciones de nuevo servicio por cada venta de la orden
        try {
          if (resp?.id_orden) {
            const { data: ventasOrden, error: ventasOrdErr } = await supabase
              .from("ventas")
              .select(
                "id_venta, id_usuario, fecha_corte, id_cuenta, id_perfil, id_orden, correo_miembro, clave_miembro, cuenta_base:cuentas!ventas_id_cuenta_fkey(correo, clave, id_plataforma, plataformas:plataformas(nombre)), cuenta_miembro:cuentas!ventas_id_cuenta_miembro_fkey(correo, clave, id_plataforma, plataformas:plataformas(nombre)), perfiles:perfiles(n_perfil)"
              )
              .eq("id_orden", resp.id_orden);
            if (ventasOrdErr) throw ventasOrdErr;
            const rowsNotif = [];
            const nuevosServiciosPorUsuario = new Map();
            (ventasOrden || []).forEach((v) => {
              const cuentaInfo = v.cuenta_miembro || v.cuenta_base || {};
              const ventaUserId = v.id_usuario;
              if (!ventaUserId) return;
              const platName = cuentaInfo?.plataformas?.nombre || "Plataforma";
              const perfilTxt = v.perfiles?.n_perfil ? `M${v.perfiles.n_perfil}` : "";
              const correoTxt = v.correo_miembro || cuentaInfo?.correo || "";
              const claveTxt = v.clave_miembro || cuentaInfo?.clave || "";
              if (!correoTxt) return;
              const items = nuevosServiciosPorUsuario.get(ventaUserId) || [];
              items.push({
                plataforma: platName,
                correoCuenta: correoTxt,
                clave: claveTxt,
                perfil: perfilTxt,
                fechaCorte: v.fecha_corte || "",
                idVenta: v.id_venta || null,
              });
              nuevosServiciosPorUsuario.set(ventaUserId, items);
            });

            nuevosServiciosPorUsuario.forEach((items, uid) => {
              if (!items.length) return;
              const userIds = pickNotificationUserIds("nuevo_servicio", { ventaUserId: uid });
              if (!userIds.length) return;
              const notif = buildNotificationPayload("nuevo_servicio", { items });
              userIds.forEach((id) => rowsNotif.push({ ...notif, id_usuario: id }));
            });
            if (rowsNotif.length) {
              const { error: notifErr } = await supabase.from("notificaciones").insert(rowsNotif);
              if (notifErr) throw notifErr;
            }
          }
        } catch (nErr) {
          console.error("nuevo_servicio notif error", nErr);
        }
        alert("Pedido procesado y asignado al cliente.");
        const dest = resp?.id_orden
          ? `entregar_servicios.html?id_orden=${encodeURIComponent(resp.id_orden)}`
          : "entregar_servicios.html";
        window.location.href = dest;
      } catch (err) {
        console.error("procesar cuenta nueva error", err);
          alert("No se pudo procesar el pedido.");
        }
      });
    </script>
  </body>
</html>
