<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ordenes</title>
    <link rel="stylesheet" href="../../styles/styles.css" />
    <style>
      .ordenes-table-wrap {
        overflow-x: auto;
      }
      .estado-cell {
        text-align: center;
        font-weight: 700;
        border-radius: 0;
      }
      .estado-ok {
        background: #dcfce7;
        color: #166534;
      }
      .estado-bad {
        background: #fee2e2;
        color: #991b1b;
      }
      .estado-warn {
        background: #fef3c7;
        color: #92400e;
      }
      .acciones-cell {
        display: flex;
        gap: 8px;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
      }
      .acciones-cell .btn-primary,
      .acciones-cell .btn-outline {
        padding: 6px 10px;
        font-size: 12px;
      }
      .ordenes-filters {
        display: flex;
        gap: 8px;
        margin: 8px 0 12px;
      }
      .btn-filter.is-active {
        background: #111;
        color: #fff;
        border-color: #111;
        box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.25);
      }
      .btn-filter:not(.is-active) {
        background: #e5e7eb;
        color: #111;
        border-color: #cbd5e1;
      }
      .orden-row-selected td {
        background: #dbeafe;
      }
      .orden-row-selected td.estado-cell {
        background: #dbeafe;
        color: #1e3a8a;
      }
      #ordenes-table tbody tr.orden-row-odd {
        background: #eef1f5;
      }
      #ordenes-table tbody tr.orden-row-even {
        background: #ffffff;
      }
      .orden-id-link {
        border: 0;
        background: transparent;
        color: #1d4ed8;
        font-weight: 700;
        text-decoration: underline;
        cursor: pointer;
        padding: 0;
      }
      .orden-id-link:hover,
      .orden-id-link:focus-visible {
        color: #1e40af;
      }
    </style>
  </head>
  <body>
    <div id="app-header" data-header-root="../../" data-header-pages="../"></div>
    <script src="../../scripts/header-loader.js"></script>

    <main class="categorias-dinamicas">
      <h2>Ordenes</h2>
      <p id="ordenes-status" class="status">Cargando ordenes...</p>
      <div class="ordenes-filters" id="ordenes-filters">
        <button
          type="button"
          class="btn-primary btn-filter is-active"
          id="btn-filter-checkout"
          aria-pressed="true"
        >
          Pagos desde checkout
        </button>
      </div>
      <div class="ordenes-table-wrap" id="ordenes-table-wrap">
        <table class="table-base" id="ordenes-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Cliente</th>
              <th>Metodo de pago</th>
              <th>Monto</th>
              <th>Referencia</th>
              <th>Fecha</th>
              <th>Hora</th>
              <th>Estado</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody id="ordenes-body"></tbody>
        </table>
      </div>
    </main>

    <script type="module">
      import { requireSession, attachLogout, attachLogoHome } from "../../scripts/session.js";
      import {
        clearServerSession,
        loadCurrentUser,
        supabase,
        procesarOrden,
      } from "../../scripts/api.js";
      import {
        buildNotificationPayload,
        pickNotificationUserIds,
      } from "../../scripts/notification-templates.js";
      import { formatDDMMYYYY } from "../../scripts/date-format.js";

      requireSession();
      attachLogoHome();
      attachLogout(clearServerSession);

      const statusEl = document.querySelector("#ordenes-status");
      const tableWrap = document.querySelector("#ordenes-table-wrap");
      const filterWrap = document.querySelector("#ordenes-filters");
      const tbodyEl = document.querySelector("#ordenes-body");
      const filterCheckoutBtn = document.querySelector("#btn-filter-checkout");

      const isTrue = (v) => v === true || v === 1 || v === "1" || v === "true" || v === "t";
      let allOrdenes = [];
      let userMap = {};
      let metodoMap = {};
      let filterCheckoutActive = true;
      let currentUser = null;
      let canManageOrdenes = false;

      const setStatus = (msg) => {
        if (statusEl) statusEl.textContent = msg || "";
      };

      const formatMonto = (monto) => {
        const num = Number(monto);
        if (!Number.isFinite(num)) return "-";
        return num.toFixed(2);
      };

      const buildMap = (rows, idKey, nameBuilder) => {
        return (rows || []).reduce((acc, row) => {
          const id = row?.[idKey];
          if (!id) return acc;
          acc[id] = nameBuilder(row);
          return acc;
        }, {});
      };

      const applyVisibleRowStripes = () => {
        if (!tbodyEl) return;
        const rows = Array.from(tbodyEl.querySelectorAll("tr")).filter(
          (tr) => window.getComputedStyle(tr).display !== "none"
        );
        rows.forEach((tr, idx) => {
          const odd = idx % 2 === 0;
          tr.classList.toggle("orden-row-odd", odd);
          tr.classList.toggle("orden-row-even", !odd);
        });
      };

      const renderOrdenes = () => {
        const rows = filterCheckoutActive
          ? allOrdenes.filter((o) => isTrue(o.origen_checkout))
          : allOrdenes;
        if (!rows.length) {
          tbodyEl.innerHTML = "";
          setStatus("No hay ordenes registradas.");
          return;
        }
        tbodyEl.innerHTML = rows
          .map((orden) => {
            const cliente = userMap[orden.id_usuario] || "-";
            const metodo = metodoMap[orden.id_metodo_de_pago] || "-";
            const montoVal = Number.isFinite(Number(orden.monto_bs))
              ? formatMonto(orden.monto_bs)
              : formatMonto(orden.total);
            const referencia = orden.referencia || "-";
            const fecha = formatDDMMYYYY(orden.fecha) || orden.fecha || "-";
            const hora = orden.hora_orden || "-";
            const verificado = isTrue(orden.pago_verificado);
            const cancelada = isTrue(orden.orden_cancelada);
            const estado = cancelada ? "Rechazada" : verificado ? "Verificado" : "Pendiente";
            const estadoClass = cancelada ? "estado-bad" : verificado ? "estado-ok" : "estado-warn";
            const canEntregar = !verificado && !cancelada;
            const canRechazar = !verificado && !cancelada;
            const accionesCell = canManageOrdenes
              ? `
                <button type="button" class="btn-primary btn-entregar" data-orden="${orden.id_orden}" ${canEntregar ? "" : "disabled"}>
                  ${canEntregar ? "Entregar servicio" : cancelada ? "Rechazada" : "Entregado"}
                </button>
                <button type="button" class="btn-outline btn-rechazar" data-orden="${orden.id_orden}" ${canRechazar ? "" : "disabled"}>
                  Rechazar servicio
                </button>
              `
              : "-";
            return `
              <tr data-orden="${orden.id_orden}">
                <td>
                  <button type="button" class="orden-id-link" data-open-orden="${orden.id_orden}">
                    ${orden.id_orden ?? "-"}
                  </button>
                </td>
                <td>${cliente || "-"}</td>
                <td>${metodo}</td>
                <td>${montoVal}</td>
                <td>${referencia}</td>
                <td>${fecha}</td>
                <td>${hora}</td>
                <td class="estado-cell ${estadoClass}">${estado}</td>
                <td class="acciones-cell">${accionesCell}</td>
              </tr>
            `;
          })
          .join("");
        applyVisibleRowStripes();
        setStatus("");
      };

      const markOrdenProcesada = (idOrden, idAdminEntrega = null) => {
        const id = Number(idOrden);
        if (!Number.isFinite(id)) return;
        const idx = allOrdenes.findIndex((o) => Number(o.id_orden) === id);
        if (idx >= 0) {
          const current = allOrdenes[idx];
          const parsedAdmin = Number.isFinite(Number(idAdminEntrega))
            ? Number(idAdminEntrega)
            : current?.id_admin ?? null;
          allOrdenes[idx] = {
            ...current,
            pago_verificado: true,
            id_admin: parsedAdmin,
          };
        }
        renderOrdenes();
      };

      const markOrdenRechazada = (idOrden) => {
        const id = Number(idOrden);
        if (!Number.isFinite(id)) return;
        const idx = allOrdenes.findIndex((o) => Number(o.id_orden) === id);
        if (idx >= 0) {
          allOrdenes[idx] = {
            ...allOrdenes[idx],
            orden_cancelada: true,
          };
        }
        renderOrdenes();
      };

      const notifyVentasEntregadas = async (idOrden) => {
        const id = Number(idOrden);
        if (!Number.isFinite(id)) return;

        const { data: ventasOrden, error: ventasOrdErr } = await supabase
          .from("ventas")
          .select(
            "id_venta, id_usuario, fecha_corte, id_cuenta, id_cuenta_miembro, id_perfil, id_orden, renovacion, correo_miembro, clave_miembro, cuentas:cuentas!ventas_id_cuenta_fkey(id_cuenta, correo, clave, id_plataforma, plataformas:plataformas(nombre, correo_cliente, clave_cliente)), cuentas_miembro:cuentas!ventas_id_cuenta_miembro_fkey(id_cuenta, correo, clave, id_plataforma, plataformas:plataformas(nombre, correo_cliente, clave_cliente)), perfiles:perfiles(n_perfil)"
          )
          .eq("id_orden", id);
        if (ventasOrdErr) throw ventasOrdErr;

        const nuevosServiciosPorUsuario = new Map();
        const renovacionesPorUsuario = new Map();

        (ventasOrden || []).forEach((v) => {
          const uid = Number(v?.id_usuario);
          if (!Number.isFinite(uid)) return;
          const cuentaRow = v.cuentas_miembro || v.cuentas || null;
          const platName = cuentaRow?.plataformas?.nombre || "Plataforma";
          const perfilTxt = v.perfiles?.n_perfil ? `M${v.perfiles.n_perfil}` : "";
          const correoTxt = v.correo_miembro || cuentaRow?.correo || "";
          const claveTxt = v.clave_miembro || cuentaRow?.clave || "";

          const item = {
            plataforma: platName,
            correoCuenta: correoTxt,
            clave: claveTxt,
            perfil: perfilTxt,
            fechaCorte: v.fecha_corte || "",
            idVenta: v.id_venta || null,
          };

          if (v.renovacion) {
            const itemsRenov = renovacionesPorUsuario.get(uid) || [];
            itemsRenov.push(item);
            renovacionesPorUsuario.set(uid, itemsRenov);
            return;
          }

          const itemsNuevos = nuevosServiciosPorUsuario.get(uid) || [];
          itemsNuevos.push(item);
          nuevosServiciosPorUsuario.set(uid, itemsNuevos);
        });

        const rowsNotif = [];
        const userIdsToFlag = new Set();

        nuevosServiciosPorUsuario.forEach((items, uid) => {
          if (!items.length) return;
          const userIds = pickNotificationUserIds("nuevo_servicio", { ventaUserId: uid });
          if (!userIds.length) return;
          const payload = buildNotificationPayload("nuevo_servicio", { items });
          userIds.forEach((idUsuario) => {
            rowsNotif.push({ ...payload, id_usuario: idUsuario });
            userIdsToFlag.add(idUsuario);
          });
        });

        renovacionesPorUsuario.forEach((items, uid) => {
          if (!items.length) return;
          const userIds = pickNotificationUserIds("servicio_renovado", { ventaUserId: uid });
          if (!userIds.length) return;
          const payload = buildNotificationPayload("servicio_renovado", { items });
          userIds.forEach((idUsuario) => {
            rowsNotif.push({ ...payload, id_usuario: idUsuario });
            userIdsToFlag.add(idUsuario);
          });
        });

        if (rowsNotif.length) {
          const { error: notifErr } = await supabase.from("notificaciones").insert(rowsNotif);
          if (notifErr) throw notifErr;
        }

        const idsFlag = Array.from(userIdsToFlag);
        if (idsFlag.length) {
          const { error: flagErr } = await supabase
            .from("usuarios")
            .update({ notificacion_inventario: true })
            .in("id_usuario", idsFlag);
          if (flagErr) {
            console.error("notificacion_inventario update error", flagErr);
          }
        }
      };

      const loadOrdenes = async () => {
        setStatus("Cargando ordenes...");
        let query = supabase
          .from("ordenes")
          .select("id_orden, id_usuario, id_metodo_de_pago, id_admin, total, monto_bs, referencia, fecha, hora_orden, pago_verificado, orden_cancelada");
        if (!isTrue(currentUser?.permiso_superadmin)) {
          query = query.eq("id_usuario", currentUser?.id_usuario ?? -1);
        }
        const { data: ordenes, error } = await query.order("id_orden", { ascending: false });
        if (error) {
          console.error("ordenes load error", error);
          setStatus("No se pudieron cargar las ordenes.");
          return;
        }
        allOrdenes = (ordenes || []).map((orden) => ({
          ...orden,
          origen_checkout: orden.id_admin == null,
        }));
        if (!allOrdenes.length) {
          tbodyEl.innerHTML = "";
          setStatus("No hay ordenes registradas.");
          return;
        }

        const userIds = Array.from(new Set(allOrdenes.map((o) => o.id_usuario).filter(Boolean)));
        const metodoIds = Array.from(
          new Set(allOrdenes.map((o) => o.id_metodo_de_pago).filter(Boolean))
        );

        userMap = {};
        if (userIds.length) {
          const { data: users, error: userErr } = await supabase
            .from("usuarios")
            .select("id_usuario, nombre, apellido")
            .in("id_usuario", userIds);
          if (userErr) {
            console.error("usuarios load error", userErr);
          } else {
            userMap = buildMap(users, "id_usuario", (u) =>
              [u.nombre, u.apellido].filter(Boolean).join(" ").trim() || "-"
            );
          }
        }

        metodoMap = {};
        if (metodoIds.length) {
          const { data: metodos, error: metErr } = await supabase
            .from("metodos_de_pago")
            .select("id_metodo_de_pago, nombre")
            .in("id_metodo_de_pago", metodoIds);
          if (metErr) {
            console.error("metodos load error", metErr);
          } else {
            metodoMap = buildMap(metodos, "id_metodo_de_pago", (m) => m.nombre || "-");
          }
        }

        renderOrdenes();
      };

      const init = async () => {
        try {
          currentUser = await loadCurrentUser();
          if (!currentUser?.id_usuario) {
            if (tableWrap) tableWrap.classList.add("hidden");
            if (filterWrap) filterWrap.classList.add("hidden");
            setStatus("No se pudo identificar al usuario.");
            return;
          }
          canManageOrdenes = isTrue(currentUser?.permiso_superadmin);
          if (!isTrue(currentUser?.permiso_superadmin)) {
            setStatus("Mostrando solo tus ordenes.");
          }
          await loadOrdenes();
        } catch (err) {
          console.error("ordenes init error", err);
          setStatus("No se pudieron cargar las ordenes.");
        }
      };

      filterCheckoutBtn?.addEventListener("click", () => {
        filterCheckoutActive = !filterCheckoutActive;
        filterCheckoutBtn.classList.toggle("is-active", filterCheckoutActive);
        filterCheckoutBtn.setAttribute("aria-pressed", filterCheckoutActive ? "true" : "false");
        renderOrdenes();
      });

      document.addEventListener("click", async (event) => {
        const row = event.target.closest("#ordenes-table tbody tr");
        if (row) {
          tbodyEl.querySelectorAll(".orden-row-selected").forEach((tr) => {
            tr.classList.remove("orden-row-selected");
          });
          row.classList.add("orden-row-selected");
        }
        const entregarBtn = event.target.closest(".btn-entregar");
        if (entregarBtn) {
          if (entregarBtn.disabled) return;
          const idOrden = Number(entregarBtn.dataset.orden);
          if (!Number.isFinite(idOrden)) return;
          const prevText = entregarBtn.textContent;
          entregarBtn.disabled = true;
          entregarBtn.textContent = "Procesando...";
          setStatus(`Procesando orden #${idOrden}...`);
          try {
            const resp = await procesarOrden(idOrden);
            if (resp?.error) {
              console.error("procesar orden error", resp);
              window.alert(resp.error || "No se pudo procesar la orden.");
              setStatus("No se pudo procesar la orden.");
              return;
            }
            markOrdenProcesada(idOrden, resp?.id_admin);
            if (!resp?.already_processed) {
              try {
                await notifyVentasEntregadas(idOrden);
              } catch (notifErr) {
                console.error("notificaciones ordenes error", notifErr);
              }
            }
            if (resp?.already_processed) {
              setStatus(`Orden #${idOrden} ya estaba procesada.`);
            } else {
              setStatus(`Orden #${idOrden} procesada correctamente.`);
            }
          } catch (err) {
            console.error("procesar orden exception", err);
            window.alert("No se pudo procesar la orden.");
            setStatus("No se pudo procesar la orden.");
          } finally {
            const currentBtn = tbodyEl?.querySelector(`.btn-entregar[data-orden="${idOrden}"]`);
            if (currentBtn && !currentBtn.disabled) {
              currentBtn.disabled = false;
              currentBtn.textContent = prevText || "Entregar servicio";
            }
          }
          return;
        }

        const openOrdenBtn = event.target.closest(".orden-id-link");
        if (openOrdenBtn) {
          const idOrden = Number(openOrdenBtn.dataset.openOrden);
          if (!Number.isFinite(idOrden)) return;
          window.location.href = `../detalle_ordenes.html?id_orden=${encodeURIComponent(idOrden)}`;
          return;
        }

        const rechazarBtn = event.target.closest(".btn-rechazar");
        if (rechazarBtn) {
          if (rechazarBtn.disabled) return;
          const idOrden = Number(rechazarBtn.dataset.orden);
          if (!Number.isFinite(idOrden)) return;
          const confirmed = window.confirm("Â¿Rechazar este servicio?");
          if (!confirmed) return;
          const { error } = await supabase
            .from("ordenes")
            .update({ orden_cancelada: true })
            .eq("id_orden", idOrden);
          if (error) {
            console.error("rechazar orden error", error);
            window.alert("No se pudo rechazar la orden.");
            return;
          }
          markOrdenRechazada(idOrden);
          setStatus(`Orden #${idOrden} rechazada.`);
        }
      });

      init();
    </script>
  </body>
</html>
