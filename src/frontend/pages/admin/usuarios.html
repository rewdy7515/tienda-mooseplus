<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Usuarios</title>
    <link rel="stylesheet" href="../../styles/styles.css" />
    <style>
      .usuarios-wrapper {
        margin-top: 12px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .usuarios-tools {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }
      .usuarios-search {
        width: min(100%, 420px);
      }
      .usuarios-table {
        width: 100%;
      }
      .usuarios-table th,
      .usuarios-table td {
        padding: 8px 10px;
      }
      .usuarios-table th {
        background: #444;
        color: #fff;
      }
      .usuarios-table tbody tr:nth-child(odd) {
        background: #f5f5f5;
      }
      .usuarios-table tbody tr:nth-child(even) {
        background: #fff;
      }
      .usuarios-edit-wrap {
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .usuarios-edit-wrap .btn-edit,
      .usuarios-edit-wrap .btn-save {
        padding: 4px 6px;
        font-size: 12px;
        line-height: 1;
      }
      .usuarios-edit-input {
        min-width: 140px;
      }
      .usuarios-edit-wrap[data-quick-edit="1"] .usuarios-text {
        cursor: pointer;
      }
      .registro-no {
        background: #fee2e2;
        color: #7f1d1d;
        font-weight: 700;
      }
      .registro-si {
        background: #dcfce7;
        color: #166534;
        font-weight: 700;
      }
      .registro-cell-content {
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      .btn-link-registro {
        padding: 4px 8px;
        font-size: 12px;
        line-height: 1;
        white-space: nowrap;
      }
      .saldo-wrap {
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }
      .saldo-text {
        font-weight: 700;
      }
      .btn-add-saldo {
        width: 24px;
        height: 24px;
        border-radius: 999px;
        padding: 0;
        line-height: 1;
        font-size: 16px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }
      .saldo-modal-body {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .saldo-modal-title {
        margin: 0;
        font-size: 17px;
        font-weight: 700;
      }
      .saldo-modal-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
      }
      .usuarios-pagination {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        flex-wrap: wrap;
      }
      .usuarios-page-label {
        font-weight: 600;
      }
      .usuarios-page-btn {
        min-width: 40px;
      }
    </style>
  </head>
  <body>
    <div id="app-header" data-header-root="../../" data-header-pages="../"></div>
    <script src="../../scripts/header-loader.js"></script>

    <main class="categorias-dinamicas">
      <h2>Usuarios</h2>
      <div class="usuarios-wrapper">
        <p id="usuarios-status" class="status">Cargando usuarios...</p>
        <p id="usuarios-phone-stat" class="status"></p>
        <div class="usuarios-tools">
          <input
            type="text"
            id="usuarios-search"
            class="form-input usuarios-search"
            placeholder="Buscar cliente por nombre y apellido"
            autocomplete="off"
          />
        </div>
        <div class="cuenta-table-wrap">
          <table class="table-base usuarios-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Cliente</th>
                <th>Tel√©fono</th>
                <th>Email</th>
                <th>Saldo</th>
                <th>Registrado</th>
              </tr>
            </thead>
            <tbody id="usuarios-body"></tbody>
          </table>
        </div>
        <div class="usuarios-pagination hidden" id="usuarios-pagination">
          <button type="button" class="btn-outline usuarios-page-btn" id="usuarios-page-prev" aria-label="P√°gina anterior">‚Üê</button>
          <span class="usuarios-page-label" id="usuarios-page-label">P√°gina 1 de 1</span>
          <button type="button" class="btn-outline usuarios-page-btn" id="usuarios-page-next" aria-label="P√°gina siguiente">‚Üí</button>
        </div>
      </div>
    </main>

    <div id="saldo-modal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-card">
        <button class="modal-close" id="saldo-modal-close" aria-label="Cerrar">√ó</button>
        <div class="modal-body saldo-modal-body">
          <p class="saldo-modal-title">¬øCu√°nto saldo deseas agregar?</p>
          <input
            type="number"
            id="saldo-input"
            class="form-input"
            placeholder="0.00"
            min="0"
            step="0.01"
            inputmode="decimal"
          />
          <div class="saldo-modal-actions">
            <button type="button" class="btn-outline" id="saldo-cancel-btn">Cancelar</button>
            <button type="button" class="btn-primary" id="saldo-add-btn">Agregar</button>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import {
        requireSession,
        getSessionRoles,
        setSessionRoles,
        attachLogoHome,
        attachLogout,
      } from "../../scripts/session.js";
      import {
        clearServerSession,
        createUsuarioSignupLink,
        ensureServerSession,
        loadCurrentUser,
        supabase,
      } from "../../scripts/api.js";
      import { buildNotificationPayload } from "../../scripts/notification-templates.js";

      requireSession();
      attachLogoHome();
      attachLogout(clearServerSession);
      const isTrue = (v) =>
        v === true || v === 1 || v === "1" || v === "true" || v === "t";

      const statusEl = document.querySelector("#usuarios-status");
      const tbodyEl = document.querySelector("#usuarios-body");
      const phoneStatEl = document.querySelector("#usuarios-phone-stat");
      const searchInputEl = document.querySelector("#usuarios-search");
      const paginationEl = document.querySelector("#usuarios-pagination");
      const pagePrevBtn = document.querySelector("#usuarios-page-prev");
      const pageNextBtn = document.querySelector("#usuarios-page-next");
      const pageLabelEl = document.querySelector("#usuarios-page-label");
      const saldoModal = document.querySelector("#saldo-modal");
      const saldoInput = document.querySelector("#saldo-input");
      const saldoCancelBtn = document.querySelector("#saldo-cancel-btn");
      const saldoAddBtn = document.querySelector("#saldo-add-btn");
      const saldoModalCloseBtn = document.querySelector("#saldo-modal-close");
      const PAGE_SIZE = 10;
      let saldoTargetUserId = null;
      let usuariosRows = [];
      let usuariosFilteredRows = [];
      let currentPage = 1;

      const setStatus = (msg) => {
        if (statusEl) statusEl.textContent = msg || "";
      };

      const formatSaldo = (value) => {
        const n = Number(value);
        return Number.isFinite(n) ? `$${n.toFixed(2)}` : "$0.00";
      };

      const openSaldoModal = (userId) => {
        saldoTargetUserId = Number(userId) || null;
        if (!saldoTargetUserId) return;
        if (saldoInput) saldoInput.value = "";
        saldoModal?.classList.remove("hidden");
        if (saldoInput) {
          saldoInput.focus();
          saldoInput.select();
        }
      };

      const closeSaldoModal = () => {
        saldoModal?.classList.add("hidden");
        saldoTargetUserId = null;
        if (saldoInput) saldoInput.value = "";
      };

      const updateSaldoInRow = (userId, saldoVal) => {
        const uid = Number(userId) || 0;
        if (!uid) return;
        usuariosRows = (usuariosRows || []).map((row) =>
          Number(row?.id_usuario) === uid ? { ...row, saldo: saldoVal } : row,
        );
        usuariosFilteredRows = (usuariosFilteredRows || []).map((row) =>
          Number(row?.id_usuario) === uid ? { ...row, saldo: saldoVal } : row,
        );
        renderCurrentPage();
      };

      const copyTextToClipboard = async (value) => {
        const text = String(value || "").trim();
        if (!text) return false;
        if (navigator?.clipboard?.writeText) {
          await navigator.clipboard.writeText(text);
          return true;
        }
        return false;
      };

      const buildSignupInviteMessage = (linkValue) => {
        const link = String(linkValue || "").trim();
        return [
          "*Registrate en nuestra Pagina Web*",
          "",
          `Link: ${link}`,
          "",
          "*Al registrarte con este link podr√°s:*",
          "",
          "üì¶ Ver todos tus servicios activos.",
          "üõçÔ∏è Comprar y renovar a *cualquier hora* con *verificaci√≥n de pago automatizado*.",
          "üö® *Reportar* y recibir *soluciones inmediatas* de ciertos reportes.",
          "",
          "_Este enlace est√° vinculado directamente a tus datos y servicios actuales. Recomendamos no compartir este link._",
        ].join("\n");
      };

      const agregarSaldo = async () => {
        if (!saldoTargetUserId) return;
        const raw = String(saldoInput?.value || "").trim().replace(",", ".");
        const monto = Number(raw);
        if (!Number.isFinite(monto) || monto <= 0) {
          alert("Ingresa un monto v√°lido.");
          saldoInput?.focus();
          return;
        }
        if (saldoAddBtn) saldoAddBtn.disabled = true;
        try {
          const { data: userRow, error: userErr } = await supabase
            .from("usuarios")
            .select("saldo")
            .eq("id_usuario", saldoTargetUserId)
            .maybeSingle();
          if (userErr) throw userErr;
          const saldoActual = Number(userRow?.saldo);
          const base = Number.isFinite(saldoActual) ? saldoActual : 0;
          const saldoNuevo = Number((base + monto).toFixed(2));
          const { error: updErr } = await supabase
            .from("usuarios")
            .update({ saldo: saldoNuevo })
            .eq("id_usuario", saldoTargetUserId);
          if (updErr) throw updErr;
          let notifErr = null;
          try {
            const notif = buildNotificationPayload("saldo_acreditado", {
              monto: formatSaldo(monto),
            });
            const { error } = await supabase.from("notificaciones").insert({
              ...notif,
              id_usuario: saldoTargetUserId,
            });
            if (error) notifErr = error;
          } catch (errNotif) {
            notifErr = errNotif;
          }
          if (notifErr) {
            console.error("notificacion saldo_acreditado error", notifErr);
          }
          updateSaldoInRow(saldoTargetUserId, saldoNuevo);
          closeSaldoModal();
          if (notifErr) {
            alert("Saldo agregado, pero no se pudo enviar la notificaci√≥n.");
          }
        } catch (err) {
          console.error("agregar saldo error", err);
          alert("No se pudo agregar saldo.");
        } finally {
          if (saldoAddBtn) saldoAddBtn.disabled = false;
        }
      };

      const formatCliente = (row) => {
        const nombre = (row?.nombre || "").trim();
        const apellido = (row?.apellido || "").trim();
        const full = `${nombre} ${apellido}`.trim();
        return full || "-";
      };

      const normalizeText = (value) =>
        String(value || "")
          .trim()
          .toLowerCase()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "");

      const buildUsuarioRowHtml = (u) => {
        const cliente = formatCliente(u);
        const tel = String(u.telefono || "").trim();
        const email = String(u.correo || "").trim();
        const saldoNum = Number(u?.saldo);
        const saldoVal = Number.isFinite(saldoNum) ? saldoNum : 0;
        const saldoTxt = formatSaldo(saldoVal);
        const phoneIsValid = !!tel && /^\d+$/.test(tel);
        const telefonoQuickEdit = phoneIsValid ? "0" : "1";
        const correoQuickEdit = email ? "0" : "1";
        const registrado = u.fecha_registro ? "S√≠" : "No";
        const registroBtnHtml =
          registrado === "No"
            ? `<button
                type="button"
                class="btn-outline btn-link-registro"
                data-id="${u.id_usuario}"
              >Link registro</button>`
            : "";
        return `
          <tr>
            <td>${u.id_usuario ?? "-"}</td>
            <td>${cliente}</td>
            <td>
              <div class="usuarios-edit-wrap" data-id="${u.id_usuario}" data-field="telefono" data-quick-edit="${telefonoQuickEdit}">
                <span class="usuarios-text">${tel || "-"}</span>
                <button type="button" class="btn-outline btn-edit">‚úèÔ∏è</button>
              </div>
            </td>
            <td>
              <div class="usuarios-edit-wrap" data-id="${u.id_usuario}" data-field="correo" data-quick-edit="${correoQuickEdit}">
                <span class="usuarios-text">${email || "-"}</span>
                <button type="button" class="btn-outline btn-edit">‚úèÔ∏è</button>
              </div>
            </td>
            <td>
              <div class="saldo-wrap" data-id="${u.id_usuario}" data-saldo="${saldoVal}">
                <span class="saldo-text">${saldoTxt}</span>
                <button
                  type="button"
                  class="btn-outline btn-add-saldo"
                  data-id="${u.id_usuario}"
                  data-saldo="${saldoVal}"
                  title="Agregar saldo"
                >+</button>
              </div>
            </td>
            <td class="${registrado === "S√≠" ? "registro-si" : "registro-no"}">
              <span class="registro-cell-content">
                <span>${registrado}</span>
                ${registroBtnHtml}
              </span>
            </td>
          </tr>
        `;
      };

      const renderPagination = () => {
        const totalRows = usuariosFilteredRows.length;
        const totalPages = Math.max(1, Math.ceil(totalRows / PAGE_SIZE));
        if (currentPage > totalPages) currentPage = totalPages;
        if (currentPage < 1) currentPage = 1;
        if (pageLabelEl) pageLabelEl.textContent = `P√°gina ${currentPage} de ${totalPages}`;
        if (pagePrevBtn) pagePrevBtn.disabled = currentPage <= 1;
        if (pageNextBtn) pageNextBtn.disabled = currentPage >= totalPages;
        if (paginationEl) paginationEl.classList.toggle("hidden", !usuariosRows.length);
      };

      const renderCurrentPage = () => {
        if (!tbodyEl) return;
        const totalRows = usuariosFilteredRows.length;
        if (!totalRows) {
          tbodyEl.innerHTML =
            '<tr><td colspan="6" class="status">No hay usuarios que coincidan con la b√∫squeda.</td></tr>';
          renderPagination();
          return;
        }
        const start = (currentPage - 1) * PAGE_SIZE;
        const end = start + PAGE_SIZE;
        const pageRows = usuariosFilteredRows.slice(start, end);
        tbodyEl.innerHTML = pageRows.map((u) => buildUsuarioRowHtml(u)).join("");
        renderPagination();
      };

      const applySearchFilter = ({ resetPage = false } = {}) => {
        if (resetPage) currentPage = 1;
        const q = normalizeText(searchInputEl?.value || "");
        usuariosFilteredRows = (usuariosRows || []).filter((row) => {
          if (!q) return true;
          const name = normalizeText(row?.nombre || "");
          const lastName = normalizeText(row?.apellido || "");
          const full = normalizeText(`${row?.nombre || ""} ${row?.apellido || ""}`);
          return name.includes(q) || lastName.includes(q) || full.includes(q);
        });
        renderCurrentPage();
        if (!usuariosRows.length) {
          setStatus("No hay usuarios registrados.");
          return;
        }
        if (q && !usuariosFilteredRows.length) {
          setStatus("No se encontraron usuarios con ese nombre/apellido.");
          return;
        }
        setStatus("");
      };

      const init = async () => {
        try {
          await ensureServerSession();
          const user = await loadCurrentUser();
          setSessionRoles(user || {});
          const roles = getSessionRoles();
          const isSuperadmin =
            isTrue(roles?.permiso_superadmin) ||
            isTrue(user?.permiso_superadmin);
          if (!isSuperadmin) {
            window.location.href = "../index.html";
            return;
          }

          const { data, error } = await supabase
            .from("usuarios")
            .select("id_usuario, nombre, apellido, telefono, correo, saldo, fecha_registro")
            .order("nombre", { ascending: true })
            .order("apellido", { ascending: true });
          if (error) throw error;
          usuariosRows = data || [];
          if (!usuariosRows.length) {
            setStatus("No hay usuarios registrados.");
            if (tbodyEl) tbodyEl.innerHTML = "";
            if (phoneStatEl) phoneStatEl.textContent = "";
            if (paginationEl) paginationEl.classList.add("hidden");
            return;
          }
          const invalidPhones = usuariosRows.filter((u) => {
            const raw = String(u?.telefono ?? "").trim();
            if (!raw) return true;
            return !/^\d+$/.test(raw);
          });
          const pct = Math.round((invalidPhones.length / usuariosRows.length) * 1000) / 10;
          if (phoneStatEl) {
            phoneStatEl.textContent = `Usuarios sin tel√©fono v√°lido: ${invalidPhones.length} de ${usuariosRows.length} (${pct}%)`;
          }
          applySearchFilter({ resetPage: true });
        } catch (err) {
          console.error("usuarios error", err);
          setStatus("No se pudieron cargar los usuarios.");
        }
      };

      init();

      searchInputEl?.addEventListener("input", () => {
        if (!usuariosRows.length) return;
        applySearchFilter({ resetPage: true });
      });

      pagePrevBtn?.addEventListener("click", () => {
        if (currentPage <= 1) return;
        currentPage -= 1;
        renderCurrentPage();
      });

      pageNextBtn?.addEventListener("click", () => {
        const totalPages = Math.max(1, Math.ceil((usuariosFilteredRows.length || 0) / PAGE_SIZE));
        if (currentPage >= totalPages) return;
        currentPage += 1;
        renderCurrentPage();
      });

      const startEdit = (wrap) => {
        if (!wrap || wrap.querySelector(".usuarios-edit-input")) return;
        const textEl = wrap.querySelector(".usuarios-text");
        const editBtn = wrap.querySelector(".btn-edit");
        if (textEl) textEl.classList.add("hidden");
        if (editBtn) editBtn.classList.add("hidden");
        const input = document.createElement("input");
        input.type = "text";
        input.className = "form-input usuarios-edit-input";
        input.value = (textEl?.textContent || "").trim() === "-" ? "" : textEl?.textContent?.trim() || "";
        const saveBtn = document.createElement("button");
        saveBtn.type = "button";
        saveBtn.className = "btn-outline btn-save";
        saveBtn.textContent = "üíæ";
        wrap.appendChild(input);
        wrap.appendChild(saveBtn);
        input.focus();
      };

      const finishEdit = (wrap, nextVal) => {
        const textEl = wrap.querySelector(".usuarios-text");
        const editBtn = wrap.querySelector(".btn-edit");
        const input = wrap.querySelector(".usuarios-edit-input");
        const saveBtn = wrap.querySelector(".btn-save");
        if (textEl) {
          textEl.textContent = nextVal || "-";
          textEl.classList.remove("hidden");
        }
        if (editBtn) editBtn.classList.remove("hidden");
        input?.remove();
        saveBtn?.remove();
        const field = wrap?.dataset?.field || "";
        if (field === "telefono") {
          const raw = String(nextVal || "").trim();
          wrap.dataset.quickEdit = raw && /^\d+$/.test(raw) ? "0" : "1";
        } else if (field === "correo") {
          wrap.dataset.quickEdit = String(nextVal || "").trim() ? "0" : "1";
        }
      };

      const saveEdit = async (wrap) => {
        if (!wrap) return;
        const id = wrap.dataset.id;
        const field = wrap.dataset.field;
        const input = wrap.querySelector(".usuarios-edit-input");
        if (!id || !field || !input) return;
        let nextVal = input.value.trim();
        if (field === "telefono") {
          nextVal = nextVal.replace(/[^\d]/g, "");
        }
        try {
          const payload = { [field]: nextVal || null };
          const { error } = await supabase
            .from("usuarios")
            .update(payload)
            .eq("id_usuario", id);
          if (error) throw error;
          const uid = Number(id) || 0;
          if (uid) {
            usuariosRows = (usuariosRows || []).map((row) =>
              Number(row?.id_usuario) === uid ? { ...row, [field]: nextVal || null } : row,
            );
            usuariosFilteredRows = (usuariosFilteredRows || []).map((row) =>
              Number(row?.id_usuario) === uid ? { ...row, [field]: nextVal || null } : row,
            );
          }
          finishEdit(wrap, nextVal);
        } catch (err) {
          console.error("usuarios update error", err);
          alert("No se pudo guardar el dato.");
        }
      };

      document.addEventListener("click", async (e) => {
        const registroBtn = e.target.closest(".btn-link-registro");
        if (registroBtn) {
          const idTarget = Number(registroBtn.dataset.id);
          if (!Number.isFinite(idTarget) || idTarget <= 0) return;
          const originalText = registroBtn.textContent;
          registroBtn.disabled = true;
          registroBtn.textContent = "Generando...";
          try {
            const result = await createUsuarioSignupLink(idTarget);
            if (result?.error) throw new Error(result.error);
            const url = String(result?.url || "").trim();
            if (!url) throw new Error("No se pudo generar el link.");
            const message = buildSignupInviteMessage(url);
            const copied = await copyTextToClipboard(message).catch(() => false);
            if (copied) {
              alert("Mensaje de registro copiado al portapapeles.");
            } else {
              window.prompt("Copia este mensaje de registro:", message);
            }
          } catch (err) {
            console.error("generar link registro error", err);
            alert(err?.message || "No se pudo generar el link de registro.");
          } finally {
            registroBtn.disabled = false;
            registroBtn.textContent = originalText || "Link registro";
          }
          return;
        }

        const addSaldoBtn = e.target.closest(".btn-add-saldo");
        if (addSaldoBtn) {
          openSaldoModal(addSaldoBtn.dataset.id);
          return;
        }

        const saveBtn = e.target.closest(".usuarios-edit-wrap .btn-save");
        if (saveBtn) {
          const wrap = saveBtn.closest(".usuarios-edit-wrap");
          await saveEdit(wrap);
          return;
        }

        const editBtn = e.target.closest(".usuarios-edit-wrap .btn-edit");
        if (editBtn) {
          const wrap = editBtn.closest(".usuarios-edit-wrap");
          if (!wrap) return;
          startEdit(wrap);
          return;
        }

        const wrap = e.target.closest(".usuarios-edit-wrap");
        if (!wrap || wrap.querySelector(".usuarios-edit-input")) return;
        const clickedText = !!e.target.closest(".usuarios-text");
        const clickedCell = !!e.target.closest("td");
        const quickEdit = wrap.dataset.quickEdit === "1";
        if ((clickedText || clickedCell) && quickEdit) {
          startEdit(wrap);
        }
      });

      saldoModal?.addEventListener("click", (e) => {
        if (e.target.classList.contains("modal-backdrop")) {
          closeSaldoModal();
        }
      });
      saldoCancelBtn?.addEventListener("click", closeSaldoModal);
      saldoModalCloseBtn?.addEventListener("click", closeSaldoModal);
      saldoAddBtn?.addEventListener("click", agregarSaldo);

      document.addEventListener("keydown", async (e) => {
        if (e.key === "Escape" && saldoModal && !saldoModal.classList.contains("hidden")) {
          closeSaldoModal();
          return;
        }
        if (
          e.key === "Enter" &&
          saldoModal &&
          !saldoModal.classList.contains("hidden") &&
          document.activeElement?.id === "saldo-input"
        ) {
          e.preventDefault();
          await agregarSaldo();
          return;
        }
        if (e.key !== "Enter") return;
        const input = e.target.closest(".usuarios-edit-input");
        if (!input) return;
        e.preventDefault();
        const wrap = input.closest(".usuarios-edit-wrap");
        await saveEdit(wrap);
      });
    </script>
  </body>
</html>
