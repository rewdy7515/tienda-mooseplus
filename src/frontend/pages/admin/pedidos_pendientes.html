<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pedidos pendientes</title>
    <link rel="stylesheet" href="../../styles/styles.css" />
    <style>
      .copyable {
        cursor: pointer;
      }
      .copy-toast {
        position: fixed;
        top: 86px;
        right: 24px;
        background: #111;
        color: #fff;
        padding: 10px 14px;
        border-radius: 8px;
        font-size: 13px;
        z-index: 2000;
        opacity: 0;
        transform: translateY(-6px);
        transition: opacity 0.2s ease, transform 0.2s ease;
        pointer-events: none;
      }
      .copy-toast.show {
        opacity: 1;
        transform: translateY(0);
      }
      .madre-bar {
        background: #f3f4f6;
        border: 2px solid #cbd5e1;
        border-bottom: none;
        border-radius: 10px 10px 0 0;
        padding: 12px 16px;
        margin: 8px 0 -6px;
        position: relative;
      }
      .madre-bar .copyable {
        font-weight: 600;
      }
      .madre-region {
        margin: 0 0 6px;
        font-size: 18px;
        font-weight: 800;
        color: #111827;
      }
      .correo-edit-wrap {
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .correo-edit-wrap .btn-edit-correo,
      .correo-edit-wrap .btn-save-correo {
        padding: 4px 6px;
        font-size: 12px;
        line-height: 1;
      }
      .correo-edit-wrap input {
        min-width: 180px;
      }
      .tipo-cell {
        text-align: center;
        font-weight: 700;
        padding: 6px 10px;
      }
      .tipo-nueva {
        background: #dcfce7;
        color: #166534;
      }
      .tipo-existe {
        background: #dbeafe;
        color: #1e3a8a;
      }
      .modal-activar-body {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .modal-activar-title {
        margin: 0;
        font-size: 18px;
        font-weight: 800;
        color: #111827;
      }
      .modal-activar-row {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .modal-activar-row label {
        font-weight: 700;
      }
      .modal-activar-row .input-wrap {
        position: relative;
      }
      .modal-activar-row input {
        width: 100%;
        box-sizing: border-box;
      }
      .modal-activar-prov {
        display: grid;
        grid-template-columns: minmax(0, 1fr) auto;
        gap: 8px;
        align-items: start;
      }
      .modal-activar-prov .btn-outline {
        padding: 10px 12px;
      }
      .modal-activar-sugerencias {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 10px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        overflow: hidden;
        z-index: 30;
        margin-top: 6px;
      }
      .modal-activar-sugerencias.hidden {
        display: none;
      }
      .modal-activar-sugerencias button {
        width: 100%;
        border: none;
        background: transparent;
        text-align: left;
        padding: 10px 12px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
      }
      .modal-activar-sugerencias button:last-child {
        border-bottom: none;
      }
      .modal-activar-sugerencias button:hover {
        background: #f7f7f7;
      }
      .modal-activar-actions {
        display: flex;
        justify-content: flex-end;
        gap: 8px;
        flex-wrap: wrap;
      }
    </style>
  </head>
  <body>
    <div id="app-header" data-header-root="../../" data-header-pages="../"></div>
    <script src="../../scripts/header-loader.js"></script>

    <main class="categorias-dinamicas">
      <h2>Pedidos pendientes</h2>
      <p id="pp-status" class="status">Cargando pedidos...</p>
      <div id="pp-tablas"></div>
    </main>
    <div id="copy-toast" class="copy-toast">Copiado al portapapeles</div>
    <div id="modal-activar-servicio" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-card modal-card-sol">
        <button type="button" class="modal-close" id="modal-activar-close" aria-label="Cerrar"></button>
        <div class="modal-activar-body">
          <h3 class="modal-activar-title">Activar servicio</h3>
          <div class="modal-activar-row">
            <label for="input-activar-costo">驴Costo para activar el servicio?</label>
            <input
              id="input-activar-costo"
              class="form-input"
              type="number"
              min="0"
              step="0.01"
              inputmode="decimal"
              placeholder="0.00"
            />
          </div>
          <div class="modal-activar-row">
            <label for="input-activar-proveedor">Proveedor</label>
            <div class="modal-activar-prov">
              <div class="input-wrap">
                <input
                  id="input-activar-proveedor"
                  class="form-input"
                  type="search"
                  placeholder="Buscar proveedor por nombre"
                  autocomplete="off"
                />
                <div id="activar-prov-sugerencias" class="modal-activar-sugerencias hidden"></div>
              </div>
              <button type="button" id="btn-activar-add-proveedor" class="btn-outline" title="Registrar proveedor">+</button>
            </div>
          </div>
          <p id="activar-modal-status" class="status"></p>
          <div class="modal-activar-actions">
            <button type="button" id="btn-activar-cancelar" class="btn-outline">Cancelar</button>
            <button type="button" id="btn-activar-entregar" class="btn-primary">Entregar servicio</button>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import { supabase, loadCurrentUser, clearServerSession } from "../../scripts/api.js";
      import { requireSession, attachLogout, attachLogoHome } from "../../scripts/session.js";
      import { formatDDMMYYYY } from "../../scripts/date-format.js";
      import { buildNotificationPayload } from "../../scripts/notification-templates.js";
      import { buildServiceCopyText } from "../../scripts/copy-format.js";
      import { copyTextNotify } from "../../scripts/copy-toast.js";

      requireSession();
      attachLogoHome();
      attachLogout(clearServerSession);

      const statusEl = document.querySelector("#pp-status");
      const tablasEl = document.querySelector("#pp-tablas");
      const modalActivarEl = document.querySelector("#modal-activar-servicio");
      const modalActivarCloseBtn = document.querySelector("#modal-activar-close");
      const modalActivarCancelarBtn = document.querySelector("#btn-activar-cancelar");
      const modalActivarEntregarBtn = document.querySelector("#btn-activar-entregar");
      const modalActivarCostoInput = document.querySelector("#input-activar-costo");
      const modalActivarProveedorInput = document.querySelector("#input-activar-proveedor");
      const modalActivarProvSugs = document.querySelector("#activar-prov-sugerencias");
      const modalActivarAddProveedorBtn = document.querySelector("#btn-activar-add-proveedor");
      const modalActivarStatusEl = document.querySelector("#activar-modal-status");
      const modalActivarTitleEl = document.querySelector(".modal-activar-title");

      let currentUser = null;
      let pendingEntregaBtn = null;
      let proveedorSeleccionadoId = null;
      let proveedoresSugeridos = [];
      let proveedorFetchCounter = 0;
      let reemplazosCache = null;
      let reemplazosCachePromise = null;

      const setStatus = (msg) => {
        if (statusEl) statusEl.textContent = msg || "";
      };
      const setModalStatus = (msg) => {
        if (modalActivarStatusEl) modalActivarStatusEl.textContent = msg || "";
      };
      const isTrue = (v) => v === true || v === 1 || v === "1" || v === "true" || v === "t";
      const hasPerfilId = (val) => Number.isFinite(Number(val)) && Number(val) > 0;
      const toPositiveId = (value) => {
        const parsed = Number(value);
        if (!Number.isFinite(parsed) || parsed <= 0) return null;
        return Math.trunc(parsed);
      };
      const loadReemplazosBloqueados = async (force = false) => {
        if (force) {
          reemplazosCache = null;
          reemplazosCachePromise = null;
        }
        if (reemplazosCache) return { data: reemplazosCache };
        if (!reemplazosCachePromise) {
          reemplazosCachePromise = supabase
            .from("reemplazos")
            .select("id_cuenta, id_perfil")
            .then(({ data, error }) => {
              if (error) throw error;
              const cuentas = new Set();
              const perfiles = new Set();
              (data || []).forEach((row) => {
                const cuentaId = toPositiveId(row?.id_cuenta);
                const perfilId = toPositiveId(row?.id_perfil);
                if (cuentaId) cuentas.add(cuentaId);
                if (perfilId) perfiles.add(perfilId);
              });
              reemplazosCache = { cuentas, perfiles };
              return reemplazosCache;
            })
            .finally(() => {
              reemplazosCachePromise = null;
            });
        }
        try {
          const data = await reemplazosCachePromise;
          return { data };
        } catch (error) {
          return { error };
        }
      };
      const getVenezuelaToday = () => {
        const veDate = new Date().toLocaleDateString("en-CA", {
          timeZone: "America/Caracas",
        });
        const [y, m, d] = String(veDate).split("-").map(Number);
        if (!y || !m || !d) return new Date();
        return new Date(y, m - 1, d);
      };
      const addMonthsKeepDay = (baseDate, months) => {
        const d = new Date(baseDate.getFullYear(), baseDate.getMonth(), 1);
        const day = baseDate.getDate();
        d.setMonth(d.getMonth() + months);
        const lastDay = new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate();
        d.setDate(Math.min(day, lastDay));
        return d;
      };
      const toYMD = (date) => {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, "0");
        const d = String(date.getDate()).padStart(2, "0");
        return `${y}-${m}-${d}`;
      };

      const hideProvSuggestions = () => {
        if (!modalActivarProvSugs) return;
        modalActivarProvSugs.classList.add("hidden");
      };

      const renderProvSuggestions = (items, forceHide = false) => {
        if (!modalActivarProvSugs) return;
        if (forceHide || !items.length) {
          modalActivarProvSugs.innerHTML = "";
          hideProvSuggestions();
          return;
        }
        modalActivarProvSugs.innerHTML = items
          .map(
            (p) => `
              <button type="button" data-id="${p.id_proveedor}" data-nombre="${p.nombre || ""}">
                ${p.nombre || ""}
              </button>
            `
          )
          .join("");
        modalActivarProvSugs.classList.remove("hidden");
      };

      const buscarProveedoresActivacion = async (texto, hide = false) => {
        const term = (texto || "").trim();
        if (!term) {
          proveedoresSugeridos = [];
          renderProvSuggestions([], true);
          return;
        }
        const current = ++proveedorFetchCounter;
        try {
          const { data, error } = await supabase
            .from("proveedores")
            .select("id_proveedor, nombre")
            .ilike("nombre", `%${term}%`)
            .order("nombre", { ascending: true })
            .limit(6);
          if (current !== proveedorFetchCounter) return;
          if (error) throw error;
          proveedoresSugeridos = data || [];
          renderProvSuggestions(proveedoresSugeridos, hide);
        } catch (err) {
          console.error("buscar proveedores activacion error", err);
          proveedoresSugeridos = [];
          renderProvSuggestions([], true);
        }
      };

      const openModalActivacion = (btn) => {
        pendingEntregaBtn = btn || null;
        proveedorSeleccionadoId = null;
        proveedoresSugeridos = [];
        setModalStatus("");
        if (modalActivarCostoInput) modalActivarCostoInput.value = "";
        if (modalActivarProveedorInput) modalActivarProveedorInput.value = "";
        renderProvSuggestions([], true);
        if (modalActivarTitleEl) {
          const plat = btn?.dataset?.plataforma || "servicio";
          modalActivarTitleEl.textContent = `Activar servicio (${plat})`;
        }
        modalActivarEl?.classList.remove("hidden");
        document.body.classList.add("modal-open");
        modalActivarCostoInput?.focus();
      };

      const closeModalActivacion = () => {
        modalActivarEl?.classList.add("hidden");
        document.body.classList.remove("modal-open");
        pendingEntregaBtn = null;
        proveedorSeleccionadoId = null;
        setModalStatus("");
        renderProvSuggestions([], true);
      };

      const requiereModalActivacion = (btn) => {
        if (!btn) return false;
        const correoCliente = isTrue(btn.dataset.correoCliente);
        const ligadoPerfil = hasPerfilId(btn.dataset.idPerfil);
        return correoCliente && !ligadoPerfil;
      };

      const renderSection = (title, grouped) => {
        const entries = Object.entries(grouped);
        if (!entries.length) return "";
        const content = entries
          .map(([_, payload]) => {
            const headerStyle = payload.color_1 ? ` style="--table-header-bg:${payload.color_1};"` : "";
            const isEntregaInmediata = payload.entrega_inmediata === true;
            const showClave = payload.clave_cliente === true;
            const showTipo = String(payload.id_plataforma || "") === "9";
            const groups = Object.values(payload.groups || {});
            const tablesHtml = groups
              .map((group) => {
                const rows = group.rows || [];
                const madre = group.cuenta_info || {};
                const usesMother = payload.cuenta_madre && !!group.cuenta_info;
                const madreBlock = usesMother
                  ? `
                    <div class="madre-bar">
                      ${madre.region ? `<p class="madre-region">${madre.region}</p>` : ""}
                      <p><strong>Cuenta madre:</strong> <span class="copyable" data-clipboard="${madre.correo || ""}">${madre.correo || "-"}</span></p>
                      <p><strong>Clave:</strong> <span class="copyable" data-clipboard="${madre.clave || ""}">${madre.clave || "-"}</span></p>
                      <p><strong>Link:</strong> ${
                        madre.link
                          ? `<a href="${madre.link}" target="_blank" rel="noopener noreferrer">${madre.link}</a>`
                          : "-"
                      }</p>
                      <p><strong>Direcci贸n:</strong> <span class="copyable" data-clipboard="${madre.direccion || ""}">${madre.direccion || "-"}</span></p>
                    </div>
                  `
                  : "";
                const body = rows
                  .map((r) => {
                    const isSpotify = String(r.id_plataforma || "") === "9";
                    const cuentaNuevaRaw = r.cuenta_nueva;
                    const cuentaNueva =
                      cuentaNuevaRaw === true ||
                      cuentaNuevaRaw === "true" ||
                      cuentaNuevaRaw === 1 ||
                      cuentaNuevaRaw === "1";
                    const tipoCell = showTipo
                      ? cuentaNuevaRaw == null
                        ? `<td></td>`
                        : `<td class="tipo-cell ${cuentaNueva ? "tipo-nueva" : "tipo-existe"}">${
                            cuentaNueva ? "Cuenta Nueva" : "Ya existe"
                          }</td>`
                      : "";
                    const correoText = r.correo || "-";
                    const correoCell = isSpotify
                      ? `
                           <td>
                             <div class="correo-edit-wrap" data-venta="${r.id_venta}" data-correo="${correoText}">
                               <span class="copyable correo-text" data-clipboard="${correoText}">${correoText}</span>
                               <button type="button" class="btn-outline btn-edit-correo" title="Editar">锔</button>
                             </div>
                           </td>`
                      : `<td class="copyable" data-clipboard="${correoText}">${correoText}</td>`;
                    return `
                  <tr>
                    <td>#${String(r.id_venta).padStart(4, "0")}</td>
                    <td>${r.cliente || "-"}</td>
                    ${
                      isEntregaInmediata
                        ? `<td>${r.fecha_pago || "-"}</td>`
                        : `<td>${r.servicio || "-"}</td>
                           ${tipoCell}
                           ${correoCell}
                           ${showClave ? `<td class="copyable" data-clipboard="${r.clave || ""}">${r.clave || "-"}</td>` : ""}`
                    }
                    ${isEntregaInmediata ? `<td>${r.servicio || "-"}</td>${tipoCell}` : ""}
                    <td>${r.fecha_pago ? formatDDMMYYYY(r.fecha_pago) : "-"}</td>
                    <td>
                      <button class="btn-primary btn-entregar" title="Entregar servicio" aria-label="Entregar servicio" data-venta="${r.id_venta}" data-usuario="${r.id_usuario || ""}" data-plataforma="${r.plataforma || ""}" data-id-plataforma="${r.id_plataforma || ""}" data-correo="${r.correo || ""}" data-clave="${r.clave || ""}" data-fecha="${r.fecha_corte || ""}" data-perfil="${r.perfil || ""}" data-nperfil="${r.n_perfil || ""}" data-poracceso="${r.por_acceso ? "true" : "false"}" data-usapines="${r.usa_pines ? "true" : "false"}" data-cuenta-madre="${r.cuenta_madre ? "true" : "false"}" data-completa="${r.completa ? "true" : "false"}" data-meses="${r.meses_contratados || ""}" data-id-cuenta="${r.id_cuenta || ""}" data-id-perfil="${r.id_perfil || ""}" data-id-cuenta-miembro="${r.id_cuenta_miembro || ""}" data-reportado="${r.reportado ? "true" : "false"}" data-correo-cliente="${payload.correo_cliente ? "true" : "false"}"></button>
                      <button class="btn-outline btn-alert" title="Acci贸n" aria-label="Acci贸n" data-venta="${r.id_venta}">!</button>
                      ${
                        r.cuenta_madre
                          ? `<button class="btn-outline btn-cambiar-madre" data-venta="${r.id_venta}" data-id-plataforma="${r.id_plataforma || ""}" data-id-cuenta="${r.id_cuenta || ""}" data-id-perfil="${r.id_perfil || ""}" data-id-cuenta-miembro="${r.id_cuenta_miembro || ""}">Cambiar cuenta madre</button>`
                          : ""
                      }
                    </td>
                  </tr>
                `
                  })
                  .join("");
                return `
                  ${madreBlock}
                  ${
                    usesMother
                      ? `<p class="status madre-stock-msg hidden" data-plat="${payload.id_plataforma || ""}">Sin stock de cuentas madres</p>`
                      : ""
                  }
                  <div class="cuenta-table-wrap">
                    <table class="table-base">
                      <thead>
                        <tr>
                          ${
                            isEntregaInmediata
                              ? `<th>Venta</th>
                                 <th>Cliente</th>
                                 <th>Fecha de pago</th>
                                 <th>Servicio solicitado</th>
                                 ${showTipo ? "<th>Tipo</th>" : ""}
                                 <th>Fecha de pedido</th>
                                 <th>Acci贸n</th>`
                              : `<th>ID venta</th>
                                 <th>Cliente</th>
                                 <th>Servicio solicitado</th>
                                 ${showTipo ? "<th>Tipo</th>" : ""}
                                 <th>Correo</th>
                                 ${showClave ? "<th>Clave</th>" : ""}
                                 <th>Fecha de pedido</th>
                                 <th>Acci贸n</th>`
                          }
                        </tr>
                      </thead>
                      <tbody>${body}</tbody>
                    </table>
                  </div>
                `;
              })
              .join("");
            return `
              <div class="proximas-bloque"${headerStyle}>
                <h3 class="proximas-title">${payload.nombre}</h3>
                ${tablesHtml}
              </div>
            `;
          })
          .join("");
        return `
          <div class="proximas-bloque">
            <h3 class="proximas-title">${title}</h3>
            ${content}
          </div>
        `;
      };

      const render = (grouped) => {
        if (!tablasEl) return;
        const entries = Object.entries(grouped);
        if (!entries.length) {
          setStatus("No hay pedidos pendientes.");
          tablasEl.innerHTML = "";
          return;
        }
        setStatus("");
        const groupedCompletas = {};
        const groupedIndividuales = {};
        entries.forEach(([platId, payload]) => {
          const groupsEntries = Object.entries(payload.groups || {});
          if (!groupsEntries.length) return;
          let hasCompletas = false;
          let hasIndividuales = false;
          const groupsCompletas = {};
          const groupsIndividuales = {};
          groupsEntries.forEach(([key, group]) => {
            const rows = group.rows || [];
            const rowsCompletas = rows.filter((r) => r.completa);
            const rowsInd = rows.filter((r) => !r.completa);
            if (rowsCompletas.length) {
              hasCompletas = true;
              groupsCompletas[key] = { ...group, rows: rowsCompletas };
            }
            if (rowsInd.length) {
              hasIndividuales = true;
              groupsIndividuales[key] = { ...group, rows: rowsInd };
            }
          });
          if (hasCompletas) {
            groupedCompletas[platId] = { ...payload, groups: groupsCompletas };
          }
          if (hasIndividuales) {
            groupedIndividuales[platId] = { ...payload, groups: groupsIndividuales };
          }
        });
        const sectionCompletas = renderSection("Cuentas completas", groupedCompletas);
        const sectionIndividuales = renderSection("Cuentas individuales", groupedIndividuales);
        tablasEl.innerHTML = [sectionCompletas, sectionIndividuales].filter(Boolean).join("");
      };

      const loadPendientes = async () => {
        try {
          const user = await loadCurrentUser();
          currentUser = user || null;
          if (!user) {
            setStatus("Usuario no autenticado.");
            return;
          }
            const { data: ventas, error } = await supabase
              .from("ventas")
              .select(
              "id_venta, id_usuario, id_precio, id_cuenta, id_cuenta_miembro, id_perfil, fecha_pago, fecha_corte, meses_contratados, pendiente, completa, reportado, cuenta_nueva, correo_miembro, clave_miembro, precios:precios(id_plataforma, plan), cuentas:cuentas!ventas_id_cuenta_fkey(id_plataforma, correo, clave, link_codigo, direccion, region), perfiles:perfiles(n_perfil)"
              )
            .eq("pendiente", true)
            .order("id_venta", { ascending: false });
          if (error) throw error;

          if (!ventas?.length) {
            render({});
            return;
          }

          const precioIds = [...new Set(ventas.map((v) => v.id_precio).filter(Boolean))];
          const userIds = [...new Set(ventas.map((v) => v.id_usuario).filter(Boolean))];

          let precioMap = {};
          if (precioIds.length) {
            const { data: precios, error: pErr } = await supabase
              .from("precios")
              .select("id_precio, id_plataforma, plan")
              .in("id_precio", precioIds);
            if (pErr) throw pErr;
            precioMap = (precios || []).reduce((acc, p) => {
              acc[p.id_precio] = p;
              return acc;
            }, {});
          }

          let userMap = {};
          if (userIds.length) {
            const { data: usuarios, error: uErr } = await supabase
              .from("usuarios")
              .select("id_usuario, nombre, apellido")
              .in("id_usuario", userIds);
            if (uErr) throw uErr;
            userMap = (usuarios || []).reduce((acc, u) => {
              const full = [u.nombre, u.apellido].filter(Boolean).join(" ").trim();
              acc[u.id_usuario] = full || `Usuario ${u.id_usuario}`;
              return acc;
            }, {});
          }

          let platMap = {};
          const platIds = [
            ...new Set(
              ventas
                .map((v) => v.precios?.id_plataforma || v.cuentas?.id_plataforma || precioMap[v.id_precio]?.id_plataforma)
                .filter(Boolean)
            ),
          ];
          if (platIds.length) {
            const { data: plats, error: platErr } = await supabase
              .from("plataformas")
              .select("id_plataforma, nombre, color_1, entrega_inmediata, correo_cliente, clave_cliente, cuenta_madre, por_acceso, usa_pines")
              .in("id_plataforma", platIds);
            if (platErr) throw platErr;
            platMap = (plats || []).reduce((acc, p) => {
              acc[p.id_plataforma] = p;
              return acc;
            }, {});
          }

          const grouped = {};
          (ventas || []).forEach((v) => {
            const precio = precioMap[v.id_precio] || v.precios || {};
            const platId = precio.id_plataforma || v.cuentas?.id_plataforma;
            const platInfo = platMap[platId] || {};
            const platName =
              platInfo.nombre || `Plataforma ${platId || "-"}`;
            const cliente = userMap[v.id_usuario] || "-";
            const servicio = precio.plan ? `${platName} - ${precio.plan}` : platName;
            const isCompleta =
              v.completa === true || v.completa === "true" || v.completa === 1 || v.completa === "1";
            if (!grouped[platId])
              grouped[platId] = {
                id_plataforma: platId,
                nombre: platName,
                entrega_inmediata:
                  platInfo.entrega_inmediata === true ||
                  platInfo.entrega_inmediata === "true" ||
                  platInfo.entrega_inmediata === "1",
                correo_cliente:
                  platInfo.correo_cliente === true ||
                  platInfo.correo_cliente === "true" ||
                  platInfo.correo_cliente === "1",
                clave_cliente:
                  platInfo.clave_cliente === true ||
                  platInfo.clave_cliente === "true" ||
                  platInfo.clave_cliente === "1",
                cuenta_madre:
                  platInfo.cuenta_madre === true ||
                  platInfo.cuenta_madre === "true" ||
                  platInfo.cuenta_madre === "1",
                por_acceso:
                  platInfo.por_acceso === true ||
                  platInfo.por_acceso === "true" ||
                  platInfo.por_acceso === "1",
                usa_pines:
                  platInfo.usa_pines === true ||
                  platInfo.usa_pines === "true" ||
                  platInfo.usa_pines === "1",
                groups: {},
                color_1: platInfo.color_1 || null,
              };
            const motherId = isCompleta ? "sin-madre" : v.id_cuenta || "sin-madre";
            if (!grouped[platId].groups[motherId]) {
              grouped[platId].groups[motherId] = {
                cuenta_info: !isCompleta && v.cuentas
                  ? {
                      correo: v.cuentas?.correo || "",
                      clave: v.cuentas?.clave || "",
                      link: v.cuentas?.link_codigo || "",
                      direccion: v.cuentas?.direccion || "",
                      region: v.cuentas?.region || "",
                    }
                  : null,
                rows: [],
              };
            }
            grouped[platId].groups[motherId].rows.push({
              id_venta: v.id_venta,
              cliente,
              id_usuario: v.id_usuario,
              fecha_pago: v.fecha_pago || "-",
              servicio,
              cuenta_nueva: v.cuenta_nueva,
              correo: v.correo_miembro || "-",
              clave: v.clave_miembro || "-",
              plataforma: platName,
              fecha_corte: v.fecha_corte || "",
              perfil: v.perfiles?.n_perfil ? `M${v.perfiles.n_perfil}` : "",
              n_perfil: v.perfiles?.n_perfil || null,
              id_plataforma: platId,
              cuenta_madre: grouped[platId].cuenta_madre && !isCompleta,
              completa: isCompleta,
              por_acceso: grouped[platId].por_acceso,
              usa_pines: grouped[platId].usa_pines,
              meses_contratados: v.meses_contratados || 1,
              id_cuenta: v.id_cuenta || null,
              id_perfil: v.id_perfil || null,
              reportado: v.reportado === true,
            });
          });

          render(grouped);
        } catch (err) {
          console.error("pedidos pendientes error", err);
          setStatus("No se pudieron cargar los pedidos.");
        }
      };

      const handleEntregarServicio = async (btn, activationData = null) => {
        const idVenta = btn?.dataset?.venta;
        const idUsuario = btn?.dataset?.usuario;
        const plataforma = btn?.dataset?.plataforma || "";
        const idPlataforma = btn?.dataset?.idPlataforma || "";
        const correoCuenta = btn?.dataset?.correo || "";
        const claveCuenta = btn?.dataset?.clave || "";
        const fechaCorteRaw = (btn?.dataset?.fecha || "").trim();
        const fechaCorte = fechaCorteRaw || "Pendiente";
        const ventaSinFechaCorte = !fechaCorteRaw;
        const perfil = btn?.dataset?.perfil || "";
        const nPerfil = btn?.dataset?.nperfil || "";
        const porAcceso = btn?.dataset?.poracceso === "true";
        const usaPines = btn?.dataset?.usapines === "true";
        const existingMadreId = btn?.dataset?.idCuenta || "";
        const existingPerfilId = btn?.dataset?.idPerfil || "";
        const isCompleta = btn?.dataset?.completa === "true";
        const cuentaMadreFlag = btn?.dataset?.cuentaMadre === "true" && !isCompleta;
        const mesesContratados = Number(btn?.dataset?.meses || 1);
        const isReportado = btn?.dataset?.reportado === "true";
        const costoActivacion = Number(activationData?.costo);
        const proveedorId = Number(activationData?.idProveedor);
        const idPlataformaNum = Number(idPlataforma);
        const hasIdPlataforma = Number.isFinite(idPlataformaNum) && idPlataformaNum > 0;
        const requireMadreActiva = idPlataformaNum === 9;
        const { data: reemplazosBloqueados, error: replErr } = await loadReemplazosBloqueados();
        if (replErr) throw replErr;

        if (!idVenta) return;
        if (!correoCuenta) {
          alert("Falta el correo del cliente.");
          return;
        }

        let nuevaCuentaId = null;
        const { data: cuentaExist, error: existErr } = await supabase
          .from("cuentas")
          .select("id_cuenta, clave")
          .eq("correo", correoCuenta)
          .order("id_cuenta", { ascending: true })
          .limit(1)
          .maybeSingle();
        if (existErr) throw existErr;
        if (cuentaExist?.id_cuenta) {
          const updateCuenta = {
            inactiva: false,
            ocupado: false,
            venta_dominio: true,
            dominio_de: idUsuario ? Number(idUsuario) : null,
            id_plataforma: hasIdPlataforma ? idPlataformaNum : null,
          };
          if (Number.isFinite(proveedorId) && proveedorId > 0) {
            updateCuenta.id_proveedor = proveedorId;
          }
          if (claveCuenta && claveCuenta !== (cuentaExist.clave || "")) {
            updateCuenta.clave = claveCuenta;
          }
          const { error: updCuentaErr } = await supabase
            .from("cuentas")
            .update(updateCuenta)
            .eq("id_cuenta", cuentaExist.id_cuenta);
          if (updCuentaErr) throw updCuentaErr;
          nuevaCuentaId = cuentaExist.id_cuenta;
        } else {
          const insertCuenta = {
            correo: correoCuenta,
            clave: claveCuenta || null,
            inactiva: false,
            ocupado: false,
            venta_dominio: true,
            dominio_de: idUsuario ? Number(idUsuario) : null,
            id_plataforma: hasIdPlataforma ? idPlataformaNum : null,
            id_proveedor: Number.isFinite(proveedorId) && proveedorId > 0 ? proveedorId : null,
          };
          const { data: cuentaNueva, error: cuentaErr } = await supabase
            .from("cuentas")
            .insert(insertCuenta)
            .select("id_cuenta")
            .single();
          if (cuentaErr) throw cuentaErr;
          nuevaCuentaId = cuentaNueva?.id_cuenta || null;
        }
        if (!nuevaCuentaId) throw new Error("No se pudo crear la cuenta.");

        let cuentaMadreId = null;
        let perfilId = null;
        if (cuentaMadreFlag && hasIdPlataforma) {
          if (existingMadreId && existingPerfilId) {
            let canUseExistingMadre = true;
            if (requireMadreActiva) {
              const { data: madreActual, error: madreActualErr } = await supabase
                .from("cuentas")
                .select("id_cuenta, inactiva")
                .eq("id_cuenta", Number(existingMadreId))
                .eq("id_plataforma", idPlataformaNum)
                .eq("cuenta_madre", true)
                .maybeSingle();
              if (madreActualErr) throw madreActualErr;
              canUseExistingMadre = Boolean(madreActual) && !isTrue(madreActual.inactiva);
            }
            if (canUseExistingMadre) {
              const madreIdNum = toPositiveId(existingMadreId);
              const perfilIdNum = toPositiveId(existingPerfilId);
              const madreEnReemplazo =
                !madreIdNum || reemplazosBloqueados.cuentas.has(madreIdNum);
              const perfilEnReemplazo =
                !perfilIdNum || reemplazosBloqueados.perfiles.has(perfilIdNum);
              if (!madreEnReemplazo && !perfilEnReemplazo) {
                cuentaMadreId = madreIdNum;
                perfilId = perfilIdNum;
              }
            }
          }
          if (!cuentaMadreId || !perfilId) {
            let madreQuery = supabase
              .from("cuentas")
              .select("id_cuenta")
              .eq("id_plataforma", idPlataformaNum)
              .eq("cuenta_madre", true);
            if (requireMadreActiva) {
              madreQuery = madreQuery.or("inactiva.is.null,inactiva.eq.false");
            }
            const { data: madres, error: madreErr } = await madreQuery
              .order("id_cuenta", { ascending: true })
              .limit(120);
            if (madreErr) throw madreErr;
            const madresDisponibles = (madres || []).filter((madre) => {
              const madreId = toPositiveId(madre?.id_cuenta);
              return !!madreId && !reemplazosBloqueados.cuentas.has(madreId);
            });
            for (const madre of madresDisponibles) {
              const madreId = toPositiveId(madre?.id_cuenta);
              if (!madreId) continue;
              const { data: perfilesMadre, error: perfErr } = await supabase
                .from("perfiles")
                .select("id_perfil")
                .eq("id_cuenta", madreId)
                .eq("ocupado", false)
                .order("n_perfil", { ascending: true })
                .limit(40);
              if (perfErr) throw perfErr;
              const perfilLibre = (perfilesMadre || []).find((perfil) => {
                const pid = toPositiveId(perfil?.id_perfil);
                return !!pid && !reemplazosBloqueados.perfiles.has(pid);
              });
              if (perfilLibre?.id_perfil) {
                cuentaMadreId = madreId;
                perfilId = perfilLibre.id_perfil;
                break;
              }
            }
            if (!perfilId) {
              const msg = document.querySelector(`.madre-stock-msg[data-plat="${idPlataforma}"]`);
              if (msg) msg.classList.remove("hidden");
            } else {
              const { error: occErr } = await supabase
                .from("perfiles")
                .update({ ocupado: true, id_cuenta_miembro: nuevaCuentaId })
                .eq("id_perfil", perfilId);
              if (occErr) throw occErr;
            }
          }
        }
        if (cuentaMadreId) {
          const { error: linkErr } = await supabase
            .from("cuentas")
            .update({ id_cuenta_madre: cuentaMadreId })
            .eq("id_cuenta", nuevaCuentaId);
          if (linkErr) throw linkErr;
        }

        const base = getVenezuelaToday();
        const next = addMonthsKeepDay(base, Number.isFinite(mesesContratados) ? mesesContratados : 1);
        const nextIso = toYMD(next);
        const updateVenta = {
          pendiente: false,
          id_cuenta: cuentaMadreId || null,
          id_cuenta_miembro: nuevaCuentaId,
          id_perfil: perfilId || null,
          cuenta_nueva: false,
        };
        if (ventaSinFechaCorte || !isReportado) {
          updateVenta.fecha_corte = nextIso;
        }
        const { error: updErr } = await supabase.from("ventas").update(updateVenta).eq("id_venta", idVenta);
        if (updErr) throw updErr;

        if (Number.isFinite(costoActivacion) && costoActivacion >= 0 && Number.isFinite(proveedorId) && proveedorId > 0) {
          const { error: histErr } = await supabase.from("historial_ventas").insert({
            id_usuario_cliente: idUsuario ? Number(idUsuario) : null,
            id_proveedor: proveedorId,
            monto: costoActivacion,
            fecha_pago: new Date().toISOString().slice(0, 10),
            venta_cliente: false,
            renovacion: false,
            id_venta: Number(idVenta),
            id_plataforma: hasIdPlataforma ? idPlataformaNum : null,
            id_cuenta: nuevaCuentaId,
            registrado_por: currentUser?.id_usuario || null,
          });
          if (histErr) throw histErr;
        }

        if (idUsuario) {
          const notif = buildNotificationPayload("nuevo_servicio", {
            plataforma,
            correoCuenta,
            perfil,
            fechaCorte,
          });
          const { error: nErr } = await supabase
            .from("notificaciones")
            .insert({ ...notif, id_usuario: Number(idUsuario) });
          if (nErr) throw nErr;
        }

        const status = document.createElement("span");
        status.className = "badge badge-green";
        status.textContent = "Servicio entregado";
        const copyBtn = document.createElement("button");
        copyBtn.type = "button";
        copyBtn.className = "btn-outline btn-copy-row";
        copyBtn.textContent = "Copiar";
        let copyCorreo = correoCuenta || "";
        let copyClave = claveCuenta || "";
        let copyPerfil = nPerfil || "";
        let copyPin = "";
        let copyFecha = nextIso;
        let copyPlatId = idPlataforma ? Number(idPlataforma) : null;
        let copyVentaPerfil = false;
        let copyVentaMiembro = false;
        let copyPerfilHogar = false;

        try {
          const { data: ventaInfo, error: vErr } = await supabase
            .from("ventas")
            .select(
              "id_venta, fecha_corte, correo_miembro, clave_miembro, id_cuenta, id_cuenta_miembro, id_perfil, cuentas:cuentas!ventas_id_cuenta_fkey(correo, clave, id_plataforma, venta_perfil, venta_miembro), cuentas_miembro:cuentas!ventas_id_cuenta_miembro_fkey(correo, clave, venta_perfil, venta_miembro), perfiles:perfiles(id_perfil, n_perfil, pin, perfil_hogar)",
            )
            .eq("id_venta", idVenta)
            .maybeSingle();
          if (vErr) throw vErr;
          if (ventaInfo) {
            copyCorreo =
              ventaInfo.correo_miembro ||
              ventaInfo.cuentas_miembro?.correo ||
              ventaInfo.cuentas?.correo ||
              copyCorreo;
            copyClave =
              ventaInfo.clave_miembro ||
              ventaInfo.cuentas_miembro?.clave ||
              ventaInfo.cuentas?.clave ||
              copyClave;
            copyPerfil = ventaInfo.perfiles?.n_perfil ?? copyPerfil ?? "";
            copyPin = ventaInfo.perfiles?.pin || "";
            copyPerfilHogar = ventaInfo.perfiles?.perfil_hogar === true;
            copyFecha = ventaInfo.fecha_corte || copyFecha;
            copyPlatId = ventaInfo.cuentas?.id_plataforma || copyPlatId;
            if (!isCompleta) {
              copyVentaPerfil =
                ventaInfo.cuentas?.venta_perfil ??
                ventaInfo.cuentas_miembro?.venta_perfil ??
                false;
              copyVentaMiembro =
                ventaInfo.cuentas?.venta_miembro ??
                ventaInfo.cuentas_miembro?.venta_miembro ??
                false;
            }
          }
        } catch (err) {
          console.warn("venta info para copiar no disponible", err);
        }

        const perfilNum = Number(copyPerfil);
        const copyText = buildServiceCopyText({
          plataforma,
          idVenta: idVenta || null,
          correo: copyCorreo,
          clave: copyClave,
          nPerfil: Number.isFinite(perfilNum) ? perfilNum : copyPerfil || null,
          pin: copyPin,
          fechaCorte: copyFecha,
          porAcceso,
          usaPines,
          ventaPerfil: copyVentaPerfil,
          ventaMiembro: copyVentaMiembro,
          idPlataforma: copyPlatId,
          perfilHogar: copyPerfilHogar,
          isSubCuenta: false,
        });
        copyBtn.dataset.copy = encodeURIComponent(copyText);
        btn.parentElement?.appendChild(status);
        btn.parentElement?.appendChild(copyBtn);
        btn.remove();
      };

      tablasEl?.addEventListener("click", async (e) => {
        const editBtn = e.target.closest(".btn-edit-correo");
        if (editBtn) {
          const wrap = editBtn.closest(".correo-edit-wrap");
          if (!wrap) return;
          const textEl = wrap.querySelector(".correo-text");
          if (!textEl) return;
          const current = textEl.textContent || "";
          editBtn.classList.add("hidden");
          textEl.classList.add("hidden");
          const input = document.createElement("input");
          input.type = "text";
          input.value = current === "-" ? "" : current;
          input.className = "input-text correo-edit-input";
          const saveBtn = document.createElement("button");
          saveBtn.type = "button";
          saveBtn.className = "btn-outline btn-save-correo";
          saveBtn.title = "Guardar";
          saveBtn.textContent = "";
          wrap.appendChild(input);
          wrap.appendChild(saveBtn);
          input.focus();
          return;
        }
        const saveBtn = e.target.closest(".btn-save-correo");
        if (saveBtn) {
          const wrap = saveBtn.closest(".correo-edit-wrap");
          if (!wrap) return;
          const input = wrap.querySelector(".correo-edit-input");
          const textEl = wrap.querySelector(".correo-text");
          const editBtn = wrap.querySelector(".btn-edit-correo");
          const idVenta = wrap.dataset.venta;
          const nextVal = (input?.value || "").trim();
          if (!idVenta || !nextVal) {
            alert("Ingresa un correo v谩lido.");
            return;
          }
          try {
            const { error: updErr } = await supabase
              .from("ventas")
              .update({ correo_miembro: nextVal })
              .eq("id_venta", idVenta);
            if (updErr) throw updErr;
            if (textEl) {
              textEl.textContent = nextVal;
              textEl.dataset.clipboard = nextVal;
              textEl.classList.remove("hidden");
            }
            if (editBtn) editBtn.classList.remove("hidden");
            wrap.dataset.correo = nextVal;
            input?.remove();
            saveBtn.remove();
            const row = wrap.closest("tr");
            const entregarBtn = row?.querySelector(".btn-entregar");
            if (entregarBtn) entregarBtn.dataset.correo = nextVal;
          } catch (err) {
            console.error("guardar correo_miembro error", err);
            alert("No se pudo guardar el correo.");
          }
          return;
        }
        const btn = e.target.closest(".btn-entregar");
        if (!btn) return;
        try {
          if (requiereModalActivacion(btn)) {
            openModalActivacion(btn);
            return;
          }
          await handleEntregarServicio(btn);
        } catch (err) {
          console.error("entregar servicio error", err);
          alert("No se pudo entregar el servicio.");
        }
      });
      tablasEl?.addEventListener("click", async (e) => {
        const btn = e.target.closest(".btn-cambiar-madre");
        if (!btn) return;
        const idVenta = btn.dataset.venta;
        const idPlataforma = Number(btn.dataset.idPlataforma || "");
        const currentMadreId = Number(btn.dataset.idCuenta || "");
        const currentPerfilId = Number(btn.dataset.idPerfil || "");
        const cuentaMiembroId = Number(btn.dataset.idCuentaMiembro || "");
        if (!idVenta || !idPlataforma || !currentMadreId || !cuentaMiembroId) return;
        try {
          const { data: reemplazosBloqueados, error: replErr } =
            await loadReemplazosBloqueados(true);
          if (replErr) throw replErr;
          const { data: nextMadres, error: madreErr } = await supabase
            .from("cuentas")
            .select("id_cuenta")
            .eq("id_plataforma", idPlataforma)
            .eq("cuenta_madre", true)
            .or("inactiva.is.null,inactiva.eq.false")
            .gt("id_cuenta", currentMadreId)
            .order("id_cuenta", { ascending: true })
            .limit(120);
          if (madreErr) throw madreErr;
          let nextMadreId = null;
          let nextPerfilId = null;
          const madresDisponibles = (nextMadres || []).filter((madre) => {
            const madreId = toPositiveId(madre?.id_cuenta);
            return !!madreId && !reemplazosBloqueados.cuentas.has(madreId);
          });
          for (const madre of madresDisponibles) {
            const madreId = toPositiveId(madre?.id_cuenta);
            if (!madreId) continue;
            const { data: perfilesMadre, error: perfErr } = await supabase
              .from("perfiles")
              .select("id_perfil")
              .eq("id_cuenta", madreId)
              .eq("ocupado", false)
              .order("n_perfil", { ascending: true })
              .limit(40);
            if (perfErr) throw perfErr;
            const perfilLibre = (perfilesMadre || []).find((perfil) => {
              const pid = toPositiveId(perfil?.id_perfil);
              return !!pid && !reemplazosBloqueados.perfiles.has(pid);
            });
            if (perfilLibre?.id_perfil) {
              nextMadreId = madreId;
              nextPerfilId = perfilLibre.id_perfil;
              break;
            }
          }
          if (!nextMadreId || !nextPerfilId) {
            alert("No hay mas cuentas validas");
            return;
          }

          if (currentPerfilId) {
            const { error: oldPerfErr } = await supabase
              .from("perfiles")
              .update({ ocupado: false, id_cuenta_miembro: null })
              .eq("id_perfil", currentPerfilId);
            if (oldPerfErr) throw oldPerfErr;
          }

          const { error: newPerfErr } = await supabase
            .from("perfiles")
            .update({ ocupado: true, id_cuenta_miembro: cuentaMiembroId })
            .eq("id_perfil", nextPerfilId);
          if (newPerfErr) throw newPerfErr;

          const { error: linkErr } = await supabase
            .from("cuentas")
            .update({ id_cuenta_madre: nextMadreId })
            .eq("id_cuenta", cuentaMiembroId);
          if (linkErr) throw linkErr;

          const { error: ventaErr } = await supabase
            .from("ventas")
            .update({ id_cuenta: nextMadreId, id_perfil: nextPerfilId })
            .eq("id_venta", idVenta);
          if (ventaErr) throw ventaErr;

          btn.dataset.idCuenta = String(nextMadreId);
          btn.dataset.idPerfil = String(nextPerfilId);
          const row = btn.closest("tr");
          const entregarBtn = row?.querySelector(".btn-entregar");
          if (entregarBtn) {
            entregarBtn.dataset.idCuenta = String(nextMadreId);
            entregarBtn.dataset.idPerfil = String(nextPerfilId);
          }
          alert("Cuenta madre actualizada.");
        } catch (err) {
          console.error("cambiar cuenta madre error", err);
          alert("No se pudo cambiar la cuenta madre.");
        }
      });
      tablasEl?.addEventListener("click", async (e) => {
        const copyBtn = e.target.closest(".btn-copy-row");
        if (copyBtn) {
          const text = decodeURIComponent(copyBtn.dataset.copy || "");
          if (!text) return;
          await copyTextNotify(text);
          return;
        }
        const cell = e.target.closest(".copyable");
        if (!cell) return;
        const text = cell.dataset.clipboard || cell.textContent || "";
        if (!text) return;
        await copyTextNotify(text);
      });

      modalActivarCloseBtn?.addEventListener("click", () => {
        closeModalActivacion();
      });
      modalActivarCancelarBtn?.addEventListener("click", () => {
        closeModalActivacion();
      });
      modalActivarEl?.addEventListener("click", (e) => {
        if (e.target.classList.contains("modal-backdrop")) {
          closeModalActivacion();
        }
      });
      modalActivarAddProveedorBtn?.addEventListener("click", (e) => {
        e.preventDefault();
        window.location.href = "registrar_proveedor.html";
      });
      modalActivarProveedorInput?.addEventListener("input", (e) => {
        proveedorSeleccionadoId = null;
        setModalStatus("");
        buscarProveedoresActivacion(e.target.value).catch((err) => {
          console.error("buscar proveedores activacion input error", err);
        });
      });
      modalActivarProveedorInput?.addEventListener("keydown", (e) => {
        if (e.key !== "Enter") return;
        e.preventDefault();
        buscarProveedoresActivacion(modalActivarProveedorInput?.value || "", false).catch((err) => {
          console.error("buscar proveedores activacion enter error", err);
        });
      });
      modalActivarProvSugs?.addEventListener("click", (e) => {
        const btn = e.target.closest("button");
        if (!btn) return;
        proveedorSeleccionadoId = Number(btn.dataset.id || "");
        if (modalActivarProveedorInput) {
          modalActivarProveedorInput.value = btn.dataset.nombre || "";
        }
        setModalStatus("");
        hideProvSuggestions();
      });
      modalActivarEntregarBtn?.addEventListener("click", async () => {
        const btn = pendingEntregaBtn;
        if (!btn) {
          closeModalActivacion();
          return;
        }
        const rawCosto = String(modalActivarCostoInput?.value || "")
          .trim()
          .replace(",", ".");
        const costoVal = Number(rawCosto);
        if (!Number.isFinite(costoVal) || costoVal < 0) {
          setModalStatus("Ingresa un costo valido.");
          return;
        }
        const provText = (modalActivarProveedorInput?.value || "").trim();
        if (!provText) {
          setModalStatus("Selecciona un proveedor.");
          return;
        }
        let provId = Number(proveedorSeleccionadoId);
        if (!Number.isFinite(provId) || provId <= 0) {
          const exact = (proveedoresSugeridos || []).find(
            (p) => (p?.nombre || "").trim().toLowerCase() === provText.toLowerCase()
          );
          if (exact?.id_proveedor) {
            provId = Number(exact.id_proveedor);
          }
        }
        if (!Number.isFinite(provId) || provId <= 0) {
          setModalStatus("Selecciona un proveedor valido de la lista.");
          return;
        }

        const payload = { costo: costoVal, idProveedor: provId };
        closeModalActivacion();
        try {
          await handleEntregarServicio(btn, payload);
        } catch (err) {
          console.error("entregar servicio con activacion error", err);
          alert("No se pudo entregar el servicio.");
        }
      });
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && modalActivarEl && !modalActivarEl.classList.contains("hidden")) {
          closeModalActivacion();
        }
      });
      document.addEventListener("click", (e) => {
        if (!modalActivarProvSugs || !modalActivarProveedorInput) return;
        if (
          modalActivarProvSugs.contains(e.target) ||
          modalActivarProveedorInput.contains(e.target)
        ) {
          return;
        }
        hideProvSuggestions();
      });

      loadPendientes();
    </script>
  </body>
</html>
