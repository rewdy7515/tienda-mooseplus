<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Administrar cuentas</title>
    <link rel="stylesheet" href="../../styles/styles.css" />
    <link rel="stylesheet" href="../../styles/admin_cuentas.css" />
    <style>
      .cuentas-wrapper {
        margin: 16px auto 0;
        width: 95%;
        max-width: none;
      }
      .cuentas-busqueda {
        display: flex;
        flex-direction: column;
        gap: 10px;
        align-items: flex-start;
      }
      .cuentas-busqueda .input-wrap {
        position: relative;
        width: 100%;
      }
      .cuentas-busqueda input {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid #ddd;
        border-radius: 10px;
        font-size: 14px;
        color: #111;
      }
      .cuentas-busqueda button {
        padding: 10px 14px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        background: #111;
        color: #fff;
      }
      .cuentas-busqueda .btn-outline {
        background: #f7f7f7;
        color: #111;
        border: 1px solid #ddd;
      }
      .cuentas-busqueda .btn-outline:hover {
        background: #eee;
      }
      .cuentas-acciones {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }
      .table-base td.action-cell {
        display: flex;
        gap: 6px;
        align-items: center;
        flex-wrap: nowrap;
        white-space: nowrap;
        width: auto;
        height: auto;
        overflow: visible;
      }
      .table-base th.action-cell {
        white-space: nowrap;
        width: auto;
      }
      .cuentas-wrapper .table-base {
        width: max-content;
        min-width: 100%;
      }
      .cuenta-table-wrap {
        overflow-x: auto;
      }
      .sugerencias-cuentas {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 10px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        margin-top: 6px;
        overflow: hidden;
        z-index: 30;
      }
      .sugerencias-cuentas.hidden {
        display: none;
      }
      .sugerencias-cuentas button {
        width: 100%;
        border: none;
        background: transparent;
        text-align: left;
        padding: 10px 12px;
        border-bottom: 1px solid #f0f0f0;
        cursor: pointer;
        color: #111;
      }
      .sugerencias-cuentas button:last-child {
        border-bottom: none;
      }
      .sugerencias-cuentas button:hover {
        background: #f7f7f7;
      }
      .cliente-alert {
        margin-left: 6px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        border: none;
        padding: 0;
        background: #111;
        color: #fff;
        font-size: 12px;
        font-weight: 700;
        cursor: pointer;
      }
      .proveedor-edit-wrap {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        position: relative;
      }
      .proveedor-input-wrap {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        position: relative;
      }
      .proveedor-edit-wrap .proveedor-input-wrap {
        display: none;
      }
      .proveedor-edit-wrap.is-editing .proveedor-input-wrap {
        display: inline-flex;
      }
      .proveedor-edit-wrap.is-editing .btn-edit-proveedor {
        display: none;
      }
      .proveedor-edit-wrap.is-editing .proveedor-text {
        display: none;
      }
      .proveedor-edit-wrap .proveedor-input,
      .proveedor-edit-wrap .proveedor-sugs,
      .proveedor-edit-wrap .btn-save-proveedor,
      .proveedor-edit-wrap .btn-cancel-proveedor {
        display: none;
      }
      .proveedor-edit-wrap.is-editing .proveedor-input,
      .proveedor-edit-wrap.is-editing .btn-save-proveedor,
      .proveedor-edit-wrap.is-editing .btn-cancel-proveedor {
        display: inline-flex;
      }
      .proveedor-edit-wrap.is-editing .proveedor-sugs {
        display: block;
      }
      .cred-copy,
      .pin-copy,
      .codigo-view a {
        cursor: pointer;
      }
      .proveedor-input-wrap.hidden {
        display: none;
      }
      .proveedor-input {
        min-width: 160px;
      }
      .btn-edit-proveedor,
      .btn-save-proveedor,
      .btn-cancel-proveedor {
        background: transparent;
        border: none;
        cursor: pointer;
        font-size: 14px;
      }

      .cuenta-detalle {
        margin: 16px auto 0;
        padding: 12px;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        background: #f9fafb;
        width: 100%;
        box-sizing: border-box;
        display: none;
      }
      .cuenta-platform-title {
        display: inline-block;
        padding: 4px 0;
        border-radius: 0;
        background: transparent;
        font-size: 26px;
        font-weight: 900;
        line-height: 1.2;
        margin: 0 0 6px;
        color: var(--platform-color, #111);
      }
      .cuenta-platform-title.is-clickable {
        cursor: pointer;
      }
      .platform-link-icon {
        display: inline-block;
        margin-left: 6px;
        font-size: 14px;
        vertical-align: middle;
      }
      .cuenta-platform-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
        margin-bottom: 6px;
      }
      .btn-marcar-tarea {
        white-space: nowrap;
      }
      .tareas-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 320px;
        overflow: auto;
        padding-right: 4px;
      }
      .tarea-item {
        display: flex;
        align-items: flex-start;
        gap: 8px;
        font-size: 14px;
      }
      .tarea-item input {
        margin-top: 2px;
      }
      .tareas-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 8px;
      }
      .cuenta-platform-cred {
        font-size: 18px;
        font-weight: 700;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 6px;
        margin: 0 0 12px;
      }
      .cuenta-platform-cred .cuenta-platform-label {
        font-weight: 700;
      }
      .cuenta-platform-cred .cuenta-platform-sep {
        opacity: 0.6;
        margin: 0 4px;
      }

      .cuenta-meta {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        gap: 8px 12px;
        margin-bottom: 12px;
      }

      .cuenta-meta p {
        margin: 0;
        font-size: 14px;
      }

      .cuenta-title {
        margin: 0 0 8px;
      }
      .cuenta-table-wrap {
        overflow-x: auto;
        overflow-y: hidden;
        scrollbar-gutter: stable;
        padding-bottom: 6px;
      }
      .fecha-wrap {
        display: flex;
        align-items: center;
        gap: 6px;
        width: 100%;
      }
      .fecha-wrap .fecha-text,
      .fecha-wrap .cliente-text,
      .fecha-wrap .correo-copy,
      .fecha-wrap .fecha-input,
      .fecha-wrap .cliente-edit-input,
      .fecha-wrap .correo-edit-input {
        flex: 1;
      }
      .btn-edit-fecha,
      .btn-edit-fecha-cuenta {
        background: transparent;
        border: none;
        cursor: pointer;
        font-size: 14px;
      }
      .btn-edit-cliente,
      .btn-save-edit,
      .btn-cancel-edit,
      .btn-save-fecha-cuenta,
      .btn-cancel-fecha-cuenta {
        background: transparent;
        border: none;
        cursor: pointer;
        font-size: 14px;
      }
      .miembros-table .correo-copy,
      .miembros-table .clave-copy {
        cursor: pointer;
      }
      .perfil-dot {
        display: inline-block;
        width: 8px;
        height: 8px;
        margin-left: 6px;
        border-radius: 50%;
        background: #f97316;
        vertical-align: middle;
      }
      .copyable-text {
        cursor: pointer;
      }
      .fecha-input,
      .fecha-input-cuenta {
        display: inline-block;
      }
      .cn-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.35);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 2000;
      }
      .cn-modal {
        background: #fff;
        padding: 16px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        max-width: 360px;
        width: 90%;
      }
      .cn-actions {
        display: flex;
        gap: 10px;
        margin-top: 12px;
        justify-content: flex-end;
      }
      .cn-btn {
        padding: 8px 12px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
      }
      .cn-primary {
        background: #111;
        color: #fff;
      }
      .cn-close {
        background: #e5e5e5;
        color: #111;
      }
      .cn-form {
        display: grid;
        gap: 8px;
        margin-top: 10px;
      }
      .cn-form input {
        padding: 8px 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
      }
      .cliente-ventas {
        margin-top: 20px;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      .cliente-ventas h3 {
        margin: 0 0 6px;
      }
      .cliente-ventas .ventas-table-wrap {
        overflow-x: auto;
      }
      .cliente-ventas table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        min-width: 500px;
      }
      .cliente-ventas th,
      .cliente-ventas td {
        border-left: 1px solid rgba(0, 0, 0, 0.08);
        border-right: 1px solid rgba(0, 0, 0, 0.08);
        padding: 3px 10px;
        text-align: left;
        font-size: 16px;
      }
      .cliente-ventas th {
        background: var(--table-header-bg, #2c2f36);
        color: #fff;
        font-weight: 800;
      }
      .cliente-ventas .btn-copy {
        padding: 6px 10px;
        border: none;
        border-radius: 8px;
        background: #111;
        color: #fff;
        cursor: pointer;
      }
      .cliente-ventas .btn-delete {
        padding: 6px 10px;
        border: none;
        border-radius: 8px;
        background: #dc2626;
        color: #fff;
        cursor: pointer;
      }
      .page-bottom-spacer {
        height: 140px;
      }
      .estado-cell {
        font-weight: 700;
        text-align: center;
      }
      .estado-cell.suspendido {
        background: #fecaca;
        color: #991b1b;
      }
      .estado-cell.vencido {
        background: #fed7aa;
        color: #9a3412;
      }
      .estado-cell.activo {
        background: #d1fae5;
        color: #065f46;
      }
      .cuenta-estado-pill {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 6px 12px;
        border-radius: 999px;
        border: 1px solid #e0e0e0;
        background: #f5f5f5;
        font-weight: 600;
        font-size: 12px;
        color: #111;
      }
      .cuenta-estado-pill.inactiva {
        background: #e5e7eb;
        color: #374151;
      }
      .cuenta-estado-pill.vencido {
        background: #fed7aa;
        color: #9a3412;
      }
      .cuenta-estado-pill.activo {
        background: #d1fae5;
        color: #065f46;
      }
      .correo-copy {
        cursor: pointer;
      }
      .btn-delete-venta {
        padding: 6px 10px;
        border: none;
        border-radius: 8px;
        background: #dc2626;
        color: #fff;
        cursor: pointer;
      }
      .precio-id-input {
        width: 92px;
        padding: 4px 6px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 13px;
      }
      .precio-id-input.is-saving {
        opacity: 0.6;
      }
      .codigo-input-wrap {
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .codigo-save-btn {
        border: none;
        background: #111;
        color: #fff;
        border-radius: 8px;
        padding: 6px 8px;
        cursor: pointer;
      }
      .copy-toast {
        position: fixed;
        top: 80px;
        right: 18px;
        background: #000;
        color: #fff;
        padding: 10px 14px;
        border-radius: 10px;
        font-size: 13px;
        font-weight: 700;
        opacity: 0;
        transform: translateY(-6px);
        transition:
          opacity 0.2s ease,
          transform 0.2s ease;
        z-index: 999;
        pointer-events: none;
      }
      .copy-toast.show {
        opacity: 1;
        transform: translateY(0);
      }
      .correo-plataformas {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        margin: 8px 0 12px;
      }
      .correo-plataformas.hidden {
        display: none;
      }
      .correo-plataformas .correo-tab-btn {
        border: 1px solid #111;
        background: #fff;
        color: #111;
        border-radius: 8px;
        padding: 6px 10px;
        font-weight: 700;
        cursor: pointer;
      }
      .correo-plataformas .correo-tab-btn.active {
        background: #111;
        color: #fff;
      }
      .replace-account-modal-card {
        max-width: 430px;
      }
      .replace-account-modal-body {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .replace-account-modal-title {
        margin: 0;
        color: #0f172a;
        font-size: 20px;
        font-weight: 800;
      }
      .replace-account-field {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .replace-account-label {
        font-size: 13px;
        font-weight: 700;
        color: #374151;
      }
      .replace-account-input {
        width: 100%;
        min-height: 42px;
        border: 1px solid #d1d5db;
        border-radius: 10px;
        padding: 10px 12px;
        font-size: 14px;
        color: #111827;
        background: #fff;
        transition:
          border-color 0.2s ease,
          box-shadow 0.2s ease;
        box-sizing: border-box;
      }
      .replace-account-input:focus {
        border-color: #111827;
        box-shadow: 0 0 0 3px rgba(17, 24, 39, 0.12);
        outline: none;
      }
      .replace-account-actions {
        margin-top: 4px;
        display: flex;
        gap: 10px;
        justify-content: flex-end;
      }
    </style>
  </head>
  <body>
    <div
      id="app-header"
      data-header-root="../../"
      data-header-pages="../"
    ></div>
    <script src="../../scripts/header-loader.js"></script>
    <div id="copy-toast" class="copy-toast">Copiado al portapapeles</div>

    <main class="categorias-dinamicas">
      <h2>Administrar cuentas</h2>
      <div class="cuentas-wrapper">
        <div class="cuentas-busqueda">
          <div class="input-wrap">
            <input
              type="search"
              id="input-venta-id"
              placeholder="Buscar por ID de venta"
              autocomplete="off"
            />
            <div class="cuentas-acciones" style="margin-top: 6px">
              <button type="button" id="btn-buscar-venta">üîç</button>
            </div>
            <p id="venta-search-msg" class="status" style="margin-top:6px; display:none;"></p>
          </div>
          <div class="input-wrap">
            <select id="select-plataforma" class="form-select">
              <option value="">Filtrar por plataforma</option>
            </select>
          </div>
          <div class="input-wrap">
            <input
              type="search"
              id="input-cliente"
              placeholder="Buscar por cliente"
              autocomplete="off"
            />
            <div id="sugs-clientes" class="sugerencias-cuentas hidden"></div>
            <p id="cliente-search-msg" class="status" style="margin-top:6px; display:none;"></p>
          </div>
          <div class="input-wrap">
            <input
              type="search"
              id="input-cuenta"
              placeholder="Buscar por correo"
              autocomplete="off"
            />
            <div id="sugs-cuentas" class="sugerencias-cuentas hidden"></div>
            <p id="cuenta-search-msg" class="status" style="margin-top:6px; display:none;"></p>
          </div>
          <div class="cuentas-acciones">
            <button type="button" id="btn-buscar-cuenta">üîç</button>
            <button type="button" class="btn-add" id="btn-ir-agregar">
              Agregar servicio
            </button>
            <button type="button" id="btn-canva" class="btn-outline">
              Cuenta Canva
            </button>
          </div>
        </div>
        <div id="plataforma-resultados"></div>
        <div id="venta-resultado"></div>
        <div id="correo-plataformas" class="correo-plataformas hidden"></div>
        <div id="cuenta-detalle" class="cuenta-detalle"></div>
        <div id="cliente-ventas" class="cliente-ventas"></div>
      </div>
      <datalist id="sugs-ocupado"></datalist>
      <div id="cn-modal" class="cn-overlay" style="display: none">
        <div class="cn-modal">
          <div id="cn-modal-step1">
            <p>No se encontr√≥ cliente en la base de datos.</p>
            <p>¬øA√±adir nuevo cliente?</p>
            <div class="cn-actions">
              <button type="button" class="cn-btn cn-primary" id="cn-modal-si">
                S√≠
              </button>
              <button type="button" class="cn-btn cn-close" id="cn-modal-no">
                No
              </button>
            </div>
          </div>
          <div id="cn-modal-step2" style="display: none">
            <p>Agregar nuevo cliente</p>
            <div class="cn-form">
              <input type="text" id="cn-nombre" placeholder="Nombre" />
              <input type="text" id="cn-apellido" placeholder="Apellido" />
              <input type="email" id="cn-correo" placeholder="Correo" />
              <input type="tel" id="cn-telefono" placeholder="Tel√©fono" />
            </div>
            <div class="cn-actions">
              <button
                type="button"
                class="cn-btn cn-primary"
                id="cn-modal-guardar"
              >
                Guardar
              </button>
              <button
                type="button"
                class="cn-btn cn-close"
                id="cn-modal-cancelar"
              >
                Cancelar
              </button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <div id="modal-delete-venta" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-card" style="max-width: 320px">
        <button class="modal-close modal-delete-close" aria-label="Cerrar">
          √ó
        </button>
        <div class="modal-body">
          <p style="margin-top: 0">
            ¬øEst√°s seguro de que quieres eliminar este servicio?
          </p>
          <div style="display: flex; gap: 10px; flex-wrap: wrap">
            <button
              type="button"
              id="btn-confirm-delete"
              class="btn-primary"
              style="background: #dc2626; border-color: #dc2626"
            >
              S√≠, eliminar
            </button>
            <button type="button" id="btn-cancel-delete" class="btn-outline">
              Volver
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="rec-overlay" class="rec-overlay">
      <div class="rec-modal">
        <h4>Recargar cuenta</h4>
        <div class="rec-row">
          <span class="rec-label">Correo</span>
          <span class="rec-copy" id="rec-mail">-</span>
        </div>
        <div class="rec-row">
          <span class="rec-label">Clave</span>
          <span class="rec-copy" id="rec-pass">-</span>
        </div>
        <div class="rec-row" id="rec-pin-row">
          <span class="rec-label">PIN</span>
          <span class="rec-copy" id="rec-pin">Buscando...</span>
        </div>
        <div class="rec-row">
          <span class="rec-label">Pr√≥x. corte</span>
          <input type="date" class="rec-date" id="rec-corte" />
        </div>
        <div class="rec-actions">
          <button type="button" class="rec-btn rec-primary" id="rec-do">
            Recargar
          </button>
          <button type="button" class="rec-btn rec-close" id="rec-close">
            Cerrar
          </button>
        </div>
        <div class="rec-actions">
          <!-- spacer for layout -->
        </div>
      </div>
    </div>

    <div id="renew-overlay" class="rec-overlay">
      <div class="rec-modal" style="max-width: 360px">
        <h4>Renovar cuenta</h4>
        <div class="rec-row">
          <span class="rec-label">Costo</span>
          <input
            type="number"
            step="0.01"
            min="0"
            id="renew-costo"
            class="form-input"
            placeholder="Monto"
            style="width: 100%; box-sizing: border-box"
          />
        </div>
        <div class="rec-row" style="align-items: center; gap: 8px">
          <span class="rec-label">Meses</span>
          <div class="modal-qty">
            <button
              type="button"
              class="row-menos"
              id="renew-menos"
              aria-label="menos"
            >
              -
            </button>
            <span id="renew-meses">1</span>
            <button
              type="button"
              class="row-mas"
              id="renew-mas"
              aria-label="m√°s"
            >
              +
            </button>
            <span class="modal-duration-suffix">meses</span>
          </div>
        </div>
        <div class="rec-row">
          <span class="rec-label">Pr√≥x. corte</span>
          <input
            type="date"
            id="renew-corte"
            class="form-input"
            style="width: 100%; box-sizing: border-box"
          />
        </div>
        <div
          class="rec-actions"
          style="margin-top: 12px; justify-content: flex-end; gap: 8px"
        >
          <button type="button" class="rec-btn rec-close" id="renew-cancel">
            Cancelar
          </button>
          <button type="button" class="rec-btn rec-primary" id="renew-do">
            Renovar
          </button>
        </div>
      </div>
    </div>

    <script type="module">
      import {
        requireSession,
        attachLogout,
        attachLogoHome,
      } from "../../scripts/session.js";
      import {
        clearServerSession,
        loadCurrentUser,
        supabase,
      } from "../../scripts/api.js";
      import { buildServiceCopyText } from "../../scripts/copy-format.js";
      import { formatDDMMYYYY } from "../../scripts/date-format.js";
      import { copyTextNotify } from "../../scripts/copy-toast.js";
      import {
        buildNotificationPayload,
        pickNotificationUserIds,
      } from "../../scripts/notification-templates.js";

      requireSession();
      attachLogoHome();

      const usernameEl = document.querySelector(".username");
      const adminLink = document.querySelector(".admin-link");
      const isTrue = (v) =>
        v === true || v === 1 || v === "1" || v === "true" || v === "t";
      const formatPerfilLabel = (value) => {
        if (value === null || value === undefined || value === "") return "";
        const raw = String(value).trim();
        if (!raw) return "";
        if (raw.toUpperCase().startsWith("M")) return raw;
        return `M${raw}`;
      };
      const normalizeExternalLink = (value) => {
        const raw = String(value || "").trim();
        if (!raw) return "";
        if (/^(https?:\/\/|mailto:|tel:|ftp:\/\/|\/\/)/i.test(raw)) {
          return raw;
        }
        return `https://${raw}`;
      };
      const getPlatFlags = (plat = {}, options = {}) => {
        const usaPines = isTrue(plat.usa_pines);
        const porPantalla = isTrue(plat.por_pantalla);
        const porAcceso = isTrue(plat.por_acceso);
        const correoCliente = isTrue(plat.correo_cliente);
        const claveCliente = isTrue(plat.clave_cliente);
        let showPin = usaPines;
        let showPerfil = porPantalla || porAcceso;
        let showClave = !(correoCliente && !claveCliente);
        if (options.fallbackAll && (!plat || Object.keys(plat).length === 0)) {
          showPin = true;
          showPerfil = true;
          showClave = true;
        }
        return {
          usaPines,
          porPantalla,
          porAcceso,
          correoCliente,
          claveCliente,
          showPin,
          showPerfil,
          showClave,
        };
      };
      const getPerfilHeaderLabel = (flags = {}) =>
        flags.porAcceso && !flags.porPantalla ? "Acceso" : "Perfil";
      const getPerfilCellLabel = (flags = {}, value, perfilHogar = false) => {
        if (!flags.showPerfil) return "";
        if (flags.porAcceso && !flags.porPantalla) return "1 dispositivo";
        const label = formatPerfilLabel(value ?? "");
        return `${label}${perfilHogar ? '<span class="perfil-dot"></span>' : ""}`;
      };
      const parseDateValue = (value) => {
        if (!value) return null;
        const str = String(value).trim();
        const isoMatch = str.match(/^(\d{4})-(\d{2})-(\d{2})$/);
        if (isoMatch) {
          const [, yyyy, mm, dd] = isoMatch;
          const parsed = new Date(Number(yyyy), Number(mm) - 1, Number(dd));
          if (!Number.isNaN(parsed.valueOf())) return parsed;
        }
        const match = str.match(/^(\d{2})\/(\d{2})\/(\d{4})$/);
        if (match) {
          const [, dd, mm, yyyy] = match;
          const parsed = new Date(Number(yyyy), Number(mm) - 1, Number(dd));
          if (!Number.isNaN(parsed.valueOf())) return parsed;
        }
        const fallback = new Date(str);
        return Number.isNaN(fallback.valueOf()) ? null : fallback;
      };
      const isOnOrBeforeToday = (value) => {
        const d = parseDateValue(value);
        if (!d) return false;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const cmp = new Date(d.getFullYear(), d.getMonth(), d.getDate());
        return cmp <= today;
      };
      const getEstadoVenta = ({ suspendido, fecha_corte } = {}) => {
        if (suspendido === true) {
          return { label: "Suspendido", className: "suspendido" };
        }
        if (!fecha_corte) {
          return { label: "-", className: "" };
        }
        if (isOnOrBeforeToday(fecha_corte)) {
          return { label: "Vencido", className: "vencido" };
        }
        return { label: "Activo", className: "activo" };
      };
      const getEstadoCuenta = (cuenta) => {
        if (!cuenta) return { label: "-", className: "" };
        if (cuenta.inactiva === true) {
          return { label: "Inactiva", className: "inactiva" };
        }
        if (!cuenta.fecha_corte) {
          return { label: "-", className: "" };
        }
        if (isOnOrBeforeToday(cuenta.fecha_corte)) {
          return { label: "Vencido", className: "vencido" };
        }
        return { label: "Activo", className: "activo" };
      };
      const renderFechaEditCell = (fechaCorte, ventaId) => {
        const fechaValue = fechaCorte || "";
        const fechaFmt = formatDDMMYYYY(fechaValue) || "";
        const ventaAttr = ventaId ? `data-venta="${ventaId}"` : "";
        return `<div class="fecha-wrap">
            <span class="fecha-text">${fechaFmt}</span>
            <button type="button" class="btn-edit-fecha" ${ventaAttr}>‚úèÔ∏è</button>
            <input type="date" class="fecha-input hidden" ${ventaAttr} value="${fechaValue}" />
            <button type="button" class="btn-save-edit hidden" ${ventaAttr} data-type="fecha">üíæ</button>
            <button type="button" class="btn-cancel-edit hidden" data-type="fecha">‚úñ</button>
          </div>`;
      };
      const renderFechaInlineCell = (fechaCorte, dataAttrs = "") => {
        const fechaValue = fechaCorte || "";
        const fechaFmt = formatDDMMYYYY(fechaValue) || "-";
        return `<div class="fecha-wrap">
            <span class="fecha-text">${fechaFmt}</span>
            <button type="button" class="btn-edit-fecha">‚úèÔ∏è</button>
            <input type="date" class="fecha-input hidden" ${dataAttrs} value="${fechaValue}" />
          </div>`;
      };
      const renderPrecioVentaCell = (ventaId, idPrecio) => {
        if (!ventaId) return "-";
        const precioVal = Number.isFinite(Number(idPrecio)) ? String(Number(idPrecio)) : "";
        return `<input
            type="number"
            class="precio-id-input"
            data-id-venta="${ventaId}"
            data-prev="${precioVal}"
            min="1"
            step="1"
            inputmode="numeric"
            value="${precioVal}"
          />`;
      };
      const decorateCopyColumns = (root) => {
        if (!root) return;
        root.querySelectorAll("table").forEach((table) => {
          const headers = Array.from(table.querySelectorAll("thead th"));
          if (!headers.length) return;
          const correoIdx = headers.findIndex((h) =>
            (h.textContent || "").trim().toLowerCase().startsWith("correo")
          );
          const claveIdx = headers.findIndex((h) =>
            (h.textContent || "").trim().toLowerCase().startsWith("clave")
          );
          if (correoIdx === -1 && claveIdx === -1) return;
          table.querySelectorAll("tbody tr").forEach((tr) => {
            const cells = Array.from(tr.children);
            const markCell = (idx) => {
              if (idx < 0 || idx >= cells.length) return;
              const cell = cells[idx];
              if (!cell || cell.querySelector("input, button, textarea, select")) return;
              if (cell.querySelector("[data-clipboard]")) return;
              const text = (cell.textContent || "").trim();
              if (!text || text === "-") return;
              cell.textContent = "";
              const span = document.createElement("span");
              span.className = "copyable-text";
              span.dataset.clipboard = text;
              span.textContent = text;
              cell.appendChild(span);
            };
            markCell(correoIdx);
            markCell(claveIdx);
          });
        });
      };
      let currentUserId = null;

      const inputCuenta = document.querySelector("#input-cuenta");
      const inputCliente = document.querySelector("#input-cliente");
      const selectPlataforma = document.querySelector("#select-plataforma");
      const plataformaResultadosEl = document.querySelector(
        "#plataforma-resultados",
      );
      const ventaResultadoEl = document.querySelector("#venta-resultado");
      const correoPlataformasEl = document.querySelector("#correo-plataformas");
      const sugs = document.querySelector("#sugs-cuentas");
      const sugsClientes = document.querySelector("#sugs-clientes");
      const btnBuscar = document.querySelector("#btn-buscar-cuenta");
      const btnBuscarVenta = document.querySelector("#btn-buscar-venta");
      const inputVentaId = document.querySelector("#input-venta-id");
      const ventaSearchMsg = document.querySelector("#venta-search-msg");
      const clienteSearchMsg = document.querySelector("#cliente-search-msg");
      const cuentaSearchMsg = document.querySelector("#cuenta-search-msg");
      const btnIrAgregar = document.querySelector("#btn-ir-agregar");
      const btnCanva = document.querySelector("#btn-canva");
      const detalleEl = document.querySelector("#cuenta-detalle");
      const clienteVentasEl = document.querySelector("#cliente-ventas");
      const modalPin = document.querySelector("#modal-pin");
      const modalPinTitle = document.querySelector("#modal-pin-title");
      const modalPinInput = document.querySelector("#input-pin");
      const modalPinSave = document.querySelector("#btn-guardar-pin");
      const modalPinClose = document.querySelector("#btn-cerrar-pin");
      const modalRecargar = document.querySelector("#rec-overlay");
      const recCorreo = document.querySelector("#rec-mail");
      const recClave = document.querySelector("#rec-pass");
      const recPin = document.querySelector("#rec-pin");
      const recPinRow = document.querySelector("#rec-pin-row");
      const recCorte = document.querySelector("#rec-corte");
      const btnCerrarRecargar = document.querySelector("#rec-close");
      const btnDoRecarga = document.querySelector("#rec-do");
      const renewOverlay = document.querySelector("#renew-overlay");
      const renewCosto = document.querySelector("#renew-costo");
      const renewMesesEl = document.querySelector("#renew-meses");
      const renewMas = document.querySelector("#renew-mas");
      const renewMenos = document.querySelector("#renew-menos");
      const renewCorte = document.querySelector("#renew-corte");
      const renewCancel = document.querySelector("#renew-cancel");
      const renewDo = document.querySelector("#renew-do");
      let renewMeses = 1;
      let renewFechaTouched = false;
      let renewPlatId = null;
      let renewBaseDate = null;
      let ocupadoSuggestions = [];
      let modalStep1 = null;
      let modalStep2 = null;
      let modalNombre = null;
      let modalApellido = null;
      let modalCorreo = null;
      let modalTelefono = null;
      let modalOverlay = null;
      let modalGuardar = null;
      let modalCancelar = null;
      let modalSi = null;
      let modalNo = null;
      let pendingOcupadoInput = null;
      let proveedoresCache = null;
      let reemplazosCache = null;
      let reemplazosCachePromise = null;
      const PIN_RECARGA_PLATFORM_ID = 21;
      const PIN_RECARGA_CACHE_TTL_MS = 60 * 1000;
      const pinRecargaState = {
        items: [],
        fetchedAt: 0,
        loading: null,
      };
      const toPositiveId = (value) => {
        const parsed = Number(value);
        if (!Number.isFinite(parsed) || parsed <= 0) return null;
        return Math.trunc(parsed);
      };
      const loadReemplazosCache = async (force = false) => {
        if (force) {
          reemplazosCache = null;
          reemplazosCachePromise = null;
        }
        if (reemplazosCache) return { data: reemplazosCache };
        if (!reemplazosCachePromise) {
          reemplazosCachePromise = supabase
            .from("reemplazos")
            .select("id_cuenta, id_perfil")
            .then(({ data, error }) => {
              if (error) throw error;
              const cuentas = new Set();
              const perfiles = new Set();
              (data || []).forEach((row) => {
                const cuentaId = toPositiveId(row?.id_cuenta);
                const perfilId = toPositiveId(row?.id_perfil);
                if (cuentaId) cuentas.add(cuentaId);
                if (perfilId) perfiles.add(perfilId);
              });
              reemplazosCache = { cuentas, perfiles };
              return reemplazosCache;
            })
            .finally(() => {
              reemplazosCachePromise = null;
            });
        }
        try {
          const data = await reemplazosCachePromise;
          return { data };
        } catch (error) {
          return { error };
        }
      };
      const addToReemplazosCache = ({ idCuenta = null, idPerfil = null }) => {
        if (!reemplazosCache) return;
        const cuentaId = toPositiveId(idCuenta);
        const perfilId = toPositiveId(idPerfil);
        if (cuentaId) reemplazosCache.cuentas.add(cuentaId);
        if (perfilId) reemplazosCache.perfiles.add(perfilId);
      };
      const normalizeText = (val) =>
        (val || "")
          .toString()
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .toLowerCase()
          .trim();
      const setSearchMsg = (el, msg) => {
        if (!el) return;
        if (msg) {
          el.textContent = msg;
          el.style.display = "block";
        } else {
          el.textContent = "";
          el.style.display = "none";
        }
      };
      const cleanClienteName = (value) => {
        const text = (value || "")
          .toString()
          .replace(/<[^>]*>/g, " ")
          .replace(/\s+/g, " ")
          .trim();
        if (!text) return "";
        const norm = normalizeText(text);
        if (norm === "vacio" || norm === "reemplazado" || text === "-") {
          return "";
        }
        return text;
      };
      const getClienteNameForReemplazoBtn = (btnRepl) => {
        if (!btnRepl) return "este usuario";
        const encoded = (btnRepl.dataset.cliente || "").trim();
        if (encoded) {
          try {
            const decoded = decodeURIComponent(encoded);
            const cleaned = cleanClienteName(decoded);
            if (cleaned) return cleaned;
          } catch (_err) {
            const cleaned = cleanClienteName(encoded);
            if (cleaned) return cleaned;
          }
        }
        const selected = cleanClienteName(inputCliente?.value || "");
        return selected || "este usuario";
      };
      const findClienteByTerm = async (term) => {
        const txt = (term || "").trim();
        if (!txt) return null;
        const tokens = txt.split(/\s+/).filter(Boolean);
        const firstToken = tokens[0] || "";
        const lastToken = tokens.length > 1 ? tokens[tokens.length - 1] : "";
        try {
          const { data, error } = await supabase
            .from("usuarios")
            .select("id_usuario, nombre, apellido, correo")
            .or(
              lastToken && lastToken !== firstToken
                ? `nombre.ilike.%${firstToken}%,apellido.ilike.%${lastToken}%,correo.ilike.%${txt}%`
                : `nombre.ilike.%${firstToken}%,apellido.ilike.%${firstToken}%,correo.ilike.%${txt}%`,
            )
            .limit(20);
          if (error) throw error;
          const norm = normalizeText(txt);
          const match = (data || []).find((u) =>
            normalizeText(`${u.nombre || ""} ${u.apellido || ""}`).includes(norm) ||
            normalizeText(u.correo || "").includes(norm)
          );
          return match || data?.[0] || null;
        } catch (err) {
          console.error("buscar cliente inline error", err);
          return null;
        }
      };
      const fetchOcupadoSuggestions = async (term) => {
        const txt = (term || "").trim();
        if (txt.length < 2) return [];
        const tokens = txt.split(/\s+/).filter(Boolean);
        const firstToken = tokens[0] || "";
        const lastToken = tokens.length > 1 ? tokens[tokens.length - 1] : "";
        try {
          const { data, error } = await supabase
            .from("usuarios")
            .select("id_usuario, nombre, apellido")
            .or(
              lastToken && lastToken !== firstToken
                ? `nombre.ilike.%${firstToken}%,apellido.ilike.%${lastToken}%`
                : `nombre.ilike.%${firstToken}%,apellido.ilike.%${firstToken}%`,
            )
            .limit(20);
          if (error) throw error;
          const norm = normalizeText(txt);
          return (data || [])
            .filter((u) =>
              normalizeText(`${u.nombre || ""} ${u.apellido || ""}`).includes(norm)
            )
            .slice(0, 5);
        } catch (err) {
          console.error("sugs ocupado error", err);
          return [];
        }
      };

      const fetchProveedoresList = async () => {
        if (Array.isArray(proveedoresCache)) return proveedoresCache;
        try {
          const { data, error } = await supabase
            .from("proveedores")
            .select("id_proveedor, nombre")
            .order("nombre", { ascending: true });
          if (error) throw error;
          proveedoresCache = (data || []).filter((p) => p?.nombre);
          return proveedoresCache;
        } catch (err) {
          console.error("fetch proveedores error", err);
          proveedoresCache = [];
          return [];
        }
      };

      const renderProveedorSugs = (wrap, items, forceHide = false) => {
        const sugs = wrap?.querySelector(".proveedor-sugs");
        if (!sugs) return;
        if (forceHide || !items.length) {
          sugs.innerHTML = "";
          sugs.classList.add("hidden");
          return;
        }
        sugs.innerHTML = items
          .map(
            (p) =>
              `<button type="button" data-id="${p.id_proveedor}" data-nombre="${p.nombre}">${p.nombre}</button>`,
          )
          .join("");
        sugs.classList.remove("hidden");
      };

      const updateProveedorSuggestions = async (input) => {
        if (!input) return;
        const wrap = input.closest(".proveedor-input-wrap");
        const term = (input.value || "").trim();
        const list = await fetchProveedoresList();
        if (!list.length) {
          renderProveedorSugs(wrap, [], true);
          return;
        }
        const norm = normalizeText(term);
        const filtered = term
          ? list.filter((p) => normalizeText(p.nombre).includes(norm)).slice(0, 6)
          : list.slice(0, 6);
        renderProveedorSugs(wrap, filtered, false);
        const exact = list.find((p) => normalizeText(p.nombre) === norm);
        if (exact) {
          input.dataset.proveedorId = exact.id_proveedor;
        } else {
          delete input.dataset.proveedorId;
        }
      };

      const toTitleCase = (str) =>
        (str || "").replace(/(\S+)/g, (w) =>
          w ? w[0].toUpperCase() + w.slice(1).toLowerCase() : "",
        );
      const showModal = () =>
        modalOverlay && (modalOverlay.style.display = "flex");
      const hideModal = () =>
        modalOverlay && (modalOverlay.style.display = "none");
      const buildCanvaRowHtml = ({
        idVenta,
        clienteNombre,
        correo,
        fechaCorte,
        userId,
        cuentaId,
        idPerfil,
        nPerfil,
        perfilHogar,
      }) => {
        const flags =
          currentCanvaFlags || getPlatFlags({}, { fallbackAll: true });
        const showPerfil = flags.showPerfil ?? true;
        const showPerfilId = flags.porPantalla === true;
        const estadoInfo = getEstadoVenta({ fecha_corte: fechaCorte });
        const correoCell = isSuperadmin
          ? `<div class="fecha-wrap">
              <span class="correo-copy correo-text" data-clipboard="${correo || ""}">${correo || "-"}</span>
              <button type="button" class="btn-edit-correo" data-venta="${idVenta}" data-cuenta="${cuentaId || ""}">‚úèÔ∏è</button>
              <input type="text" class="correo-edit-input hidden" data-venta="${idVenta}" data-cuenta="${cuentaId || ""}" value="${correo || ""}" />
              <button type="button" class="btn-save-edit hidden" data-venta="${idVenta}" data-cuenta="${cuentaId || ""}" data-type="correo">üíæ</button>
              <button type="button" class="btn-cancel-edit hidden" data-type="correo">‚úñ</button>
            </div>`
          : `<span class="correo-copy" data-clipboard="${correo || ""}">${correo || "-"}</span>`;
        const clienteCell = isSuperadmin
          ? `<div class="fecha-wrap">
              <span class="cliente-text">${clienteNombre || "-"}</span>
              <button type="button" class="btn-edit-cliente" data-venta="${idVenta}">‚úèÔ∏è</button>
              <input type="text" class="cliente-edit-input hidden" data-venta="${idVenta}" value="${clienteNombre || ""}" list="sugs-ocupado" />
              <button type="button" class="btn-save-edit hidden" data-venta="${idVenta}" data-type="cliente">üíæ</button>
              <button type="button" class="btn-cancel-edit hidden" data-type="cliente">‚úñ</button>
            </div>`
          : `${clienteNombre || "-"}`;
        const fechaCell = isSuperadmin
          ? `<div class="fecha-wrap">
              <span class="fecha-text">${formatDDMMYYYY(fechaCorte) || ""}</span>
              <button type="button" class="btn-edit-fecha" data-venta="${idVenta}">‚úèÔ∏è</button>
              <input type="date" class="fecha-input hidden" data-venta="${idVenta}" value="${fechaCorte || ""}" />
              <button type="button" class="btn-save-edit hidden" data-venta="${idVenta}" data-type="fecha">üíæ</button>
              <button type="button" class="btn-cancel-edit hidden" data-type="fecha">‚úñ</button>
            </div>`
          : `${formatDDMMYYYY(fechaCorte) || ""}`;
        const deleteBtn =
          isSuperadmin && idVenta
          ? `<button type="button" class="btn-delete-venta" data-id-venta="${idVenta}">Eliminar</button>`
          : "";
        const perfilIdCell = showPerfilId ? `<td>${idPerfil || ""}</td>` : "";
        const perfilLabel = getPerfilCellLabel(flags, nPerfil, perfilHogar);
        const perfilCell = showPerfil ? `<td>${perfilLabel}</td>` : "";
        return `
          <tr data-id-venta="${idVenta || ""}">
            ${perfilIdCell}
            ${perfilCell}
            <td>${clienteCell}</td>
            <td>${correoCell}</td>
            <td>${fechaCell}</td>
            <td class="estado-cell ${estadoInfo.className}">${estadoInfo.label}</td>
            <td>
              <button type="button" class="btn-outline btn-ver-cuenta" data-cuenta="${cuentaId || ""}">Ver cuenta</button>
              ${deleteBtn}
            </td>
          </tr>
        `;
      };

      const insertCanvaRowSorted = (tbody, newRow, addRow) => {
        if (!tbody || !newRow) return;
        const rows = Array.from(tbody.querySelectorAll("tr")).filter(
          (tr) => tr !== addRow && tr !== newRow,
        );
        rows.push(newRow);
        rows.sort((a, b) => {
          const aId = Number(
            a.dataset.idVenta ||
              a.querySelector("td")?.textContent?.replace("#", "") ||
              0,
          );
          const bId = Number(
            b.dataset.idVenta ||
              b.querySelector("td")?.textContent?.replace("#", "") ||
              0,
          );
          if (!aId && !bId) return 0;
          if (!aId) return 1;
          if (!bId) return -1;
          return aId - bId;
        });
        rows.forEach((row) => tbody.appendChild(row));
        if (addRow) tbody.appendChild(addRow);
      };
      const goStep1 = () => {
        if (modalStep1) modalStep1.style.display = "block";
        if (modalStep2) modalStep2.style.display = "none";
      };
      const goStep2 = () => {
        if (modalStep1) modalStep1.style.display = "none";
        if (modalStep2) modalStep2.style.display = "block";
      };

      const initModalNuevoCliente = () => {
        modalOverlay = document.querySelector("#cn-modal");
        modalStep1 = document.querySelector("#cn-modal-step1");
        modalStep2 = document.querySelector("#cn-modal-step2");
        modalNombre = document.querySelector("#cn-nombre");
        modalApellido = document.querySelector("#cn-apellido");
        modalCorreo = document.querySelector("#cn-correo");
        modalTelefono = document.querySelector("#cn-telefono");
        modalGuardar = document.querySelector("#cn-modal-guardar");
        modalCancelar = document.querySelector("#cn-modal-cancelar");
        modalSi = document.querySelector("#cn-modal-si");
        modalNo = document.querySelector("#cn-modal-no");

        modalNo?.addEventListener("click", () => {
          hideModal();
          pendingOcupadoInput = null;
        });
        modalCancelar?.addEventListener("click", () => {
          goStep1();
          hideModal();
          pendingOcupadoInput = null;
        });
        modalSi?.addEventListener("click", () => {
          if (pendingOcupadoInput) {
            const parts = (pendingOcupadoInput.value || "").trim().split(/\s+/);
            const nombre = toTitleCase(parts.shift() || "");
            const apellido = toTitleCase(parts.join(" ").trim());
            if (modalNombre) modalNombre.value = nombre;
            if (modalApellido) modalApellido.value = apellido;
          }
          goStep2();
        });
        modalGuardar?.addEventListener("click", async () => {
          if (!pendingOcupadoInput) {
            hideModal();
            return;
          }
          const nombre = toTitleCase(modalNombre?.value || "");
          const apellido = toTitleCase(modalApellido?.value || "");
          const correo = (modalCorreo?.value || "").trim();
          const telefono = (modalTelefono?.value || "").trim();
          if (!nombre || !apellido || !correo) {
            alert("Completa nombre, apellido y correo.");
            return;
          }
          try {
            const { data, error } = await supabase
              .from("usuarios")
              .insert({ nombre, apellido, correo, telefono })
              .select("id_usuario")
              .single();
            if (error) throw error;
            const id = data?.id_usuario;
            pendingOcupadoInput.value = `${nombre} ${apellido}`;
            if (id) pendingOcupadoInput.dataset.userId = id;
            validateRegistrarBtn(pendingOcupadoInput.closest("tr"));
            hideModal();
            goStep1();
            pendingOcupadoInput = null;
          } catch (err) {
            console.error("crear usuario error", err);
            alert("No se pudo crear el usuario.");
          }
        });
      };

      const showModalRecargar = () => {
        modalRecargar?.classList.add("show");
      };
      const hideModalRecargar = () => {
        modalRecargar?.classList.remove("show");
      };
      const showModalRenovar = () => {
        renewOverlay?.classList.add("show");
      };
      const hideModalRenovar = () => {
        renewOverlay?.classList.remove("show");
      };

      const copyWithToast = async (el) => {
        if (!el) return;
        const text = el.dataset?.clipboard || el.textContent?.trim() || "";
        if (!text) return;
        await copyTextNotify(text);
      };
      const updateRowCopyPayload = (row) => {
        if (!row) return;
        const copyBtn = row.querySelector(".btn-copy-row");
        const replBtn = row.querySelector(".btn-reemplazar-row");
        if (!copyBtn || !replBtn) return;
        const idVenta = (replBtn.dataset.idventa || "").trim();
        if (!idVenta) return;
        const fechaVal =
          (replBtn.dataset.fecha || "").trim() ||
          (row.querySelector(".fecha-input")?.value || "").trim();
        const correoVal = (
          replBtn.dataset.correo ||
          row.querySelector(".correo-copy")?.dataset?.clipboard ||
          row.querySelector(".correo-copy")?.textContent ||
          currentCuentaDetalle?.correo ||
          ""
        ).trim();
        const claveVal = (
          replBtn.dataset.clave ||
          row.querySelector(".clave-copy")?.dataset?.clipboard ||
          row.querySelector(".clave-copy")?.textContent ||
          currentCuentaDetalle?.clave ||
          ""
        ).trim();
        const pinVal = (
          replBtn.dataset.pin ||
          row.querySelector(".pin-copy")?.dataset?.clipboard ||
          row.querySelector(".pin-copy")?.textContent ||
          ""
        ).trim();
        const ventaPerfil =
          replBtn.dataset.ventaPerfil !== undefined
            ? isTrue(replBtn.dataset.ventaPerfil)
            : currentCuentaDetalle?.venta_perfil;
        const ventaMiembro =
          replBtn.dataset.ventaMiembro !== undefined
            ? isTrue(replBtn.dataset.ventaMiembro)
            : currentCuentaDetalle?.venta_miembro;
        const copyText = buildServiceCopyText({
          plataforma:
            replBtn.dataset.plat || currentCuentaDetalle?.plataformaNombre || "",
          idVenta,
          correo: correoVal,
          clave: claveVal,
          nPerfil: replBtn.dataset.nperfil || "",
          pin: pinVal,
          fechaCorte: fechaVal,
          porAcceso: currentCuentaDetalle?.por_acceso,
          usaPines: currentCuentaDetalle?.usa_pines,
          ventaPerfil,
          ventaMiembro,
          idPlataforma: currentCuentaDetalle?.plataformaId,
          perfilHogar: row.querySelector(".toggle-hogar")?.checked === true,
          isSubCuenta: false,
        });
        copyBtn.dataset.copy = encodeURIComponent(copyText);
      };
      let fetchCounter = 0;
      let currentCuentaId = null;
      let currentCuentaDetalle = null;
      let modalState = {
        type: null,
        targetId: null,
        max: null,
        correo: "",
        nPerfil: null,
        plataforma: "",
      };
      let isSuperadmin = false;
      const modalReemplazo = document.querySelector("#modal-reemplazo-row");
      const modalMiembroAdd = document.querySelector("#modal-miembro-add");
      const modalReemplazoConfirm = document.querySelector(
        "#modal-reemplazo-confirm",
      );
      const modalReemplazoConfirmMsg = document.querySelector(
        "#modal-reemplazo-confirm-msg",
      );
      const btnReemplazoConfirmSi = document.querySelector(
        "#btn-reemplazo-confirm-si",
      );
      const btnReemplazoConfirmNo = document.querySelector(
        "#btn-reemplazo-confirm-no",
      );
      const modalReemplazarCuenta = document.querySelector(
        "#modal-reemplazar-cuenta",
      );
      const modalReemplazarRelacionados = document.querySelector(
        "#modal-reemplazar-relacionados",
      );
      const btnReemplazarCuentaClose = document.querySelector(
        "#btn-reemplazar-cuenta-close",
      );
      const btnReemplazarCuentaCancel = document.querySelector(
        "#btn-reemplazar-cuenta-cancel",
      );
      const btnReemplazarCuentaConfirm = document.querySelector(
        "#btn-reemplazar-cuenta-confirm",
      );
      const btnReemplazarRelacionadosSi = document.querySelector(
        "#btn-reemplazar-relacionados-si",
      );
      const btnReemplazarRelacionadosNo = document.querySelector(
        "#btn-reemplazar-relacionados-no",
      );
      const inputReemplazarCuentaCorreo = document.querySelector(
        "#input-reemplazar-cuenta-correo",
      );
      const inputReemplazarCuentaClave = document.querySelector(
        "#input-reemplazar-cuenta-clave",
      );
      const inputReemplazarCuentaFecha = document.querySelector(
        "#input-reemplazar-cuenta-fecha",
      );
      const modalTareas = document.querySelector("#modal-tareas");
      const tareasListEl = document.querySelector("#tareas-list");
      const btnTareasCancel = document.querySelector("#btn-tareas-cancel");
      const btnTareasSend = document.querySelector("#btn-tareas-send");
      const btnMiembroSi = document.querySelector("#btn-miembro-si");
      const btnMiembroNo = document.querySelector("#btn-miembro-no");
      let pendingMiembroAdd = null;
      let fetchCounterClientes = 0;
      const modalDelete = document.querySelector("#modal-delete-venta");
      const btnConfirmDelete = document.querySelector("#btn-confirm-delete");
      const btnCancelDelete = document.querySelector("#btn-cancel-delete");
      const btnCloseDelete = document.querySelector(".modal-delete-close");
      let deleteTargetId = null;
      let deleteTargetRow = null;
      const modalReemplazoMsg = document.querySelector("#modal-reemplazo-msg");
      let currentCanvaCuenta = null;
      let currentCanvaFlags = null;
      let tareasCache = null;
      let tareasCuentaId = null;
      let reemplazarCuentaTargetId = null;
      let reemplazoRelacionadosContext = null;
      let pendingReemplazoBtn = null;

      (async () => {
        try {
          const user = await loadCurrentUser();
          if (user && usernameEl) {
            const fullName = [user.nombre, user.apellido]
              .filter(Boolean)
              .join(" ")
              .trim();
            usernameEl.textContent = fullName || user.correo || "Usuario";
          }
          currentUserId = user?.id_usuario || null;
          isSuperadmin = isTrue(user?.permiso_superadmin);
          const isAdmin =
            isTrue(user?.permiso_admin) || isTrue(user?.permiso_superadmin);
          if (adminLink) {
            adminLink.classList.toggle("hidden", !isAdmin);
            adminLink.style.display = isAdmin ? "block" : "none";
          }
          loadPlataformasSelect();
        } catch (err) {
          console.error("admin cuentas init error", err);
        }
      })();

      const renderSugerencias = (items, forceHide = false) => {
        if (!sugs) return;
        if (forceHide || !items.length) {
          sugs.innerHTML = "";
          sugs.classList.add("hidden");
          return;
        }
        sugs.innerHTML = items
          .map(
            (c) =>
              `<button type="button" data-id="${c.id_cuenta}" data-correo="${c.correo || ""}">${c.correo || ""}</button>`,
          )
          .join("");
        sugs.classList.remove("hidden");
      };

      const clearPlataformaResultados = () => {
        if (plataformaResultadosEl) {
          plataformaResultadosEl.innerHTML = "";
          plataformaResultadosEl.classList.add("hidden");
        }
      };

      const hideDetalle = () => {
        if (!detalleEl) return;
        detalleEl.innerHTML = "";
        detalleEl.style.display = "none";
      };

      const clearCorreoPlataformas = () => {
        if (!correoPlataformasEl) return;
        correoPlataformasEl.innerHTML = "";
        correoPlataformasEl.classList.add("hidden");
      };

      const renderCorreoPlataformas = (cuentas, activeId = null) => {
        if (!correoPlataformasEl) return;
        if (!Array.isArray(cuentas) || cuentas.length <= 1) {
          clearCorreoPlataformas();
          return;
        }
        correoPlataformasEl.innerHTML = cuentas
          .map((c) => {
            const label = c.plataformaNombre || `Plataforma ${c.id_plataforma || ""}`;
            const isActive = String(c.id_cuenta) === String(activeId);
            return `<button type="button" class="correo-tab-btn ${isActive ? "active" : ""}" data-cuenta="${c.id_cuenta}">${label}</button>`;
          })
          .join("");
        correoPlataformasEl.classList.remove("hidden");
      };

      const toggleBusquedaViews = (showBusqueda) => {
        const displayVal = showBusqueda ? "" : "none";
        if (detalleEl) detalleEl.style.display = showBusqueda ? "block" : "none";
        if (clienteVentasEl) clienteVentasEl.style.display = displayVal;
      };

      const loadPlataformasSelect = async () => {
        if (!selectPlataforma) return;
        try {
          const { data, error } = await supabase
            .from("plataformas")
            .select("id_plataforma, nombre")
            .order("id_plataforma", { ascending: true });
          if (error) throw error;
          selectPlataforma.innerHTML =
            '<option value="">Filtrar por plataforma</option>';
          (data || []).forEach((p) => {
            const opt = document.createElement("option");
            opt.value = p.id_plataforma;
            opt.textContent = p.nombre || `Plataforma ${p.id_plataforma}`;
            selectPlataforma.appendChild(opt);
          });
        } catch (err) {
          console.error("load plataformas select error", err);
        }
      };

      const buscarCuentas = async (texto, forceHide = false) => {
        const term = (texto || "").trim();
        if (!term) {
          renderSugerencias([], true);
          clienteVentasEl && (clienteVentasEl.innerHTML = "");
          hideDetalle();
          clearCorreoPlataformas();
          return [];
        }
        const current = ++fetchCounter;
        try {
          const { data, error } = await supabase
            .from("cuentas")
            .select(
              "id_cuenta, correo, id_plataforma, id_proveedor, region, clave, fecha_corte, venta_perfil, venta_miembro",
            )
            .ilike("correo", `%${term}%`)
            .order("correo", { ascending: true })
            .limit(10);
          if (current !== fetchCounter) return;
          if (error) throw error;
          const unique = Array.from(
            new Map(
              (data || []).filter((c) => c.correo).map((c) => [c.correo, c]),
            ).values(),
          ).slice(0, 5);
          renderSugerencias(unique, forceHide);
          return unique;
        } catch (err) {
          console.error("buscar cuentas error", err);
          renderSugerencias([], true);
          return [];
        }
      };

      const applyCorreoPrefill = () => {
        const params = new URLSearchParams(window.location.search);
        const correo = (params.get("correo") || "").trim();
        if (!correo || !inputCuenta) return;
        inputCuenta.value = correo;
        resetClienteBusqueda();
        if (selectPlataforma) selectPlataforma.value = "";
        clearPlataformaResultados();
        toggleBusquedaViews(true);
        buscarCuentas(correo, true);
        loadCuentaDetalleByCorreo(correo);
        renderSugerencias([], true);
      };

      inputCuenta?.addEventListener("input", (e) => {
        setSearchMsg(cuentaSearchMsg, "");
        buscarCuentas(e.target.value || "");
      });

      btnBuscar?.addEventListener("click", (e) => {
        e.preventDefault();
        runCuentaSearch(false);
      });

      inputCuenta?.addEventListener("keydown", async (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          await runCuentaSearch(true);
        }
      });

      inputCuenta?.addEventListener("search", async () => {
        await runCuentaSearch(true);
      });

      // nota: keydown Enter cubre el caso; evitamos keyup para no duplicar b√∫squeda.

      const renderSugerenciasClientes = (items, forceHide = false) => {
        if (!sugsClientes) return;
        if (forceHide || !items.length) {
          sugsClientes.innerHTML = "";
          sugsClientes.classList.add("hidden");
          return;
        }
        sugsClientes.innerHTML = items
          .map((c) => {
            const nombre = [c.nombre, c.apellido].filter(Boolean).join(" ").trim();
            const correo = c.correo || "";
            return `
            <button type="button" data-id="${c.id_usuario}" data-correo="${correo}">
              ${nombre} (${correo})
            </button>
          `;
          })
          .join("");
        sugsClientes.classList.remove("hidden");
      };

      const buscarClientes = async (texto) => {
        const term = (texto || "").trim();
        if (!term) {
          renderSugerenciasClientes([], true);
          return [];
        }
        const tokens = term.split(/\s+/).filter(Boolean);
        const firstToken = tokens[0] || "";
        const lastToken = tokens.length > 1 ? tokens[tokens.length - 1] : "";
        const norm = normalizeText(term);
        const current = ++fetchCounterClientes;
        try {
          const { data, error } = await supabase
            .from("usuarios")
            .select("id_usuario, nombre, apellido, correo")
            .or(
              lastToken && lastToken !== firstToken
                ? `nombre.ilike.%${firstToken}%,apellido.ilike.%${lastToken}%,correo.ilike.%${term}%`
                : `nombre.ilike.%${firstToken}%,apellido.ilike.%${firstToken}%,correo.ilike.%${term}%`,
            );
          const dataLimited = (data || []).slice(0, 20);
          if (current !== fetchCounterClientes) return;
          if (error) throw error;
          const parsed = (dataLimited || [])
            .filter((u) =>
              normalizeText(`${u.nombre || ""} ${u.apellido || ""}`).includes(norm) ||
              normalizeText(u.correo || "").includes(norm)
            )
            .map((u) => ({
              id_usuario: u.id_usuario,
              nombre: u.nombre,
              apellido: u.apellido,
              correo: u.correo,
            }))
            .slice(0, 5);
          renderSugerenciasClientes(parsed, false);
          return parsed;
        } catch (err) {
          console.error("buscar clientes error", err);
          renderSugerenciasClientes([], true);
          return [];
        }
      };

      const runClienteSearch = async () => {
        const term = (inputCliente?.value || "").trim();
        setSearchMsg(clienteSearchMsg, "");
        if (!term) {
          setSearchMsg(clienteSearchMsg, "No se encontraron coincidencias");
          return;
        }
        const found = await findClienteByTerm(term);
        renderSugerenciasClientes([], true);
        renderSugerencias([], true);
        if (!found?.id_usuario) {
          setSearchMsg(clienteSearchMsg, "No se encontraron coincidencias");
          return;
        }
        if (inputCliente) {
          const fullName = [found.nombre, found.apellido]
            .filter(Boolean)
            .join(" ")
            .trim();
          if (fullName) inputCliente.value = fullName;
          inputCliente.dataset.selectedId = found.id_usuario;
        }
        loadVentasByCliente(found.id_usuario);
      };

      const runCuentaSearch = async (forceHideSugs = true) => {
        const term = (inputCuenta?.value || "").trim();
        setSearchMsg(cuentaSearchMsg, "");
        const results = await buscarCuentas(term, forceHideSugs);
        if (term) {
          const normalizedTerm = term.toLowerCase();
          const exactMatch = (results || []).find(
            (r) => String(r?.correo || "").trim().toLowerCase() === normalizedTerm,
          );
          const correoToLoad = String(
            exactMatch?.correo || results?.[0]?.correo || term,
          ).trim();
          if (correoToLoad) {
            if (inputCuenta) inputCuenta.value = correoToLoad;
            loadCuentaDetalleByCorreo(correoToLoad);
          }
        }
        if (Array.isArray(results) && results.length === 0) {
          setSearchMsg(cuentaSearchMsg, "No se encontraron coincidencias");
        }
        if (forceHideSugs) renderSugerencias([], true);
      };

      const renderVentaResultado = (ventaData, notFound = false) => {
        if (!ventaResultadoEl) return;
        if (!ventaData) {
          ventaResultadoEl.innerHTML = notFound
            ? '<p class="status">No se encontr√≥ la venta.</p>'
            : "";
          return;
        }
        const {
          usuarioNombre,
          perfil,
          pin,
          fecha_corte,
          id_venta,
          platFlags = {},
          showPerfil = true,
          showPin = true,
        } = ventaData;
        const flags = platFlags || { showPerfil, showPin };
        const finalShowPerfil = flags.showPerfil ?? showPerfil;
        const finalShowPin = flags.showPin ?? showPin;
        const perfilLabel = finalShowPerfil ? getPerfilCellLabel(flags, perfil) : "";
        const pinCell = finalShowPin ? `<td>${pin || ""}</td>` : "";
        const perfilCellFinal = finalShowPerfil ? `<td>${perfilLabel}</td>` : "";
        const rows = `
          <tr>
            <td>${usuarioNombre || "Vac√≠o"}</td>
            ${perfilCellFinal}
            ${pinCell}
            <td>${renderFechaEditCell(fecha_corte, id_venta)}</td>
            <td><button type="button" class="btn-outline btn-ver-cuenta" data-cuenta="${ventaData.id_cuenta || ""}">Ver cuenta</button></td>
          </tr>
        `;
        ventaResultadoEl.innerHTML = `
          <div class="cuenta-table-wrap" style="margin-top:12px;">
            <table class="table-base">
              <thead>
                <tr>
                  <th>Ocupado por</th>
                  ${finalShowPerfil ? `<th>${getPerfilHeaderLabel(flags)}</th>` : ""}
                  ${finalShowPin ? "<th>PIN</th>" : ""}
                  <th>Fecha de corte</th>
                  <th class="action-cell">Acci√≥n</th>
                </tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        `;
        decorateCopyColumns(ventaResultadoEl);
      };

      const buscarVentaPorId = async (id) => {
        if (!id) {
          renderVentaResultado(null);
          return false;
        }
        try {
          const cleaned = String(id).replace(/[^0-9]/g, "");
          const idNum = Number(cleaned);
          if (!idNum) {
            renderVentaResultado(null, true);
            return false;
          }
          const { data: venta, error } = await supabase
            .from("ventas")
            .select("id_venta, id_usuario, id_perfil, id_cuenta, fecha_corte")
            .eq("id_venta", idNum)
            .maybeSingle();
          if (error) throw error;
          if (!venta) {
            renderVentaResultado(null, true);
            return false;
          }
          let platFlags = { showPerfil: true, showPin: true };
          if (venta.id_cuenta) {
            const { data: cuentaRow, error: cuentaErr } = await supabase
              .from("cuentas")
              .select("id_plataforma")
              .eq("id_cuenta", venta.id_cuenta)
              .maybeSingle();
            if (cuentaErr) throw cuentaErr;
            if (cuentaRow?.id_plataforma) {
              const { data: platRow, error: platErr } = await supabase
                .from("plataformas")
                .select("usa_pines, por_pantalla, por_acceso, correo_cliente, clave_cliente")
                .eq("id_plataforma", cuentaRow.id_plataforma)
                .maybeSingle();
              if (platErr) throw platErr;
              platFlags = getPlatFlags(platRow || {});
            }
          }
          let usuarioNombre = "Vac√≠o";
          if (venta.id_usuario) {
            const { data: userRow } = await supabase
              .from("usuarios")
              .select("nombre, apellido")
              .eq("id_usuario", venta.id_usuario)
              .maybeSingle();
            if (userRow) {
              usuarioNombre =
                [userRow.nombre, userRow.apellido]
                  .filter(Boolean)
                  .join(" ")
                  .trim() || usuarioNombre;
            }
          }
          let perfil = "";
          let pin = "";
          if (venta.id_perfil) {
            const { data: perfilRow } = await supabase
              .from("perfiles")
              .select("n_perfil, pin")
              .eq("id_perfil", venta.id_perfil)
              .maybeSingle();
            perfil = perfilRow?.n_perfil ? `M${perfilRow.n_perfil}` : "";
            pin = perfilRow?.pin || "";
          }
          renderVentaResultado({
            usuarioNombre,
            perfil,
            pin,
            fecha_corte: venta.fecha_corte || "",
            id_cuenta: venta.id_cuenta,
            id_venta: venta.id_venta,
            platFlags,
          });
          return true;
        } catch (err) {
          console.error("buscar venta por id error", err);
          renderVentaResultado(null, true);
          return false;
        }
      };

      const renderPlataformaCuentas = (
        plataformaNombre,
        cuentas,
        ventas,
        usersMap,
        perfilesMap,
        subCtas = [],
        opts = {},
      ) => {
        if (!plataformaResultadosEl) return;
        if (!cuentas.length) {
          plataformaResultadosEl.innerHTML =
            '<p class="status">No hay cuentas para esta plataforma.</p>';
          plataformaResultadosEl.classList.remove("hidden");
          return;
        }
        const platFlags = getPlatFlags(opts.platFlags || {});
        const showPin = platFlags.showPin;
        const showPerfil = platFlags.showPerfil;
        const showClave = platFlags.showClave;
        const perfilHeader = getPerfilHeaderLabel(platFlags);
        const html = cuentas
          .map((cta) => {
            const ventasCta = (ventas || []).filter(
              (v) => v.id_cuenta === cta.id_cuenta,
            );
            const perfilesCuenta = (opts.perfilesAll || []).filter(
              (p) => p.id_cuenta === cta.id_cuenta,
            );
            const ventasSinPerfil = (opts.ventasSinPerfil || []).filter(
              (v) => v.id_cuenta === cta.id_cuenta,
            );
            const maxPerfilCuenta = perfilesCuenta.reduce((max, p) => {
              const n = Number(p.n_perfil) || 0;
              return Math.max(max, n);
            }, 0);
            const subRows =
              subCtas
                .filter((s) => s.id_cuenta === cta.id_cuenta)
                .map(
                  (s) => `
                  <tr>
                    <td>Sub-cuenta #${s.id_sub_cuenta}</td>
                    <td>${s.correo || ""}</td>
                    ${showClave ? `<td>${s.clave || ""}</td>` : ""}
                    ${showPin ? `<td>${s.pin || ""}</td>` : ""}
                  </tr>
                `,
                )
                .join("") || "";
            const rowsArr = [];
            perfilesCuenta.forEach((p) => {
              const venta = ventasCta.find((v) => v.id_perfil === p.id_perfil);
              const userInfo = venta ? usersMap[venta.id_usuario] || {} : {};
              const perfilCell = showPerfil
                ? `<td>${getPerfilCellLabel(platFlags, p.n_perfil, p.perfil_hogar)}</td>`
                : "";
              const pinCell = showPin ? `<td>${p.pin || ""}</td>` : "";
              rowsArr.push(`
                <tr>
                  <td>${venta ? `#${venta.id_venta ?? ""}` : ""}</td>
                  <td>${userInfo.nombre || ""}</td>
                  <td>${userInfo.correo || ""}</td>
                  ${perfilCell}
                  ${pinCell}
                  <td>${renderFechaEditCell(venta?.fecha_corte, venta?.id_venta)}</td>
                  <td></td>
                </tr>
              `);
            });
            ventasSinPerfil.forEach((v) => {
              const perfilValue =
                platFlags.porAcceso && !platFlags.porPantalla
                  ? "1 dispositivo"
                  : cta.clave || "";
              const perfilCell = showPerfil ? `<td>${perfilValue}</td>` : "";
              const pinCell = showPin ? "<td></td>" : "";
              rowsArr.push(`
                <tr>
                  <td>${v.id_venta ? `#${v.id_venta}` : ""}</td>
                  <td>${v.ocupadoPor || ""}</td>
                  <td>${cta.correo || ""}</td>
                  ${perfilCell}
                  ${pinCell}
                  <td>${renderFechaEditCell(v.fecha_corte, v.id_venta)}</td>
                  <td></td>
                </tr>
              `);
            });
            const colCount =
              5 + (showPerfil ? 1 : 0) + (showPin ? 1 : 0);
            const rows =
              rowsArr.join("") ||
              `<tr><td colspan="${colCount}">Sin ventas asignadas.</td></tr>`;
            let addRow = "";
            if (opts.masPerfiles) {
              const maxPerfiles =
                Number(opts.numMax) || Math.max(maxPerfilCuenta, 1);
              const nextPerfil = (maxPerfilCuenta % maxPerfiles || 0) + 1;
              addRow = `
                <tr>
                  <td colspan="${colCount}" style="text-align:center;">
                    <button type="button" class="btn-add-perfil" data-cuenta="${cta.id_cuenta}" data-next="${nextPerfil}" data-max="${maxPerfiles}" style="width:100%;">+</button>
                  </td>
                </tr>
              `;
            }
            return `
              <div class="cuenta-detalle" style="margin-top:12px;">
                <h3 class="cuenta-title">${cta.correo || "Cuenta"}</h3>
                <p><strong>Clave:</strong> ${cta.clave || "-"}</p>
                <div class="cuenta-table-wrap">
                  <table class="table-base">
                    <thead>
                      <tr>
                        <th>ID Venta</th>
                        <th>Cliente</th>
                        <th>Correo</th>
                        ${showPerfil ? `<th>${perfilHeader}</th>` : ""}
                        ${showPin ? "<th>PIN</th>" : ""}
                        <th>Fecha corte</th>
                        <th class="action-cell">Acci√≥n</th>
                      </tr>
                    </thead>
                    <tbody>${rows}${addRow}</tbody>
                  </table>
                </div>
                ${
                  subRows
                    ? `
                <div class="cuenta-table-wrap" style="margin-top:8px;">
                  <table class="table-base">
                    <thead>
                      <tr>
                        <th>Sub-cuenta</th>
                        <th>Correo</th>
                        ${showClave ? "<th>Clave</th>" : ""}
                        ${showPin ? "<th>PIN</th>" : ""}
                      </tr>
                    </thead>
                    <tbody>${subRows}</tbody>
                  </table>
                </div>`
                    : ""
                }
              </div>
            `;
          })
          .join("");
        plataformaResultadosEl.innerHTML = `
          <h3 style="margin-bottom:8px;">${plataformaNombre || "Plataforma"}</h3>
          ${html}
        `;
        decorateCopyColumns(plataformaResultadosEl);
        plataformaResultadosEl.classList.remove("hidden");
        plataformaResultadosEl.style.display = "block";
        plataformaResultadosEl.style.visibility = "visible";
      };

      const loadPlataformaCuentas = async (platId) => {
        if (!platId || !plataformaResultadosEl) return;
        plataformaResultadosEl.innerHTML =
          '<p class="status">Cargando cuentas...</p>';
        plataformaResultadosEl.classList.remove("hidden");
        try {
          const platIdNum = Number(platId);
          const [
            { data: cuentas, error: cErr },
            { data: platInfo, error: pErr },
          ] = await Promise.all([
            supabase
              .from("cuentas")
              .select("id_cuenta, correo, clave, inactiva")
              .eq("id_plataforma", platIdNum)
              .or("inactiva.is.null,inactiva.eq.false")
              .order("correo"),
            supabase
              .from("plataformas")
              .select(
                "nombre, mas_perfiles, num_max_dispositivos, por_acceso, por_pantalla, usa_pines, max_dig_pin, correo_cliente, clave_cliente",
              )
              .eq("id_plataforma", platIdNum)
              .maybeSingle(),
          ]);
          if (cErr) throw cErr;
          if (pErr) throw pErr;
          const subCtas = [];
          const cuentasActivas = (cuentas || []).filter(
            (c) => c.inactiva !== true,
          );
          const cuentaIds = cuentasActivas.map((c) => c.id_cuenta);
          let ventas = [];
          let usersMap = {};
          let perfilesMap = {};
          let perfilesAll = [];
          let ventasSinPerfil = [];
          if (cuentaIds.length) {
            const { data: ventasData, error: vErr } = await supabase
              .from("ventas")
              .select("id_venta, id_cuenta, id_perfil, id_usuario, fecha_corte")
              .in("id_cuenta", cuentaIds)
              .order("id_perfil", { ascending: true });
            if (vErr) throw vErr;
            ventas = ventasData || [];
            const { data: perfAll, error: perfAllErr } = await supabase
              .from("perfiles")
              .select("id_perfil, id_cuenta, n_perfil, pin, correo, perfil_hogar")
              .in("id_cuenta", cuentaIds)
              .order("n_perfil", { ascending: true });
            if (perfAllErr) throw perfAllErr;
            perfilesAll = perfAll || [];
            const userIds = Array.from(
              new Set(ventas.map((v) => v.id_usuario).filter(Boolean)),
            );
            if (userIds.length) {
              const { data: usersData, error: uErr } = await supabase
                .from("usuarios")
                .select("id_usuario, nombre, apellido, correo")
                .in("id_usuario", userIds);
              if (uErr) throw uErr;
              usersMap = (usersData || []).reduce((acc, u) => {
                acc[u.id_usuario] = {
                  nombre:
                    [u.nombre, u.apellido].filter(Boolean).join(" ").trim() ||
                    u.correo ||
                    "",
                  correo: u.correo || "",
                };
                return acc;
              }, {});
            }
            perfilesMap = (perfilesAll || []).reduce((acc, p) => {
              acc[p.id_perfil] = p;
              return acc;
            }, {});
            ventasSinPerfil = ventas
              .filter((v) => !v.id_perfil)
              .map((v) => ({
                id_venta: v.id_venta,
                fecha_corte: v.fecha_corte || "",
                ocupadoPor: v.id_usuario
                  ? usersMap[v.id_usuario]?.nombre ||
                    usersMap[v.id_usuario]?.correo ||
                    `Usuario ${v.id_usuario}`
                  : "Vac√≠o",
                id_usuario: v.id_usuario || null,
                id_cuenta: v.id_cuenta || null,
              }));
          }
          const subActivas =
            platIdNum === 1
              ? (subCtas || []).filter((s) => s.inactiva !== true)
              : [];
          renderPlataformaCuentas(
            platInfo?.nombre,
            cuentasActivas,
            ventas,
            usersMap,
            perfilesMap,
            subActivas,
            {
              masPerfiles: isTrue(platInfo?.mas_perfiles),
              numMax: platInfo?.num_max_dispositivos || null,
              perfilesAll,
              ventasSinPerfil,
              platFlags: platInfo || {},
            },
          );
        } catch (err) {
          console.error("load plataforma cuentas error", err);
          plataformaResultadosEl.innerHTML =
            '<p class="status">No se pudieron cargar las cuentas.</p>';
        }
      };

      const resetClienteBusqueda = () => {
        if (inputCliente) {
          inputCliente.value = "";
          delete inputCliente.dataset.selectedId;
        }
        setSearchMsg(clienteSearchMsg, "");
        renderSugerenciasClientes([], true);
      };

      const resetCuentaBusqueda = () => {
        if (inputCuenta) inputCuenta.value = "";
        setSearchMsg(cuentaSearchMsg, "");
        renderSugerencias([], true);
        detalleEl && (detalleEl.innerHTML = "");
        clearCorreoPlataformas();
      };

      inputCliente?.addEventListener("input", (e) => {
        setSearchMsg(clienteSearchMsg, "");
        if (e.target.value?.length) {
          resetCuentaBusqueda();
          clienteVentasEl && (clienteVentasEl.innerHTML = "");
          if (selectPlataforma) selectPlataforma.value = "";
          clearPlataformaResultados();
          toggleBusquedaViews(true);
        }
        buscarClientes(e.target.value || "");
      });

      inputCliente?.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          runClienteSearch();
        }
      });

      sugsClientes?.addEventListener("click", (e) => {
        const btn = e.target.closest("button");
        if (!btn) return;
        setSearchMsg(clienteSearchMsg, "");
        const texto = btn.textContent || "";
        if (inputCliente) {
          const nameOnly = texto.replace(/\s*\(.+\)\s*$/, "").trim();
          inputCliente.value = nameOnly;
        }
        renderSugerenciasClientes([], true);
        renderSugerencias([], true);
        const userId = btn.dataset.id;
        if (userId) {
          inputCliente.dataset.selectedId = userId;
          loadVentasByCliente(userId);
        }
      });

      inputCuenta?.addEventListener("input", (e) => {
        setSearchMsg(cuentaSearchMsg, "");
        if (e.target.value?.length) {
          resetClienteBusqueda();
          clienteVentasEl && (clienteVentasEl.innerHTML = "");
          if (selectPlataforma) selectPlataforma.value = "";
          clearPlataformaResultados();
          clearCorreoPlataformas();
          toggleBusquedaViews(true);
        }
        renderSugerenciasClientes([], true);
        buscarCuentas(e.target.value || "");
      });

      document.addEventListener("click", (e) => {
        const insideCuentas =
          sugs?.contains(e.target) || inputCuenta?.contains(e.target);
        const insideClientes =
          sugsClientes?.contains(e.target) || inputCliente?.contains(e.target);
        if (!insideCuentas) renderSugerencias([], true);
        if (!insideClientes) renderSugerenciasClientes([], true);
      });

      inputVentaId?.addEventListener("input", () => {
        setSearchMsg(ventaSearchMsg, "");
      });

      btnBuscarVenta?.addEventListener("click", async (e) => {
        e.preventDefault();
        setSearchMsg(ventaSearchMsg, "");
        const found = await buscarVentaPorId(inputVentaId?.value || "");
        if (!found) {
          setSearchMsg(ventaSearchMsg, "No se encontraron coincidencias");
        }
      });

      inputVentaId?.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          setSearchMsg(ventaSearchMsg, "");
          buscarVentaPorId(inputVentaId?.value || "").then((found) => {
            if (!found) {
              setSearchMsg(ventaSearchMsg, "No se encontraron coincidencias");
            }
          });
        }
      });

      detalleEl?.addEventListener("click", async (e) => {
        const addBtn = e.target.closest(".btn-add-perfil");
        if (addBtn) {
          const cuentaId = addBtn.dataset.cuenta;
          const next = Number(addBtn.dataset.next) || 1;
          try {
            const { error } = await supabase
              .from("perfiles")
              .insert({
                id_cuenta: cuentaId,
                n_perfil: next,
                ocupado: false,
                perfil_hogar: false,
              });
            if (error) throw error;
            if (cuentaId) loadCuentaDetalle(cuentaId);
          } catch (err) {
            console.error("add perfil error", err);
            alert("No se pudo agregar el perfil.");
          }
          return;
        }
        const convertBtn = e.target.closest(".btn-convertir-perfiles");
        if (convertBtn) {
          if (!currentCuentaDetalle) {
            alert("No se pudo obtener la cuenta actual.");
            return;
          }
          if (currentCuentaDetalle.ocupado !== false) {
            alert("La cuenta debe estar desocupada para convertirla.");
            return;
          }
          if ((currentCuentaDetalle.perfiles || []).length) {
            alert("La cuenta ya tiene perfiles asociados.");
            return;
          }
          const totalPerfiles = Math.max(
            1,
            Number(currentCuentaDetalle.num_max_dispositivos) || 1,
          );
          const usaPines = currentCuentaDetalle.usa_pines === true;
          const maxDigPin = Number(currentCuentaDetalle.max_dig_pin) || 0;
          const perfiles = Array.from({ length: totalPerfiles }).map(
            (_, idx) => {
              let pinVal = null;
              if (usaPines) {
                const digits = Math.max(1, maxDigPin);
                const min = digits === 1 ? 0 : Math.pow(10, digits - 1);
                const max = Math.pow(10, digits) - 1;
                pinVal = Math.floor(Math.random() * (max - min + 1)) + min;
              }
              const isHogar =
                Number(currentCuentaDetalle.id_plataforma) === 1 && idx === 0;
              return {
                id_cuenta: currentCuentaDetalle.id_cuenta,
                n_perfil: idx + 1,
                ocupado: false,
                pin: pinVal,
                perfil_hogar: isHogar,
                correo: null,
              };
            },
          );
          try {
            const { error: updErr } = await supabase
              .from("cuentas")
              .update({ venta_perfil: true, venta_miembro: false })
              .eq("id_cuenta", currentCuentaDetalle.id_cuenta);
            if (updErr) throw updErr;
            const { error: perfErr } = await supabase
              .from("perfiles")
              .insert(perfiles);
            if (perfErr) throw perfErr;
            alert("Cuenta convertida a perfiles.");
            loadCuentaDetalle(currentCuentaDetalle.id_cuenta);
          } catch (err) {
            console.error("convertir cuenta perfiles error", err);
            alert("No se pudo convertir la cuenta.");
          }
          return;
        }
      });

      selectPlataforma?.addEventListener("change", () => {
        const val = selectPlataforma.value;
        renderSugerencias([], true);
        renderSugerenciasClientes([], true);
        resetClienteBusqueda();
        resetCuentaBusqueda();
        if (!val) {
          clearPlataformaResultados();
          toggleBusquedaViews(true);
          return;
        }
        toggleBusquedaViews(false);
        loadPlataformaCuentas(val);
      });

      plataformaResultadosEl?.addEventListener("click", async (e) => {
        const copyEl = e.target.closest(".copyable-text");
        if (copyEl) {
          copyWithToast(copyEl);
          return;
        }
        const addBtn = e.target.closest(".btn-add-perfil");
        if (!addBtn) return;
        const cuentaId = addBtn.dataset.cuenta;
        const next = Number(addBtn.dataset.next) || 1;
        try {
          const { error } = await supabase
            .from("perfiles")
            .insert({
              id_cuenta: cuentaId,
              n_perfil: next,
              ocupado: false,
              perfil_hogar: false,
            });
          if (error) throw error;
          if (selectPlataforma?.value) {
            loadPlataformaCuentas(selectPlataforma.value);
          }
        } catch (err) {
          console.error("add perfil plataforma view error", err);
          alert("No se pudo agregar el perfil.");
        }
      });

      // Inicializar modal de nuevo cliente
      initModalNuevoCliente();

      const renderVentasCliente = (grouped) => {
        if (!clienteVentasEl) return;
        if (!grouped || !Object.keys(grouped).length) {
          clienteVentasEl.innerHTML = "";
          return;
        }
        const blocks = Object.entries(grouped).map(([platName, groupVal]) => {
          const rows = Array.isArray(groupVal)
            ? groupVal
            : groupVal?.rows || [];
          const flags = Array.isArray(groupVal)
            ? getPlatFlags(rows[0]?.platFlags || {}, { fallbackAll: true })
            : groupVal?.flags || getPlatFlags({}, { fallbackAll: true });
          const showPerfil = flags.showPerfil ?? true;
          const showClave = flags.showClave ?? true;
          const perfilHeader = getPerfilHeaderLabel(flags);
          const clienteSeleccionadoEncoded = encodeURIComponent(
            cleanClienteName(inputCliente?.value || ""),
          );
          const trs = rows
            .map((r) => {
              const correo = r.correo || "";
              const correoSafe = correo.replace(/"/g, "&quot;");
              const correoCell = correo
                ? `<span class="copyable-text" data-clipboard="${correoSafe}">${correo}</span>`
                : "-";
              const alertBtn = correo
                ? `<button type="button" class="cliente-alert" data-correo="${correoSafe}" title="Ver cuenta">!</button>`
                : "";
              const perfilLabel = showPerfil
                ? getPerfilCellLabel(flags, r.n_perfil, r.perfil_hogar)
                : "";
              const perfilCell = showPerfil ? `<td>${perfilLabel}</td>` : "";
              const claveCell = showClave ? `<td>${r.clave || ""}</td>` : "";
              const estadoInfo = getEstadoVenta({
                fecha_corte: r.fecha_corte,
                suspendido: r.suspendido === true,
              });
              return `
              <tr>
                <td>${r.id_venta ?? ""}</td>
                <td>
                  ${correoCell}
                  ${alertBtn}
                </td>
                ${claveCell}
                ${perfilCell}
                <td>${renderFechaEditCell(r.fecha_corte, r.id_venta)}</td>
                <td class="estado-cell ${estadoInfo.className}">${estadoInfo.label}</td>
                <td>${renderPrecioVentaCell(r.id_venta, r.id_precio)}</td>
                <td class="action-cell">
                  <button class="btn-primary btn-reemplazar-row"
                    data-cuenta="${r.id_cuenta ?? ""}"
                    data-perfil="${r.id_perfil ?? ""}"
                    data-idventa="${r.id_venta ?? ""}"
                    data-cliente="${clienteSeleccionadoEncoded}"
                  >Reemplazar</button>
                  <button class="btn-copy" data-copy="${encodeURIComponent(
                    buildServiceCopyText({
                      plataforma: platName,
                      idVenta: r.id_venta,
                      correo: r.correo,
                      clave: r.clave,
                      nPerfil: r.n_perfil,
                      pin: r.pin,
                      fechaCorte: r.fecha_corte,
                      porAcceso: r.por_acceso,
                      usaPines: r.usa_pines,
                      ventaPerfil: r.venta_perfil,
                      ventaMiembro: r.venta_miembro,
                      idPlataforma: r.id_plataforma,
                      perfilHogar: r.perfil_hogar,
                      isSubCuenta: r.es_subcuenta,
                    }),
                  )}">Copiar</button>
                  ${
                    Number(r.id_plataforma) === 9 &&
                    r.id_venta &&
                    (r.venta_miembro === true || r.venta_perfil === true)
                      ? `<button class="btn-outline btn-reactivar-venta" data-idventa="${r.id_venta}">Reactivar</button>`
                      : ""
                  }
                  <button class="btn-delete" data-id-venta="${r.id_venta ?? ""}">Eliminar</button>
                </td>
              </tr>
            `;
            })
            .join("");
          return `
            <div class="ventas-bloque">
              <h3>${platName}</h3>
              <div class="ventas-table-wrap">
                <table class="table-base">
                  <thead>
                    <tr>
                      <th>ID de Venta</th>
                      <th>Correo</th>
                      ${showClave ? "<th>Clave</th>" : ""}
                      ${showPerfil ? `<th>${perfilHeader}</th>` : ""}
                      <th>Fecha de Corte</th>
                      <th>Estado</th>
                      <th>ID Precio</th>
                      <th class="action-cell">Acci√≥n</th>
                    </tr>
                  </thead>
                  <tbody>${trs}</tbody>
                </table>
              </div>
            </div>
          `;
        });
        clienteVentasEl.innerHTML = blocks.join("");
        decorateCopyColumns(clienteVentasEl);
      };

      const loadVentasByCliente = async (idUsuario) => {
        if (!idUsuario) return;
        if (detalleEl) detalleEl.innerHTML = "";
        clearCorreoPlataformas();
        try {
          const { data: ventas, error } = await supabase
            .from("ventas")
            .select(
              "id_venta, id_cuenta, id_perfil, fecha_corte, id_usuario, id_precio, correo_miembro, clave_miembro, suspendido",
            )
            .eq("id_usuario", idUsuario);
          if (error) throw error;
          const cuentasIds = [
            ...new Set((ventas || []).map((v) => v.id_cuenta).filter(Boolean)),
          ];
          const perfilesIds = [
            ...new Set((ventas || []).map((v) => v.id_perfil).filter(Boolean)),
          ];
          let cuentaMap = {};
          if (cuentasIds.length) {
            const { data: cuentas } = await supabase
              .from("cuentas")
              .select(
                "id_cuenta, correo, clave, id_plataforma, venta_perfil, venta_miembro, cuenta_madre",
              )
              .in("id_cuenta", cuentasIds);
            cuentaMap =
              (cuentas || []).reduce((acc, c) => {
                acc[c.id_cuenta] = c;
                return acc;
              }, {}) || {};
          }
          let perfilMap = {};
          if (perfilesIds.length) {
            const { data: perfiles } = await supabase
              .from("perfiles")
              .select("id_perfil, n_perfil, pin, perfil_hogar")
              .in("id_perfil", perfilesIds);
            perfilMap =
              (perfiles || []).reduce((acc, p) => {
                acc[p.id_perfil] = {
                  n_perfil: p.n_perfil,
                  pin: p.pin,
                  perfil_hogar: p.perfil_hogar === true,
                };
                return acc;
              }, {}) || {};
          }
          let precioMap = {};
          const precioIds = [
            ...new Set((ventas || []).map((v) => v.id_precio).filter(Boolean)),
          ];
          if (precioIds.length) {
            const { data: precios } = await supabase
              .from("precios")
              .select("id_precio, id_plataforma")
              .in("id_precio", precioIds);
            precioMap =
              (precios || []).reduce((acc, p) => {
                acc[p.id_precio] = p.id_plataforma;
                return acc;
              }, {}) || {};
          }
          let plataformaMap = {};
          const platIds = [
            ...new Set(
              (ventas || [])
                .map(
                  (v) =>
                    cuentaMap[v.id_cuenta]?.id_plataforma ||
                    precioMap[v.id_precio],
                )
                .filter(Boolean),
            ),
          ];
          if (platIds.length) {
            const { data: plats } = await supabase
              .from("plataformas")
              .select(
                "id_plataforma, nombre, por_acceso, por_pantalla, usa_pines, correo_cliente, clave_cliente",
              )
              .in("id_plataforma", platIds);
            plataformaMap =
              (plats || []).reduce((acc, p) => {
                acc[p.id_plataforma] = {
                  nombre: p.nombre || `Plataforma ${p.id_plataforma}`,
                  por_acceso: p.por_acceso,
                  usa_pines: p.usa_pines,
                  por_pantalla: p.por_pantalla,
                  correo_cliente: p.correo_cliente,
                  clave_cliente: p.clave_cliente,
                };
                return acc;
              }, {}) || {};
          }
          const grouped = {};
          (ventas || []).forEach((v) => {
            const cuenta = cuentaMap[v.id_cuenta] || {};
            const platId =
              cuenta.id_plataforma || precioMap[v.id_precio] || "desconocida";
            const platInfo = plataformaMap[platId] || {};
            const platName = platInfo.nombre || `Plataforma ${platId}`;
            if (!grouped[platName]) {
              grouped[platName] = {
                rows: [],
                flags: getPlatFlags(platInfo || {}, { fallbackAll: true }),
              };
            }
            const perfilInfo = perfilMap[v.id_perfil] || {};
            const isCuentaMadre = cuenta.cuenta_madre === true;
            const correoVenta = isCuentaMadre
              ? v.correo_miembro || ""
              : cuenta.correo || "";
            const claveVenta = isCuentaMadre
              ? v.clave_miembro || ""
              : cuenta.clave || "";
            grouped[platName].rows.push({
              id_venta: v.id_venta,
              id_cuenta: v.id_cuenta,
              id_perfil: v.id_perfil,
              correo: correoVenta,
              clave: claveVenta,
              n_perfil: perfilInfo.n_perfil ?? "",
              pin: perfilInfo.pin ?? "",
              fecha_corte: v.fecha_corte || "",
              suspendido: v.suspendido === true,
              id_precio: v.id_precio ?? null,
              id_plataforma: platId,
              perfil_hogar: perfilInfo.perfil_hogar,
              es_subcuenta: false,
              por_acceso: !!platInfo.por_acceso,
              usa_pines: !!platInfo.usa_pines,
              venta_perfil: cuenta.venta_perfil,
              venta_miembro: cuenta.venta_miembro,
              platFlags: platInfo || {},
            });
          });
          renderVentasCliente(grouped);
        } catch (err) {
          console.error("loadVentasByCliente error", err);
          if (clienteVentasEl)
            clienteVentasEl.innerHTML =
              '<p class="status">No se pudo cargar ventas.</p>';
        }
      };

      const updateVentaIdPrecio = async (input) => {
        if (!input) return;
        const ventaId = Number(input.dataset.idVenta || input.dataset.idventa || 0);
        if (!Number.isFinite(ventaId) || ventaId <= 0) return;
        const previousRaw = String(input.dataset.prev || "").trim();
        const raw = String(input.value || "").trim();
        let idPrecio = null;
        if (raw) {
          if (!/^\d+$/.test(raw)) {
            alert("El ID Precio debe ser un n√∫mero entero.");
            input.value = previousRaw;
            return;
          }
          idPrecio = Number(raw);
          if (!Number.isFinite(idPrecio) || idPrecio <= 0) {
            alert("El ID Precio debe ser mayor a 0.");
            input.value = previousRaw;
            return;
          }
        }
        const previousVal = previousRaw ? Number(previousRaw) : null;
        if (previousVal === idPrecio) return;

        input.disabled = true;
        input.classList.add("is-saving");
        try {
          const { error } = await supabase
            .from("ventas")
            .update({ id_precio: idPrecio })
            .eq("id_venta", ventaId);
          if (error) throw error;
          input.dataset.prev = idPrecio ? String(idPrecio) : "";
          input.value = input.dataset.prev;
        } catch (err) {
          console.error("update id_precio venta error", err);
          alert("No se pudo actualizar el ID Precio.");
          input.value = previousRaw;
        } finally {
          input.disabled = false;
          input.classList.remove("is-saving");
        }
      };

      const bindPrecioInputEvents = (rootEl) => {
        if (!rootEl) return;
        rootEl.addEventListener("change", (e) => {
          const input = e.target.closest(".precio-id-input");
          if (!input) return;
          updateVentaIdPrecio(input);
        });
        rootEl.addEventListener("keydown", (e) => {
          const input = e.target.closest(".precio-id-input");
          if (!input) return;
          if (e.key === "Enter") {
            e.preventDefault();
            input.blur();
          }
        });
      };

      bindPrecioInputEvents(clienteVentasEl);
      bindPrecioInputEvents(detalleEl);

      clienteVentasEl?.addEventListener("click", async (e) => {
        const copyEl = e.target.closest(".copyable-text");
        if (copyEl) {
          copyWithToast(copyEl);
          return;
        }
        const alertBtn = e.target.closest(".cliente-alert");
        if (alertBtn) {
          const correo = alertBtn.dataset.correo || "";
          if (correo) {
            window.open(`admin_cuentas.html?correo=${encodeURIComponent(correo)}`, "_blank");
          }
          return;
        }
        const reactBtn = e.target.closest(".btn-reactivar-venta");
        if (reactBtn) {
          const ventaId = reactBtn.dataset.idventa || reactBtn.dataset.idVenta || "";
          if (!ventaId) return;
          try {
            const { error } = await supabase
              .from("ventas")
              .update({ pendiente: true })
              .eq("id_venta", ventaId);
            if (error) throw error;
            reactBtn.disabled = true;
            reactBtn.textContent = "Reactivado";
          } catch (err) {
            console.error("reactivar venta cliente view error", err);
            alert("No se pudo reactivar la venta.");
          }
          return;
        }
        const replBtn = e.target.closest(".btn-reemplazar-row");
        if (replBtn) {
          openReemplazoConfirmModal(replBtn);
          return;
        }
        const btn = e.target.closest(".btn-copy");
        const delBtn = e.target.closest(".btn-delete");
        if (btn) {
          const text = decodeURIComponent(btn.dataset.copy || "");
          if (!text) return;
          try {
            navigator.clipboard.writeText(text);
          } catch (_err) {
            const ta = document.createElement("textarea");
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand("copy");
            ta.remove();
          }
          return;
        }
        if (delBtn) {
          deleteTargetId = delBtn.dataset.idVenta || null;
          deleteTargetRow = delBtn.closest("tr");
          if (modalDelete) modalDelete.classList.remove("hidden");
        }
      });

      const closeDeleteModal = () => {
        deleteTargetId = null;
        deleteTargetRow = null;
        modalDelete?.classList.add("hidden");
      };

      btnCancelDelete?.addEventListener("click", closeDeleteModal);
      btnCloseDelete?.addEventListener("click", closeDeleteModal);
      modalDelete?.addEventListener("click", (e) => {
        if (e.target.classList.contains("modal-backdrop")) closeDeleteModal();
      });

      btnConfirmDelete?.addEventListener("click", async () => {
        if (!deleteTargetId) return;
        try {
          const { error } = await supabase
            .from("ventas")
            .delete()
            .eq("id_venta", deleteTargetId);
          if (error) throw error;
          if (deleteTargetRow) {
            deleteTargetRow.remove();
          } else {
            document
              .querySelectorAll(`[data-id-venta="${deleteTargetId}"]`)
              .forEach((el) => {
                const row = el.closest("tr");
                if (row) row.remove();
              });
          }
        } catch (err) {
          console.error("delete venta error", err);
        } finally {
          closeDeleteModal();
        }
      });

      inputCuenta?.addEventListener("focus", () => {
        // no force show, suggestions appear only on input
      });

      btnIrAgregar?.addEventListener("click", () => {
        window.location.href = "agregar_servicios.html";
      });

      sugs?.addEventListener("click", (e) => {
        const btn = e.target.closest("button");
        if (!btn || !inputCuenta) return;
        setSearchMsg(cuentaSearchMsg, "");
        inputCuenta.value = btn.dataset.correo || "";
        renderSugerencias([], true);
        if (btn.dataset.correo) {
          loadCuentaDetalleByCorreo(btn.dataset.correo);
        }
      });

      correoPlataformasEl?.addEventListener("click", (e) => {
        const btn = e.target.closest(".correo-tab-btn");
        if (!btn) return;
        const cuentaId = btn.dataset.cuenta;
        if (!cuentaId) return;
        if (String(currentCuentaId) === String(cuentaId)) return;
        correoPlataformasEl
          .querySelectorAll(".correo-tab-btn")
          .forEach((b) => b.classList.toggle("active", b === btn));
        loadCuentaDetalle(cuentaId);
      });

      ventaResultadoEl?.addEventListener("click", (e) => {
        const btn = e.target.closest(".btn-ver-cuenta");
        if (!btn) return;
        const cuentaId = btn.dataset.cuenta;
        if (cuentaId) {
          clearCorreoPlataformas();
          loadCuentaDetalle(cuentaId);
        }
      });

      const loadCuentaCanva = async () => {
        if (!detalleEl) return;
        detalleEl.style.display = "block";
        detalleEl.innerHTML = '<p class="status">Cargando cuenta Canva...</p>';
        try {
          const { data: cuenta, error: cErr } = await supabase
            .from("cuentas")
            .select(
              "id_cuenta, correo, clave, fecha_corte, inactiva, id_plataforma",
            )
            .eq("id_cuenta", 688)
            .maybeSingle();
          if (cErr) throw cErr;
          if (!cuenta?.id_cuenta) {
            detalleEl.innerHTML =
              '<p class="status">No hay cuenta registrada para Canva.</p>';
            return;
          }
          let canvaFlags = { showPerfil: true, showClave: true, showPin: true };
          if (cuenta.id_plataforma) {
            const { data: platInfo, error: platErr } = await supabase
              .from("plataformas")
              .select("usa_pines, por_pantalla, por_acceso, correo_cliente, clave_cliente")
              .eq("id_plataforma", cuenta.id_plataforma)
              .maybeSingle();
            if (platErr) throw platErr;
            canvaFlags = getPlatFlags(platInfo || {}, { fallbackAll: true });
          }
          currentCanvaCuenta = cuenta;
          currentCanvaFlags = canvaFlags;
          const { data: ventas, error: vErr } = await supabase
            .from("ventas")
            .select("id_venta, id_usuario, id_perfil, fecha_corte, suspendido, id_precio, correo_miembro")
            .eq("id_cuenta", cuenta.id_cuenta)
            .not("id_perfil", "is", null)
            .order("id_venta", { ascending: true });
          if (vErr) throw vErr;

          const perfilIds = Array.from(
            new Set((ventas || []).map((v) => v.id_perfil).filter(Boolean))
          );
          let perfilesMap = {};
          if (perfilIds.length) {
            const { data: perfiles, error: pErr } = await supabase
              .from("perfiles")
              .select("id_perfil, n_perfil")
              .in("id_perfil", perfilIds);
            if (pErr) throw pErr;
            perfilesMap = (perfiles || []).reduce((acc, p) => {
              acc[p.id_perfil] = p;
              return acc;
            }, {});
          }

          const userIds = Array.from(
            new Set((ventas || []).map((v) => v.id_usuario).filter(Boolean))
          );
          let usersMap = {};
          if (userIds.length) {
            const { data: users, error: uErr } = await supabase
              .from("usuarios")
              .select("id_usuario, nombre, apellido")
              .in("id_usuario", userIds);
            if (uErr) throw uErr;
            usersMap = (users || []).reduce((acc, u) => {
              acc[u.id_usuario] =
                [u.nombre, u.apellido].filter(Boolean).join(" ").trim() ||
                `Usuario ${u.id_usuario}`;
              return acc;
            }, {});
          }

          const rows = (ventas || []).map((v) => {
            const estadoInfo = getEstadoVenta({
              suspendido: v.suspendido === true,
              fecha_corte: v.fecha_corte,
            });
            const perfilInfo = perfilesMap[v.id_perfil] || {};
            const cliente = usersMap[v.id_usuario] || "-";
            const copyText = `Correo: ${v.correo_miembro || ""}`;
            const showPerfilId = canvaFlags.porPantalla === true;
            const perfilIdCell = showPerfilId
              ? `<td>${v.id_perfil || ""}</td>`
              : "";
            const perfilCell = canvaFlags.showPerfil
              ? `<td>${getPerfilCellLabel(canvaFlags, perfilInfo.n_perfil)}</td>`
              : "";
            return `
              <tr data-id-venta="${v.id_venta || ""}">
                ${perfilIdCell}
                ${perfilCell}
                <td>${cliente}</td>
                <td>${v.correo_miembro || "-"}</td>
                <td>${renderFechaEditCell(v.fecha_corte, v.id_venta)}</td>
                <td class="estado-cell ${estadoInfo.className}">${estadoInfo.label}</td>
                <td>${renderPrecioVentaCell(v.id_venta, v.id_precio)}</td>
                <td class="action-cell">
                  <button type="button" class="btn-outline btn-copy-row" data-copy="${encodeURIComponent(copyText)}">Copiar</button>
                  ${
                    isSuperadmin && v.id_venta
                      ? `<button type="button" class="btn-delete-venta" data-id-venta="${v.id_venta}">Eliminar</button>`
                      : ""
                  }
                </td>
              </tr>
            `;
          });
          const colCountCanva =
            6 + (canvaFlags.showPerfil ? 1 : 0) + (canvaFlags.porPantalla ? 1 : 0);
          const body = rows.length
            ? rows.join("")
            : `<tr><td colspan="${colCountCanva}" class="status">Sin perfiles registrados.</td></tr>`;

          detalleEl.innerHTML = `
            <h3 class="cuenta-title">Cuenta Canva</h3>
            <div class="cuenta-meta">
              <p><strong>Correo:</strong> ${cuenta.correo || "-"}</p>
              <p><strong>Clave:</strong> ${cuenta.clave || "-"}</p>
              <p><strong>Fecha de corte:</strong> ${formatDDMMYYYY(cuenta.fecha_corte) || "-"}</p>
            </div>
            <div class="cuenta-table-wrap">
              <table class="table-base">
                <thead>
                  <tr>
                    ${canvaFlags.porPantalla ? "<th>ID Perfil</th>" : ""}
                    ${canvaFlags.showPerfil ? `<th>${getPerfilHeaderLabel(canvaFlags)}</th>` : ""}
                    <th>Cliente</th>
                    <th>Correo</th>
                    <th>Fecha de corte</th>
                    <th>Estado</th>
                    <th>ID Precio</th>
                    <th class="action-cell">Acci√≥n</th>
                  </tr>
                </thead>
                <tbody>${body}</tbody>
              </table>
            </div>
          `;
          decorateCopyColumns(detalleEl);
        } catch (err) {
          console.error("load cuenta canva error", err);
          detalleEl.innerHTML =
            '<p class="status">No se pudo cargar la cuenta Canva.</p>';
        }
      };

      btnCanva?.addEventListener("click", () => {
        loadCuentaCanva();
      });

      const renderDetalle = (info) => {
        currentCuentaId = info.id_cuenta || null;
        if (!detalleEl) return;
        detalleEl.style.display = "block";
        if (!info) {
          detalleEl.style.removeProperty("--platform-color");
          detalleEl.innerHTML = '<p class="status">Sin datos.</p>';
          return;
        }
        const color1 = info.plataformaColor1 || "";
        if (color1) {
          detalleEl.style.setProperty("--platform-color", color1);
        } else {
          detalleEl.style.removeProperty("--platform-color");
        }

        const colMode = info.colMode || "ocupado";
        const showHogar = info.showHogar;
        const isCuentaMadre = info.cuenta_madre === true;
        const flags = getPlatFlags(info);
        const showPin = flags.showPin;
        const showPerfil = flags.showPerfil;
        const showClaveCliente = flags.showClave;
        const perfilHeader = getPerfilHeaderLabel(flags);

        let thead = "";
        if (isCuentaMadre) {
          thead = `<tr>
            <th>ID Venta</th>
            ${showPerfil ? `<th>${perfilHeader}</th>` : ""}
            <th>Cliente</th>
            <th>Correo</th>
            ${showClaveCliente ? "<th>Clave</th>" : ""}
            <th>Fecha de corte</th>
            <th>Estado</th>
            <th>ID Precio</th>
            <th class="action-cell">Acci√≥n</th>
          </tr>`;
        } else if (colMode === "perfil") {
          thead = `<tr>
            <th>Venta</th>
            ${showPerfil ? `<th>${perfilHeader}</th>` : ""}
            ${showPin ? "<th>PIN</th>" : ""}
            ${showHogar ? "<th>Perfil hogar</th>" : ""}
            <th>Ocupado por</th>
            <th>Fecha de corte</th>
            <th>Estado</th>
            <th>ID Precio</th>
            <th class="action-cell">Acci√≥n</th>
          </tr>`;
        } else if (colMode === "miembro") {
          thead = `<tr>
            <th>ID Venta</th>
            ${showPin ? "<th>PIN</th>" : ""}
            <th>Ocupado por</th>
            <th>Fecha de corte</th>
            <th>Estado</th>
            <th>ID Precio</th>
            <th class="action-cell">Acci√≥n</th>
          </tr>`;
        } else {
          thead = `<tr>
            <th>ID Venta</th>
            <th>Cliente</th>
            <th>Fecha de corte</th>
            <th>Estado</th>
            <th>ID Precio</th>
            <th class="action-cell">Acciones</th>
          </tr>`;
        }

        let rows = [...(info.perfiles || [])];
        if (isCuentaMadre) {
          rows = [...(info.madreRows || [])];
        }
        // Cuentas completas: mostrar siempre la tabla basada en ventas (no en perfiles).
        if (colMode === "ocupado" && !isCuentaMadre) {
          rows = (Array.isArray(info.ventasCuenta) ? info.ventasCuenta : []).map((v) => ({
            perfil: "",
            pin: "",
            hogar: false,
            id_perfil: null,
            n_raw: null,
            reemplazado: false,
            ocupadoPor:
              info.usuariosCuenta?.[v.id_usuario] ||
              (v.id_usuario ? `Usuario ${v.id_usuario}` : "-"),
            id_venta: v.id_venta,
            fecha_corte: v.fecha_corte || "",
            fecha_corte_fmt: formatDDMMYYYY(v.fecha_corte) || "",
            suspendido: v.suspendido === true,
            id_precio: v.id_precio ?? null,
          }));
        }
        if (colMode === "miembro" && rows.length === 0) {
          rows.push({
            perfil: "",
            pin: "",
            hogar: false,
            id_perfil: null,
            n_raw: null,
            reemplazado: false,
            ocupadoPor: "",
            id_venta: null,
            fecha_corte: "",
            fecha_corte_fmt: "",
            suspendido: false,
            id_precio: null,
          });
        }
        if (colMode === "ocupado" && !isCuentaMadre && rows.length === 0) {
          rows.push({
            perfil: "",
            pin: "",
            hogar: false,
            id_perfil: null,
            n_raw: null,
            reemplazado: false,
            ocupadoPor: "",
            id_venta: null,
            fecha_corte: "",
            fecha_corte_fmt: "",
            suspendido: false,
            id_precio: null,
          });
        }
        if (colMode === "miembro" && !isCuentaMadre) {
          const fechaReferencia = info.fecha_corte_display || info.fecha_corte || "";
          if (fechaReferencia) {
            rows = rows.map((row) => ({
              ...row,
              fecha_corte: fechaReferencia,
              fecha_corte_fmt: formatDDMMYYYY(fechaReferencia) || "",
            }));
          }
        }

        const getEstado = (row) => getEstadoVenta(row);

        const tbodyRows = rows
          .map((p) => {
            const ocupadoRaw = p.ocupadoPor || "";
            const ocupadoEmpty =
              !ocupadoRaw || ocupadoRaw === "Vac√≠o" || ocupadoRaw === "-";
            const clienteNombre = cleanClienteName(
              p.reemplazado ? "" : ocupadoRaw,
            );
            const clienteNombreEncoded = encodeURIComponent(clienteNombre);
            const ocupadoCell = ocupadoEmpty
              ? '<input type="text" class="ocupado-input" placeholder="Nombre y apellido" list="sugs-ocupado" />'
              : ocupadoRaw;
            const estado = getEstado(p);
            if (isCuentaMadre) {
              const cliente = p.cliente || "-";
              const correo = p.correo || "";
              const clave = p.clave || "";
              const fecha = p.fecha_corte || "";
              const canInlineAssign = !p.id_venta;
              const clienteCell = canInlineAssign
                ? '<input type="text" class="ocupado-input" placeholder="Nombre y apellido" list="sugs-ocupado" />'
                : cliente || "-";
              const correoCell = canInlineAssign
                ? '<input type="text" class="correo-input" placeholder="Correo" />'
                : correo || "-";
              const claveCell = showClaveCliente
                ? canInlineAssign
                  ? '<input type="text" class="clave-input" placeholder="Clave" />'
                  : clave || "-"
                : "";
              const accesoCell = showPerfil
                ? `<td>${getPerfilCellLabel(flags, p.n_raw, p.hogar)}</td>`
                : "";
              const fechaCell = canInlineAssign
                ? renderFechaInlineCell("", `data-perfil="${p.id_perfil || ""}"`)
                : renderFechaEditCell(fecha, p.id_venta);
              const estadoRow = getEstado({
                suspendido: p.suspendido === true,
                fecha_corte: fecha,
              });
              const copyText = buildServiceCopyText({
                plataforma: info.plataformaNombre,
                idVenta: p.id_venta,
                correo,
                clave,
                nPerfil: p.n_raw,
                pin: p.pin,
                fechaCorte: fecha,
                porAcceso: info.por_acceso,
                usaPines: info.usa_pines,
                ventaPerfil: info.venta_perfil,
                ventaMiembro: info.venta_miembro,
                idPlataforma: info.plataformaId,
                perfilHogar: p.hogar,
                isSubCuenta: false,
              });
              const accionButtons = canInlineAssign
                ? `
                  <button type="button" class="btn-primary btn-registrar-servicio btn-disabled" disabled
                    data-perfil="${p.id_perfil || ""}"
                  >Asignar servicio</button>
                `
                : `
                  <button type="button" class="btn-outline btn-copy-row" data-copy="${encodeURIComponent(copyText)}">Copiar</button>
                  ${
                    info.isPlat9 && p.id_venta
                      ? `<button type="button" class="btn-outline btn-reactivar-venta" data-idventa="${p.id_venta || ""}">Reactivar</button>`
                      : ""
                  }
                  ${
                    info.isPlat9 && p.id_venta
                      ? `<button type="button" class="btn-outline btn-cambiar-madre" data-idventa="${p.id_venta || ""}" data-perfil="${p.id_perfil || ""}" data-cuenta="${info.id_cuenta || ""}">Cambiar cuenta madre</button>`
                      : ""
                  }
                  <button type="button" class="btn-outline btn-registrar-servicio btn-disabled" disabled
                    data-perfil="${p.id_perfil || ""}"
                  >Registrar servicio</button>
                  ${
                    isSuperadmin && p.id_venta
                      ? `<button type="button" class="btn-delete-venta" data-id-venta="${p.id_venta}">Eliminar</button>`
                      : ""
                  }
                `;
              return `<tr>
                <td>${p.id_venta ? `#${p.id_venta}` : ""}</td>
                ${accesoCell}
                <td>${clienteCell}</td>
                <td>${correoCell}</td>
                ${showClaveCliente ? `<td>${claveCell}</td>` : ""}
                <td>${fechaCell}</td>
                <td class="estado-cell ${estadoRow.className}">${estadoRow.label}</td>
                <td>${renderPrecioVentaCell(p.id_venta, p.id_precio)}</td>
                <td class="action-cell">
                  ${accionButtons}
                </td>
              </tr>`;
            }
            if (colMode === "perfil") {
              const toggleHtml = showHogar
                ? `<label class="toggle-label toggle-small">
                    <input type="checkbox" class="toggle-hogar" data-perfil="${p.id_perfil}" ${p.hogar ? "checked" : ""} />
                    <span class="toggle-switch toggle-green" aria-hidden="true"></span>
                    <span class="toggle-text">${p.hogar ? "Activar" : "Desactivar"}</span>
                  </label>`
                : "";
              const copyText = buildServiceCopyText({
                plataforma: info.plataformaNombre,
                idVenta: p.id_venta,
                correo: info.correo,
                clave: info.clave,
                nPerfil: p.n_raw,
                pin: p.pin,
                fechaCorte: p.fecha_corte,
                porAcceso: info.por_acceso,
                usaPines: info.usa_pines,
                ventaPerfil: info.venta_perfil,
                ventaMiembro: info.venta_miembro,
                idPlataforma: info.plataformaId,
                perfilHogar: p.hogar,
                isSubCuenta: false,
              });
              const perfilLabel = showPerfil
                ? getPerfilCellLabel(flags, p.n_raw, p.hogar)
                : "";
              const perfilCell = showPerfil ? `<td>${perfilLabel}</td>` : "";
              const pinCell = showPin
                ? `<td class="pin-cell">
                  <span class="pin-copy" data-clipboard="${p.pin ?? ""}">${p.pin ?? ""}</span>
                  <button type="button" class="btn-pin" data-perfil="${p.id_perfil}" data-pin="${p.pin ?? ""}" data-max="${info.max_dig_pin || ""}" data-nperfil="${p.n_raw ?? ""}" data-correo="${info.correo || ""}" data-plat="${info.plataformaNombre || ""}">‚úèÔ∏è</button>
                </td>`
                : "";
              return `<tr>
                <td>${p.id_venta ? `#${p.id_venta}` : ""}</td>
                ${perfilCell}
                ${pinCell}
                ${showHogar ? `<td>${toggleHtml}</td>` : ""}
                <td class="${p.reemplazado ? "ocupado-reemplazo" : ""}">${p.reemplazado ? "Reemplazado" : ocupadoCell}</td>
                <td>
                  ${
                    p.id_venta
                      ? renderFechaEditCell(p.fecha_corte, p.id_venta)
                      : renderFechaInlineCell("", `data-perfil="${p.id_perfil || ""}"`)
                  }
                </td>
                <td class="estado-cell ${estado.className}">${estado.label}</td>
                <td>${renderPrecioVentaCell(p.id_venta, p.id_precio)}</td>
                <td class="action-cell">
                  <button type="button" class="btn-primary btn-reemplazar-row"
                  data-perfil="${p.id_perfil || ""}"
                  data-correo="${info.correo || ""}"
                  data-clave="${info.clave || ""}"
                  data-nperfil="${p.n_raw ?? ""}"
                  data-pin="${p.pin ?? ""}"
                  data-plat="${info.plataformaNombre || ""}"
                  data-fecha="${p.fecha_corte || info.fecha_corte || ""}"
                  data-idventa="${p.id_venta || ""}"
                  data-cliente="${clienteNombreEncoded}"
                >Reemplazar</button>
                  <button type="button" class="btn-outline btn-copy-row" data-copy="${encodeURIComponent(copyText)}">Copiar</button>
                  ${
                    info.isPlat9 && info.venta_miembro === true && p.id_venta
                      ? `<button type="button" class="btn-outline btn-reactivar-venta" data-idventa="${p.id_venta || ""}">Reactivar</button>`
                      : ""
                  }
                  <button type="button" class="btn-outline btn-registrar-servicio btn-disabled" disabled
                    data-perfil="${p.id_perfil || ""}"
                  >Registrar servicio</button>
                  ${
                    isSuperadmin && p.id_venta
                      ? `<button type="button" class="btn-delete-venta" data-id-venta="${p.id_venta}">Eliminar</button>`
                      : ""
                  }
                </td>
              </tr>`;
            }
            if (colMode === "miembro") {
              const copyText = buildServiceCopyText({
                plataforma: info.plataformaNombre,
                idVenta: p.id_venta,
                correo: info.correo,
                clave: info.clave,
                nPerfil: p.n_raw,
                pin: p.pin,
                fechaCorte: p.fecha_corte,
                porAcceso: info.por_acceso,
                usaPines: info.usa_pines,
                ventaPerfil: info.venta_perfil,
                ventaMiembro: info.venta_miembro,
                idPlataforma: info.plataformaId,
                perfilHogar: p.hogar,
                isSubCuenta: false,
              });
              const pinCell = showPin
                ? `<td class="pin-cell">
                  <span class="pin-copy" data-clipboard="${p.pin ?? ""}">${p.pin ?? ""}</span>
                  <button type="button" class="btn-pin" data-perfil="${p.id_perfil}" data-pin="${p.pin ?? ""}" data-max="${info.max_dig_pin || ""}" data-nperfil="${p.n_raw ?? ""}" data-correo="${info.correo || ""}" data-plat="${info.plataformaNombre || ""}">‚úèÔ∏è</button>
                </td>`
                : "";
              return `<tr>
                <td>${p.id_venta ? `#${p.id_venta}` : ""}</td>
                ${pinCell}
                <td class="${p.reemplazado ? "ocupado-reemplazo" : ""}">${p.reemplazado ? "Reemplazado" : ocupadoCell}</td>
                <td>
                  ${
                    p.id_venta
                      ? renderFechaEditCell(p.fecha_corte, p.id_venta)
                      : renderFechaInlineCell("", `data-perfil="${p.id_perfil || ""}"`)
                  }
                </td>
                <td class="estado-cell ${estado.className}">${estado.label}</td>
                <td>${renderPrecioVentaCell(p.id_venta, p.id_precio)}</td>
                <td class="action-cell">
                  <button type="button" class="btn-primary btn-reemplazar-row"
                  data-perfil="${p.id_perfil || ""}"
                  data-correo="${info.correo || ""}"
                  data-clave="${info.clave || ""}"
                  data-nperfil="${p.n_raw ?? ""}"
                  data-pin="${p.pin ?? ""}"
                  data-plat="${info.plataformaNombre || ""}"
                  data-fecha="${p.fecha_corte || info.fecha_corte || ""}"
                  data-idventa="${p.id_venta || ""}"
                  data-cliente="${clienteNombreEncoded}"
                >Reemplazar</button>
                  <button type="button" class="btn-outline btn-copy-row" data-copy="${encodeURIComponent(copyText)}">Copiar</button>
                  <button type="button" class="btn-outline btn-registrar-servicio btn-disabled" disabled
                    data-perfil="${p.id_perfil || ""}"
                  >Registrar servicio</button>
                  ${
                    isSuperadmin && p.id_venta
                      ? `<button type="button" class="btn-delete-venta" data-id-venta="${p.id_venta}">Eliminar</button>`
                      : ""
                  }
                </td>
              </tr>`;
            }
            const copyText = buildServiceCopyText({
              plataforma: info.plataformaNombre,
              idVenta: p.id_venta,
              correo: info.correo,
              clave: info.clave,
              nPerfil: p.n_raw,
              pin: p.pin,
              fechaCorte: p.fecha_corte,
              porAcceso: info.por_acceso,
              usaPines: info.usa_pines,
              ventaPerfil: info.venta_perfil,
              ventaMiembro: info.venta_miembro,
              idPlataforma: info.plataformaId,
              perfilHogar: p.hogar,
              isSubCuenta: false,
            });
            const hasVenta = !!p.id_venta;
            const clienteCell = hasVenta ? (ocupadoRaw || "-") : ocupadoCell;
            return `<tr>
              <td>${p.id_venta ? `#${p.id_venta}` : ""}</td>
              <td class="${p.reemplazado ? "ocupado-reemplazo" : ""}">${p.reemplazado ? "Reemplazado" : clienteCell}</td>
              <td>
                ${
                  p.id_venta
                    ? renderFechaEditCell(p.fecha_corte, p.id_venta)
                    : renderFechaInlineCell("", `data-perfil="${p.id_perfil || ""}"`)
                }
              </td>
              <td class="estado-cell ${estado.className}">${estado.label}</td>
              <td>${renderPrecioVentaCell(p.id_venta, p.id_precio)}</td>
              <td class="action-cell">
                <button type="button" class="btn-outline btn-copy-row" data-copy="${encodeURIComponent(copyText)}" ${hasVenta ? "" : "disabled"}>Copiar</button>
              </td>
            </tr>`;
          })
          .join("");

        let addPerfilRow = "";
        const colCountPerfil =
          6 +
          (showPerfil ? 1 : 0) +
          (showPin ? 1 : 0) +
          (showHogar ? 1 : 0);
        const colCountMiembro = 6 + (showPin ? 1 : 0);
        const colCountOcupado = 6;
        const colCountMadre =
          7 + (showPerfil ? 1 : 0) + (showClaveCliente ? 1 : 0);
        const colCountTable = isCuentaMadre
          ? colCountMadre
          : colMode === "perfil"
            ? colCountPerfil
            : colMode === "miembro"
              ? colCountMiembro
              : colCountOcupado;
        if (colMode === "perfil" && info.mas_perfiles) {
          const maxPerfiles =
            Number(info.num_max_dispositivos) || rows.length || 1;
          const nextPerfil = (rows.length % maxPerfiles || 0) + 1;
          addPerfilRow = `<tr>
            <td colspan="${colCountPerfil}" style="text-align:center;">
              <button type="button" class="btn-add-perfil" data-cuenta="${info.id_cuenta || ""}" data-next="${nextPerfil}" data-max="${maxPerfiles}" style="width:100%;">+</button>
            </td>
          </tr>`;
        }

        const emptyRow =
          rows.length === 0
            ? `<tr><td colspan="${colCountTable}" style="text-align:center;">Sin registros.</td></tr>`
            : "";
        const table = `<div class="cuenta-table-wrap">
                <table class="table-base">
                  <thead>${thead}</thead>
                  <tbody>${tbodyRows}${emptyRow}${isCuentaMadre ? "" : addPerfilRow}</tbody>
                </table>
              </div>`;

        let plat9Table = "";
        if (info.isPlat9 && info.cuenta_madre === true) {
          const filas = info.plat9Rows || [];
          const needsPlus = filas.length < 5;
          const plat9ColCount = 5 + (showClaveCliente ? 1 : 0);
          const bodyRows = filas
            .map(
              (r) => `<tr>
              <td>${r.cliente || "-"}</td>
              <td>${r.correo || "-"}</td>
              ${showClaveCliente ? `<td>${r.clave || "-"}</td>` : ""}
              <td>${r.usuario || "-"}</td>
              <td>${renderFechaEditCell(r.fecha_corte, r.id_venta)}</td>
              <td>${r.estado || "-"}</td>
            </tr>`,
            )
            .join("");
          const plus = needsPlus
            ? `<tr class="row-add-miembro plat9-plus-row"><td colspan="${plat9ColCount}">+</td></tr>`
            : "";
          plat9Table = `
            <h4>Clientes</h4>
            <div class="cuenta-table-wrap">
              <table class="table-base">
                <thead>
                  <tr>
                    <th>Cliente</th>
                    <th>Correo</th>
                    ${showClaveCliente ? "<th>Clave</th>" : ""}
                    <th>Usuario</th>
                    <th>Fecha de corte</th>
                    <th>Estado</th>
                  </tr>
                </thead>
                <tbody>${bodyRows}${plus}</tbody>
              </table>
            </div>
          `;
        }

        const recargarLabel =
          info.id_plataforma === 1 ? "Recargar cuenta" : "Renovar cuenta";
        const tipoServicio =
          info.venta_perfil === true
            ? "Perfiles"
            : info.venta_miembro === true
              ? "Miembro"
              : "Cuenta completa";
        const plataformaLink = (info.plataformaLink || "").trim();
        const plataformaLinkAttr = plataformaLink
          ? plataformaLink.replace(/"/g, "&quot;")
          : "";
        const plataformaTitleClass = plataformaLink
          ? "cuenta-platform-title is-clickable"
          : "cuenta-platform-title";

        detalleEl.innerHTML = `
          <div class="cuenta-platform-header">
            <div class="${plataformaTitleClass}" ${
              plataformaLinkAttr
                ? `data-link="${plataformaLinkAttr}" title="Abrir p√°gina de la plataforma"`
                : ""
            }>${info.plataformaNombre || "-"}${
              plataformaLinkAttr
                ? '<span class="platform-link-icon" aria-hidden="true">‚Üó</span>'
                : ""
            }</div>
            <button type="button" class="btn-outline btn-marcar-tarea" data-cuenta="${info.id_cuenta || ""}">Marcar tarea</button>
          </div>
          <div class="cuenta-platform-cred">
            <span class="cuenta-platform-label">Correo:</span>
            <span class="cred-copy" data-clipboard="${info.correo || ""}">${info.correo || "-"}</span>
            <span class="cuenta-platform-sep">‚Ä¢</span>
            <span class="cuenta-platform-label">Clave:</span>
            <span class="cred-copy" data-clipboard="${info.clave || ""}">${info.clave || "-"}</span>
          </div>
          ${
            (() => {
              const linkVal = info.link_codigo || "";
              const linkHref = normalizeExternalLink(linkVal);
              const correoVal = info.correo_codigo || "";
              const claveVal = info.pin_codigo || "";
              const linkHtml = linkVal
                ? `<span class="codigo-field" data-field="link_codigo">
                    <span class="codigo-view">
                      <a href="${linkHref}" target="_blank" rel="noopener noreferrer">${linkVal}</a>
                    </span>
                    <button type="button" class="codigo-edit-btn" data-field="link_codigo" data-cuenta="${info.id_cuenta}" aria-label="Editar link">‚úèÔ∏è</button>
                    <span class="codigo-input-wrap hidden">
                      <input type="text" class="input-inline" value="${linkVal}" placeholder="-" data-field="link_codigo" />
                      <button type="button" class="codigo-save-btn" data-field="link_codigo" data-cuenta="${info.id_cuenta}" aria-label="Guardar link">üíæ</button>
                      <button type="button" class="codigo-cancel-btn" aria-label="Cancelar">‚úñ</button>
                    </span>
                  </span>`
                : `<span class="codigo-input-wrap">
                    <input type="text" class="input-inline" value="" placeholder="-" data-field="link_codigo" />
                    <button type="button" class="codigo-save-btn" data-field="link_codigo" data-cuenta="${info.id_cuenta}" aria-label="Guardar link">üíæ</button>
                  </span>`;
              const direccionVal = info.direccion || "";
              const direccionHtml = direccionVal
                ? `<p><strong>Direcci√≥n:</strong> <span class="cred-copy cuenta-direccion" data-clipboard="${direccionVal}">${direccionVal}</span></p>`
                : "";
              const proveedorVal = info.proveedorNombre || "";
              const proveedorHtml = `
                <span class="proveedor-edit-wrap" data-cuenta="${info.id_cuenta}" data-proveedor-id="${info.proveedorId || ""}">
                  <span class="proveedor-text">${proveedorVal || "-"}</span>
                  <button type="button" class="btn-edit-proveedor" aria-label="Editar proveedor">‚úèÔ∏è</button>
                  <span class="proveedor-input-wrap hidden">
                    <input type="text" class="input-inline proveedor-input" placeholder="Proveedor" autocomplete="off" />
                    <span class="sugerencias-cuentas proveedor-sugs hidden"></span>
                    <button type="button" class="btn-save-proveedor" data-cuenta="${info.id_cuenta}" aria-label="Guardar proveedor">üíæ</button>
                    <button type="button" class="btn-cancel-proveedor" aria-label="Cancelar">‚úñ</button>
                  </span>
                </span>`;
              const correoHtml = correoVal
                ? `<span class="cred-copy" data-clipboard="${correoVal}">${correoVal}</span>`
                : `<span class="codigo-input-wrap">
                    <input type="text" class="input-inline" value="" placeholder="-" data-field="correo_codigo" />
                    <button type="button" class="codigo-save-btn" data-field="correo_codigo" data-cuenta="${info.id_cuenta}" aria-label="Guardar correo">üíæ</button>
                  </span>`;
              const claveHtml = claveVal
                ? `<span class="codigo-field" data-field="pin_codigo">
                    <span class="codigo-view">
                      <span class="pin-copy" data-clipboard="${claveVal}">${claveVal}</span>
                    </span>
                    <button type="button" class="codigo-edit-btn" data-field="pin_codigo" data-cuenta="${info.id_cuenta}" aria-label="Editar clave">‚úèÔ∏è</button>
                    <span class="codigo-input-wrap hidden">
                      <input type="text" class="input-inline" value="${claveVal}" placeholder="-" data-field="pin_codigo" />
                      <button type="button" class="codigo-save-btn" data-field="pin_codigo" data-cuenta="${info.id_cuenta}" aria-label="Guardar clave">üíæ</button>
                      <button type="button" class="codigo-cancel-btn" aria-label="Cancelar">‚úñ</button>
                    </span>
                  </span>`
                : `<span class="codigo-input-wrap">
                    <input type="text" class="input-inline" value="" placeholder="-" data-field="pin_codigo" />
                    <button type="button" class="codigo-save-btn" data-field="pin_codigo" data-cuenta="${info.id_cuenta}" aria-label="Guardar clave">üíæ</button>
                  </span>`;
              return `
          <div class="cuenta-meta two-cols">
            <div>
              <p><strong>Proveedor:</strong> ${proveedorHtml}</p>
              <p><strong>Regi√≥n:</strong> ${info.region || "-"}</p>
              <p><strong>Correo:</strong> <span class="cred-copy" data-clipboard="${info.correo || ""}">${info.correo || "-"}</span></p>
              <p>
                <strong>Clave:</strong> <span class="cred-copy" data-clipboard="${info.clave || ""}">${info.clave || "-"}</span>
                <button type="button" class="btn-pin btn-clave" data-cuenta="${info.id_cuenta}" data-clave="${info.clave || ""}" data-correo="${info.correo || ""}">‚úèÔ∏è</button>
              </p>
              <p><strong>Fecha de corte:</strong>
                <span class="fecha-wrap cuenta-fecha-wrap">
                  <span class="fecha-corte-text">${info.fecha_corte_display_fmt || info.fecha_corte_fmt || formatDDMMYYYY(info.fecha_corte_display || info.fecha_corte) || "-"}</span>
                  <button type="button" class="btn-edit-fecha-cuenta" data-cuenta="${info.id_cuenta}">‚úèÔ∏è</button>
                  <input type="date" class="fecha-input-cuenta hidden" data-cuenta="${info.id_cuenta}" value="${info.fecha_corte_display || info.fecha_corte || ""}" />
                  <button type="button" class="btn-save-fecha-cuenta hidden" data-cuenta="${info.id_cuenta}">üíæ</button>
                  <button type="button" class="btn-cancel-fecha-cuenta hidden">‚úñ</button>
                </span>
              </p>
              <p><span class="cuenta-estado-pill ${info.estadoCuentaClass || ""}">${info.estadoCuenta || "-"}</span></p>
            </div>
            <div>
              <p><strong>Acceso a c√≥digos</strong></p>
              <p>Instaddr: ${info.instaddr ? "Disponible" : "No disponible"}</p>
              <p>Link: ${linkHtml}</p>
              ${direccionHtml}
              <p>Correo: ${correoHtml}</p>
              <p>Clave: ${claveHtml}</p>
            </div>
          </div>
              `;
            })()
          }
          <div class="cuenta-toggle">
            <label class="toggle-label">
              <input type="checkbox" id="toggle-activa" data-id="${info.id_cuenta}" ${info.inactiva ? "checked" : ""} />
              <span class="toggle-switch" aria-hidden="true"></span>
              <span class="toggle-text">${info.inactiva ? "Inactivada" : "Activa"}</span>
            </label>
          </div>
          <div class="cuenta-toggle">
            <button type="button" class="btn-recargar-cuenta" data-cuenta="${info.id_cuenta}" data-correo="${info.correo || ""}" data-clave="${info.clave || ""}" data-corte="${info.fecha_corte_display || info.fecha_corte || ""}" data-plat="${info.id_plataforma || ""}" data-usa-pins="${info.usa_pines ? "1" : "0"}">${recargarLabel}</button>
            <div class="cuenta-tipo-label">${tipoServicio}</div>
          </div>
          <div class="cuenta-toggle">
            <button
              type="button"
              class="btn-outline btn-reemplazar-cuenta"
              data-cuenta="${info.id_cuenta}"
              data-correo="${info.correo || ""}"
              data-clave="${info.clave || ""}"
              data-fecha="${info.fecha_corte_display || info.fecha_corte || ""}"
            >
              Reemplazar cuenta
            </button>
          </div>
          ${
            info.venta_perfil === true
              ? `
          <div class="cuenta-toggle">
            <button type="button" class="btn-outline btn-cambiar-completa ${info.hasVentasCuenta ? "btn-disabled" : ""}" ${info.hasVentasCuenta ? "disabled" : ""} data-cuenta="${info.id_cuenta}">
              Cambiar a cuenta completa
            </button>
          </div>
          `
              : ""
          }
          ${
            info.venta_perfil === false && info.venta_miembro === false
              ? `
          <div class="cuenta-toggle">
            <button type="button" class="btn-outline btn-convertir-perfiles" data-cuenta="${info.id_cuenta}">Convertir a cuenta por perfiles</button>
          </div>
          `
              : ""
          }
          ${info.cuenta_madre ? "" : plat9Table}
          <h4>${isCuentaMadre ? "Perfiles ocupados" : colMode === "ocupado" ? "Ventas de cuenta completa" : "Perfiles"}</h4>
          ${table}
          ${
            !info.venta_dominio && info.showMiembros && info.venta_miembro !== true
              ? `
          <h4>Miembros extras</h4>
          <div class="cuenta-table-wrap">
                <table class="table-base">
              <thead>
                <tr>
                  <th>Correo</th>
                  ${showClaveCliente ? "<th>Clave</th>" : ""}
                  ${showPin ? "<th>PIN</th>" : ""}
                  <th>Ocupado por</th>
                  <th>ID Venta</th>
                  <th>ID Precio</th>
                  <th>Fecha de corte</th>
                  <th class="action-cell">Acci√≥n</th>
                </tr>
              </thead>
              <tbody>
                ${
                  (info.miembrosExtras || [])
                    .map((m) => {
                      const hasVenta = !!m.id_venta;
                      const copyText = hasVenta
                        ? buildServiceCopyText({
                            plataforma: info.plataformaNombre,
                            idVenta: m.id_venta,
                            correo: m.correo,
                            clave: m.clave,
                            pin: m.pin,
                            fechaCorte: m.fecha_corte,
                            porAcceso: info.por_acceso,
                            usaPines: info.usa_pines,
                            ventaPerfil: m.venta_perfil ?? info.venta_perfil,
                            ventaMiembro: m.venta_miembro ?? info.venta_miembro,
                            idPlataforma: m.id_plataforma ?? info.plataformaId,
                          })
                        : "";
                      const clienteNombreEncoded = encodeURIComponent(
                        cleanClienteName(m.ocupado || ""),
                      );
                      return `
                        <tr>
                          <td><span class="correo-copy" data-clipboard="${m.correo || ""}">${m.correo || "-"}</span></td>
                          ${showClaveCliente ? `<td><span class="clave-copy" data-clipboard="${m.clave || ""}">${m.clave || "-"}</span></td>` : ""}
                          ${showPin ? `<td><span class="pin-copy" data-clipboard="${m.pin || ""}">${m.pin || "-"}</span></td>` : ""}
                          <td>${hasVenta ? m.ocupado || "-" : `<input type="text" class="ocupado-input" placeholder="Nombre y apellido" />`}</td>
                          <td>${hasVenta ? `#${m.id_venta}` : "-"}</td>
                          <td>${renderPrecioVentaCell(m.id_venta, m.id_precio)}</td>
                          <td>
                            ${
                              hasVenta
                                ? renderFechaEditCell(m.fecha_corte, m.id_venta)
                                : renderFechaInlineCell("", `data-cuenta="${m.id_cuenta || ""}"`)
                            }
                          </td>
                          <td class="action-cell">
                            <button
                              type="button"
                              class="btn-primary btn-reemplazar-row"
                              data-perfil=""
                              data-cuenta="${m.id_cuenta || ""}"
                              data-idventa="${m.id_venta || ""}"
                              data-venta-miembro="${m.venta_miembro ? "true" : "false"}"
                              data-venta-perfil="${m.venta_perfil ? "true" : "false"}"
                              data-cliente="${clienteNombreEncoded}"
                            >Reemplazar</button>
                            <button type="button" class="btn-outline btn-copy-row" data-copy="${encodeURIComponent(copyText)}" ${hasVenta ? "" : "disabled"}>Copiar</button>
                            ${
                              info.isPlat9 &&
                              hasVenta &&
                              (m.venta_miembro === true || info.cuenta_madre === true)
                                ? `<button type="button" class="btn-outline btn-reactivar-venta" data-idventa="${m.id_venta || ""}">Reactivar</button>`
                                : ""
                            }
                            <button type="button" class="btn-outline btn-registrar-servicio btn-disabled" disabled data-cuenta="${m.id_cuenta || ""}">Registrar servicio</button>
                            ${
                              isSuperadmin && hasVenta
                                ? `<button type="button" class="btn-delete-venta" data-id-venta="${m.id_venta || ""}">Eliminar</button>`
                                : ""
                            }
                          </td>
                        </tr>
                      `;
                    })
                    .join("") || ""
                }
                ${
                  (() => {
                    const maxMiembros = Number(info.max_miembros);
                    const actuales = (info.miembrosExtras || []).length;
                    if (Number.isFinite(maxMiembros) && maxMiembros > 0 && actuales >= maxMiembros) {
                      return "";
                    }
                    const colSpan = 6 + (showClaveCliente ? 1 : 0) + (showPin ? 1 : 0);
                    return `<tr class="row-add-miembro">
                      <td colspan="${colSpan}" style="text-align:center; font-weight:700; cursor:pointer;">+</td>
                    </tr>`;
                  })()
                }
              </tbody>
            </table>
          </div>
          <div class="miembros-footnote" id="miembros-footnote-${info.id_cuenta || ""}"></div>
        `
              : ""
          }
          ${
            info.venta_miembro || info.venta_dominio
              ? `<p class="cuenta-miembro-label">Miembro de: ${info.correo_madre || ""}${info.correo_madre ? ` <span class="cliente-alert" data-correo="${info.correo_madre}" title="Ver cuenta">!</span>` : ""}</p>`
              : ""
          }
        `;
        decorateCopyColumns(detalleEl);

        const toggle = detalleEl.querySelector("#toggle-activa");
        if (toggle) {
          toggle.addEventListener("change", async (e) => {
            const checked = e.target.checked;
            const id = e.target.dataset.id;
            try {
              const { error } = await supabase
                .from("cuentas")
                .update({ inactiva: checked })
                .eq("id_cuenta", id);
              if (error) throw error;
              const labelText = e.target
                .closest(".toggle-label")
                ?.querySelector(".toggle-text");
              if (labelText)
                labelText.textContent = checked ? "Inactivada" : "Activa";
            } catch (err) {
              console.error("toggle inactiva error", err);
              e.target.checked = !checked;
            }
          });
        }
      };

      const loadCuentaDetalle = async (idCuenta) => {
        if (!detalleEl) return;
        if (clienteVentasEl) clienteVentasEl.innerHTML = "";
        detalleEl.style.display = "block";
        detalleEl.style.removeProperty("--platform-color");
        detalleEl.innerHTML = '<p class="status">Cargando cuenta...</p>';
        try {
          const { data: cuenta, error } = await supabase
            .from("cuentas")
            .select(
              "id_cuenta, correo, clave, fecha_corte, id_plataforma, id_proveedor, region, direccion, venta_perfil, venta_miembro, venta_dominio, dominio_de, id_cuenta_madre, instaddr, link_codigo, correo_codigo, pin_codigo, inactiva, ocupado, cuenta_madre",
            )
            .eq("id_cuenta", idCuenta)
            .maybeSingle();
          if (error) throw error;
          if (!cuenta) {
            detalleEl.innerHTML = '<p class="status">Cuenta no encontrada.</p>';
            return;
          }

          const platId = cuenta.id_plataforma;
          const provId = cuenta.id_proveedor;
          const cuentaEstado = getEstadoCuenta(cuenta);
          const isCuentaMiembroDependiente =
            cuenta.venta_miembro === true && cuenta.cuenta_madre !== true;
          let fechaCorteCuentaMostrar = cuenta.fecha_corte || "";
          let estadoCuentaMostrar = cuentaEstado;

          const [
            { data: prov, error: provErr },
            { data: plat, error: platErr },
          ] = await Promise.all([
            provId
              ? supabase
                  .from("proveedores")
                  .select("nombre")
                  .eq("id_proveedor", provId)
                  .maybeSingle()
              : Promise.resolve({ data: null, error: null }),
                platId
                  ? supabase
                      .from("plataformas")
                      .select(
                    "nombre, color_1, usa_pines, max_dig_pin, por_acceso, por_pantalla, mas_perfiles, num_max_dispositivos, max_miembros, correo_cliente, clave_cliente, link_pagina",
                  )
                  .eq("id_plataforma", platId)
                  .maybeSingle()
              : Promise.resolve({ data: null, error: null }),
          ]);
          if (provErr) throw provErr;
          if (platErr) throw platErr;

          let perfiles = [];
          let ventasMap = {};
          let usersMap = {};
          let ventasCuenta = [];
          let usuariosCuenta = {};

          const colMode =
            cuenta.venta_perfil === true && cuenta.venta_miembro === false
              ? "perfil"
              : cuenta.venta_perfil === false && cuenta.venta_miembro === true
                ? "miembro"
                : "ocupado";
          const showHogar = platId === 1 && colMode === "perfil";

          const { data: perfData, error: perfErr } = await supabase
            .from("perfiles")
            .select("id_perfil, n_perfil, pin, perfil_hogar, ocupado")
            .eq("id_cuenta", idCuenta)
            .order("n_perfil");
          if (perfErr) throw perfErr;
          perfiles = perfData || [];

          let correoMadre = "";
          if (
            (cuenta.venta_miembro === true || cuenta.venta_dominio === true) &&
            cuenta.id_cuenta_madre
          ) {
            const { data: madreData, error: madreErr } = await supabase
              .from("cuentas")
              .select("correo, fecha_corte, inactiva")
              .eq("id_cuenta", cuenta.id_cuenta_madre)
              .maybeSingle();
            if (madreErr) throw madreErr;
            correoMadre = madreData?.correo || "";
            if (isCuentaMiembroDependiente && madreData) {
              fechaCorteCuentaMostrar = madreData.fecha_corte || "";
              estadoCuentaMostrar = getEstadoCuenta({
                inactiva: madreData.inactiva === true,
                fecha_corte: madreData.fecha_corte || "",
              });
            }
          }

          const perfilIds = perfiles.map((p) => p.id_perfil).filter(Boolean);
          if (perfilIds.length) {
            const { data: ventas, error: ventErr } = await supabase
            .from("ventas")
            .select("id_perfil, id_usuario, id_venta, fecha_corte, suspendido, id_precio, correo_miembro, clave_miembro")
              .in("id_perfil", perfilIds);
            if (ventErr) throw ventErr;
            ventasMap = (ventas || []).reduce((acc, v) => {
              acc[v.id_perfil] = {
                id_usuario: v.id_usuario,
                id_venta: v.id_venta,
                fecha_corte: v.fecha_corte,
                suspendido: v.suspendido,
                id_precio: v.id_precio,
                correo_miembro: v.correo_miembro,
                clave_miembro: v.clave_miembro,
              };
              return acc;
            }, {});

            const userIds = Array.from(
              new Set((ventas || []).map((v) => v.id_usuario).filter(Boolean)),
            );
            if (userIds.length) {
              const { data: users, error: userErr } = await supabase
                .from("usuarios")
                .select("id_usuario, nombre, apellido")
                .in("id_usuario", userIds);
              if (userErr) throw userErr;
              usersMap = (users || []).reduce((acc, u) => {
                acc[u.id_usuario] =
                  [u.nombre, u.apellido].filter(Boolean).join(" ").trim() ||
                  `Usuario ${u.id_usuario}`;
                return acc;
              }, {});
            }
          }

          const { data: ventasCuentaCheck, error: ventasCuentaErr } = await supabase
            .from("ventas")
            .select("id_venta")
            .eq("id_cuenta", idCuenta)
            .limit(1);
          if (ventasCuentaErr) throw ventasCuentaErr;
          const hasVentasCuenta = !!ventasCuentaCheck?.length;

          // Ventas de cuenta completa (sin perfiles)
          if (colMode === "ocupado" || colMode === "miembro") {
            const ventasSelect =
              "id_venta, id_usuario, fecha_corte, suspendido, id_precio";
            let ventasCta = [];
            if (cuenta.venta_dominio === true) {
              const queryResults = await Promise.all([
                supabase
                  .from("ventas")
                  .select(ventasSelect)
                  .eq("id_cuenta", idCuenta),
                supabase
                  .from("ventas")
                  .select(ventasSelect)
                  .eq("id_cuenta_miembro", idCuenta),
                cuenta.correo
                  ? supabase
                      .from("ventas")
                      .select(ventasSelect)
                      .eq("correo_miembro", cuenta.correo)
                  : Promise.resolve({ data: [], error: null }),
              ]);
              queryResults.forEach((r) => {
                if (r?.error) throw r.error;
              });
              const mapVentas = new Map();
              queryResults.forEach((r) => {
                (r?.data || []).forEach((v) => {
                  const key = Number(v?.id_venta) || null;
                  if (!key || mapVentas.has(key)) return;
                  mapVentas.set(key, v);
                });
              });
              ventasCta = Array.from(mapVentas.values());
            } else {
              const { data, error: ventasCtaErr } = await supabase
                .from("ventas")
                .select(ventasSelect)
                .eq("id_cuenta", idCuenta);
              if (ventasCtaErr) throw ventasCtaErr;
              ventasCta = data || [];
            }
            ventasCuenta = ventasCta || [];
            const userIdsCta = Array.from(
              new Set(
                (ventasCta || []).map((v) => v.id_usuario).filter(Boolean),
              ),
            );
            if (userIdsCta.length) {
              const { data: usuariosCta, error: usrErr } = await supabase
                .from("usuarios")
                .select("id_usuario, nombre, apellido, correo")
                .in("id_usuario", userIdsCta);
              if (usrErr) throw usrErr;
              usuariosCuenta = (usuariosCta || []).reduce((acc, u) => {
                acc[u.id_usuario] =
                  [u.nombre, u.apellido].filter(Boolean).join(" ").trim() ||
                  u.correo ||
                  `Usuario ${u.id_usuario}`;
                return acc;
              }, {});
            }
          }

          // Perfiles marcados en reemplazos
          let replSet = new Set();
          if (perfilIds.length) {
            const { data: repls, error: replErr } = await supabase
              .from("reemplazos")
              .select("id_perfil")
              .in("id_perfil", perfilIds);
            if (replErr) throw replErr;
            replSet = new Set((repls || []).map((r) => r.id_perfil));
          }

          const perfilesRows = perfiles.map((p) => {
            const enReemplazos = replSet.has(p.id_perfil);
            const ocupador =
              p.id_perfil && ventasMap[p.id_perfil]?.id_usuario
                ? usersMap[ventasMap[p.id_perfil].id_usuario] || "Vac√≠o"
                  : "Vac√≠o";
            const isOcupadoEmpty =
              !ocupador || ocupador === "Vac√≠o" || ocupador === "-";
            const ocupadoCell = isOcupadoEmpty
              ? '<input type="text" class="ocupado-input" placeholder="Nombre y apellido" list="sugs-ocupado" />'
              : ocupador;
              return {
                perfil: `M${p.n_perfil ?? ""}`,
                pin: p.pin,
                hogar: p.perfil_hogar === true,
                id_perfil: p.id_perfil,
                n_raw: p.n_perfil,
                ocupadoPor: enReemplazos ? "Reemplazado" : ocupadoCell,
                id_venta: ventasMap[p.id_perfil]?.id_venta || null,
                fecha_corte: ventasMap[p.id_perfil]?.fecha_corte || "",
                fecha_corte_fmt:
                  formatDDMMYYYY(ventasMap[p.id_perfil]?.fecha_corte) || "",
                suspendido: ventasMap[p.id_perfil]?.suspendido === true,
                reemplazado: enReemplazos,
                id_precio: ventasMap[p.id_perfil]?.id_precio ?? null,
              };
            });

          const madreRows = cuenta.cuenta_madre
            ? perfiles.map((p) => {
                const ventaInfo = ventasMap[p.id_perfil] || {};
                const cliente =
                  ventaInfo.id_usuario
                    ? usersMap[ventaInfo.id_usuario] ||
                      `Usuario ${ventaInfo.id_usuario || "-"}`
                    : "";
                return {
                  id_venta: ventaInfo.id_venta || null,
                  id_perfil: p.id_perfil,
                  n_raw: p.n_perfil,
                  pin: p.pin,
                  hogar: p.perfil_hogar === true,
                  cliente,
                  correo: ventaInfo.correo_miembro || "",
                  clave: ventaInfo.clave_miembro || "",
                  fecha_corte: ventaInfo.fecha_corte || "",
                  suspendido: ventaInfo.suspendido === true,
                  id_precio: ventaInfo.id_precio ?? null,
                };
              })
            : [];

          let plat9Rows = null;
          let isPlat9 = platId === 9;
          if (isPlat9) {
            const { data: ventas9, error: vent9Err } = await supabase
              .from("ventas")
              .select("id_venta, id_usuario, fecha_corte, pendiente")
              .eq("id_cuenta", idCuenta);
            if (vent9Err) throw vent9Err;
            const userIds9 = Array.from(
              new Set((ventas9 || []).map((v) => v.id_usuario).filter(Boolean)),
            );
            let userNames9 = {};
            if (userIds9.length) {
              const { data: users9, error: u9Err } = await supabase
                .from("usuarios")
                .select("id_usuario, nombre, apellido")
                .in("id_usuario", userIds9);
              if (u9Err) throw u9Err;
              userNames9 = (users9 || []).reduce((acc, u) => {
                acc[u.id_usuario] =
                  [u.nombre, u.apellido].filter(Boolean).join(" ").trim() ||
                  `Usuario ${u.id_usuario}`;
                return acc;
              }, {});
            }
            plat9Rows = (ventas9 || []).map((v) => ({
              id_venta: v.id_venta || null,
              cliente: userNames9[v.id_usuario] || "-",
              correo: cuenta.correo || "-",
              clave: cuenta.clave || "-",
              usuario: v.id_usuario ? `#${v.id_usuario}` : "-",
              fecha_corte: v.fecha_corte || "",
              fecha_corte_fmt: formatDDMMYYYY(v.fecha_corte) || "",
              estado: v.pendiente ? "Pendiente" : "Activo",
            }));
          }

          // Miembros extras por id_cuenta_madre
          const { data: miembros, error: membErr } = await supabase
            .from("cuentas")
            .select(
              "id_cuenta, correo, clave, pin, id_plataforma, venta_miembro, venta_perfil",
            )
            .eq("id_cuenta_madre", idCuenta);
          if (membErr) throw membErr;

          let miembrosConUsuario = [];
          if (miembros?.length) {
            const cuentaIds = miembros.map((m) => m.id_cuenta).filter(Boolean);
            const { data: ventasM, error: ventMErr } = await supabase
              .from("ventas")
              .select(
                "id_cuenta, id_venta, id_precio, fecha_corte, usuario:usuarios!ventas_id_usuario_fkey(nombre, apellido)",
              )
              .in("id_cuenta", cuentaIds);
            if (ventMErr) throw ventMErr;
            const mapUser = (ventasM || []).reduce((acc, v) => {
              const full = [v.usuario?.nombre, v.usuario?.apellido]
                .filter(Boolean)
                .join(" ")
                .trim();
              acc[v.id_cuenta] = full || "Vac√≠o";
              return acc;
            }, {});
            const mapVenta = (ventasM || []).reduce((acc, v) => {
              if (!acc[v.id_cuenta]) {
                acc[v.id_cuenta] = {
                  id_venta: v.id_venta,
                  id_precio: v.id_precio ?? null,
                  fecha_corte: v.fecha_corte || "",
                };
              }
              return acc;
            }, {});
            miembrosConUsuario = (miembros || []).map((m) => ({
              id_cuenta: m.id_cuenta,
              correo: m.correo,
              clave: m.clave,
              pin: m.pin,
              ocupado: mapUser[m.id_cuenta] || "-",
              id_venta: mapVenta[m.id_cuenta]?.id_venta || null,
              id_precio: mapVenta[m.id_cuenta]?.id_precio ?? null,
              fecha_corte: mapVenta[m.id_cuenta]?.fecha_corte || "",
              fecha_corte_fmt:
                formatDDMMYYYY(mapVenta[m.id_cuenta]?.fecha_corte) || "",
              id_plataforma: m.id_plataforma,
              venta_miembro: m.venta_miembro,
              venta_perfil: m.venta_perfil,
            }));
          }

          // Obtener √∫ltimos 3 correos agregados en plataforma 1
          let ultimosCorreosPlat1 = [];
          try {
            const { data: ultimos, error: ultErr } = await supabase
              .from("cuentas")
              .select("correo")
              .eq("id_plataforma", 1)
              .not("correo", "is", null)
              .order("id_cuenta", { ascending: false })
              .limit(3);
            if (ultErr) throw ultErr;
            ultimosCorreosPlat1 = (ultimos || [])
              .map((c) => c.correo)
              .filter(Boolean);
          } catch (err) {
            console.error("ultimos correos plat1 error", err);
          }

          currentCuentaDetalle = {
            plataformaNombre: plat?.nombre || "",
            plataformaLink: plat?.link_pagina || "",
            plataformaColor1: plat?.color_1 || "",
            plataformaId: platId,
            id_plataforma: platId,
            proveedorNombre: prov?.nombre || "",
            proveedorId: provId || null,
            region: cuenta.region || "",
            correo: cuenta.correo || "",
            clave: cuenta.clave || "",
            direccion: cuenta.direccion || "",
            fecha_corte: cuenta.fecha_corte || "",
            fecha_corte_fmt: formatDDMMYYYY(cuenta.fecha_corte) || "",
            fecha_corte_display: fechaCorteCuentaMostrar,
            fecha_corte_display_fmt: formatDDMMYYYY(fechaCorteCuentaMostrar) || "",
            estadoCuenta: estadoCuentaMostrar.label,
            estadoCuentaClass: estadoCuentaMostrar.className,
            perfiles: perfilesRows,
            madreRows,
            colMode,
            showHogar,
            inactiva: cuenta.inactiva,
            instaddr: cuenta.instaddr,
            link_codigo: cuenta.link_codigo,
            correo_codigo: cuenta.correo_codigo,
            pin_codigo: cuenta.pin_codigo,
            ocupado: cuenta.ocupado,
            id_cuenta: cuenta.id_cuenta,
            max_dig_pin: plat?.max_dig_pin || null,
            showMiembros: platId === 1,
            miembrosExtras: miembrosConUsuario,
            plat9Rows,
            isPlat9,
            venta_perfil: cuenta.venta_perfil,
            venta_miembro: cuenta.venta_miembro,
            cuenta_madre: cuenta.cuenta_madre === true,
            hasVentasCuenta,
        ultimosCorreosPlat1,
            por_acceso: plat?.por_acceso || false,
            por_pantalla: plat?.por_pantalla || false,
            usa_pines: plat?.usa_pines || false,
            mas_perfiles: isTrue(plat?.mas_perfiles),
            num_max_dispositivos: plat?.num_max_dispositivos || null,
            max_miembros: plat?.max_miembros ?? null,
            correo_cliente: plat?.correo_cliente === true,
            clave_cliente: plat?.clave_cliente === true,
            ventasCuenta,
            usuariosCuenta,
            correo_madre: correoMadre,
            venta_dominio: cuenta.venta_dominio === true,
          };

          renderDetalle(currentCuentaDetalle);
          if (currentCuentaDetalle.usa_pines === true) {
            warmPinRecargaStock();
          }

          // Pie de tabla de miembros extras: √∫ltimos correos agregados en plataforma 1
          if (platId === 1 && detalleEl) {
            const foot = detalleEl.querySelector(
              `#miembros-footnote-${idCuenta}`,
            );
            if (foot && currentCuentaDetalle.ultimosCorreosPlat1?.length) {
              foot.textContent = `Ultimos correos registrados: ${currentCuentaDetalle.ultimosCorreosPlat1.join(", ")}`;
            }
          }
        } catch (err) {
          console.error("detalle cuenta error", err);
          if (detalleEl)
            detalleEl.innerHTML =
              '<p class="status">No se pudo cargar el detalle.</p>';
        }
      };

      const loadCuentaDetalleByCorreo = async (correo) => {
        try {
          const { data, error } = await supabase
            .from("cuentas")
            .select("id_cuenta, id_plataforma")
            .eq("correo", correo)
            .order("id_plataforma", { ascending: true });
          if (error) throw error;
          if (!data?.length) {
            clearCorreoPlataformas();
            return;
          }
          const platIds = Array.from(
            new Set(data.map((c) => c.id_plataforma).filter(Boolean)),
          );
          let platMap = {};
          if (platIds.length) {
            const { data: plats, error: pErr } = await supabase
              .from("plataformas")
              .select("id_plataforma, nombre")
              .in("id_plataforma", platIds);
            if (pErr) throw pErr;
            platMap = (plats || []).reduce((acc, p) => {
              acc[p.id_plataforma] = p.nombre;
              return acc;
            }, {});
          }
          const cuentas = data.map((c) => ({
            ...c,
            plataformaNombre: platMap[c.id_plataforma] || "",
          }));
          const firstId = cuentas[0]?.id_cuenta;
          renderCorreoPlataformas(cuentas, firstId);
          if (firstId) {
            loadCuentaDetalle(firstId);
          }
        } catch (err) {
          console.error("buscar por correo error", err);
        }
      };

      const isPinRecargaCacheFresh = () =>
        Date.now() - (pinRecargaState.fetchedAt || 0) < PIN_RECARGA_CACHE_TTL_MS;

      const consumePinRecargaCache = (pinId) => {
        if (!pinId) return;
        pinRecargaState.items = (pinRecargaState.items || []).filter(
          (it) => String(it?.id || "") !== String(pinId),
        );
      };

      const loadPinRecargaStock = async ({ force = false } = {}) => {
        const hasCached = Array.isArray(pinRecargaState.items) && pinRecargaState.items.length > 0;
        if (!force && hasCached && isPinRecargaCacheFresh()) {
          return pinRecargaState.items;
        }
        if (pinRecargaState.loading) {
          try {
            await pinRecargaState.loading;
          } catch (_err) {
            // noop
          }
          return pinRecargaState.items || [];
        }
        pinRecargaState.loading = (async () => {
          try {
            const { data, error } = await supabase
              .from("tarjetas_de_regalo")
              .select("id_tarjeta_de_regalo, pin")
              .eq("id_plataforma", PIN_RECARGA_PLATFORM_ID)
              .or("usado.is.null,usado.eq.false")
              .order("id_tarjeta_de_regalo", { ascending: true })
              .limit(25);
            if (error) throw error;
            pinRecargaState.items = (data || []).map((r) => ({
              id: r.id_tarjeta_de_regalo,
              pin: r.pin,
            }));
            pinRecargaState.fetchedAt = Date.now();
          } catch (err) {
            console.error("fetch pin recarga error", err);
            pinRecargaState.items = [];
            pinRecargaState.fetchedAt = Date.now();
          } finally {
            pinRecargaState.loading = null;
          }
        })();
        await pinRecargaState.loading;
        return pinRecargaState.items || [];
      };

      const fetchPinRecarga = async ({ force = false } = {}) => {
        try {
          const stock = await loadPinRecargaStock({ force });
          return stock?.[0] || null;
        } catch (err) {
          console.error("fetch pin recarga error", err);
          return null;
        }
      };

      const warmPinRecargaStock = () => {
        loadPinRecargaStock().catch(() => {});
      };

      applyCorreoPrefill();

      attachLogout(clearServerSession);

      // Toggle perfil hogar editable
      detalleEl?.addEventListener("change", async (e) => {
        const hog = e.target.closest(".toggle-hogar");
        if (!hog) return;
        const checked = hog.checked;
        const idPerfil = hog.dataset.perfil;
        if (!idPerfil) return;
        try {
          const { error } = await supabase
            .from("perfiles")
            .update({ perfil_hogar: checked })
            .eq("id_perfil", idPerfil);
          if (error) throw error;
        } catch (err) {
          console.error("toggle hogar error", err);
          hog.checked = !checked;
        }
      });

      // Copiar correo/clave en detalle de cuenta
      detalleEl?.addEventListener("click", (e) => {
        const platformTitle = e.target.closest(".cuenta-platform-title[data-link]");
        if (platformTitle) {
          const rawLink = (platformTitle.dataset.link || "").trim();
          const href = normalizeExternalLink(rawLink);
          if (href) {
            window.open(href, "_blank", "noopener");
          }
          return;
        }
        const cred = e.target.closest(".cred-copy");
        if (cred) {
          const text = cred.dataset.clipboard || cred.textContent || "";
          if (!text) return;
          copyTextNotify(text);
          return;
        }
        const copyEl = e.target.closest(".copyable-text");
        if (copyEl) {
          copyWithToast(copyEl);
          return;
        }
        const correoCopy = e.target.closest(".correo-copy");
        if (correoCopy) {
          const text = correoCopy.dataset.clipboard || correoCopy.textContent || "";
          if (!text) return;
          copyTextNotify(text);
          return;
        }
        const claveCopy = e.target.closest(".clave-copy");
        if (claveCopy) {
          const text = claveCopy.dataset.clipboard || claveCopy.textContent || "";
          if (!text) return;
          copyTextNotify(text);
          return;
        }
        const pinEl = e.target.closest(".pin-copy");
        if (pinEl) {
          const text = pinEl.dataset.clipboard || pinEl.textContent || "";
          if (!text) return;
          copyTextNotify(text);
        }
      });

      // Editar proveedor (solo cuando est√° vac√≠o)
      detalleEl?.addEventListener("click", async (e) => {
        const editProvBtn = e.target.closest(".btn-edit-proveedor");
        if (editProvBtn) {
          const wrap = editProvBtn.closest(".proveedor-edit-wrap");
          const inputWrap = wrap?.querySelector(".proveedor-input-wrap");
          const input = inputWrap?.querySelector(".proveedor-input");
          const textEl = wrap?.querySelector(".proveedor-text");
          if (wrap) wrap.classList.add("is-editing");
          if (inputWrap) inputWrap.classList.remove("hidden");
          if (input) {
            input.value = textEl?.textContent?.trim() === "-" ? "" : textEl?.textContent?.trim() || "";
            const provId = wrap?.dataset.proveedorId;
            if (provId) {
              input.dataset.proveedorId = provId;
            } else {
              delete input.dataset.proveedorId;
            }
            input.focus();
            updateProveedorSuggestions(input);
          }
          return;
        }
        const cancelProvBtn = e.target.closest(".btn-cancel-proveedor");
        if (cancelProvBtn) {
          const inputWrap = cancelProvBtn.closest(".proveedor-input-wrap");
          const wrap = cancelProvBtn.closest(".proveedor-edit-wrap");
          const sugs = inputWrap?.querySelector(".proveedor-sugs");
          const input = inputWrap?.querySelector(".proveedor-input");
          if (input) {
            input.value = "";
            delete input.dataset.proveedorId;
          }
          if (sugs) {
            sugs.innerHTML = "";
            sugs.classList.add("hidden");
          }
          if (inputWrap) inputWrap.classList.add("hidden");
          if (wrap) wrap.classList.remove("is-editing");
          return;
        }
        const sugBtn = e.target.closest(".proveedor-sugs button");
        if (sugBtn) {
          const inputWrap = sugBtn.closest(".proveedor-input-wrap");
          const input = inputWrap?.querySelector(".proveedor-input");
          if (input) {
            input.value = sugBtn.dataset.nombre || "";
            input.dataset.proveedorId = sugBtn.dataset.id || "";
            input.focus();
          }
          const sugs = inputWrap?.querySelector(".proveedor-sugs");
          if (sugs) {
            sugs.innerHTML = "";
            sugs.classList.add("hidden");
          }
          return;
        }
        const saveProvBtn = e.target.closest(".btn-save-proveedor");
        if (saveProvBtn) {
          const inputWrap = saveProvBtn.closest(".proveedor-input-wrap");
          const input = inputWrap?.querySelector(".proveedor-input");
          const cuentaId = saveProvBtn.dataset.cuenta || currentCuentaDetalle?.id_cuenta;
          const value = (input?.value || "").trim();
          if (!cuentaId || !value) {
            alert("Selecciona un proveedor.");
            return;
          }
          const list = await fetchProveedoresList();
          const norm = normalizeText(value);
          const match =
            list.find((p) => String(p.id_proveedor) === String(input?.dataset.proveedorId)) ||
            list.find((p) => normalizeText(p.nombre) === norm);
          if (!match?.id_proveedor) {
            alert("Selecciona un proveedor v√°lido de la lista.");
            return;
          }
          try {
            const { error } = await supabase
              .from("cuentas")
              .update({ id_proveedor: match.id_proveedor })
              .eq("id_cuenta", cuentaId);
            if (error) throw error;
            loadCuentaDetalle(cuentaId);
          } catch (err) {
            console.error("guardar proveedor error", err);
            alert("No se pudo guardar el proveedor.");
          }
        }
      });

      // Guardar datos de acceso a c√≥digos
      detalleEl?.addEventListener("click", async (e) => {
        const editBtn = e.target.closest(".codigo-edit-btn");
        if (editBtn) {
          const wrap = editBtn.closest(".codigo-field");
          const inputWrap = wrap?.querySelector(".codigo-input-wrap");
          const view = wrap?.querySelector(".codigo-view");
          const input = inputWrap?.querySelector("input");
          if (input) {
            input.dataset.original = input.value || "";
            input.classList.remove("hidden");
            input.classList.add("show");
            input.focus();
            input.select();
          }
          if (inputWrap) inputWrap.classList.remove("hidden");
          if (view) view.classList.add("hidden");
          editBtn.classList.add("hidden");
          return;
        }
        const cancelBtn = e.target.closest(".codigo-cancel-btn");
        if (cancelBtn) {
          const inputWrap = cancelBtn.closest(".codigo-input-wrap");
          const wrap = cancelBtn.closest(".codigo-field");
          const view = wrap?.querySelector(".codigo-view");
          const edit = wrap?.querySelector(".codigo-edit-btn");
          const input = inputWrap?.querySelector("input");
          if (input) {
            input.value = input.dataset.original || input.value;
            input.classList.add("hidden");
            input.classList.remove("show");
          }
          if (inputWrap) inputWrap.classList.add("hidden");
          if (view) view.classList.remove("hidden");
          if (edit) edit.classList.remove("hidden");
          return;
        }
        const saveBtn = e.target.closest(".codigo-save-btn");
        if (!saveBtn) return;
        const field = saveBtn.dataset.field;
        const cuentaId = saveBtn.dataset.cuenta || currentCuentaDetalle?.id_cuenta;
        const wrap = saveBtn.closest(".codigo-input-wrap");
        const input = wrap?.querySelector("input");
        const value = (input?.value || "").trim();
        if (!field || !cuentaId) return;
        try {
          const payload = { [field]: value || null };
          const { error } = await supabase.from("cuentas").update(payload).eq("id_cuenta", cuentaId);
          if (error) throw error;
          loadCuentaDetalle(cuentaId);
        } catch (err) {
          console.error("guardar acceso codigos error", err);
          alert("No se pudo guardar el dato.");
        }
      });

      // Recargar cuenta modal
      detalleEl?.addEventListener("click", async (e) => {
        const editCuentaFechaBtn = e.target.closest(".btn-edit-fecha-cuenta");
        if (editCuentaFechaBtn) {
          const wrap = editCuentaFechaBtn.closest(".cuenta-fecha-wrap");
          const input = wrap?.querySelector(".fecha-input-cuenta");
          const span = wrap?.querySelector(".fecha-corte-text");
          const saveBtn = wrap?.querySelector(".btn-save-fecha-cuenta");
          const cancelBtn = wrap?.querySelector(".btn-cancel-fecha-cuenta");
          if (input) {
            input.classList.remove("hidden");
            input.classList.add("show");
            input.dataset.original = input.value || "";
            input.focus();
          }
          if (span) span.classList.add("hidden");
          if (saveBtn) saveBtn.classList.remove("hidden");
          if (cancelBtn) cancelBtn.classList.remove("hidden");
          editCuentaFechaBtn.classList.add("hidden");
          return;
        }
        const cancelCuentaFechaBtn = e.target.closest(".btn-cancel-fecha-cuenta");
        if (cancelCuentaFechaBtn) {
          const wrap = cancelCuentaFechaBtn.closest(".cuenta-fecha-wrap");
          const input = wrap?.querySelector(".fecha-input-cuenta");
          const span = wrap?.querySelector(".fecha-corte-text");
          const editBtn = wrap?.querySelector(".btn-edit-fecha-cuenta");
          const saveBtn = wrap?.querySelector(".btn-save-fecha-cuenta");
          if (input) {
            input.value = input.dataset.original || input.value;
            input.classList.add("hidden");
            input.classList.remove("show");
          }
          if (span) span.classList.remove("hidden");
          if (editBtn) editBtn.classList.remove("hidden");
          if (saveBtn) saveBtn.classList.add("hidden");
          cancelCuentaFechaBtn.classList.add("hidden");
          return;
        }
        const saveCuentaFechaBtn = e.target.closest(".btn-save-fecha-cuenta");
        if (saveCuentaFechaBtn) {
          const wrap = saveCuentaFechaBtn.closest(".cuenta-fecha-wrap");
          const input = wrap?.querySelector(".fecha-input-cuenta");
          const span = wrap?.querySelector(".fecha-corte-text");
          const editBtn = wrap?.querySelector(".btn-edit-fecha-cuenta");
          const cancelBtn = wrap?.querySelector(".btn-cancel-fecha-cuenta");
          const cuentaId = saveCuentaFechaBtn.dataset.cuenta || input?.dataset.cuenta;
          const newDate = input?.value || "";
          if (!cuentaId || !newDate) return;
          try {
            const { error } = await supabase
              .from("cuentas")
              .update({ fecha_corte: newDate })
              .eq("id_cuenta", cuentaId);
            if (error) throw error;
            if (span) {
              span.textContent = formatDDMMYYYY(newDate) || newDate;
              span.classList.remove("hidden");
            }
            if (input) {
              input.classList.add("hidden");
              input.classList.remove("show");
            }
            if (editBtn) editBtn.classList.remove("hidden");
            if (cancelBtn) cancelBtn.classList.add("hidden");
            saveCuentaFechaBtn.classList.add("hidden");
            detalleEl?.querySelectorAll(".btn-recargar-cuenta").forEach((btn) => {
              btn.dataset.corte = newDate;
            });
          } catch (err) {
            console.error("update fecha corte cuenta error", err);
            alert("No se pudo actualizar la fecha.");
          }
          return;
        }
        const deleteBtn = e.target.closest(".btn-delete-venta");
        if (deleteBtn) {
          deleteTargetId = deleteBtn.dataset.idVenta || null;
          deleteTargetRow = deleteBtn.closest("tr");
          if (modalDelete) modalDelete.classList.remove("hidden");
          return;
        }
        const reactivarBtn = e.target.closest(".btn-reactivar-venta");
        if (reactivarBtn) {
          const ventaId = reactivarBtn.dataset.idventa || reactivarBtn.dataset.idVenta || "";
          if (!ventaId) {
            alert("No se encontr√≥ la venta.");
            return;
          }
          try {
            const { error } = await supabase
              .from("ventas")
              .update({ pendiente: true })
              .eq("id_venta", ventaId);
            if (error) throw error;
            if (currentCuentaId) {
              await loadCuentaDetalle(currentCuentaId);
            }
          } catch (err) {
            console.error("reactivar venta error", err);
            alert("No se pudo reactivar la venta.");
          }
          return;
        }
        const copyRowBtn = e.target.closest(".btn-copy-row");
        if (copyRowBtn) {
          const text = decodeURIComponent(copyRowBtn.dataset.copy || "");
          await copyTextNotify(text);
          return;
        }

        const editBtn = e.target.closest(".btn-edit-fecha");
        if (editBtn) {
          const row = editBtn.closest("tr");
          const input = row?.querySelector(".fecha-input");
          const span = row?.querySelector(".fecha-text");
          const saveBtn = row?.querySelector('.btn-save-edit[data-type="fecha"]');
          const cancelBtn = row?.querySelector('.btn-cancel-edit[data-type="fecha"]');
          if (input) {
            input.classList.remove("hidden");
            input.classList.add("show");
            input.dataset.original = input.value || "";
            input.focus();
          }
          if (span) span.classList.add("hidden");
          if (saveBtn) saveBtn.classList.remove("hidden");
          if (cancelBtn) cancelBtn.classList.remove("hidden");
          if (saveBtn || cancelBtn) editBtn.classList.add("hidden");
          return;
        }
        const editClienteBtn = e.target.closest(".btn-edit-cliente");
        if (editClienteBtn) {
          const row = editClienteBtn.closest("tr");
          const input = row?.querySelector(".cliente-edit-input");
          const span = row?.querySelector(".cliente-text");
          const saveBtn = row?.querySelector('.btn-save-edit[data-type="cliente"]');
          const cancelBtn = row?.querySelector('.btn-cancel-edit[data-type="cliente"]');
          if (input) {
            input.classList.remove("hidden");
            input.classList.add("show");
            input.dataset.original = input.value || "";
            input.focus();
            input.select();
          }
          if (span) span.classList.add("hidden");
          if (saveBtn) saveBtn.classList.remove("hidden");
          if (cancelBtn) cancelBtn.classList.remove("hidden");
          if (saveBtn || cancelBtn) editClienteBtn.classList.add("hidden");
          return;
        }
        const cancelEditBtn = e.target.closest(".btn-cancel-edit");
        if (cancelEditBtn) {
          const row = cancelEditBtn.closest("tr");
          const type = cancelEditBtn.dataset.type;
          if (type === "fecha") {
            const input = row?.querySelector(".fecha-input");
            const span = row?.querySelector(".fecha-text");
            const editBtn = row?.querySelector(".btn-edit-fecha");
            const saveBtn = row?.querySelector('.btn-save-edit[data-type="fecha"]');
            if (input) {
              input.value = input.dataset.original || input.value;
              input.classList.add("hidden");
              input.classList.remove("show");
            }
            if (span) span.classList.remove("hidden");
            if (editBtn) editBtn.classList.remove("hidden");
            if (saveBtn) saveBtn.classList.add("hidden");
            cancelEditBtn.classList.add("hidden");
          } else if (type === "correo") {
            const input = row?.querySelector(".correo-edit-input");
            const span = row?.querySelector(".correo-text");
            const editBtn = row?.querySelector(".btn-edit-correo");
            const saveBtn = row?.querySelector('.btn-save-edit[data-type="correo"]');
            if (input) {
              input.value = input.dataset.original || input.value;
              input.classList.add("hidden");
              input.classList.remove("show");
            }
            if (span) span.classList.remove("hidden");
            if (editBtn) editBtn.classList.remove("hidden");
            if (saveBtn) saveBtn.classList.add("hidden");
            cancelEditBtn.classList.add("hidden");
          } else if (type === "cliente") {
            const input = row?.querySelector(".cliente-edit-input");
            const span = row?.querySelector(".cliente-text");
            const editBtn = row?.querySelector(".btn-edit-cliente");
            const saveBtn = row?.querySelector('.btn-save-edit[data-type="cliente"]');
            if (input) {
              input.value = input.dataset.original || input.value;
              input.classList.add("hidden");
              input.classList.remove("show");
            }
            if (span) span.classList.remove("hidden");
            if (editBtn) editBtn.classList.remove("hidden");
            if (saveBtn) saveBtn.classList.add("hidden");
            cancelEditBtn.classList.add("hidden");
          }
          return;
        }
        const saveEditBtn = e.target.closest(".btn-save-edit");
        if (saveEditBtn) {
          const row = saveEditBtn.closest("tr");
          const type = saveEditBtn.dataset.type;
          if (type === "fecha") {
            const input = row?.querySelector(".fecha-input");
            const span = row?.querySelector(".fecha-text");
            const editBtn = row?.querySelector(".btn-edit-fecha");
            const cancelBtn = row?.querySelector('.btn-cancel-edit[data-type="fecha"]');
            const ventaId = saveEditBtn.dataset.venta || input?.dataset.venta;
            const newDate = input?.value || "";
            if (!ventaId || !newDate) return;
            try {
              const { error } = await supabase
                .from("ventas")
                .update({ fecha_corte: newDate })
                .eq("id_venta", ventaId);
              if (error) throw error;
              if (span) {
                span.textContent = formatDDMMYYYY(newDate) || newDate;
                span.classList.remove("hidden");
              }
              if (input) {
                input.classList.add("hidden");
                input.classList.remove("show");
              }
              if (editBtn) editBtn.classList.remove("hidden");
              if (cancelBtn) cancelBtn.classList.add("hidden");
              saveEditBtn.classList.add("hidden");
              const replBtn = row?.querySelector(".btn-reemplazar-row");
              if (replBtn) {
                replBtn.dataset.fecha = newDate;
              }
              updateRowCopyPayload(row);
            } catch (err) {
              console.error("update fecha corte error", err);
              alert("No se pudo actualizar la fecha.");
            }
            return;
          }
          if (type === "correo") {
            const input = row?.querySelector(".correo-edit-input");
            const span = row?.querySelector(".correo-text");
            const editBtn = row?.querySelector(".btn-edit-correo");
            const cancelBtn = row?.querySelector('.btn-cancel-edit[data-type="correo"]');
            const ventaId = saveEditBtn.dataset.venta || input?.dataset.venta;
            const cuentaId =
              saveEditBtn.dataset.cuenta ||
              input?.dataset.cuenta ||
              currentCanvaCuenta?.id_cuenta;
            const newCorreo = (input?.value || "").trim();
            if (!ventaId || !newCorreo) return;
            try {
              const { error: vErr } = await supabase
                .from("ventas")
                .update({ correo_miembro: newCorreo })
                .eq("id_venta", ventaId);
              if (vErr) throw vErr;
              if (cuentaId) {
                const { error: cErr } = await supabase
                  .from("cuentas")
                  .update({ correo: newCorreo })
                  .eq("id_cuenta", cuentaId);
                if (cErr) throw cErr;
              }
              const copySpan = row?.querySelector(".correo-copy");
              if (copySpan) {
                copySpan.textContent = newCorreo;
                copySpan.dataset.clipboard = newCorreo;
              }
              if (span) span.classList.remove("hidden");
              if (input) {
                input.classList.add("hidden");
                input.classList.remove("show");
              }
              if (editBtn) editBtn.classList.remove("hidden");
              if (cancelBtn) cancelBtn.classList.add("hidden");
              saveEditBtn.classList.add("hidden");
              const replBtn = row?.querySelector(".btn-reemplazar-row");
              if (replBtn) {
                replBtn.dataset.correo = newCorreo;
              }
              updateRowCopyPayload(row);
            } catch (err) {
              console.error("update correo miembro error", err);
              alert("No se pudo actualizar el correo.");
            }
            return;
          }
          if (type === "cliente") {
            const input = row?.querySelector(".cliente-edit-input");
            const span = row?.querySelector(".cliente-text");
            const editBtn = row?.querySelector(".btn-edit-cliente");
            const cancelBtn = row?.querySelector('.btn-cancel-edit[data-type="cliente"]');
            const value = (input?.value || "").trim();
            if (!value || !value.includes(" ")) {
              alert("Ingresa nombre y apellido.");
              return;
            }
            const parts = value.split(/\s+/);
            const nombre = parts.shift() || "";
            const apellido = parts.join(" ").trim();
            try {
              const ventaId = saveEditBtn.dataset.venta || input?.dataset.venta;
              if (!ventaId) {
                alert("No se pudo identificar la venta.");
                return;
              }
              const { data: userFound, error: uErr } = await supabase
                .from("usuarios")
                .select("id_usuario")
                .ilike("nombre", nombre)
                .ilike("apellido", apellido)
                .limit(1)
                .maybeSingle();
              if (uErr) throw uErr;
              if (!userFound?.id_usuario) {
                alert("Cliente no encontrado.");
                return;
              }
              const { error } = await supabase
                .from("ventas")
                .update({ id_usuario: userFound.id_usuario })
                .eq("id_venta", ventaId);
              if (error) throw error;
              if (span) {
                span.textContent = value;
                span.classList.remove("hidden");
              }
              if (input) {
                input.classList.add("hidden");
                input.classList.remove("show");
              }
              if (editBtn) editBtn.classList.remove("hidden");
              if (cancelBtn) cancelBtn.classList.add("hidden");
              saveEditBtn.classList.add("hidden");
              const replBtn = row?.querySelector(".btn-reemplazar-row");
              if (replBtn) {
                replBtn.dataset.cliente = encodeURIComponent(value);
              }
              updateRowCopyPayload(row);
            } catch (err) {
              console.error("update cliente error", err);
              alert("No se pudo actualizar el cliente.");
            }
            return;
          }
        }
        const editCorreoBtn = e.target.closest(".btn-edit-correo");
        if (editCorreoBtn) {
          const row = editCorreoBtn.closest("tr");
          const input = row?.querySelector(".correo-edit-input");
          const span = row?.querySelector(".correo-text");
          const saveBtn = row?.querySelector('.btn-save-edit[data-type="correo"]');
          const cancelBtn = row?.querySelector('.btn-cancel-edit[data-type="correo"]');
          if (input) {
            input.classList.remove("hidden");
            input.classList.add("show");
            input.dataset.original = input.value || "";
            input.focus();
            input.select();
          }
          if (span) span.classList.add("hidden");
          if (saveBtn) saveBtn.classList.remove("hidden");
          if (cancelBtn) cancelBtn.classList.remove("hidden");
          if (saveBtn || cancelBtn) editCorreoBtn.classList.add("hidden");
          return;
        }

        const btnRegistrar = e.target.closest(".btn-registrar-servicio");
        if (btnRegistrar) {
          const row = btnRegistrar.closest("tr");
          if (!row) return;
          const isCanvaRow = row?.classList.contains("canva-input-row");
          const nameInput = row.querySelector(".ocupado-input");
          const fechaInput = row.querySelector(".fecha-input");
          const correoInput = row.querySelector(".correo-input");
          const claveInput = row.querySelector(".clave-input");
          const userId = nameInput?.dataset.userId;
          const fechaVal = fechaInput?.value;
          const perfilId = btnRegistrar.dataset.perfil || null;
          const cuentaId = btnRegistrar.dataset.cuenta || currentCuentaId;
          let newVentaId = null;
          if (!cuentaId) {
            alert("No se pudo identificar la cuenta.");
            return;
          }
          try {
            let finalUserId = userId ? Number(userId) : null;
            if (correoInput) {
              const nombreVal = (nameInput?.value || "").trim();
              const correoVal = (correoInput?.value || "").trim();
              const claveVal = (claveInput?.value || "").trim();
              if (!nombreVal || !/\s+/.test(nombreVal)) {
                alert("Ingresa nombre y apellido.");
                return;
              }
              if (!correoVal) {
                alert("Ingresa un correo.");
                return;
              }
              if (claveInput && !claveVal) {
                alert("Ingresa una clave.");
                return;
              }
              if (!fechaVal) {
                alert("Ingresa una fecha de corte.");
                return;
              }
              if (!finalUserId) {
                const parts = nombreVal.split(/\s+/);
                const nombre = parts.shift() || "";
                const apellido = parts.join(" ").trim();
                if (nombre && apellido) {
                  const { data: userFound, error: uErr } = await supabase
                    .from("usuarios")
                    .select("id_usuario")
                    .ilike("nombre", nombre)
                    .ilike("apellido", apellido)
                    .limit(1)
                    .maybeSingle();
                  if (uErr) throw uErr;
                  if (userFound?.id_usuario) {
                    finalUserId = userFound.id_usuario;
                  }
                }
              }
              const isSpotify = Number(currentCuentaDetalle?.plataformaId) === 9;
              let memberCuentaId = null;
              if (isSpotify) {
                if (!finalUserId) {
                  alert("Selecciona un cliente v√°lido.");
                  return;
                }
                const { data: cuentaExist, error: cErr } = await supabase
                  .from("cuentas")
                  .select(
                    "id_cuenta, id_cuenta_madre, dominio_de, venta_dominio, venta_miembro, venta_perfil, cuenta_madre",
                  )
                  .eq("id_plataforma", 9)
                  .eq("correo", correoVal)
                  .maybeSingle();
                if (cErr) throw cErr;
                if (!cuentaExist?.id_cuenta) {
                  const payloadCuenta = {
                    id_plataforma: 9,
                    correo: correoVal,
                    clave: claveVal || null,
                    inactiva: false,
                    ocupado: false,
                    venta_dominio: true,
                    dominio_de: finalUserId,
                    id_cuenta_madre: Number(cuentaId),
                    venta_perfil: false,
                    venta_miembro: false,
                    cuenta_madre: false,
                    id_proveedor: currentCuentaDetalle?.proveedorId || null,
                  };
                  const { data: newCuenta, error: insErr } = await supabase
                    .from("cuentas")
                    .insert(payloadCuenta)
                    .select("id_cuenta")
                    .single();
                  if (insErr) throw insErr;
                  memberCuentaId = newCuenta?.id_cuenta || null;
                } else {
                  if (cuentaExist.cuenta_madre === true) {
                    alert("El correo corresponde a una cuenta madre. Usa el correo del cliente.");
                    return;
                  }
                  memberCuentaId = cuentaExist.id_cuenta;
                  const updates = {};
                  if (
                    Number(cuentaExist.id_cuenta_madre || 0) !==
                    Number(cuentaId)
                  ) {
                    updates.id_cuenta_madre = Number(cuentaId);
                  }
                  if (claveVal) updates.clave = claveVal;
                  if (
                    finalUserId &&
                    Number(cuentaExist.dominio_de || 0) !== Number(finalUserId)
                  ) {
                    updates.dominio_de = Number(finalUserId);
                  }
                  if (cuentaExist.venta_dominio !== true) updates.venta_dominio = true;
                  if (cuentaExist.venta_miembro !== false) updates.venta_miembro = false;
                  if (cuentaExist.venta_perfil !== false) updates.venta_perfil = false;
                  if (cuentaExist.cuenta_madre === true) updates.cuenta_madre = false;
                  if (Object.keys(updates).length) {
                    const { error: updErr } = await supabase
                      .from("cuentas")
                      .update(updates)
                      .eq("id_cuenta", memberCuentaId);
                    if (updErr) throw updErr;
                  }
                }
                if (perfilId && memberCuentaId) {
                  const { error: perfErr } = await supabase
                    .from("perfiles")
                  .update({ ocupado: true, id_cuenta_miembro: memberCuentaId })
                    .eq("id_perfil", perfilId);
                  if (perfErr) throw perfErr;
                }
              }
              const { data: ventaRow, error } = await supabase
                .from("ventas")
                .insert({
                  id_usuario: finalUserId,
                  id_cuenta: Number(cuentaId),
                  id_cuenta_miembro: isSpotify ? memberCuentaId : null,
                  id_perfil: perfilId ? Number(perfilId) : null,
                  fecha_corte: fechaVal,
                  fecha_pago: new Date().toISOString().slice(0, 10),
                  pendiente: false,
                  meses_contratados: 1,
                  correo_miembro: correoVal,
                  clave_miembro: claveVal || null,
                })
                .select("id_venta")
                .single();
              if (error) throw error;
              newVentaId = ventaRow?.id_venta || null;
            } else {
              const nombreVal = (nameInput?.value || "").trim();
              if (!nombreVal || !/\s+/.test(nombreVal)) {
                alert("Ingresa nombre y apellido.");
                return;
              }
              if (!finalUserId) {
                const parts = nombreVal.split(/\s+/);
                const nombre = parts.shift() || "";
                const apellido = parts.join(" ").trim();
                if (nombre && apellido) {
                  const { data: userFound, error: uErr } = await supabase
                    .from("usuarios")
                    .select("id_usuario")
                    .ilike("nombre", nombre)
                    .ilike("apellido", apellido)
                    .limit(1)
                    .maybeSingle();
                  if (uErr) throw uErr;
                  if (userFound?.id_usuario) {
                    finalUserId = userFound.id_usuario;
                    if (nameInput) nameInput.dataset.userId = userFound.id_usuario;
                  }
                }
              }
              if (!finalUserId) {
                pendingOcupadoInput = nameInput;
                goStep1();
                showModal();
                return;
              }
              if (!fechaVal) {
                alert("Ingresa una fecha de corte.");
                return;
              }
              const { data: ventaRow, error } = await supabase
                .from("ventas")
                .insert({
                  id_usuario: Number(finalUserId),
                  id_cuenta: Number(cuentaId),
                  id_perfil: perfilId ? Number(perfilId) : null,
                  fecha_corte: fechaVal,
                  fecha_pago: new Date().toISOString().slice(0, 10),
                  pendiente: false,
                  meses_contratados: 1,
                })
                .select("id_venta")
                .single();
              if (error) throw error;
              newVentaId = ventaRow?.id_venta || null;
            }
            if (isCanvaRow) {
              const tbody = row.closest("tbody");
              const addRow = tbody?.querySelector(".row-add-canva");
              const nombreVal = (nameInput?.value || "").trim();
              const correoVal = (correoInput?.value || "").trim();
              const html = buildCanvaRowHtml({
                idVenta: newVentaId,
                clienteNombre: nombreVal,
                correo: correoVal,
                fechaCorte: fechaVal,
                userId: finalUserId,
                cuentaId,
              });
              const temp = document.createElement("tbody");
              temp.innerHTML = html.trim();
              const newRow = temp.querySelector("tr");
              if (newRow && tbody) {
                row.remove();
                insertCanvaRowSorted(tbody, newRow, addRow);
              }
            } else if (correoInput) {
              const nombreVal = (nameInput?.value || "").trim();
              const correoVal = (correoInput?.value || "").trim();
              const claveVal = (claveInput?.value || "").trim();
              const fechaFmt = formatDDMMYYYY(fechaVal) || fechaVal || "";
              const estadoInfo = getEstadoVenta({ fecha_corte: fechaVal });
              const currentFlags = getPlatFlags(currentCuentaDetalle || {});
              const showClaveCliente = currentFlags.showClave;
              const showPerfil = currentFlags.showPerfil;

              const cells = Array.from(row.children);
              let idx = 0;
              const idCell = cells[idx++] || null;
              const accesoCell = showPerfil ? cells[idx++] || null : null;
              const clienteCell = cells[idx++] || null;
              const correoCell = cells[idx++] || null;
              const claveCell = showClaveCliente ? cells[idx++] || null : null;
              const fechaCell = cells[idx++] || null;
              const estadoCell = cells[idx++] || null;
              const precioCell = cells[idx++] || null;
              const accionCell = cells[idx++] || null;

              if (idCell) idCell.textContent = newVentaId ? `#${newVentaId}` : "";
              if (clienteCell) clienteCell.textContent = nombreVal || "-";
              if (correoCell) correoCell.textContent = correoVal || "-";
              if (showClaveCliente && claveCell) claveCell.textContent = claveVal || "-";
              if (fechaCell) fechaCell.textContent = fechaFmt;
              if (estadoCell) {
                estadoCell.textContent = estadoInfo.label;
                estadoCell.classList.remove("activo", "vencido", "suspendido");
                if (estadoInfo.className)
                  estadoCell.classList.add(estadoInfo.className);
              }
              if (precioCell) {
                precioCell.innerHTML = renderPrecioVentaCell(newVentaId, null);
              }

              let nPerfil = "";
              let perfilHogar = false;
              if (accesoCell) {
                nPerfil = (accesoCell.textContent || "").replace(/\D/g, "");
                perfilHogar = !!accesoCell.querySelector(".perfil-dot");
              }

              const copyText = buildServiceCopyText({
                plataforma: currentCuentaDetalle?.plataformaNombre || "",
                idVenta: newVentaId,
                correo: correoVal,
                clave: claveVal,
                nPerfil: nPerfil || "",
                pin: "",
                fechaCorte: fechaVal,
                porAcceso: currentCuentaDetalle?.por_acceso,
                usaPines: currentCuentaDetalle?.usa_pines,
                ventaPerfil: currentCuentaDetalle?.venta_perfil,
                ventaMiembro: currentCuentaDetalle?.venta_miembro,
                idPlataforma: currentCuentaDetalle?.plataformaId,
                perfilHogar,
                isSubCuenta: false,
              });

              if (accionCell) {
                accionCell.innerHTML = `
                  <button type="button" class="btn-outline btn-copy-row" data-copy="${encodeURIComponent(copyText)}">Copiar</button>
                  <button type="button" class="btn-outline btn-registrar-servicio btn-disabled" disabled
                    data-perfil="${perfilId || ""}"
                  >Registrar servicio</button>
                  ${
                    isSuperadmin && newVentaId
                      ? `<button type="button" class="btn-delete-venta" data-id-venta="${newVentaId}">Eliminar</button>`
                      : ""
                  }
                `;
              }
            }
            alert("Servicio registrado.");
          } catch (err) {
            console.error("registrar servicio error", err);
            alert("No se pudo registrar el servicio.");
          }
          return;
        }

        const btnRec = e.target.closest(".btn-recargar-cuenta");
        if (!btnRec) return;
        const platId = Number(btnRec.dataset.plat || 0);
        const usaPins = isTrue(btnRec.dataset.usaPins);
        const parsedBaseDate = parseDateValue(btnRec.dataset.corte);
        if (recPinRow) recPinRow.style.display = usaPins ? "" : "none";
        renewPlatId = platId || null;
        if (platId === 1) {
          recCorreo.textContent = btnRec.dataset.correo || "-";
          recClave.textContent = btnRec.dataset.clave || "-";
          if (recCorte) {
            const baseDate = parsedBaseDate || new Date();
            const plus30 = new Date(
              baseDate.getTime() + 30 * 24 * 60 * 60 * 1000,
            );
            recCorte.value = plus30.toISOString().slice(0, 10);
          }
          if (usaPins) {
            const cachedPin = pinRecargaState.items?.[0] || null;
            if (cachedPin?.pin) {
              recPin.textContent = cachedPin.pin;
              recPin.dataset.tid = cachedPin.id || "";
            } else {
              recPin.textContent = "Buscando...";
              recPin.dataset.tid = "";
            }
          } else {
            recPin.textContent = "";
            recPin.dataset.tid = "";
          }
          showModalRecargar();
          if (usaPins) {
            let pinObj = pinRecargaState.items?.[0] || null;
            if (!pinObj) {
              pinObj = await fetchPinRecarga();
            } else if (!isPinRecargaCacheFresh()) {
              // refresca en background para la pr√≥xima apertura
              loadPinRecargaStock({ force: true }).catch(() => {});
            }
            if (pinObj?.pin) {
              recPin.textContent = pinObj.pin;
              recPin.dataset.tid = pinObj.id || "";
            } else {
              recPin.textContent = "Sin stock";
              recPin.dataset.tid = "";
            }
          }
        } else {
          renewMeses = 1;
          renewFechaTouched = false;
          renewBaseDate = parsedBaseDate || new Date();
          if (renewCosto) renewCosto.value = "";
          if (renewMesesEl) renewMesesEl.textContent = renewMeses;
          const next = new Date(renewBaseDate);
          next.setMonth(next.getMonth() + renewMeses);
          if (renewCorte) {
            renewCorte.value = Number.isNaN(next.valueOf())
              ? ""
              : next.toISOString().slice(0, 10);
          }
          renewCorte?.addEventListener(
            "input",
            () => {
              renewFechaTouched = true;
            },
            { once: true },
          );
          showModalRenovar();
        }
      });

      modalRecargar?.addEventListener("click", (e) => {
        if (e.target === modalRecargar) {
          hideModalRecargar();
          return;
        }
        const badge = e.target.closest(".rec-copy");
        if (badge) {
          copyWithToast(badge);
        }
      });

      btnCerrarRecargar?.addEventListener("click", () => hideModalRecargar());

      modalRecargar?.addEventListener("click", (e) => {
        if (e.target === modalRecargar) hideModalRecargar();
      });

      const validateRegistrarBtn = (row) => {
        if (!row) return;
        const nameInput = row.querySelector(".ocupado-input");
        const fechaInput = row.querySelector(".fecha-input");
        const correoInput = row.querySelector(".correo-input");
        const claveInput = row.querySelector(".clave-input");
        const btn = row.querySelector(".btn-registrar-servicio");
        if (!btn) return;
        const normalizedName = (nameInput?.value || "").trim().replace(/\s+/g, " ");
        const hasName =
          !!normalizedName &&
          (normalizedName.length >= 3 || !!nameInput?.dataset?.userId);
        const hasCorreo = correoInput && correoInput.value.trim().length > 0;
        const hasClave = !claveInput || claveInput.value.trim().length > 0;
        const hasDate =
          !!(fechaInput && /^\d{4}-\d{2}-\d{2}$/.test(String(fechaInput.value || "").trim()));
        const enabled = correoInput
          ? !!(hasName && hasCorreo && hasDate && hasClave)
          : !!(hasName && hasDate);
        btn.disabled = !enabled;
        btn.classList.toggle("btn-disabled", !enabled);
      };

      detalleEl?.addEventListener("input", (e) => {
        if (e.target.matches(".proveedor-input")) {
          updateProveedorSuggestions(e.target);
          return;
        }
        if (
          e.target.matches(".ocupado-input") ||
          e.target.matches(".cliente-edit-input") ||
          e.target.matches(".fecha-input") ||
          e.target.matches(".correo-input") ||
          e.target.matches(".clave-input")
        ) {
          const row = e.target.closest("tr");
          if (!row) return;
          if (e.target.matches(".cliente-edit-input")) {
            fetchOcupadoSuggestions(e.target.value).then((list) => {
              ocupadoSuggestions = list;
              const dl = document.querySelector("#sugs-ocupado");
              if (dl) {
                dl.innerHTML = list
                  .map(
                    (u) =>
                      `<option data-id="${u.id_usuario}" value="${[u.nombre, u.apellido].filter(Boolean).join(" ").trim()}"></option>`,
                  )
                  .join("");
              }
            });
            return;
          }
          if (e.target.matches(".ocupado-input")) {
            const input = e.target;
            const isCanvaRow = row?.classList.contains("canva-input-row");
            if (isCanvaRow) {
              fetchOcupadoSuggestions(input.value).then((list) => {
                ocupadoSuggestions = list;
                const dl = document.querySelector("#sugs-ocupado");
                if (dl) {
                  dl.innerHTML = list
                    .map(
                      (u) =>
                        `<option data-id="${u.id_usuario}" value="${[u.nombre, u.apellido].filter(Boolean).join(" ").trim()}"></option>`,
                    )
                    .join("");
                }
              });
              validateRegistrarBtn(row);
              return;
            }
            fetchOcupadoSuggestions(input.value).then((list) => {
              ocupadoSuggestions = list;
              const dl = document.querySelector("#sugs-ocupado");
              if (dl) {
                dl.innerHTML = list
                  .map(
                    (u) =>
                      `<option data-id="${u.id_usuario}" value="${[u.nombre, u.apellido].filter(Boolean).join(" ").trim()}"></option>`,
                  )
                  .join("");
              }
            });
            findClienteByTerm(input.value).then((u) => {
              if (u && input) {
                input.dataset.userId = u.id_usuario;
              } else if (input) {
                delete input.dataset.userId;
                if (input.value.trim().includes(" ")) {
                  pendingOcupadoInput = input;
                  goStep1();
                  showModal();
                }
              }
              validateRegistrarBtn(row);
            });
          } else {
            validateRegistrarBtn(row);
          }
        }
      });

      detalleEl?.addEventListener("change", (e) => {
        if (e.target.matches(".ocupado-input")) {
          const input = e.target;
          const row = input.closest("tr");
          const isCanvaRow = row?.classList.contains("canva-input-row");
          if (isCanvaRow) {
            const match = (ocupadoSuggestions || []).find(
              (u) =>
                normalizeText([u.nombre, u.apellido].filter(Boolean).join(" ").trim()) ===
                normalizeText(input.value.trim()),
            );
            if (match) {
              input.dataset.userId = match.id_usuario;
            } else {
              delete input.dataset.userId;
            }
            validateRegistrarBtn(row);
            return;
          }
          const match = (ocupadoSuggestions || []).find(
            (u) =>
              normalizeText([u.nombre, u.apellido].filter(Boolean).join(" ").trim()) ===
              normalizeText(input.value.trim()),
          );
          if (match) {
            input.dataset.userId = match.id_usuario;
          } else {
            delete input.dataset.userId;
            if (isCanvaRow && input.value.trim().includes(" ")) {
              pendingOcupadoInput = input;
              goStep1();
              showModal();
            }
          }
          validateRegistrarBtn(row);
        }
      });

      detalleEl?.addEventListener("change", async (e) => {
        if (e.target.matches(".correo-input") || e.target.matches(".clave-input")) {
          const row = e.target.closest("tr");
          validateRegistrarBtn(row);
          return;
        }
        if (e.target.matches(".fecha-input")) {
          const input = e.target;
          const row = input.closest("tr");
          validateRegistrarBtn(row);
          if (row?.querySelector('.btn-save-edit[data-type="fecha"]')) return;
          const ventaBtn = row?.querySelector(".btn-edit-fecha");
          const ventaId = input.dataset.venta || ventaBtn?.dataset.venta;
          const newDate = input.value;
          if (!newDate) return;
          if (!ventaId) {
            const span = row?.querySelector(".fecha-text");
            if (span) {
              span.textContent = formatDDMMYYYY(newDate) || newDate;
              span.classList.remove("hidden");
            }
            input.classList.remove("show");
            input.classList.add("hidden");
            validateRegistrarBtn(row);
            return;
          }
          try {
            const { error } = await supabase
              .from("ventas")
              .update({ fecha_corte: newDate })
              .eq("id_venta", ventaId);
            if (error) throw error;
            const span = row.querySelector(".fecha-text");
            if (span) {
              span.textContent = formatDDMMYYYY(newDate) || newDate;
              span.classList.remove("hidden");
            }
            input.classList.remove("show");
            input.classList.add("hidden");
            const replBtn = row?.querySelector(".btn-reemplazar-row");
            if (replBtn) {
              replBtn.dataset.fecha = newDate;
            }
            updateRowCopyPayload(row);
          } catch (err) {
            console.error("update fecha corte error", err);
            alert("No se pudo actualizar la fecha.");
          }
          return;
        }
        if (e.target.matches(".correo-edit-input")) {
          const input = e.target;
          const row = input.closest("tr");
          if (row?.querySelector('.btn-save-edit[data-type="correo"]')) return;
          const ventaId = input.dataset.venta;
          if (!ventaId) return;
          const newCorreo = input.value.trim();
          if (!newCorreo) return;
          try {
            const { error } = await supabase
              .from("ventas")
              .update({ correo_miembro: newCorreo })
              .eq("id_venta", ventaId);
            if (error) throw error;
            const span = row.querySelector(".correo-copy");
            if (span) {
              span.textContent = newCorreo;
              span.dataset.clipboard = newCorreo;
              span.classList.remove("hidden");
            }
            input.classList.remove("show");
            input.classList.add("hidden");
            const replBtn = row?.querySelector(".btn-reemplazar-row");
            if (replBtn) {
              replBtn.dataset.correo = newCorreo;
            }
            updateRowCopyPayload(row);
          } catch (err) {
            console.error("update correo miembro error", err);
            alert("No se pudo actualizar el correo.");
          }
          return;
        }
      });

      // Modal renovar (plataformas != 1)
      const updateRenewFecha = () => {
        if (!renewCorte) return;
        if (renewFechaTouched) return;
        const base =
          renewBaseDate instanceof Date && !Number.isNaN(renewBaseDate.valueOf())
            ? new Date(renewBaseDate)
            : new Date();
        const next = new Date(base);
        next.setMonth(next.getMonth() + renewMeses);
        renewCorte.value = Number.isNaN(next.valueOf())
          ? ""
          : next.toISOString().slice(0, 10);
      };

      renewMas?.addEventListener("click", () => {
        renewMeses = renewMeses + 1;
        if (renewMesesEl) renewMesesEl.textContent = renewMeses;
        updateRenewFecha();
      });
      renewMenos?.addEventListener("click", () => {
        renewMeses = Math.max(1, renewMeses - 1);
        if (renewMesesEl) renewMesesEl.textContent = renewMeses;
        updateRenewFecha();
      });
      renewCorte?.addEventListener("input", () => {
        renewFechaTouched = true;
      });
      renewCancel?.addEventListener("click", () => {
        hideModalRenovar();
      });
      renewOverlay?.addEventListener("click", (e) => {
        if (e.target === renewOverlay) hideModalRenovar();
      });

      renewDo?.addEventListener("click", async () => {
        try {
          const monto = parseFloat(renewCosto?.value || "0");
          if (!monto || Number.isNaN(monto) || monto <= 0) {
            alert("Ingresa un costo v√°lido.");
            return;
          }
          const nuevaFecha = renewCorte?.value;
          if (!nuevaFecha) {
            alert("Selecciona la fecha de corte.");
            return;
          }
          if (!currentCuentaId) {
            alert("No se pudo identificar la cuenta.");
            return;
          }
          const today = new Date().toISOString().slice(0, 10);
          const { error: updErr } = await supabase
            .from("cuentas")
            .update({ fecha_corte: nuevaFecha })
            .eq("id_cuenta", currentCuentaId);
          if (updErr) throw updErr;

          const { error: histErr } = await supabase
            .from("historial_ventas")
            .insert({
              monto,
              fecha_pago: today,
              venta_cliente: false,
              renovacion: true,
              id_venta: null,
              id_proveedor: currentCuentaDetalle?.proveedorId
                ? Number(currentCuentaDetalle.proveedorId)
                : null,
              id_plataforma: currentCuentaDetalle?.plataformaId
                ? Number(currentCuentaDetalle.plataformaId)
                : renewPlatId
                  ? Number(renewPlatId)
                  : null,
              id_cuenta: currentCuentaId,
              registrado_por: currentUserId,
              referencia: null,
            });
          if (histErr) throw histErr;

          hideModalRenovar();
          alert("Renovaci√≥n registrada.");
          const fechaSpan = detalleEl?.querySelector(".fecha-corte-text");
          if (fechaSpan)
            fechaSpan.textContent = formatDDMMYYYY(nuevaFecha) || nuevaFecha;
          detalleEl?.querySelectorAll(".btn-recargar-cuenta").forEach((btn) => {
            btn.dataset.corte = nuevaFecha;
          });
        } catch (err) {
          console.error("renovar cuenta error", err);
          alert("No se pudo renovar la cuenta.");
        }
      });

      // Acci√≥n recargar
      btnDoRecarga?.addEventListener("click", async () => {
        try {
          const nuevaFecha = recCorte?.value;
          if (!nuevaFecha) {
            alert("Selecciona una fecha de corte.");
            return;
          }
          if (!currentCuentaId) {
            alert("No se pudo identificar la cuenta.");
            return;
          }
          const today = new Date().toISOString().slice(0, 10);
          // Actualizar fecha_corte de cuenta
          const { error: updErr } = await supabase
            .from("cuentas")
            .update({ fecha_corte: nuevaFecha })
            .eq("id_cuenta", currentCuentaId);
          if (updErr) throw updErr;

          // Marcar tarjeta de regalo como usada si tenemos id
          const pinId = recPin?.dataset?.tid;
          if (pinId) {
            const { error: cardErr } = await supabase
              .from("tarjetas_de_regalo")
              .update({
                usado: true,
                fecha_uso: today,
                id_cuenta: currentCuentaId,
              })
              .eq("id_tarjeta_de_regalo", pinId);
            if (cardErr) throw cardErr;
            consumePinRecargaCache(pinId);
          }

          hideModalRecargar();
          alert("Recarga registrada");
          const fechaSpan = detalleEl?.querySelector(".fecha-corte-text");
          if (fechaSpan)
            fechaSpan.textContent = formatDDMMYYYY(nuevaFecha) || nuevaFecha;
          // actualizar dataset corte en botones recargar visibles
          detalleEl?.querySelectorAll(".btn-recargar-cuenta").forEach((btn) => {
            btn.dataset.corte = nuevaFecha;
          });
        } catch (err) {
          console.error("recargar cuenta error", err);
          alert("No se pudo recargar la cuenta.");
        }
      });

      // Tabla plataforma 9: fila +
      detalleEl?.addEventListener("click", (e) => {
        const plusRow = e.target.closest(".plat9-plus-row");
        if (!plusRow) return;
        const tbody = plusRow.parentElement;
        if (!tbody) return;
        if (tbody.querySelector(".plat9-input-row")) return; // evita m√∫ltiples
        const newRow = document.createElement("tr");
        newRow.className = "plat9-input-row";
        newRow.innerHTML = `
          <td><input type="text" class="plat9-input" placeholder="Cliente" /></td>
          <td><input type="text" class="plat9-input" placeholder="Correo" /></td>
          <td><input type="text" class="plat9-input" placeholder="Clave" /></td>
          <td><input type="text" class="plat9-input" placeholder="Usuario" /></td>
          <td>-</td>
          <td>-</td>
        `;
        tbody.insertBefore(newRow, plusRow);
      });

      // Miembros extras: fila +
      detalleEl?.addEventListener("click", async (e) => {
        const addRow = e.target.closest(".row-add-miembro");
        if (!addRow) return;
        if (addRow.classList.contains("plat9-plus-row")) return; // no inputs for plataforma 9
        const maxMiembros = Number(currentCuentaDetalle?.max_miembros);
        const actuales = (currentCuentaDetalle?.miembrosExtras || []).length;
        if (Number.isFinite(maxMiembros) && maxMiembros > 0 && actuales >= maxMiembros) {
          alert("Ya alcanzaste el m√°ximo de miembros extras.");
          return;
        }
        const tbody = addRow.closest("tbody");
        if (!tbody) return;
        if (tbody.querySelector(".miembro-input-row")) return;
        const currentFlags = getPlatFlags(currentCuentaDetalle || {});
        const colSpanMiembroInput =
          6 + (currentFlags.showClave ? 1 : 0) + (currentFlags.showPin ? 1 : 0);
        const inputRow = document.createElement("tr");
        inputRow.className = "miembro-input-row";
        inputRow.innerHTML = `
          <td colspan="${colSpanMiembroInput}">
            <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
              <div class="input-wrap" style="min-width:220px; flex:1 1 260px;">
                <input type="text" id="miembro-input" placeholder="Buscar correo (plataforma 1)" autocomplete="off" />
                <div id="miembro-sugs" class="sugerencias-cuentas hidden"></div>
              </div>
              <input type="text" id="miembro-clave" placeholder="Clave" style="min-width:150px;" />
              <button type="button" class="btn-save-miembro">üíæ</button>
            </div>
          </td>
        `;
        tbody.insertBefore(inputRow, addRow);

        const inp = inputRow.querySelector("#miembro-input");
        const claveInput = inputRow.querySelector("#miembro-clave");
        const sugsBox = inputRow.querySelector("#miembro-sugs");
        let sugsCounter = 0;
        const renderSugs = (items) => {
          if (!sugsBox) return;
          if (!items.length) {
            sugsBox.innerHTML = "";
            sugsBox.classList.add("hidden");
            return;
          }
          sugsBox.innerHTML = items
            .map(
              (c) =>
                `<button type="button" data-correo="${c.correo || ""}" data-clave="${c.clave || ""}">${c.correo || ""}</button>`,
            )
            .join("");
          sugsBox.classList.remove("hidden");
        };
        const platId = currentCuentaDetalle?.plataformaId || 1;
        const search = async (term) => {
          const t = term.trim();
          if (!t) {
            renderSugs([]);
            return;
          }
          const current = ++sugsCounter;
          try {
            const { data, error } = await supabase
              .from("cuentas")
              .select("correo, clave")
              .eq("id_plataforma", platId)
              .ilike("correo", `%${t}%`)
              .limit(5);
            if (current !== sugsCounter) return;
            if (error) throw error;
            renderSugs(data || []);
          } catch (err) {
            console.error("sugs miembro error", err);
            renderSugs([]);
          }
        };
        inp?.addEventListener("input", (ev) => search(ev.target.value));
        sugsBox?.addEventListener("click", (ev) => {
          const btn = ev.target.closest("button[data-correo]");
          if (!btn) return;
          inp.value = btn.dataset.correo || "";
          claveInput.value = btn.dataset.clave || "";
          renderSugs([]);
        });
        document.addEventListener(
          "click",
          (ev) => {
            if (!inputRow.contains(ev.target)) {
              renderSugs([]);
            }
          },
          { once: true },
        );
        inp?.focus();
      });

      // Cuenta Canva: fila +
      detalleEl?.addEventListener("click", (e) => {
        const addRow = e.target.closest(".row-add-canva");
        if (!addRow) return;
        const tbody = addRow.closest("tbody");
        if (!tbody) return;
        const cuentaId = addRow.dataset.cuenta || currentCuentaId;
        if (!cuentaId) return;
        const newRow = document.createElement("tr");
        newRow.className = "canva-input-row";
        const showPerfil = currentCanvaFlags?.showPerfil ?? true;
        const showPerfilId = currentCanvaFlags?.porPantalla === true;
        const perfilCells = showPerfil
          ? showPerfilId
            ? "<td></td><td></td>"
            : "<td></td>"
          : "";
        newRow.innerHTML = `
          ${perfilCells}
          <td><input type="text" class="ocupado-input" placeholder="Nombre y apellido" list="sugs-ocupado" /></td>
          <td><input type="text" class="correo-input" placeholder="Correo" /></td>
          <td>${renderFechaInlineCell("", "")}</td>
          <td>-</td>
          <td>
            <button type="button" class="btn-outline btn-registrar-servicio btn-disabled" disabled data-cuenta="${cuentaId}">
              Registrar servicio
            </button>
          </td>
        `;
        tbody.insertBefore(newRow, addRow);
        const nameInput = newRow.querySelector(".ocupado-input");
        if (nameInput) nameInput.focus();
      });

      // Guardar miembro extra
      detalleEl?.addEventListener("click", async (e) => {
        const btnSave = e.target.closest(".btn-save-miembro");
        if (!btnSave) return;
        const row = btnSave.closest(".miembro-input-row");
        const correoInp = row?.querySelector("#miembro-input");
        const claveInp = row?.querySelector("#miembro-clave");
        const correoVal = (correoInp?.value || "").trim();
        const claveVal = (claveInp?.value || "").trim();
        if (!correoVal) {
          alert("Ingresa un correo de cuenta (plataforma 1).");
          return;
        }
        if (!currentCuentaId) {
          alert("No se pudo identificar la cuenta principal.");
          return;
        }
        try {
          const platIdMiembro = currentCuentaDetalle?.plataformaId || 1;
          const { data: cuentaMiembro, error: cmErr } = await supabase
            .from("cuentas")
            .select("id_cuenta")
            .eq("correo", correoVal)
            .eq("id_plataforma", platIdMiembro)
            .maybeSingle();
          if (cmErr) throw cmErr;
          if (!cuentaMiembro?.id_cuenta) {
            pendingMiembroAdd = {
              correo: correoVal,
              clave: claveVal,
              plataformaId: currentCuentaDetalle?.plataformaId || 1,
              idCuentaMiembro: currentCuentaId,
              ocupado: false,
            };
            modalMiembroAdd?.classList.remove("hidden");
            return;
          }
          const payload = {
            venta_miembro: true,
            venta_perfil: false,
            id_cuenta_madre: currentCuentaId,
          };
          if (claveVal) payload.clave = claveVal;
          const { error: updErr } = await supabase
            .from("cuentas")
            .update(payload)
            .eq("id_cuenta", cuentaMiembro.id_cuenta);
          if (updErr) throw updErr;
          alert("Miembro actualizado.");
          await loadCuentaDetalle(currentCuentaId || currentCuentaDetalle?.id_cuenta);
        } catch (err) {
          console.error("guardar miembro extra error", err);
          alert("No se pudo guardar el miembro.");
        }
      });

      // Modal agregar miembro faltante
      const hideMiembroModal = () => {
        modalMiembroAdd?.classList.add("hidden");
        pendingMiembroAdd = null;
      };
      btnMiembroNo?.addEventListener("click", hideMiembroModal);
      modalMiembroAdd?.addEventListener("click", (e) => {
        if (e.target.classList.contains("modal-backdrop")) hideMiembroModal();
        if (e.target.classList.contains("modal-close")) hideMiembroModal();
      });
      btnMiembroSi?.addEventListener("click", async () => {
        if (!pendingMiembroAdd) {
          hideMiembroModal();
          return;
        }
        const { correo, clave, plataformaId, idCuentaMiembro, ocupado } =
          pendingMiembroAdd;
        try {
          const payload = {
            id_plataforma: plataformaId,
            correo,
            clave: clave || null,
            fecha_pagada: null,
            fecha_corte: null,
            inactiva: false,
            venta_miembro: true,
            venta_perfil: false,
            id_cuenta_madre: idCuentaMiembro,
            id_proveedor: currentCuentaDetalle?.proveedorId || null,
            ocupado: ocupado === false ? false : null,
          };
          const { error } = await supabase
            .from("cuentas")
            .insert(payload)
            .select("id_cuenta")
            .maybeSingle();
          if (error) throw error;
          await loadCuentaDetalle(currentCuentaId || idCuentaMiembro);
          alert("Servicio agregado como miembro.");
        } catch (err) {
          console.error("crear miembro extra error", err);
          alert("No se pudo agregar el servicio.");
        } finally {
          hideMiembroModal();
        }
      });

      // Modal PIN
      const closePinModal = () => {
        modalPin?.classList.add("hidden");
        modalState = { type: null, targetId: null, max: null };
        if (modalPinInput) {
          modalPinInput.value = "";
          modalPinInput.removeAttribute("maxLength");
        }
        if (modalPinTitle) modalPinTitle.textContent = "Cambiar";
      };

      const closeReemplazoConfirmModal = () => {
        if (!modalReemplazoConfirm) return;
        modalReemplazoConfirm.classList.add("hidden");
        modalReemplazoConfirm.setAttribute("aria-hidden", "true");
        if (modalReemplazoConfirmMsg) modalReemplazoConfirmMsg.textContent = "";
        pendingReemplazoBtn = null;
      };

      const openReemplazoConfirmModal = (btnRepl) => {
        if (!btnRepl || btnRepl.disabled) return;
        const clienteNombre = getClienteNameForReemplazoBtn(btnRepl);
        if (!modalReemplazoConfirm) {
          handleReemplazoClick(btnRepl);
          return;
        }
        pendingReemplazoBtn = btnRepl;
        if (modalReemplazoConfirmMsg) {
          modalReemplazoConfirmMsg.textContent =
            `¬øQuieres reemplazar a ${clienteNombre} de cuenta?`;
        }
        modalReemplazoConfirm.classList.remove("hidden");
        modalReemplazoConfirm.setAttribute("aria-hidden", "false");
      };

      const handleReemplazoClick = async (btnRepl) => {
        if (!btnRepl || btnRepl.disabled) return;
        const labelInicial = btnRepl.textContent || "Reemplazar";
        const fromClienteTable = !!btnRepl.closest("#cliente-ventas");
        const fromDetalleTable = !!btnRepl.closest("#cuenta-detalle");
        const cuentaDetalleInicial = Number(currentCuentaDetalle?.id_cuenta || 0);
        btnRepl.disabled = true;
        btnRepl.classList.add("btn-disabled");
        btnRepl.textContent = "Reemplazando...";
        try {
          const cuentaIdFromBtn = btnRepl.dataset.cuenta || "";
          if (
            fromClienteTable &&
            cuentaIdFromBtn &&
            (!currentCuentaDetalle ||
              String(currentCuentaDetalle.id_cuenta) !== String(cuentaIdFromBtn))
          ) {
            await loadCuentaDetalle(cuentaIdFromBtn);
          }
          if (!currentCuentaDetalle) {
            alert("No se pudo obtener la cuenta actual.");
            return;
          }
          const plataformaId = currentCuentaDetalle.plataformaId;
          const cuentaId = cuentaIdFromBtn || currentCuentaDetalle.id_cuenta;
          const ventaIdFromBtn = toPositiveId(
            btnRepl.dataset.idventa || btnRepl.dataset.idVenta,
          );
          const rowPerfil =
            currentCuentaDetalle.perfiles?.find(
              (p) =>
                ventaIdFromBtn &&
                toPositiveId(p.id_venta) === ventaIdFromBtn,
            ) ||
            currentCuentaDetalle.perfiles?.find(
              (p) => String(p.id_perfil) === String(btnRepl.dataset.perfil || ""),
            );
          const ventaId =
            ventaIdFromBtn ||
            toPositiveId(rowPerfil?.id_venta) ||
            toPositiveId(obtenerVentaPerfil(btnRepl.dataset.perfil));
          const perfilAnteriorId = toPositiveId(
            rowPerfil?.id_perfil || btnRepl.dataset.perfil,
          );
          if (!ventaId) {
            alert("No se encontr√≥ la venta asociada.");
            return;
          }
          const { data: ventaInfo, error: ventaInfoErr } = await supabase
            .from("ventas")
            .select("id_usuario, fecha_corte")
            .eq("id_venta", ventaId)
            .maybeSingle();
          if (ventaInfoErr) throw ventaInfoErr;

          const hasVentaPerfilAttr = btnRepl.dataset.ventaPerfil !== undefined;
          const hasVentaMiembroAttr = btnRepl.dataset.ventaMiembro !== undefined;
          const ventaPerfil = hasVentaPerfilAttr
            ? isTrue(btnRepl.dataset.ventaPerfil)
            : currentCuentaDetalle.venta_perfil === true;
          const ventaMiembro = hasVentaMiembroAttr
            ? isTrue(btnRepl.dataset.ventaMiembro)
            : currentCuentaDetalle.venta_miembro === true;
          const perfilHogar = rowPerfil?.hogar === true;

          let nuevoCuenta = null;
          let nuevoPerfil = null;
          let dataDestino = {};

          console.log("[reemplazo] request", {
            plataformaId,
            cuentaId,
            perfilHogar,
            ventaPerfil,
            ventaMiembro,
          });
          if (rowPerfil?.id_perfil) {
            const { data: perfilDestino, error: perfilErr } =
              await findPerfilLibre(plataformaId, perfilHogar, cuentaId);
            if (perfilErr) {
              console.error("[reemplazo] findPerfilLibre error", perfilErr);
              throw perfilErr;
            }
            console.log("[reemplazo] perfilDestino", perfilDestino);
            if (!perfilDestino) {
              alert("Sin stock");
              return;
            }
            nuevoPerfil = perfilDestino.id_perfil;
            nuevoCuenta = perfilDestino.id_cuenta;
            dataDestino = {
              correo: perfilDestino.cuentas?.correo,
              clave: perfilDestino.cuentas?.clave,
              pin: perfilDestino.pin,
              n_perfil: perfilDestino.n_perfil,
            };
          } else if (ventaMiembro && !ventaPerfil) {
            const { data: cuentaDestino, error: cuentaErr } =
              await findCuentaMiembroLibre(plataformaId, cuentaId);
            if (cuentaErr) {
              console.error(
                "[reemplazo] findCuentaMiembroLibre error",
                cuentaErr,
              );
              throw cuentaErr;
            }
            if (!cuentaDestino) {
              alert("Sin stock");
              return;
            }
            nuevoPerfil = null;
            nuevoCuenta = cuentaDestino.id_cuenta;
            dataDestino = {
              correo: cuentaDestino.correo,
              clave: cuentaDestino.clave,
            };
          } else {
            alert("Sin stock");
            return;
          }

          const updates = {
            id_cuenta: nuevoCuenta || null,
            id_perfil: nuevoPerfil || null,
            id_sub_cuenta: null,
          };
          const { error: updVentaErr } = await supabase
            .from("ventas")
            .update(updates)
            .eq("id_venta", ventaId);
          if (updVentaErr) {
            console.error("[reemplazo] update venta error", updVentaErr);
            throw updVentaErr;
          }

          let perfilTieneOtraVenta = false;
          if (perfilAnteriorId) {
            const { data: perfilVentasRestantes, error: perfilVentasErr } =
              await supabase
                .from("ventas")
                .select("id_venta")
                .eq("id_perfil", perfilAnteriorId)
                .neq("id_venta", ventaId)
                .limit(1);
            if (perfilVentasErr) throw perfilVentasErr;
            perfilTieneOtraVenta = (perfilVentasRestantes || []).length > 0;
          }

          if (perfilAnteriorId && !perfilTieneOtraVenta) {
            const { error: freeErr } = await supabase
              .from("perfiles")
              .update({ ocupado: false })
              .eq("id_perfil", perfilAnteriorId);
            if (freeErr)
              console.error("[reemplazo] liberar perfil previo error", freeErr);
          } else if (perfilAnteriorId && perfilTieneOtraVenta) {
            const { error: keepOccErr } = await supabase
              .from("perfiles")
              .update({ ocupado: true })
              .eq("id_perfil", perfilAnteriorId);
            if (keepOccErr)
              console.error(
                "[reemplazo] mantener perfil previo ocupado error",
                keepOccErr,
              );
          }
          if (nuevoPerfil) {
            const { error: occErr } = await supabase
              .from("perfiles")
              .update({ ocupado: true })
              .eq("id_perfil", nuevoPerfil);
            if (occErr)
              console.error("[reemplazo] marcar perfil nuevo error", occErr);
          }
          if (nuevoCuenta) {
            const { error: occCuentaErr } = await supabase
              .from("cuentas")
              .update({ ocupado: true })
              .eq("id_cuenta", nuevoCuenta);
            if (occCuentaErr)
              console.error("[reemplazo] marcar cuenta nueva error", occCuentaErr);
          }

          const debeRegistrarReemplazo = !(perfilAnteriorId && perfilTieneOtraVenta);
          if (debeRegistrarReemplazo) {
            const { error: insReemplazoErr } = await supabase
              .from("reemplazos")
              .insert({
                id_cuenta: cuentaId,
                id_perfil: perfilAnteriorId,
                id_sub_cuenta: null,
              });
            if (insReemplazoErr) throw insReemplazoErr;
            addToReemplazosCache({
              idCuenta: cuentaId,
              idPerfil: perfilAnteriorId,
            });
          }

          try {
            const userIds = pickNotificationUserIds("servicio_reemplazado", {
              ventaUserId: ventaInfo?.id_usuario,
            });
            if (userIds.length) {
              const notif = buildNotificationPayload(
                "servicio_reemplazado",
                {
                  plataforma: currentCuentaDetalle.plataformaNombre || "",
                  correoViejo: currentCuentaDetalle.correo || "",
                  perfilViejo:
                    rowPerfil?.perfil ||
                    (rowPerfil?.n_raw ? `M${rowPerfil.n_raw}` : ""),
                  correoNuevo: dataDestino.correo || "",
                  perfilNuevo: dataDestino.n_perfil
                    ? `M${dataDestino.n_perfil}`
                    : "",
                  claveNuevo: dataDestino.clave || "",
                },
                { idCuenta: nuevoCuenta || null },
              );
              const rows = userIds.map((uid) => ({
                ...notif,
                id_usuario: uid,
              }));
              await supabase.from("notificaciones").insert(rows);
            }
          } catch (nErr) {
            console.error("notificacion servicio_reemplazado error", nErr);
          }

          const perfilTxtOld = rowPerfil?.perfil || "-";
          const perfilTxtNew = dataDestino?.n_perfil
            ? `M${dataDestino.n_perfil}`
            : "-";
          const idVentaFmt = `#${String(ventaId).padStart(4, "0")}`;
          const nuevoCopy = buildServiceCopyText({
            plataforma: currentCuentaDetalle.plataformaNombre,
            idVenta: idVentaFmt?.replace("#", "") || ventaId,
            correo: dataDestino.correo,
            clave: dataDestino.clave,
            nPerfil: dataDestino.n_perfil,
            pin: dataDestino.pin,
            fechaCorte:
              rowPerfil?.fecha_corte || currentCuentaDetalle.fecha_corte,
            porAcceso: currentCuentaDetalle.por_acceso,
            usaPines: currentCuentaDetalle.usa_pines,
            ventaPerfil: currentCuentaDetalle.venta_perfil,
            ventaMiembro: currentCuentaDetalle.venta_miembro,
            idPlataforma: currentCuentaDetalle.plataformaId,
            perfilHogar: dataDestino.perfil_hogar,
            isSubCuenta: false,
          });
          const msgLines = [
            `_*Reemplazo de:*`,
            `${currentCuentaDetalle.correo || "-"} ${perfilTxtOld}_`,
            "",
            nuevoCopy,
          ].join("\n");
          modalReemplazoMsg.textContent = "Servicio reemplazado";
          const copyBtn = modalReemplazo.querySelector("#btn-reemplazo-copy");
          const copyContent = modalReemplazo.querySelector(
            "#modal-reemplazo-copytext",
          );
          if (copyBtn) copyBtn.dataset.copy = msgLines;
          if (copyContent) copyContent.textContent = msgLines;
          modalReemplazo.classList.remove("hidden");

          try {
            if (fromDetalleTable) {
              const refreshCuentaId = Number(
                cuentaDetalleInicial || currentCuentaDetalle?.id_cuenta || cuentaId || 0,
              );
              if (refreshCuentaId > 0) {
                await loadCuentaDetalle(refreshCuentaId);
              }
            }
            if (fromClienteTable) {
              const selectedClienteId = Number(
                inputCliente?.dataset?.selectedId || 0,
              );
              if (selectedClienteId > 0) {
                await loadVentasByCliente(selectedClienteId);
              }
            }
          } catch (refreshErr) {
            console.error("refresh reemplazo fila error", refreshErr);
          }
        } catch (err) {
          console.error("reemplazo admin error", err);
          alert("No se pudo reemplazar.");
        } finally {
          if (btnRepl.isConnected) {
            btnRepl.disabled = false;
            btnRepl.classList.remove("btn-disabled");
            btnRepl.textContent = labelInicial;
          }
        }
      };

      const closeTareasModal = () => {
        if (!modalTareas) return;
        modalTareas.classList.add("hidden");
        modalTareas.setAttribute("aria-hidden", "true");
        tareasCuentaId = null;
      };

      const renderTareasList = (tareas) => {
        if (!tareasListEl) return;
        if (!Array.isArray(tareas) || !tareas.length) {
          tareasListEl.innerHTML =
            '<p class="status" style="margin:0;">No hay tareas.</p>';
          return;
        }
        tareasListEl.innerHTML = tareas
          .map(
            (t) => `
              <label class="tarea-item">
                <input type="checkbox" value="${t.id_tarea}">
                <span>${t.titulo || "-"}</span>
              </label>
            `,
          )
          .join("");
      };

      const loadTareas = async () => {
        if (tareasCache) return tareasCache;
        const { data, error } = await supabase
          .from("tareas")
          .select("id_tarea, titulo")
          .order("id_tarea", { ascending: true });
        if (error) {
          console.error("cargar tareas error", error);
          tareasCache = [];
          return tareasCache;
        }
        tareasCache = data || [];
        return tareasCache;
      };

      const openTareasModal = async (cuentaId) => {
        if (!modalTareas) return;
        tareasCuentaId = cuentaId || currentCuentaId || null;
        modalTareas.classList.remove("hidden");
        modalTareas.setAttribute("aria-hidden", "false");
        const tareas = await loadTareas();
        renderTareasList(tareas);
      };

      const closeReemplazarRelacionadosModal = () => {
        if (!modalReemplazarRelacionados) return;
        modalReemplazarRelacionados.classList.add("hidden");
        modalReemplazarRelacionados.setAttribute("aria-hidden", "true");
        reemplazoRelacionadosContext = null;
      };

      const openReemplazarRelacionadosModal = ({
        oldCuentaId,
        nuevaCuentaId,
        perfilMapOldToNew,
        oldPerfilNById = {},
        newPerfilNById = {},
        plataformaNombre = "",
        correoViejo = "",
        correoNuevo = "",
        claveNueva = "",
      }) => {
        if (!modalReemplazarRelacionados) return;
        reemplazoRelacionadosContext = {
          oldCuentaId: Number(oldCuentaId) || null,
          nuevaCuentaId: Number(nuevaCuentaId) || null,
          perfilMapOldToNew: perfilMapOldToNew || {},
          oldPerfilNById: oldPerfilNById || {},
          newPerfilNById: newPerfilNById || {},
          plataformaNombre: String(plataformaNombre || "").trim(),
          correoViejo: String(correoViejo || "").trim(),
          correoNuevo: String(correoNuevo || "").trim(),
          claveNueva: String(claveNueva || "").trim(),
        };
        modalReemplazarRelacionados.classList.remove("hidden");
        modalReemplazarRelacionados.setAttribute("aria-hidden", "false");
      };

      const replaceRelatedClientsFromCuenta = async ({
        oldCuentaId,
        nuevaCuentaId,
        perfilMapOldToNew = {},
        oldPerfilNById = {},
        newPerfilNById = {},
        plataformaNombre = "",
        correoViejo = "",
        correoNuevo = "",
        claveNueva = "",
      }) => {
        const oldId = Number(oldCuentaId);
        const newId = Number(nuevaCuentaId);
        if (!Number.isFinite(oldId) || oldId <= 0) {
          throw new Error("Cuenta origen inv√°lida");
        }
        if (!Number.isFinite(newId) || newId <= 0) {
          throw new Error("Cuenta destino inv√°lida");
        }

        const { data: ventasRelacionadas, error: ventasErr } = await supabase
          .from("ventas")
          .select("id_venta, id_usuario, id_cuenta, id_cuenta_miembro, id_perfil")
          .or(`id_cuenta.eq.${oldId},id_cuenta_miembro.eq.${oldId}`);
        if (ventasErr) throw ventasErr;

        const ventas = Array.isArray(ventasRelacionadas) ? ventasRelacionadas : [];
        let updatedVentas = 0;
        const perfilesAsignados = new Set();
        let notificationsSent = 0;
        let notificationsFailed = 0;

        for (const venta of ventas) {
          const idVenta = Number(venta?.id_venta);
          if (!Number.isFinite(idVenta) || idVenta <= 0) continue;
          const oldPerfilId = Number(venta?.id_perfil);
          const mappedPerfil =
            Number.isFinite(oldPerfilId) && oldPerfilId > 0
              ? Number(perfilMapOldToNew[oldPerfilId] || 0)
              : 0;
          const idCuentaVenta = Number(venta?.id_cuenta);
          const idCuentaMiembroVenta = Number(venta?.id_cuenta_miembro);
          const updatePayload = {};
          if (Number.isFinite(idCuentaVenta) && idCuentaVenta === oldId) {
            updatePayload.id_cuenta = newId;
          }
          if (Number.isFinite(idCuentaMiembroVenta) && idCuentaMiembroVenta === oldId) {
            updatePayload.id_cuenta_miembro = newId;
          }

          if (
            Number.isFinite(oldPerfilId) &&
            oldPerfilId > 0 &&
            Number.isFinite(idCuentaVenta) &&
            idCuentaVenta === oldId
          ) {
            updatePayload.id_perfil =
              Number.isFinite(mappedPerfil) && mappedPerfil > 0 ? mappedPerfil : null;
          }
          if (!Object.keys(updatePayload).length) continue;

          const { error: updVentaErr } = await supabase
            .from("ventas")
            .update(updatePayload)
            .eq("id_venta", idVenta);
          if (updVentaErr) throw updVentaErr;
          updatedVentas += 1;

          try {
            const userIds = pickNotificationUserIds("servicio_reemplazado", {
              ventaUserId: venta?.id_usuario,
            });
            if (userIds.length) {
              const oldPerfilLabel = formatPerfilLabel(
                oldPerfilNById?.[oldPerfilId] || "",
              );
              const newPerfilId = Number(updatePayload.id_perfil || 0);
              const newPerfilLabel = formatPerfilLabel(
                newPerfilNById?.[newPerfilId] || "",
              );
              const notif = buildNotificationPayload(
                "servicio_reemplazado",
                {
                  plataforma:
                    String(plataformaNombre || "").trim() ||
                    String(currentCuentaDetalle?.plataformaNombre || "").trim(),
                  correoViejo:
                    String(correoViejo || "").trim() ||
                    String(currentCuentaDetalle?.correo || "").trim(),
                  perfilViejo: oldPerfilLabel || "",
                  correoNuevo: String(correoNuevo || "").trim(),
                  perfilNuevo: newPerfilLabel || "",
                  claveNuevo: String(claveNueva || "").trim(),
                },
                { idCuenta: newId },
              );
              const notifRows = userIds.map((uid) => ({
                ...notif,
                id_usuario: uid,
              }));
              const { error: notifErr } = await supabase
                .from("notificaciones")
                .insert(notifRows);
              if (notifErr) throw notifErr;
              notificationsSent += notifRows.length;
            }
          } catch (notifErr) {
            notificationsFailed += 1;
            console.error(
              "notificacion servicio_reemplazado relacionados error",
              notifErr,
            );
          }

          if (
            Number.isFinite(mappedPerfil) &&
            mappedPerfil > 0 &&
            Number.isFinite(idCuentaVenta) &&
            idCuentaVenta === oldId
          ) {
            perfilesAsignados.add(mappedPerfil);
          }
        }

        const { error: updMadreErr } = await supabase
          .from("cuentas")
          .update({ id_cuenta_madre: newId })
          .eq("id_cuenta_madre", oldId);
        if (updMadreErr) throw updMadreErr;

        if (perfilesAsignados.size) {
          const perfilIds = Array.from(perfilesAsignados);
          const { error: occPerfErr } = await supabase
            .from("perfiles")
            .update({ ocupado: true })
            .in("id_perfil", perfilIds);
          if (occPerfErr) throw occPerfErr;
        }

        if (updatedVentas > 0) {
          const { error: occCuentaErr } = await supabase
            .from("cuentas")
            .update({ ocupado: true })
            .eq("id_cuenta", newId);
          if (occCuentaErr) throw occCuentaErr;
        }

        return {
          updatedVentas,
          perfilesAsignados: perfilesAsignados.size,
          notificationsSent,
          notificationsFailed,
        };
      };

      const closeReemplazarCuentaModal = () => {
        if (!modalReemplazarCuenta) return;
        modalReemplazarCuenta.classList.add("hidden");
        modalReemplazarCuenta.setAttribute("aria-hidden", "true");
        reemplazarCuentaTargetId = null;
        if (inputReemplazarCuentaCorreo) inputReemplazarCuentaCorreo.value = "";
        if (inputReemplazarCuentaClave) inputReemplazarCuentaClave.value = "";
        if (inputReemplazarCuentaFecha) inputReemplazarCuentaFecha.value = "";
      };

      const openReemplazarCuentaModal = ({ cuentaId, fechaCorte = "" }) => {
        if (!modalReemplazarCuenta || !cuentaId) return;
        reemplazarCuentaTargetId = Number(cuentaId);
        if (inputReemplazarCuentaCorreo) inputReemplazarCuentaCorreo.value = "";
        if (inputReemplazarCuentaClave) inputReemplazarCuentaClave.value = "";
        const fechaDefault =
          String(fechaCorte || "").trim() ||
          String(
            currentCuentaDetalle?.fecha_corte_display ||
              currentCuentaDetalle?.fecha_corte ||
              "",
          ).trim();
        if (inputReemplazarCuentaFecha) inputReemplazarCuentaFecha.value = fechaDefault;
        modalReemplazarCuenta.classList.remove("hidden");
        modalReemplazarCuenta.setAttribute("aria-hidden", "false");
      };

      // Acciones de detalle: PIN y Reemplazo
      detalleEl?.addEventListener("click", async (e) => {
        const alertBtn = e.target.closest(".cliente-alert");
        if (alertBtn) {
          const correo = alertBtn.dataset.correo || "";
          if (correo) {
            window.open(`admin_cuentas.html?correo=${encodeURIComponent(correo)}`, "_blank");
          }
          return;
        }
        const btnTareas = e.target.closest(".btn-marcar-tarea");
        if (btnTareas) {
          const cuentaId = btnTareas.dataset.cuenta || currentCuentaId;
          await openTareasModal(cuentaId);
          return;
        }
        const btnCambiar = e.target.closest(".btn-cambiar-completa");
        if (btnCambiar) {
          if (btnCambiar.disabled) return;
          const cuentaId = btnCambiar.dataset.cuenta || currentCuentaDetalle?.id_cuenta;
          if (!cuentaId) return;
          try {
            const { error: delErr } = await supabase.from("perfiles").delete().eq("id_cuenta", cuentaId);
            if (delErr) throw delErr;
            const { error: updErr } = await supabase
              .from("cuentas")
              .update({ venta_perfil: false, venta_miembro: true })
              .eq("id_cuenta", cuentaId);
            if (updErr) throw updErr;
            loadCuentaDetalle(cuentaId);
          } catch (err) {
            console.error("cambiar a cuenta completa error", err);
            alert("No se pudo cambiar a cuenta completa.");
          }
          return;
        }
        const btnPin = e.target.closest(".btn-pin");
        if (btnPin) {
          const idPerfil = btnPin.dataset.perfil || null;
          const pinVal = btnPin.dataset.pin || "";
          const max = Number(btnPin.dataset.max) || null;
          const nPerfil = btnPin.dataset.nperfil || "";
          const correoVal = btnPin.dataset.correo || "";
          const platVal = btnPin.dataset.plat || "";
          modalState = {
            type: "pin",
            targetId: idPerfil,
            max,
            nPerfil,
            correo: correoVal,
            plataforma: platVal,
          };
          if (modalPinTitle) modalPinTitle.textContent = "Cambiar PIN";
          if (modalPinInput) {
            modalPinInput.value = pinVal;
            if (max) modalPinInput.maxLength = max;
            else modalPinInput.removeAttribute("maxLength");
          }
          if (pinVal) {
            await copyTextNotify(pinVal);
          }
          modalPin?.classList.remove("hidden");
          return;
        }

        const btnRepl = e.target.closest(".btn-reemplazar-row");
        if (btnRepl) {
          openReemplazoConfirmModal(btnRepl);
          return;
        }
        const btnCambiarMadre = e.target.closest(".btn-cambiar-madre");
        if (btnCambiarMadre) {
          await handleCambiarCuentaMadre(btnCambiarMadre);
          return;
        }
        const btnReemplazarCuenta = e.target.closest(".btn-reemplazar-cuenta");
        if (btnReemplazarCuenta) {
          openReemplazarCuentaModal({
            cuentaId:
              btnReemplazarCuenta.dataset.cuenta || currentCuentaDetalle?.id_cuenta,
            fechaCorte:
              btnReemplazarCuenta.dataset.fecha ||
              currentCuentaDetalle?.fecha_corte_display ||
              currentCuentaDetalle?.fecha_corte ||
              "",
          });
          return;
        }
      });

      // Modal clave (cuenta)
      detalleEl?.addEventListener("click", (e) => {
        const btn = e.target.closest(".btn-clave");
        if (!btn) return;
        const idCuenta = btn.dataset.cuenta || null;
        const claveVal = btn.dataset.clave || "";
        const correoVal = btn.dataset.correo || "";
        modalState = {
          type: "clave",
          targetId: idCuenta,
          max: null,
          correo: correoVal,
        };
        if (modalPinTitle) modalPinTitle.textContent = "Cambiar clave";
        if (modalPinInput) {
          modalPinInput.value = claveVal;
          modalPinInput.removeAttribute("maxLength");
        }
        modalPin?.classList.remove("hidden");
      });

      detalleEl?.addEventListener("click", (e) => {
        const btn = e.target.closest(".btn-ver-cuenta");
        if (!btn) return;
        const cuentaId = btn.dataset.cuenta;
        if (cuentaId) loadCuentaDetalle(cuentaId);
      });

      modalPinClose?.addEventListener("click", closePinModal);
      modalPin?.addEventListener("click", (e) => {
        if (e.target.classList.contains("modal-backdrop")) closePinModal();
      });
      modalReemplazoConfirm?.addEventListener("click", (e) => {
        if (e.target.classList.contains("modal-backdrop")) {
          closeReemplazoConfirmModal();
        }
      });
      btnReemplazoConfirmNo?.addEventListener(
        "click",
        closeReemplazoConfirmModal,
      );
      btnReemplazoConfirmSi?.addEventListener("click", async () => {
        const targetBtn = pendingReemplazoBtn;
        if (!targetBtn) {
          closeReemplazoConfirmModal();
          return;
        }
        if (btnReemplazoConfirmSi) btnReemplazoConfirmSi.disabled = true;
        if (btnReemplazoConfirmNo) btnReemplazoConfirmNo.disabled = true;
        closeReemplazoConfirmModal();
        try {
          await handleReemplazoClick(targetBtn);
        } finally {
          if (btnReemplazoConfirmSi) btnReemplazoConfirmSi.disabled = false;
          if (btnReemplazoConfirmNo) btnReemplazoConfirmNo.disabled = false;
        }
      });

      btnReemplazarCuentaClose?.addEventListener(
        "click",
        closeReemplazarCuentaModal,
      );
      btnReemplazarCuentaCancel?.addEventListener(
        "click",
        closeReemplazarCuentaModal,
      );
      modalReemplazarCuenta?.addEventListener("click", (e) => {
        if (e.target.classList.contains("modal-backdrop")) {
          closeReemplazarCuentaModal();
        }
      });
      modalReemplazarRelacionados?.addEventListener("click", (e) => {
        if (e.target.classList.contains("modal-backdrop")) {
          closeReemplazarRelacionadosModal();
        }
      });
      btnReemplazarRelacionadosNo?.addEventListener("click", async () => {
        const ctx = reemplazoRelacionadosContext;
        closeReemplazarRelacionadosModal();
        try {
          if (ctx?.nuevaCuentaId) {
            await loadCuentaDetalle(ctx.nuevaCuentaId);
          }
        } catch (err) {
          console.error("cargar cuenta reemplazada error", err);
        }
        alert("Cuenta reemplazada.");
      });
      btnReemplazarRelacionadosSi?.addEventListener("click", async () => {
        const ctx = reemplazoRelacionadosContext;
        if (!ctx?.oldCuentaId || !ctx?.nuevaCuentaId) {
          closeReemplazarRelacionadosModal();
          return;
        }
        if (btnReemplazarRelacionadosSi) btnReemplazarRelacionadosSi.disabled = true;
        if (btnReemplazarRelacionadosNo) btnReemplazarRelacionadosNo.disabled = true;
        try {
          const result = await replaceRelatedClientsFromCuenta({
            oldCuentaId: ctx.oldCuentaId,
            nuevaCuentaId: ctx.nuevaCuentaId,
            perfilMapOldToNew: ctx.perfilMapOldToNew,
            oldPerfilNById: ctx.oldPerfilNById,
            newPerfilNById: ctx.newPerfilNById,
            plataformaNombre: ctx.plataformaNombre,
            correoViejo: ctx.correoViejo,
            correoNuevo: ctx.correoNuevo,
            claveNueva: ctx.claveNueva,
          });
          closeReemplazarRelacionadosModal();
          await loadCuentaDetalle(ctx.nuevaCuentaId);
          const notifPart =
            result.notificationsSent > 0 || result.notificationsFailed > 0
              ? ` Notificaciones enviadas: ${result.notificationsSent}${
                  result.notificationsFailed > 0
                    ? `, con error: ${result.notificationsFailed}`
                    : ""
                }.`
              : "";
          alert(
            `Cuenta reemplazada. Clientes relacionados actualizados: ${result.updatedVentas}.${notifPart}`,
          );
        } catch (err) {
          console.error("reemplazar clientes relacionados error", err);
          closeReemplazarRelacionadosModal();
          await loadCuentaDetalle(ctx.nuevaCuentaId);
          alert("Cuenta reemplazada, pero no se pudieron reemplazar clientes relacionados.");
        } finally {
          if (btnReemplazarRelacionadosSi) btnReemplazarRelacionadosSi.disabled = false;
          if (btnReemplazarRelacionadosNo) btnReemplazarRelacionadosNo.disabled = false;
        }
      });
      btnReemplazarCuentaConfirm?.addEventListener("click", async () => {
        const cuentaId = Number(reemplazarCuentaTargetId);
        if (!Number.isFinite(cuentaId) || cuentaId <= 0) {
          closeReemplazarCuentaModal();
          return;
        }
        const correoVal = (inputReemplazarCuentaCorreo?.value || "").trim();
        const claveVal = (inputReemplazarCuentaClave?.value || "").trim();
        const fechaVal = (inputReemplazarCuentaFecha?.value || "").trim();
        if (!correoVal) {
          alert("Ingresa el correo.");
          inputReemplazarCuentaCorreo?.focus();
          return;
        }
        if (!claveVal) {
          alert("Ingresa la clave.");
          inputReemplazarCuentaClave?.focus();
          return;
        }
        try {
          const { data: cuentaBase, error: cuentaBaseErr } = await supabase
            .from("cuentas")
            .select(
              "id_cuenta, id_plataforma, id_proveedor, region, correo_codigo, clave_codigo, link_codigo, pin_codigo, instaddr, venta_perfil, venta_miembro, id_cuenta_madre, direccion, dominio_de, venta_dominio, cuenta_madre, pin, fecha_pagada, fecha_corte, ocupado, inactiva",
            )
            .eq("id_cuenta", cuentaId)
            .maybeSingle();
          if (cuentaBaseErr) throw cuentaBaseErr;
          if (!cuentaBase?.id_cuenta) {
            alert("No se encontr√≥ la cuenta base.");
            return;
          }

          const { data: perfilesBase, error: perfilesBaseErr } = await supabase
            .from("perfiles")
            .select(
              "id_perfil, n_perfil, pin, perfil_hogar, id_cuenta_miembro, ocupado",
            )
            .eq("id_cuenta", cuentaId)
            .order("n_perfil", { ascending: true });
          if (perfilesBaseErr) throw perfilesBaseErr;
          const perfilesOrigen = perfilesBase || [];

          const shouldCreatePerfiles =
            cuentaBase.venta_perfil === true ||
            cuentaBase.cuenta_madre === true ||
            perfilesOrigen.length > 0;

          let plataformaMeta = {
            usa_pines: false,
            max_dig_pin: 4,
            num_max_dispositivos: 1,
            max_miembros: 1,
          };
          if (shouldCreatePerfiles && cuentaBase.id_plataforma) {
            const { data: platInfo, error: platInfoErr } = await supabase
              .from("plataformas")
              .select("usa_pines, max_dig_pin, num_max_dispositivos, max_miembros")
              .eq("id_plataforma", cuentaBase.id_plataforma)
              .maybeSingle();
            if (platInfoErr) throw platInfoErr;
            plataformaMeta = {
              usa_pines: isTrue(platInfo?.usa_pines),
              max_dig_pin: Number(platInfo?.max_dig_pin) > 0 ? Number(platInfo.max_dig_pin) : 4,
              num_max_dispositivos:
                Number(platInfo?.num_max_dispositivos) > 0
                  ? Number(platInfo.num_max_dispositivos)
                  : 1,
              max_miembros:
                Number(platInfo?.max_miembros) > 0
                  ? Number(platInfo.max_miembros)
                  : 1,
            };
          }

          const payloadNuevaCuenta = {
            id_plataforma: cuentaBase.id_plataforma,
            id_proveedor: cuentaBase.id_proveedor || null,
            correo: correoVal,
            clave: claveVal || null,
            fecha_corte: fechaVal || cuentaBase.fecha_corte || null,
            fecha_pagada: cuentaBase.fecha_pagada || null,
            inactiva: false,
            ocupado: false,
            region: cuentaBase.region || null,
            correo_codigo: cuentaBase.correo_codigo || null,
            clave_codigo: cuentaBase.clave_codigo || null,
            link_codigo: cuentaBase.link_codigo || null,
            pin_codigo: cuentaBase.pin_codigo || null,
            instaddr: cuentaBase.instaddr === true,
            venta_perfil: cuentaBase.venta_perfil === true,
            venta_miembro: cuentaBase.venta_miembro === true,
            id_cuenta_madre: cuentaBase.id_cuenta_madre || null,
            direccion: cuentaBase.direccion || null,
            dominio_de: cuentaBase.dominio_de || null,
            venta_dominio: cuentaBase.venta_dominio === true,
            cuenta_madre: cuentaBase.cuenta_madre === true,
            pin: cuentaBase.pin ?? null,
          };
          const { data: nuevaCuenta, error: nuevaCuentaErr } = await supabase
            .from("cuentas")
            .insert(payloadNuevaCuenta)
            .select("id_cuenta")
            .single();
          if (nuevaCuentaErr) throw nuevaCuentaErr;
          const nuevaCuentaId = Number(nuevaCuenta?.id_cuenta || 0);
          if (!nuevaCuentaId) throw new Error("No se pudo crear la cuenta nueva.");

          const oldPerfilNById = (perfilesOrigen || []).reduce((acc, perfil) => {
            const oldPerfilId = Number(perfil?.id_perfil);
            const nPerfil = Number(perfil?.n_perfil);
            if (Number.isFinite(oldPerfilId) && oldPerfilId > 0 && Number.isFinite(nPerfil)) {
              acc[oldPerfilId] = nPerfil;
            }
            return acc;
          }, {});
          let newPerfilIdByN = {};

          if (shouldCreatePerfiles) {
            const perfilesByN = (perfilesOrigen || []).reduce((acc, perfil) => {
              const key = Number(perfil.n_perfil);
              if (Number.isFinite(key)) acc[key] = perfil;
              return acc;
            }, {});
            const totalConfig = cuentaBase.cuenta_madre
              ? Math.max(1, Number(plataformaMeta.max_miembros) || 1)
              : Math.max(1, Number(plataformaMeta.num_max_dispositivos) || 1);
            const totalPerfiles = Math.max(totalConfig, perfilesOrigen.length || 0, 1);
            const maxPin = Math.max(1, Number(plataformaMeta.max_dig_pin) || 4);
            const perfilesInsert = Array.from({ length: totalPerfiles }).map((_, idx) => {
              const nPerfil = idx + 1;
              const perfilOrigen = perfilesByN[nPerfil] || null;
              let pinPerfil = null;
              if (plataformaMeta.usa_pines === true) {
                if (perfilOrigen?.pin !== null && perfilOrigen?.pin !== undefined) {
                  pinPerfil = perfilOrigen.pin;
                } else {
                  const min = maxPin === 1 ? 0 : Math.pow(10, maxPin - 1);
                  const max = Math.pow(10, maxPin) - 1;
                  pinPerfil = Math.floor(Math.random() * (max - min + 1)) + min;
                }
              }
              return {
                id_cuenta: nuevaCuentaId,
                n_perfil: nPerfil,
                ocupado: false,
                pin: pinPerfil,
                perfil_hogar:
                  Number(cuentaBase.id_plataforma) === 1 ? idx === 0 : false,
                correo: null,
                id_cuenta_miembro: null,
              };
            });
            const { data: perfilesNuevosRows, error: perfilesNuevosErr } = await supabase
              .from("perfiles")
              .insert(perfilesInsert)
              .select("id_perfil, n_perfil");
            if (perfilesNuevosErr) throw perfilesNuevosErr;
            newPerfilIdByN = (perfilesNuevosRows || []).reduce((acc, perfil) => {
              const nPerfil = Number(perfil?.n_perfil);
              const idPerfil = Number(perfil?.id_perfil);
              if (Number.isFinite(nPerfil) && Number.isFinite(idPerfil) && idPerfil > 0) {
                acc[nPerfil] = idPerfil;
              }
              return acc;
            }, {});
          }

          const perfilMapOldToNew = Object.entries(oldPerfilNById).reduce((acc, [oldPerfilId, nPerfil]) => {
            const oldIdNum = Number(oldPerfilId);
            const newId = Number(newPerfilIdByN[nPerfil] || 0);
            if (Number.isFinite(oldIdNum) && oldIdNum > 0 && Number.isFinite(newId) && newId > 0) {
              acc[oldIdNum] = newId;
            }
            return acc;
          }, {});
          const newPerfilNById = Object.entries(newPerfilIdByN).reduce(
            (acc, [nPerfil, perfilId]) => {
              const idNum = Number(perfilId);
              const nNum = Number(nPerfil);
              if (Number.isFinite(idNum) && idNum > 0 && Number.isFinite(nNum)) {
                acc[idNum] = nNum;
              }
              return acc;
            },
            {},
          );

          const { error: inactivarCuentaErr } = await supabase
            .from("cuentas")
            .update({ inactiva: true })
            .eq("id_cuenta", cuentaId);
          if (inactivarCuentaErr) throw inactivarCuentaErr;

          closeReemplazarCuentaModal();
          openReemplazarRelacionadosModal({
            oldCuentaId: cuentaId,
            nuevaCuentaId,
            perfilMapOldToNew,
            oldPerfilNById,
            newPerfilNById,
            plataformaNombre: currentCuentaDetalle?.plataformaNombre || "",
            correoViejo: cuentaBase.correo || currentCuentaDetalle?.correo || "",
            correoNuevo: correoVal,
            claveNueva: claveVal,
          });
        } catch (err) {
          console.error("reemplazar cuenta error", err);
          alert("No se pudo reemplazar la cuenta.");
        }
      });

      modalReemplazo?.addEventListener("click", (e) => {
        if (e.target.classList.contains("modal-close")) {
          modalReemplazo.classList.add("hidden");
        }
      });

      btnTareasCancel?.addEventListener("click", closeTareasModal);
      modalTareas?.addEventListener("click", (e) => {
        if (e.target.classList.contains("modal-backdrop")) closeTareasModal();
        if (e.target.classList.contains("modal-close")) closeTareasModal();
      });
      btnTareasSend?.addEventListener("click", async () => {
        if (!tareasCuentaId) {
          closeTareasModal();
          return;
        }
        const selected = Array.from(
          tareasListEl?.querySelectorAll('input[type="checkbox"]:checked') || [],
        ).map((el) => Number(el.value)).filter(Boolean);
        if (!selected.length) {
          alert("Selecciona al menos una tarea.");
          return;
        }
        try {
          const rows = selected.map((id) => ({
            id_tarea: id,
            cuenta: Number(tareasCuentaId),
          }));
          const { error } = await supabase
            .from("tareas_asignadas")
            .insert(rows);
          if (error) throw error;
          alert("Tareas asignadas.");
          closeTareasModal();
        } catch (err) {
          console.error("asignar tareas error", err);
          alert("No se pudieron asignar las tareas.");
        }
      });

      document
        .querySelector("#btn-reemplazo-copy")
        ?.addEventListener("click", (e) => {
          const btn = e.currentTarget;
          const text = btn?.dataset?.copy || "";
          copyWithToastAt(text, btn);
        });

      const copyWithToastAt = (text, anchor) => {
        if (!text) return;
        copyTextNotify(text);
      };

      // Helpers de reemplazo (versi√≥n simplificada, sin reporte)
      const findPerfilLibre = async (plataformaId, perfilHogar, excludeCuenta) => {
        const { data: bloqueados, error: replErr } = await loadReemplazosCache(true);
        if (replErr) return { error: replErr };
        let query = supabase
          .from("perfiles")
          .select(
            "id_perfil, perfil_hogar, id_cuenta, pin, n_perfil, ocupado, cuentas!perfiles_id_cuenta_fkey!inner(id_plataforma, inactiva, correo, clave)",
          )
          .eq("cuentas.id_plataforma", plataformaId)
          .eq("ocupado", false)
          .order("id_perfil", { ascending: true });
        if (perfilHogar === true) {
          query = query.eq("perfil_hogar", true);
        } else {
          query = query.or("perfil_hogar.is.null,perfil_hogar.eq.false");
        }
        query = query.or("inactiva.is.null,inactiva.eq.false", {
          foreignTable: "cuentas",
        });
        if (excludeCuenta) query = query.neq("id_cuenta", excludeCuenta);
        const { data, error } = await query;
        if (error) return { error };
        const libre = (data || []).find((perfil) => {
          const perfilId = toPositiveId(perfil?.id_perfil);
          return !!perfilId && !bloqueados.perfiles.has(perfilId);
        });
        return { data: libre || null };
      };

      const findCuentaMiembroLibre = async (plataformaId, excludeCuenta) => {
        const { data: bloqueados, error: replErr } = await loadReemplazosCache(true);
        if (replErr) return { error: replErr };
        let query = supabase
          .from("cuentas")
          .select("id_cuenta, correo, clave, inactiva, ocupado, venta_perfil, venta_miembro")
          .eq("id_plataforma", plataformaId)
          .eq("venta_perfil", false)
          .eq("venta_miembro", true)
          .eq("ocupado", false)
          .order("id_cuenta", { ascending: true });
        query = query.or("inactiva.is.null,inactiva.eq.false");
        if (excludeCuenta) query = query.neq("id_cuenta", excludeCuenta);
        const { data, error } = await query;
        if (error) return { error };
        const libre = (data || []).find((cuenta) => {
          const cuentaId = toPositiveId(cuenta?.id_cuenta);
          return !!cuentaId && !bloqueados.cuentas.has(cuentaId);
        });
        return { data: libre || null };
      };

      const findSubCuentaLibre = async (plataformaId, excludeCuenta) => {
        return { data: null, error: null };
      };

      const findCuentaCompleta = async (plataformaId, excludeCuenta) => {
        const { data: bloqueados, error: replErr } = await loadReemplazosCache(true);
        if (replErr) return { error: replErr };
        let query = supabase
          .from("cuentas")
          .select("id_cuenta, correo, clave, inactiva")
          .eq("id_plataforma", plataformaId)
          .eq("venta_perfil", false)
          .eq("venta_miembro", false)
          .eq("inactiva", false)
          .or("ocupado.is.null,ocupado.eq.false")
          .order("id_cuenta", { ascending: true });
        if (excludeCuenta) query = query.neq("id_cuenta", excludeCuenta);
        const { data, error } = await query;
        if (error) return { error };
        const libre = (data || []).find((cuenta) => {
          const cuentaId = toPositiveId(cuenta?.id_cuenta);
          return !!cuentaId && !bloqueados.cuentas.has(cuentaId);
        });
        return { data: libre || null };
      };

      const findPerfilLibreCuentaMadre = async (plataformaId, excludeCuenta) => {
        const { data: bloqueados, error: replErr } = await loadReemplazosCache(true);
        if (replErr) return { error: replErr };
        let query = supabase
          .from("perfiles")
          .select(
            "id_perfil, id_cuenta, n_perfil, ocupado, cuentas!perfiles_id_cuenta_fkey!inner(id_cuenta, id_plataforma, cuenta_madre, inactiva)",
          )
          .eq("cuentas.id_plataforma", plataformaId)
          .eq("cuentas.cuenta_madre", true)
          .eq("ocupado", false)
          .order("id_perfil", { ascending: true });
        query = query.or("inactiva.is.null,inactiva.eq.false", {
          foreignTable: "cuentas",
        });
        if (excludeCuenta) query = query.neq("id_cuenta", excludeCuenta);
        const { data, error } = await query;
        if (error) return { error };
        const libre = (data || []).find((perfil) => {
          const perfilId = toPositiveId(perfil?.id_perfil);
          return !!perfilId && !bloqueados.perfiles.has(perfilId);
        });
        return { data: libre || null };
      };

      const handleCambiarCuentaMadre = async (btn) => {
        try {
          if (!currentCuentaDetalle?.isPlat9) return;
          const ventaId = btn.dataset.idventa || "";
          if (!ventaId) {
            alert("No se encontr√≥ la venta asociada.");
            return;
          }
          const oldPerfilId = btn.dataset.perfil || null;
          const oldCuentaId =
            btn.dataset.cuenta || currentCuentaDetalle?.id_cuenta || null;
          const { data: ventaInfo, error: ventaErr } = await supabase
            .from("ventas")
            .select("id_venta, id_cuenta, id_perfil, id_cuenta_miembro")
            .eq("id_venta", ventaId)
            .maybeSingle();
          if (ventaErr) throw ventaErr;
          const { data: perfilDestino, error: perfilErr } =
            await findPerfilLibreCuentaMadre(9, oldCuentaId);
          if (perfilErr) throw perfilErr;
          if (!perfilDestino) {
            await supabase
              .from("ventas")
              .update({ pendiente: true, reportado: true })
              .eq("id_venta", ventaId);
            alert("Sin stock de cuentas madre. Solicitud enviada.");
            return;
          }
          const nuevoCuenta = perfilDestino.id_cuenta;
          const nuevoPerfil = perfilDestino.id_perfil;
          const { error: updVentaErr } = await supabase
            .from("ventas")
            .update({
              id_cuenta: nuevoCuenta,
              id_perfil: nuevoPerfil,
              pendiente: true,
              reportado: true,
            })
            .eq("id_venta", ventaId);
          if (updVentaErr) throw updVentaErr;
          if (ventaInfo?.id_cuenta_miembro) {
            await supabase
              .from("cuentas")
              .update({ id_cuenta_madre: nuevoCuenta })
              .eq("id_cuenta", ventaInfo.id_cuenta_miembro);
          }
          const perfilPrev = ventaInfo?.id_perfil || oldPerfilId;
          if (perfilPrev) {
            await supabase
              .from("perfiles")
              .update({ ocupado: false })
              .eq("id_perfil", perfilPrev);
          }
          await supabase
            .from("perfiles")
            .update({ ocupado: true })
            .eq("id_perfil", nuevoPerfil);
          alert("Cuenta madre cambiada.");
          if (currentCuentaDetalle?.id_cuenta) {
            loadCuentaDetalle(currentCuentaDetalle.id_cuenta);
          }
        } catch (err) {
          console.error("cambiar cuenta madre error", err);
          alert("No se pudo cambiar la cuenta madre.");
        }
      };

      const obtenerVentaPerfil = (perfilId) => {
        if (!currentCuentaDetalle?.perfiles) return null;
        const row = currentCuentaDetalle.perfiles.find(
          (p) => String(p.id_perfil) === String(perfilId),
        );
        return row?.id_venta || null;
      };

      modalPinSave?.addEventListener("click", async () => {
        if (!modalState.targetId) {
          closePinModal();
          return;
        }
        const newPin = modalPinInput?.value.trim() || "";
        if (
          modalState.type === "pin" &&
          modalState.max &&
          newPin.length > modalState.max
        ) {
          alert(`El PIN no debe exceder ${modalState.max} d√≠gitos.`);
          return;
        }
        try {
          if (modalState.type === "pin") {
            const { error } = await supabase
              .from("perfiles")
              .update({ pin: newPin || null })
              .eq("id_perfil", modalState.targetId);
            if (error) throw error;
            const pinBtn = detalleEl?.querySelector(
              `.btn-pin[data-perfil="${modalState.targetId}"]`,
            );
            const pinSpan = pinBtn
              ?.closest(".pin-cell")
              ?.querySelector(".pin-copy");
            if (pinSpan) {
              pinSpan.textContent = newPin || "";
              pinSpan.dataset.clipboard = newPin || "";
            }
            if (pinBtn) pinBtn.dataset.pin = newPin || "";
            const pinRow = pinBtn?.closest("tr");
            const replPinBtn = pinRow?.querySelector(".btn-reemplazar-row");
            if (replPinBtn) {
              replPinBtn.dataset.pin = newPin || "";
            }
            updateRowCopyPayload(pinRow);

            // Notificar cambio de PIN al usuario de la venta del perfil
            const { data: ventaPerfil, error: ventaErr } = await supabase
              .from("ventas")
              .select("id_usuario, id_cuenta, id_cuenta_miembro, fecha_corte")
              .eq("id_perfil", modalState.targetId)
              .maybeSingle();
            if (ventaErr) throw ventaErr;

            // Si la cuenta involucrada es miembro, sincroniza tambi√©n el PIN en cuentas.pin.
            const cuentaIdsCandidatas = new Set();
            const cuentaDetalleId = toPositiveId(currentCuentaDetalle?.id_cuenta);
            if (currentCuentaDetalle?.venta_miembro === true && cuentaDetalleId) {
              cuentaIdsCandidatas.add(cuentaDetalleId);
            }
            const cuentaVentaId = toPositiveId(ventaPerfil?.id_cuenta);
            const cuentaMiembroVentaId = toPositiveId(ventaPerfil?.id_cuenta_miembro);
            if (cuentaVentaId) cuentaIdsCandidatas.add(cuentaVentaId);
            if (cuentaMiembroVentaId) cuentaIdsCandidatas.add(cuentaMiembroVentaId);
            if (cuentaIdsCandidatas.size) {
              const ids = Array.from(cuentaIdsCandidatas);
              const { data: cuentasTipos, error: cuentasTiposErr } = await supabase
                .from("cuentas")
                .select("id_cuenta, venta_miembro")
                .in("id_cuenta", ids);
              if (cuentasTiposErr) throw cuentasTiposErr;
              const cuentasMiembroIds = (cuentasTipos || [])
                .filter((c) => c?.venta_miembro === true)
                .map((c) => toPositiveId(c?.id_cuenta))
                .filter(Boolean);
              if (cuentasMiembroIds.length) {
                const resSyncPin = await Promise.all(
                  cuentasMiembroIds.map((idCuenta) =>
                    supabase
                      .from("cuentas")
                      .update({ pin: newPin || null })
                      .eq("id_cuenta", idCuenta),
                  ),
                );
                const syncErr = resSyncPin.find((r) => r?.error)?.error;
                if (syncErr) throw syncErr;
              }
            }

            const userIds = pickNotificationUserIds("pin_actualizado", {
              ventaUserId: ventaPerfil?.id_usuario,
            });
            if (userIds.length) {
              const notif = buildNotificationPayload(
                "pin_actualizado",
                {
                  plataforma: modalState.plataforma || "",
                  correoCuenta: modalState.correo || "",
                  perfil: modalState.nPerfil ? `M${modalState.nPerfil}` : "",
                  pin: newPin || "",
                },
                { idCuenta: ventaPerfil?.id_cuenta || currentCuentaId },
              );
              const rows = userIds.map((uid) => ({
                ...notif,
                id_usuario: uid,
              }));
              const { error: notifErr } = await supabase
                .from("notificaciones")
                .insert(rows);
              if (notifErr) throw notifErr;
            }
          } else if (modalState.type === "clave") {
            const { error } = await supabase
              .from("cuentas")
              .update({ clave: newPin || null })
              .eq("id_cuenta", modalState.targetId);
            if (error) throw error;

            // Si la cuenta es miembro/dominio, sincroniza la clave en ventas.
            let isCuentaMiembro = false;
            let isCuentaDominio = false;
            let correoCuentaDominio = (modalState?.correo || "").trim();
            if (
              currentCuentaDetalle &&
              String(currentCuentaDetalle.id_cuenta || "") ===
                String(modalState.targetId || "")
            ) {
              isCuentaMiembro = currentCuentaDetalle.venta_miembro === true;
              isCuentaDominio = currentCuentaDetalle.venta_dominio === true;
              if (!correoCuentaDominio) {
                correoCuentaDominio = (currentCuentaDetalle.correo || "").trim();
              }
            } else {
              const { data: cuentaTipo, error: cuentaTipoErr } = await supabase
                .from("cuentas")
                .select("venta_miembro, venta_dominio, correo")
                .eq("id_cuenta", modalState.targetId)
                .maybeSingle();
              if (cuentaTipoErr) throw cuentaTipoErr;
              isCuentaMiembro = cuentaTipo?.venta_miembro === true;
              isCuentaDominio = cuentaTipo?.venta_dominio === true;
              if (!correoCuentaDominio) {
                correoCuentaDominio = (cuentaTipo?.correo || "").trim();
              }
            }
            if (isCuentaMiembro) {
              const targetCuentaId = Number(modalState.targetId);
              const updatesVentas = [];
              updatesVentas.push(
                supabase
                  .from("ventas")
                  .update({ clave_miembro: newPin || null })
                  .eq("id_cuenta_miembro", targetCuentaId),
              );
              updatesVentas.push(
                supabase
                  .from("ventas")
                  .update({ clave_miembro: newPin || null })
                  .eq("id_cuenta", targetCuentaId)
                  .is("id_cuenta_miembro", null),
              );
              const ventasResults = await Promise.all(updatesVentas);
              const ventasErr = ventasResults.find((r) => r?.error)?.error;
              if (ventasErr) throw ventasErr;
            }
            if (isCuentaDominio && correoCuentaDominio) {
              const { error: ventasDomErr } = await supabase
                .from("ventas")
                .update({ clave_miembro: newPin || null })
                .eq("correo_miembro", correoCuentaDominio);
              if (ventasDomErr) throw ventasDomErr;
            }

            // Notificar cambio de clave a usuarios con fecha_corte >= ma√±ana y no suspendidos
            const { data: ventasUsuarios, error: ventErr } = await supabase
              .from("ventas")
              .select("id_usuario, fecha_corte, suspendido")
              .eq("id_cuenta", modalState.targetId);
            if (ventErr) throw ventErr;

            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const tomorrowStr = tomorrow.toISOString().slice(0, 10);
            const userIds = Array.from(
              new Set(
                (ventasUsuarios || [])
                  .filter((v) => {
                    if (v?.suspendido === true) return false;
                    if (!v?.fecha_corte) return false;
                    return v.fecha_corte >= tomorrowStr;
                  })
                  .map((v) => v.id_usuario)
                  .filter(Boolean),
              ),
            );
            if (userIds.length) {
              const notif = buildNotificationPayload(
                "clave_actualizada",
                {
                  plataforma: modalState.plataforma || "",
                  correoCuenta: modalState.correo || "",
                  clave: newPin || "",
                },
                { idCuenta: modalState.targetId },
              );
              const rows = userIds.map((uid) => ({
                ...notif,
                id_usuario: uid,
              }));
              const { error: notifErr } = await supabase
                .from("notificaciones")
                .insert(rows);
              if (notifErr) throw notifErr;
            }
          }
          if (modalState.type === "clave") {
            const claveText = newPin || "-";
            const claveClipboard = newPin || "";
            if (
              currentCuentaDetalle &&
              String(currentCuentaDetalle.id_cuenta || "") ===
                String(modalState.targetId || "")
            ) {
              currentCuentaDetalle.clave = newPin || "";
            }
            const platformCredVals = detalleEl?.querySelectorAll(
              ".cuenta-platform-cred .cred-copy",
            );
            if (platformCredVals?.length > 1) {
              platformCredVals[1].textContent = claveText;
              platformCredVals[1].dataset.clipboard = claveClipboard;
            }
            const claveBtns = Array.from(
              detalleEl?.querySelectorAll(
                `.btn-clave[data-cuenta="${modalState.targetId}"]`,
              ) || [],
            );
            claveBtns.forEach((btn) => {
              btn.dataset.clave = newPin || "";
              const claveSpan = btn.closest("p")?.querySelector(".cred-copy");
              if (claveSpan) {
                claveSpan.textContent = claveText;
                claveSpan.dataset.clipboard = claveClipboard;
              }
            });
            detalleEl?.querySelectorAll(".btn-reemplazar-row[data-clave]").forEach((btn) => {
              btn.dataset.clave = newPin || "";
            });
            detalleEl?.querySelectorAll(".btn-recargar-cuenta").forEach((btn) => {
              btn.dataset.clave = newPin || "";
            });
            detalleEl?.querySelectorAll("tr").forEach((row) => {
              updateRowCopyPayload(row);
            });
          }
          closePinModal();
        } catch (err) {
          console.error("update pin/clave error", err);
          alert("No se pudo actualizar.");
        }
      });
    </script>

    <div id="modal-reemplazar-cuenta" class="modal hidden" aria-hidden="true">
      <div class="modal-backdrop"></div>
      <div class="modal-card replace-account-modal-card">
        <button
          class="modal-close"
          id="btn-reemplazar-cuenta-close"
          aria-label="Cerrar"
        >
          √ó
        </button>
        <div class="replace-account-modal-body">
          <h3 class="replace-account-modal-title">Reemplazar cuenta</h3>
          <label class="replace-account-field">
            <span class="replace-account-label">Correo</span>
            <input
              type="text"
              id="input-reemplazar-cuenta-correo"
              class="replace-account-input"
              placeholder="correo@ejemplo.com"
            />
          </label>
          <label class="replace-account-field">
            <span class="replace-account-label">Clave</span>
            <input
              type="text"
              id="input-reemplazar-cuenta-clave"
              class="replace-account-input"
              placeholder="Ingresa la clave"
            />
          </label>
          <label class="replace-account-field">
            <span class="replace-account-label">Fecha de corte</span>
            <input
              type="date"
              id="input-reemplazar-cuenta-fecha"
              class="replace-account-input"
            />
          </label>
          <div class="replace-account-actions">
            <button
              type="button"
              class="btn-outline"
              id="btn-reemplazar-cuenta-cancel"
            >
              Cancelar
            </button>
            <button
              type="button"
              class="btn-primary"
              id="btn-reemplazar-cuenta-confirm"
            >
              Reemplazar
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="modal-reemplazo-confirm" class="modal hidden" aria-hidden="true">
      <div class="modal-backdrop"></div>
      <div class="modal-card modal-card-resumen" style="max-width: 360px; text-align: center">
        <div class="modal-body">
          <p id="modal-reemplazo-confirm-msg" style="margin: 0 0 14px 0; font-weight: 700">
            ¬øQuieres reemplazar este servicio?
          </p>
          <div style="display: flex; gap: 10px; justify-content: center">
            <button type="button" class="btn-primary" id="btn-reemplazo-confirm-si">S√≠</button>
            <button type="button" class="btn-outline" id="btn-reemplazo-confirm-no">No</button>
          </div>
        </div>
      </div>
    </div>

    <div id="modal-reemplazar-relacionados" class="modal hidden" aria-hidden="true">
      <div class="modal-backdrop"></div>
      <div class="modal-card modal-card-resumen" style="max-width: 360px; text-align: center">
        <div class="modal-body">
          <p style="margin: 0 0 14px 0; font-weight: 700">¬øReemplazar clientes relacionados?</p>
          <div style="display: flex; gap: 10px; justify-content: center">
            <button type="button" class="btn-primary" id="btn-reemplazar-relacionados-si">S√≠</button>
            <button type="button" class="btn-outline" id="btn-reemplazar-relacionados-no">No</button>
          </div>
        </div>
      </div>
    </div>

    <div id="modal-tareas" class="modal hidden" aria-hidden="true">
      <div class="modal-backdrop"></div>
      <div class="modal-card" style="max-width: 420px">
        <button class="modal-close" aria-label="Cerrar">√ó</button>
        <div class="modal-body resumen-body">
          <h3 style="margin: 0">Marcar tarea</h3>
          <div id="tareas-list" class="tareas-list"></div>
          <div class="tareas-actions">
            <button type="button" class="btn-outline" id="btn-tareas-cancel">Cancelar</button>
            <button type="button" class="btn-primary" id="btn-tareas-send">Enviar</button>
          </div>
        </div>
      </div>
    </div>

    <div id="modal-reemplazo-row" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div
        class="modal-card modal-card-resumen"
        style="max-width: 280px; text-align: center"
      >
        <button class="modal-close" aria-label="Cerrar">√ó</button>
        <div class="modal-body resumen-body">
          <p id="modal-reemplazo-msg" style="margin: 0; font-weight: 600">
            Reemplazando...
          </p>
          <button
            type="button"
            id="btn-reemplazo-copy"
            class="btn-outline"
            style="
              margin-top: 10px;
              white-space: pre-wrap;
              text-align: left;
              width: 100%;
            "
          >
            Copiar resumen
          </button>
          <pre
            id="modal-reemplazo-copytext"
            style="white-space: pre-wrap; text-align: left; margin: 6px 0 0 0"
          ></pre>
        </div>
      </div>
    </div>

    <div id="modal-miembro-add" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div
        class="modal-card modal-card-resumen"
        style="max-width: 320px; text-align: center"
      >
        <button class="modal-close" aria-label="Cerrar">√ó</button>
        <div class="modal-body">
          <p style="margin: 0 0 10px 0">
            No se encontr√≥ esta cuenta en la base de datos.
          </p>
          <p style="margin: 0 0 14px 0">¬øDeseas agregar este servicio?</p>
          <div style="display: flex; gap: 10px; justify-content: center">
            <button type="button" class="btn-primary" id="btn-miembro-si">
              S√≠, agregar
            </button>
            <button type="button" class="btn-outline" id="btn-miembro-no">
              Cancelar
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="modal-pin" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-card modal-card-resumen" style="max-width: 320px">
        <button class="modal-close" id="btn-cerrar-pin" aria-label="Cerrar">
          √ó
        </button>
        <div class="modal-body modal-renovar-sel-body">
          <h3 id="modal-pin-title">Cambiar PIN</h3>
          <input type="text" id="input-pin" class="input" />
          <button type="button" class="btn-primary" id="btn-guardar-pin">
            Guardar
          </button>
        </div>
      </div>
    </div>
    <div class="page-bottom-spacer"></div>
  </body>
</html>
