<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Editar precios</title>
    <link rel="stylesheet" href="../../styles/styles.css" />
    <style>
      .precios-wrapper {
        display: flex;
        flex-direction: column;
        gap: 16px;
        width: 100%;
        max-width: none;
      }
      .plan-editor {
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .plan-text {
        flex: 1;
      }
      .plan-edit-controls {
        display: flex;
        flex-direction: column;
        gap: 6px;
        width: 100%;
      }
      .plan-edit {
        background: transparent;
        border: none;
        cursor: pointer;
        font-size: 14px;
      }
      .plan-input-wrap {
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .plan-input,
      .plan-select {
        width: 100%;
        padding: 6px 8px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 12px;
      }
      .plan-save {
        background: transparent;
        border: none;
        cursor: pointer;
        font-size: 14px;
      }
      .precio-block {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 12px;
        background: #fff;
      }
      .precio-block h3 {
        margin: 0 0 8px 0;
        font-size: 16px;
      }
      .precio-table {
        width: 100%;
        border-collapse: collapse;
      }
      .precio-table th,
      .precio-table td {
        border: 1px solid #e5e7eb;
        padding: 8px;
        text-align: left;
      }
      .precio-table th {
        background: var(--table-header-bg, #2c2f36);
        color: #fff;
      }
      .precio-table tbody tr:nth-child(odd) {
        background: #fafafa;
      }
      .precio-cell {
        position: relative;
        padding-right: 78px;
      }
      .inline-edit {
        display: flex;
        align-items: center;
        gap: 6px;
        width: 100%;
      }
      .inline-edit input {
        flex: 1;
        width: 100%;
        padding: 6px 8px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        box-sizing: border-box;
        font-size: 14px;
      }
      .inline-save {
        background: transparent;
        border: none;
        cursor: pointer;
        font-size: 14px;
      }
      .precio-cell input {
        width: 100%;
        padding: 6px 8px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        box-sizing: border-box;
        font-size: 14px;
      }
      .precio-actions {
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }
      .precio-edit,
      .precio-delete {
        background: #111;
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 6px 8px;
        cursor: pointer;
        line-height: 1;
      }
      .precio-delete {
        background: #dc2626;
      }
      .qty-popover {
        position: absolute;
        top: 100%;
        left: 0;
        z-index: 10;
        background: #fff;
        border: 1px solid #d1d5db;
        border-radius: 10px;
        padding: 10px;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        gap: 8px;
        min-width: 180px;
      }
      .qty-controls {
        display: flex;
        align-items: center;
        gap: 8px;
        justify-content: space-between;
      }
      .qty-controls button {
        width: 32px;
        height: 32px;
        border-radius: 10px;
        border: 1px solid #d1d5db;
        background: #111;
        color: #fff;
        cursor: pointer;
      }
      .qty-value {
        min-width: 40px;
        text-align: center;
        font-weight: 700;
      }
      .qty-popover select {
        padding: 8px 10px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
      }
      .qty-actions {
        display: flex;
        gap: 8px;
        justify-content: flex-end;
      }
      .qty-actions button {
        padding: 6px 10px;
        border-radius: 8px;
        border: none;
        cursor: pointer;
      }
      .btn-save {
        background: #111;
        color: #fff;
      }
      .btn-cancel {
        background: #e5e7eb;
        color: #111;
      }
      .row-add {
        background: #d1d5db !important;
        color: #111;
        cursor: pointer;
        height: 24px;
      }
      .row-add:hover {
        background: #10b981 !important;
        color: #fff;
      }
      .descuento-config {
        min-width: 170px;
        padding-right: 8px;
      }
      .descuento-inline {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        width: 100%;
      }
      .descuento-cell-wrap {
        display: flex;
        flex-direction: column;
        gap: 6px;
        width: 100%;
      }
      .descuento-select {
        width: 100%;
        min-width: 120px;
        padding: 6px 8px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        background: #fff;
        font-size: 12px;
      }
      .descuento-scope-label {
        font-size: 10px;
        font-weight: 700;
        color: #6b7280;
        letter-spacing: 0.02em;
        text-transform: uppercase;
      }
      .descuento-pair-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 6px;
        width: 100%;
      }
      .descuento-pair-item {
        display: flex;
        flex-direction: column;
        gap: 4px;
        min-width: 0;
      }
      .descuento-pair-check {
        display: inline-flex;
        align-items: center;
        justify-content: flex-start;
        gap: 6px;
        font-size: 11px;
        color: #6b7280;
      }
      .descuento-pair-check input[type="checkbox"] {
        width: 14px;
        height: 14px;
        accent-color: #16a34a;
        cursor: pointer;
      }
      .descuento-pair-check input[type="checkbox"]:disabled {
        cursor: not-allowed;
        opacity: 0.6;
      }
      .descuento-help {
        width: 26px;
        height: 26px;
        border-radius: 999px;
        border: 1px solid #d1d5db;
        background: #111;
        color: #fff;
        cursor: pointer;
        font-weight: 700;
        line-height: 1;
      }
      .descuento-help:hover {
        background: #000;
      }
      .descuentos-modal-card {
        width: min(920px, 94vw);
        max-width: 920px;
      }
      .descuentos-modal-body {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .descuentos-table-wrap {
        width: 100%;
        overflow: auto;
        max-height: 62vh;
      }
      .descuentos-table th,
      .descuentos-table td {
        text-align: center;
        white-space: nowrap;
      }
      .descuentos-col-h {
        min-width: 120px;
      }
      .descuento-check-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 4px 8px;
        width: 100%;
        align-items: center;
      }
      .descuento-check-title {
        font-size: 10px;
        font-weight: 700;
        color: #6b7280;
        text-align: center;
      }
      .descuento-check {
        display: inline-flex;
        justify-content: center;
        align-items: center;
      }
      .descuento-check input[type="checkbox"] {
        width: 14px;
        height: 14px;
        accent-color: #16a34a;
        cursor: pointer;
      }
      .descuento-check input[type="checkbox"]:disabled {
        cursor: not-allowed;
        opacity: 0.6;
      }
      .descuento-check-mark {
        font-size: 11px;
        font-weight: 700;
        color: #6b7280;
        text-align: center;
        line-height: 1;
      }
      .descuento-warning {
        margin: 0;
        font-size: 12px;
        color: #b45309;
      }
    </style>
  </head>
  <body>
    <div id="app-header" data-header-root="../../" data-header-pages="../../"></div>
    <script src="../../scripts/header-loader.js"></script>

    <main class="categorias-dinamicas">
      <h2>Editar precios</h2>
      <div class="precios-wrapper" id="precios-wrapper">
        <p class="status" id="estado">Cargando plataformas y precios...</p>
      </div>
      <div style="height: 160px;"></div>
    </main>

    <div id="descuentos-modal" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-card descuentos-modal-card">
        <button type="button" id="descuentos-modal-close" class="modal-close" aria-label="Cerrar">√ó</button>
        <div class="modal-body descuentos-modal-body">
          <h3>Grupos de descuentos por columna</h3>
          <div class="descuentos-table-wrap">
            <table class="table-base descuentos-table" id="descuentos-table"></table>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import { requireSession, attachLogout, attachLogoHome } from "../../scripts/session.js";
      import { clearServerSession, supabase } from "../../scripts/api.js";

      requireSession();
      attachLogoHome();
      attachLogout(clearServerSession);

      const wrapper = document.getElementById("precios-wrapper");
      const estadoEl = document.getElementById("estado");
      const descuentosModalEl = document.getElementById("descuentos-modal");
      const descuentosModalCloseEl = document.getElementById("descuentos-modal-close");
      const descuentosModalBackdropEl = descuentosModalEl?.querySelector(".modal-backdrop");
      const descuentosTableEl = document.getElementById("descuentos-table");

      const FALLBACK_DISCOUNT_COLUMNS = ["descuento_1", "descuento_2", "descuento_3", "descuento_4"];
      let descuentoColumnas = [...FALLBACK_DISCOUNT_COLUMNS];
      let descuentoOpciones = [];
      let descuentosFilas = [];
      let soporteColumnasDescuentoPlataforma = true;
      let soporteChecksDescuentoPlataforma = true;
      let soporteColumnasDescuentoPorGrupo = true;
      let soporteDescuentoFilaIds = true;
      let soporteDescuentoFilaGrupo = true;
      let soporteDescuentoFilaChecks = true;

      const setEstado = (msg) => {
        if (estadoEl) estadoEl.textContent = msg || "";
      };

      const obtenerColumnasDescuento = (rows = []) => {
        if (!Array.isArray(rows) || !rows.length) return [...FALLBACK_DISCOUNT_COLUMNS];
        const keys = Object.keys(rows[0] || {});
        const desdeTercera = keys.slice(2).filter(Boolean);
        const columnas = desdeTercera.filter((k) => /^descuento_/i.test(String(k)));
        if (columnas.length) return columnas;
        const porNombre = keys.filter((k) => /^descuento_/i.test(String(k)));
        return porNombre.length ? porNombre : [...FALLBACK_DISCOUNT_COLUMNS];
      };

      const construirOpcionesDescuento = (rows = [], columnas = []) => {
        const ids = [];
        (rows || []).forEach((row) => {
          const id = Number(row?.id_descuento);
          if (!Number.isFinite(id)) return;
          if (!ids.includes(id)) ids.push(id);
        });
        return (columnas || []).map((col, idx) => ({
          label: col,
          id: Number.isFinite(Number(ids[idx])) ? Number(ids[idx]) : null,
          pos: idx + 1,
        }));
      };

      const getDescuentoIdPorPos = (pos = 1) => {
        const target = Number(pos);
        const opt = descuentoOpciones.find((o) => Number(o.pos) === target && Number.isFinite(Number(o.id)));
        if (opt) return Number(opt.id);
        const first = descuentoOpciones.find((o) => Number.isFinite(Number(o.id)));
        return first ? Number(first.id) : null;
      };

      const normalizarIdDescuento = (value, fallback = null) => {
        const num = Number(value);
        if (Number.isFinite(num) && descuentoOpciones.some((o) => Number(o.id) === num)) {
          return Math.trunc(num);
        }
        const fallbackNum = Number(fallback);
        if (Number.isFinite(fallbackNum) && descuentoOpciones.some((o) => Number(o.id) === fallbackNum)) {
          return Math.trunc(fallbackNum);
        }
        return getDescuentoIdPorPos(1);
      };

      const resolveScopeFields = (field = "") =>
        field === "id_descuento_mes"
          ? {
              detalField: "aplica_descuento_mes_detal",
              mayorField: "aplica_descuento_mes_mayor",
            }
          : {
              detalField: "aplica_descuento_cantidad_detal",
              mayorField: "aplica_descuento_cantidad_mayor",
            };

      const resolveDiscountGroupFields = (field = "") =>
        field === "id_descuento_mes"
          ? {
              legacyField: "id_descuento_mes",
              detalField: "id_descuento_mes_detal",
              mayorField: "id_descuento_mes_mayor",
            }
          : {
              legacyField: "id_descuento_cantidad",
              detalField: "id_descuento_cantidad_detal",
              mayorField: "id_descuento_cantidad_mayor",
            };

      const fallbackPosByDiscountField = (field = "") =>
        /cantidad/i.test(String(field || "")) ? 2 : 1;

      const isExplicitFalse = (v) =>
        v === false || v === 0 || v === "0" || String(v || "").toLowerCase() === "false";

      const isSet = (v) => v !== undefined && v !== null && v !== "";

      const canPersistFieldPerRow = (field = "") => {
        const f = String(field || "");
        if (!f) return false;
        if (/^aplica_descuento_/i.test(f)) return soporteDescuentoFilaChecks;
        if (/^id_descuento_.*_(detal|mayor)$/i.test(f)) {
          return soporteDescuentoFilaIds && soporteDescuentoFilaGrupo;
        }
        if (/^id_descuento_/i.test(f)) return soporteDescuentoFilaIds;
        return false;
      };

      const canPersistFieldOnPlatform = (field = "") => {
        const f = String(field || "");
        if (!f) return false;
        if (/^aplica_descuento_/i.test(f)) return soporteChecksDescuentoPlataforma;
        if (/^id_descuento_.*_(detal|mayor)$/i.test(f)) {
          return soporteColumnasDescuentoPlataforma && soporteColumnasDescuentoPorGrupo;
        }
        if (/^id_descuento_/i.test(f)) return soporteColumnasDescuentoPlataforma;
        return false;
      };

      const valorDescuento = (row, col) => {
        const raw = Number(row?.[col]);
        return Number.isFinite(raw) ? raw : null;
      };

      const renderModalDescuentos = () => {
        if (!descuentosTableEl) return;
        const cols = [...descuentoColumnas];
        if (!descuentosFilas.length) {
          descuentosTableEl.innerHTML = `
            <thead>
              <tr><th>Meses</th>${cols.map((c) => `<th class="descuentos-col-h">${c}</th>`).join("")}</tr>
            </thead>
            <tbody>
              <tr><td colspan="${cols.length + 1}">No hay datos en la tabla descuentos.</td></tr>
            </tbody>
          `;
          return;
        }
        descuentosTableEl.innerHTML = `
          <thead>
            <tr>
              <th>Meses</th>
              ${cols.map((c) => `<th class="descuentos-col-h">${c}</th>`).join("")}
            </tr>
          </thead>
          <tbody>
            ${descuentosFilas
              .map((row) => {
                const meses = row?.meses ?? "-";
                const values = cols
                  .map((c) => {
                    const v = valorDescuento(row, c);
                    return `<td>${v == null ? "-" : `${v}%`}</td>`;
                  })
                  .join("");
                return `<tr><td>${meses}</td>${values}</tr>`;
              })
              .join("")}
          </tbody>
        `;
      };

      const abrirModalDescuentos = () => {
        renderModalDescuentos();
        descuentosModalEl?.classList.remove("hidden");
        document.body.classList.add("modal-open");
      };

      const cerrarModalDescuentos = () => {
        descuentosModalEl?.classList.add("hidden");
        document.body.classList.remove("modal-open");
      };

      const formatCantidad = (cantidad, flags = {}, completa = false) => {
        if (cantidad == null) return "-";
        const { por_pantalla, por_acceso } = flags;
        if (completa) return `${cantidad} cuenta completa`;
        if (por_pantalla) return `${cantidad} pantalla${cantidad === 1 ? "" : "s"}`;
        if (por_acceso) return `${cantidad} dispositivo${cantidad === 1 ? "" : "s"}`;
        return `${cantidad}`;
      };

      const renderActions = ({ editLabel, showDelete = false, deleteLabel }) => {
        const deleteBtn = showDelete
          ? `<button type="button" class="precio-delete" aria-label="${deleteLabel || "Eliminar"}">üóëÔ∏è</button>`
          : "";
        return `
          <span class="precio-actions">
            <button type="button" class="precio-edit" aria-label="${editLabel}">‚úèÔ∏è</button>
            ${deleteBtn}
          </span>
        `;
      };

      const renderDescuentoCell = (platMeta = {}, field, value) => {
        const idPlataforma = platMeta.id_plataforma;
        const idPrecio = Number(platMeta.id_precio);
        const isPlat9 = Number(idPlataforma) === 9;
        const fallbackId = getDescuentoIdPorPos(fallbackPosByDiscountField(field));
        const selected = normalizarIdDescuento(value, fallbackId);
        const hasValidOptions = descuentoOpciones.some((o) => Number.isFinite(Number(o.id)));
        const { detalField, mayorField } = resolveScopeFields(field);
        const { detalField: detalIdField, mayorField: mayorIdField } = resolveDiscountGroupFields(field);
        const detalEnabled = !isExplicitFalse(platMeta?.[detalField]);
        const mayorEnabled = !isExplicitFalse(platMeta?.[mayorField]);
        const resolvePersistMeta = (preferredField = "", fallbackField = preferredField) => {
          const pref = String(preferredField || "");
          const fallback = String(fallbackField || pref);
          const canRowPref = Number.isFinite(idPrecio) && canPersistFieldPerRow(pref);
          if (canRowPref) return { field: pref, target: "precios", supported: true };
          const canPlatPref = canPersistFieldOnPlatform(pref);
          if (canPlatPref) return { field: pref, target: "plataformas", supported: true };
          const canRowFallback = Number.isFinite(idPrecio) && canPersistFieldPerRow(fallback);
          if (canRowFallback) return { field: fallback, target: "precios", supported: true };
          const canPlatFallback = canPersistFieldOnPlatform(fallback);
          if (canPlatFallback) return { field: fallback, target: "plataformas", supported: true };
          return { field: fallback, target: "plataformas", supported: false };
        };
        const selectPersistDefault = resolvePersistMeta(field, field);
        const detalScopePersist = resolvePersistMeta(detalField, detalField);
        const mayorScopePersist = resolvePersistMeta(mayorField, mayorField);
        const selectEnabled = hasValidOptions && selectPersistDefault.supported;
        const title = !hasValidOptions
          ? "No hay IDs v√°lidos en descuentos para guardar."
          : selectPersistDefault.supported
            ? "Selecciona la columna de descuentos"
            : "Faltan columnas id_descuento_mes/id_descuento_cantidad en plataformas/precios";
        const haySoporteGrupo =
          (Number.isFinite(idPrecio) && soporteDescuentoFilaGrupo) || soporteColumnasDescuentoPorGrupo;
        const titlePorGrupo = !haySoporteGrupo
          ? "Faltan columnas id_descuento_*_detal/id_descuento_*_mayor en plataformas/precios."
          : title;

        if (isPlat9) {
          const detalPersist = resolvePersistMeta(detalIdField, field);
          const mayorPersist = resolvePersistMeta(mayorIdField, field);
          const detalUsaGrupo = detalPersist.field === detalIdField;
          const mayorUsaGrupo = mayorPersist.field === mayorIdField;
          const detalleValue = normalizarIdDescuento(
            detalUsaGrupo ? platMeta?.[detalIdField] : selected,
            selected
          );
          const mayorValue = normalizarIdDescuento(
            mayorUsaGrupo ? platMeta?.[mayorIdField] : selected,
            selected
          );
          const detalSelectEnabled = hasValidOptions && detalPersist.supported;
          const mayorSelectEnabled = hasValidOptions && mayorPersist.supported;
          return `
            <td class="precio-cell descuento-config">
              <div class="descuento-cell-wrap">
                <div class="descuento-inline">
                  <div class="descuento-pair-grid">
                    <label class="descuento-pair-item">
                      <span class="descuento-scope-label">Detal</span>
                      <select
                        class="descuento-select"
                        data-descuento-select="1"
                        data-field="${detalPersist.field}"
                        data-target="${detalPersist.target}"
                        data-group="detal"
                        data-plat="${idPlataforma}"
                        data-price="${Number.isFinite(idPrecio) ? idPrecio : ""}"
                        data-prev="${detalleValue ?? ""}"
                        title="${titlePorGrupo}"
                        ${detalSelectEnabled ? "" : "disabled"}
                      >
                        ${descuentoOpciones
                          .map(
                            (opt) =>
                              `<option value="${opt.id ?? ""}" ${detalleValue === opt.id ? "selected" : ""} ${
                                Number.isFinite(Number(opt.id)) ? "" : "disabled"
                              }>${opt.label}</option>`
                          )
                          .join("")}
                      </select>
                      <label class="descuento-pair-check">
                        <input
                          type="checkbox"
                          data-descuento-scope="1"
                          data-plat="${idPlataforma}"
                          data-field="${detalField}"
                          data-target="${detalScopePersist.target}"
                          data-price="${Number.isFinite(idPrecio) ? idPrecio : ""}"
                          ${detalScopePersist.supported ? "" : "disabled"}
                          ${detalEnabled ? "checked" : ""}
                        />
                        <span>Aplicar</span>
                      </label>
                    </label>
                    <label class="descuento-pair-item">
                      <span class="descuento-scope-label">Mayor</span>
                      <select
                        class="descuento-select"
                        data-descuento-select="1"
                        data-field="${mayorPersist.field}"
                        data-target="${mayorPersist.target}"
                        data-group="mayor"
                        data-plat="${idPlataforma}"
                        data-price="${Number.isFinite(idPrecio) ? idPrecio : ""}"
                        data-prev="${mayorValue ?? ""}"
                        title="${titlePorGrupo}"
                        ${mayorSelectEnabled ? "" : "disabled"}
                      >
                        ${descuentoOpciones
                          .map(
                            (opt) =>
                              `<option value="${opt.id ?? ""}" ${mayorValue === opt.id ? "selected" : ""} ${
                                Number.isFinite(Number(opt.id)) ? "" : "disabled"
                              }>${opt.label}</option>`
                          )
                          .join("")}
                      </select>
                      <label class="descuento-pair-check">
                        <input
                          type="checkbox"
                          data-descuento-scope="1"
                          data-plat="${idPlataforma}"
                          data-field="${mayorField}"
                          data-target="${mayorScopePersist.target}"
                          data-price="${Number.isFinite(idPrecio) ? idPrecio : ""}"
                          ${mayorScopePersist.supported ? "" : "disabled"}
                          ${mayorEnabled ? "checked" : ""}
                        />
                        <span>Aplicar</span>
                      </label>
                    </label>
                  </div>
                  <button type="button" class="descuento-help" data-descuento-help="1" aria-label="Ver tabla de descuentos">?</button>
                </div>
              </div>
            </td>
          `;
        }

        return `
          <td class="precio-cell descuento-config">
            <div class="descuento-cell-wrap">
              <div class="descuento-inline">
                <select
                  class="descuento-select"
                  data-descuento-select="1"
                  data-field="${selectPersistDefault.field}"
                  data-target="${selectPersistDefault.target}"
                  data-plat="${idPlataforma}"
                  data-price="${Number.isFinite(idPrecio) ? idPrecio : ""}"
                  data-prev="${selected ?? ""}"
                  title="${title}"
                  ${selectEnabled ? "" : "disabled"}
                >
                  ${descuentoOpciones
                    .map(
                      (opt) =>
                        `<option value="${opt.id ?? ""}" ${selected === opt.id ? "selected" : ""} ${
                          Number.isFinite(Number(opt.id)) ? "" : "disabled"
                        }>${opt.label}</option>`
                    )
                    .join("")}
                </select>
                <button type="button" class="descuento-help" data-descuento-help="1" aria-label="Ver tabla de descuentos">?</button>
              </div>
              <div class="descuento-check-grid">
                <span class="descuento-check-title">Detal</span>
                <span class="descuento-check-title">Mayor</span>
                <label class="descuento-check">
                  <input
                    type="checkbox"
                    data-descuento-scope="1"
                    data-plat="${idPlataforma}"
                    data-field="${detalField}"
                    data-target="${detalScopePersist.target}"
                    data-price="${Number.isFinite(idPrecio) ? idPrecio : ""}"
                    ${detalScopePersist.supported ? "" : "disabled"}
                    ${detalEnabled ? "checked" : ""}
                  />
                </label>
                <label class="descuento-check">
                  <input
                    type="checkbox"
                    data-descuento-scope="1"
                    data-plat="${idPlataforma}"
                    data-field="${mayorField}"
                    data-target="${mayorScopePersist.target}"
                    data-price="${Number.isFinite(idPrecio) ? idPrecio : ""}"
                    ${mayorScopePersist.supported ? "" : "disabled"}
                    ${mayorEnabled ? "checked" : ""}
                  />
                </label>
              </div>
            </div>
          </td>
        `;
      };

      const renderTabla = (titulo, precios, platFlags = {}, platMeta = {}, planKey = null, planOptions = []) => {
        const esGift = !!platMeta.tarjeta_de_regalo;
        const descuentoMesHeader = "Descuento mes";
        const descuentoCantHeader = "Descuento cant.";
        const descuentoMes = normalizarIdDescuento(
          platMeta.id_descuento_mes,
          getDescuentoIdPorPos(1)
        );
        const descuentoCant = normalizarIdDescuento(
          platMeta.id_descuento_cantidad,
          getDescuentoIdPorPos(2)
        );
        const descuentoMesDetal = normalizarIdDescuento(
          platMeta.id_descuento_mes_detal,
          descuentoMes
        );
        const descuentoMesMayor = normalizarIdDescuento(
          platMeta.id_descuento_mes_mayor,
          descuentoMes
        );
        const descuentoCantDetal = normalizarIdDescuento(
          platMeta.id_descuento_cantidad_detal,
          descuentoCant
        );
        const descuentoCantMayor = normalizarIdDescuento(
          platMeta.id_descuento_cantidad_mayor,
          descuentoCant
        );
        const platMetaConDescuento = {
          ...platMeta,
          id_descuento_mes: descuentoMes,
          id_descuento_cantidad: descuentoCant,
          id_descuento_mes_detal: descuentoMesDetal,
          id_descuento_mes_mayor: descuentoMesMayor,
          id_descuento_cantidad_detal: descuentoCantDetal,
          id_descuento_cantidad_mayor: descuentoCantMayor,
        };
        const resolveDescuentoMetaFila = (precio = {}) => {
          const baseMes = platMetaConDescuento.id_descuento_mes;
          const baseCant = platMetaConDescuento.id_descuento_cantidad;
          const baseMesDetal = platMetaConDescuento.id_descuento_mes_detal;
          const baseMesMayor = platMetaConDescuento.id_descuento_mes_mayor;
          const baseCantDetal = platMetaConDescuento.id_descuento_cantidad_detal;
          const baseCantMayor = platMetaConDescuento.id_descuento_cantidad_mayor;
          return {
            ...platMetaConDescuento,
            id_precio: Number(precio?.id_precio),
            id_descuento_mes: normalizarIdDescuento(
              soporteDescuentoFilaIds && isSet(precio?.id_descuento_mes)
                ? precio.id_descuento_mes
                : baseMes,
              baseMes
            ),
            id_descuento_cantidad: normalizarIdDescuento(
              soporteDescuentoFilaIds && isSet(precio?.id_descuento_cantidad)
                ? precio.id_descuento_cantidad
                : baseCant,
              baseCant
            ),
            id_descuento_mes_detal: normalizarIdDescuento(
              soporteDescuentoFilaIds && soporteDescuentoFilaGrupo && isSet(precio?.id_descuento_mes_detal)
                ? precio.id_descuento_mes_detal
                : baseMesDetal,
              baseMesDetal
            ),
            id_descuento_mes_mayor: normalizarIdDescuento(
              soporteDescuentoFilaIds && soporteDescuentoFilaGrupo && isSet(precio?.id_descuento_mes_mayor)
                ? precio.id_descuento_mes_mayor
                : baseMesMayor,
              baseMesMayor
            ),
            id_descuento_cantidad_detal: normalizarIdDescuento(
              soporteDescuentoFilaIds && soporteDescuentoFilaGrupo && isSet(precio?.id_descuento_cantidad_detal)
                ? precio.id_descuento_cantidad_detal
                : baseCantDetal,
              baseCantDetal
            ),
            id_descuento_cantidad_mayor: normalizarIdDescuento(
              soporteDescuentoFilaIds && soporteDescuentoFilaGrupo && isSet(precio?.id_descuento_cantidad_mayor)
                ? precio.id_descuento_cantidad_mayor
                : baseCantMayor,
              baseCantMayor
            ),
            aplica_descuento_mes_detal:
              soporteDescuentoFilaChecks && isSet(precio?.aplica_descuento_mes_detal)
                ? !isExplicitFalse(precio.aplica_descuento_mes_detal)
                : !isExplicitFalse(platMetaConDescuento?.aplica_descuento_mes_detal),
            aplica_descuento_mes_mayor:
              soporteDescuentoFilaChecks && isSet(precio?.aplica_descuento_mes_mayor)
                ? !isExplicitFalse(precio.aplica_descuento_mes_mayor)
                : !isExplicitFalse(platMetaConDescuento?.aplica_descuento_mes_mayor),
            aplica_descuento_cantidad_detal:
              soporteDescuentoFilaChecks && isSet(precio?.aplica_descuento_cantidad_detal)
                ? !isExplicitFalse(precio.aplica_descuento_cantidad_detal)
                : !isExplicitFalse(platMetaConDescuento?.aplica_descuento_cantidad_detal),
            aplica_descuento_cantidad_mayor:
              soporteDescuentoFilaChecks && isSet(precio?.aplica_descuento_cantidad_mayor)
                ? !isExplicitFalse(precio.aplica_descuento_cantidad_mayor)
                : !isExplicitFalse(platMetaConDescuento?.aplica_descuento_cantidad_mayor),
          };
        };
        const planOpts = (planOptions || []).filter(Boolean);
        const sorted = [...precios].sort((a, b) => {
          const aComp = a.completa ? 1 : 0;
          const bComp = b.completa ? 1 : 0;
          if (aComp !== bComp) return aComp - bComp; // primero pantallas/dispositivos, luego cuenta completa
          const aCant = Number(a.cantidad ?? 0);
          const bCant = Number(b.cantidad ?? 0);
          if (aCant !== bCant) return aCant - bCant;
          const aDur = Number(a.duracion ?? 0);
          const bDur = Number(b.duracion ?? 0);
          return aDur - bDur;
        });
        const rows = sorted
          .map((p) => {
            const descuentoMetaFila = resolveDescuentoMetaFila(p);
            if (esGift) {
              return `
              <tr>
                <td data-id="${p.id_precio || ""}" data-field="cantidad" class="precio-cell" data-completa="${p.completa ? "true" : "false"}" data-porpantalla="${platFlags.por_pantalla ? "true" : "false"}" data-poracceso="${platFlags.por_acceso ? "true" : "false"}" data-cantidad="${p.cantidad ?? ""}">
                  <span class="precio-text">${p.cantidad != null ? formatCantidad(p.cantidad, platFlags, p.completa) : "-"}</span>
                  ${renderActions({ editLabel: "Editar cantidad" })}
                </td>
                <td data-id="${p.id_precio || ""}" data-field="valor_tarjeta_de_regalo" class="precio-cell" data-valor="${p.valor_tarjeta_de_regalo ?? ""}" data-moneda="${p.moneda || ""}">
                  <span class="precio-text">${p.valor_tarjeta_de_regalo != null ? `${p.valor_tarjeta_de_regalo} ${p.moneda || ""}` : "-"}</span>
                  ${renderActions({
                    editLabel: "Editar valor",
                    showDelete: p.valor_tarjeta_de_regalo != null,
                    deleteLabel: "Eliminar valor",
                  })}
                </td>
                <td data-id="${p.id_precio || ""}" data-field="region" class="precio-cell" data-region="${p.region || ""}">
                  <span class="precio-text">${p.region || "-"}</span>
                  ${renderActions({ editLabel: "Editar regi√≥n" })}
                </td>
                <td data-id="${p.id_precio || ""}" data-field="precio_usd_detal" class="precio-cell">
                  <span class="precio-text">${p.precio_usd_detal != null ? `$${p.precio_usd_detal}` : "-"}</span>
                  ${renderActions({
                    editLabel: "Editar precio detal",
                    showDelete: p.precio_usd_detal != null,
                    deleteLabel: "Eliminar precio detal",
                  })}
                </td>
                <td data-id="${p.id_precio || ""}" data-field="precio_usd_mayor" class="precio-cell">
                  <span class="precio-text">${p.precio_usd_mayor != null ? `$${p.precio_usd_mayor}` : "-"}</span>
                  ${renderActions({
                    editLabel: "Editar precio mayor",
                    showDelete: p.precio_usd_mayor != null,
                    deleteLabel: "Eliminar precio mayor",
                  })}
                </td>
                ${renderDescuentoCell(descuentoMetaFila, "id_descuento_mes", descuentoMetaFila.id_descuento_mes)}
                ${renderDescuentoCell(descuentoMetaFila, "id_descuento_cantidad", descuentoMetaFila.id_descuento_cantidad)}
              </tr>
            `;
            }
            const planLabel = p.plan ? p.plan : "Sin plan";
            const planCell = `
                <td class="plan-cell">
                  <div class="plan-editor" data-id="${p.id_precio || ""}">
                    <span class="plan-text">${planLabel}</span>
                    <button type="button" class="plan-edit" data-id="${p.id_precio || ""}" aria-label="Editar plan">‚úèÔ∏è</button>
                    <div class="plan-edit-controls hidden">
                      <select class="plan-select">
                        <option value="">Seleccionar</option>
                        ${planOpts
                          .map(
                            (opt) =>
                              `<option value="${opt}" ${p.plan === opt ? "selected" : ""}>${opt}</option>`
                          )
                          .join("")}
                      </select>
                      <span class="plan-input-wrap">
                        <input type="text" class="plan-input" placeholder="Nuevo plan" />
                        <button type="button" class="plan-save" data-id="${p.id_precio || ""}" aria-label="Guardar plan">üíæ</button>
                        <button type="button" class="plan-cancel" aria-label="Cancelar">‚úñ</button>
                      </span>
                    </div>
                  </div>
                </td>
            `;
            return `
              <tr>
                <td data-id="${p.id_precio || ""}" data-field="cantidad" class="precio-cell" data-completa="${p.completa ? "true" : "false"}" data-porpantalla="${platFlags.por_pantalla ? "true" : "false"}" data-poracceso="${platFlags.por_acceso ? "true" : "false"}" data-cantidad="${p.cantidad ?? ""}">
                  <span class="precio-text">${p.cantidad != null ? formatCantidad(p.cantidad, platFlags, p.completa) : "-"}</span>
                  ${renderActions({ editLabel: "Editar cantidad" })}
                </td>
                ${planCell}
                <td data-id="${p.id_precio || ""}" data-field="duracion" class="precio-cell">
                  <span class="precio-text">${p.duracion != null ? `${p.duracion} mes${p.duracion === 1 ? "" : "es"}` : "-"}</span>
                  ${renderActions({ editLabel: "Editar duraci√≥n" })}
                </td>
                <td data-id="${p.id_precio || ""}" data-field="precio_usd_detal" class="precio-cell">
                  <span class="precio-text">${p.precio_usd_detal != null ? `$${p.precio_usd_detal}` : "-"}</span>
                  ${renderActions({
                    editLabel: "Editar precio detal",
                    showDelete: p.precio_usd_detal != null,
                    deleteLabel: "Eliminar precio detal",
                  })}
                </td>
                <td data-id="${p.id_precio || ""}" data-field="precio_usd_mayor" class="precio-cell">
                  <span class="precio-text">${p.precio_usd_mayor != null ? `$${p.precio_usd_mayor}` : "-"}</span>
                  ${renderActions({
                    editLabel: "Editar precio mayor",
                    showDelete: p.precio_usd_mayor != null,
                    deleteLabel: "Eliminar precio mayor",
                  })}
                </td>
                ${renderDescuentoCell(descuentoMetaFila, "id_descuento_mes", descuentoMetaFila.id_descuento_mes)}
                ${renderDescuentoCell(descuentoMetaFila, "id_descuento_cantidad", descuentoMetaFila.id_descuento_cantidad)}
              </tr>
            `;
          })
          .join("");
        return `
          <div class="precio-block">
            <h3>${titulo}</h3>
            <table class="table-base precio-table">
              <thead>
                <tr>
                  <th>Cantidad</th>
                  ${esGift ? "<th>Valor</th><th>Regi√≥n</th>" : "<th>Plan</th><th>Duraci√≥n</th>"}
                  <th>Precio USD detal</th>
                  <th>Precio USD mayor</th>
                  <th>${descuentoMesHeader}</th>
                  <th>${descuentoCantHeader}</th>
                </tr>
              </thead>
              <tbody>
                ${rows || `<tr><td colspan="7">Sin precios</td></tr>`}
                <tr class="row-add" data-add="true" data-plat="${platMeta.id_plataforma}" data-plan="${planKey || ""}" data-gift="${esGift}" data-porpantalla="${platFlags.por_pantalla ? "true" : "false"}" data-poracceso="${platFlags.por_acceso ? "true" : "false"}" data-descuento-mes="${descuentoMes}" data-descuento-cant="${descuentoCant}" data-descuento-mes-detal="${descuentoMesDetal}" data-descuento-mes-mayor="${descuentoMesMayor}" data-descuento-cant-detal="${descuentoCantDetal}" data-descuento-cant-mayor="${descuentoCantMayor}" data-aplica-descuento-mes-detal="${!isExplicitFalse(platMeta?.aplica_descuento_mes_detal)}" data-aplica-descuento-mes-mayor="${!isExplicitFalse(platMeta?.aplica_descuento_mes_mayor)}" data-aplica-descuento-cantidad-detal="${!isExplicitFalse(platMeta?.aplica_descuento_cantidad_detal)}" data-aplica-descuento-cantidad-mayor="${!isExplicitFalse(platMeta?.aplica_descuento_cantidad_mayor)}">
                  <td colspan="7" style="text-align:center; font-weight:700;">+</td>
                </tr>
              </tbody>
            </table>
          </div>
        `;
      };

      const agruparPorPlan = (precios) => {
        const planMap = new Map();
        precios.forEach((p) => {
          const key = p.plan || "__DEFAULT__";
          if (!planMap.has(key)) planMap.set(key, []);
          planMap.get(key).push(p);
        });
        return planMap;
      };

      const cargar = async () => {
        try {
          soporteColumnasDescuentoPlataforma = true;
          soporteChecksDescuentoPlataforma = true;
          soporteColumnasDescuentoPorGrupo = true;
          soporteDescuentoFilaIds = true;
          soporteDescuentoFilaGrupo = true;
          soporteDescuentoFilaChecks = true;
          const { data: descuentosData, error: descuentosErr } = await supabase
            .from("descuentos")
            .select("*")
            .order("meses", { ascending: true });
          if (descuentosErr) throw descuentosErr;
          descuentosFilas = descuentosData || [];
          descuentoColumnas = obtenerColumnasDescuento(descuentosFilas);
          descuentoOpciones = construirOpcionesDescuento(descuentosFilas, descuentoColumnas);

          let plataformas = [];
          let platErr = null;
          const selectPlataformasConDescuentosGrupo =
            "id_plataforma, nombre, por_pantalla, por_acceso, tarjeta_de_regalo, id_descuento_mes, id_descuento_cantidad, id_descuento_mes_detal, id_descuento_mes_mayor, id_descuento_cantidad_detal, id_descuento_cantidad_mayor, aplica_descuento_mes_detal, aplica_descuento_mes_mayor, aplica_descuento_cantidad_detal, aplica_descuento_cantidad_mayor";
          const selectPlataformasConDescuentos =
            "id_plataforma, nombre, por_pantalla, por_acceso, tarjeta_de_regalo, id_descuento_mes, id_descuento_cantidad, aplica_descuento_mes_detal, aplica_descuento_mes_mayor, aplica_descuento_cantidad_detal, aplica_descuento_cantidad_mayor";
          const selectPlataformasConIdsGrupo =
            "id_plataforma, nombre, por_pantalla, por_acceso, tarjeta_de_regalo, id_descuento_mes, id_descuento_cantidad, id_descuento_mes_detal, id_descuento_mes_mayor, id_descuento_cantidad_detal, id_descuento_cantidad_mayor";
          const selectPlataformasConIds =
            "id_plataforma, nombre, por_pantalla, por_acceso, tarjeta_de_regalo, id_descuento_mes, id_descuento_cantidad";
          const selectPlataformasBase =
            "id_plataforma, nombre, por_pantalla, por_acceso, tarjeta_de_regalo";

          ({ data: plataformas, error: platErr } = await supabase
            .from("plataformas")
            .select(selectPlataformasConDescuentosGrupo));

          if (platErr) {
            const msg = String(platErr.message || "");
            if (
              /id_descuento_mes_detal|id_descuento_mes_mayor|id_descuento_cantidad_detal|id_descuento_cantidad_mayor/i.test(
                msg
              )
            ) {
              soporteColumnasDescuentoPorGrupo = false;
              ({ data: plataformas, error: platErr } = await supabase
                .from("plataformas")
                .select(selectPlataformasConDescuentos));
            }
          }

          if (platErr) {
            const msg = String(platErr.message || "");
            if (
              /aplica_descuento_mes_detal|aplica_descuento_mes_mayor|aplica_descuento_cantidad_detal|aplica_descuento_cantidad_mayor/i.test(
                msg
              )
            ) {
              soporteChecksDescuentoPlataforma = false;
              const selectSinChecks = soporteColumnasDescuentoPorGrupo
                ? selectPlataformasConIdsGrupo
                : selectPlataformasConIds;
              ({ data: plataformas, error: platErr } = await supabase
                .from("plataformas")
                .select(selectSinChecks));
              if (!platErr) {
                plataformas = (plataformas || []).map((p) => ({
                  ...p,
                  aplica_descuento_mes_detal: true,
                  aplica_descuento_mes_mayor: true,
                  aplica_descuento_cantidad_detal: true,
                  aplica_descuento_cantidad_mayor: true,
                  id_descuento_mes_detal:
                    p.id_descuento_mes_detal ?? p.id_descuento_mes,
                  id_descuento_mes_mayor:
                    p.id_descuento_mes_mayor ?? p.id_descuento_mes,
                  id_descuento_cantidad_detal:
                    p.id_descuento_cantidad_detal ?? p.id_descuento_cantidad,
                  id_descuento_cantidad_mayor:
                    p.id_descuento_cantidad_mayor ?? p.id_descuento_cantidad,
                }));
              }
            } else if (/id_descuento_mes|id_descuento_cantidad/i.test(msg)) {
              soporteColumnasDescuentoPlataforma = false;
              soporteChecksDescuentoPlataforma = false;
              soporteColumnasDescuentoPorGrupo = false;
              ({ data: plataformas, error: platErr } = await supabase
                .from("plataformas")
                .select(selectPlataformasBase));
              if (!platErr) {
                plataformas = (plataformas || []).map((p) => ({
                  ...p,
                  id_descuento_mes: getDescuentoIdPorPos(1),
                  id_descuento_cantidad: getDescuentoIdPorPos(2),
                  id_descuento_mes_detal: getDescuentoIdPorPos(1),
                  id_descuento_mes_mayor: getDescuentoIdPorPos(1),
                  id_descuento_cantidad_detal: getDescuentoIdPorPos(2),
                  id_descuento_cantidad_mayor: getDescuentoIdPorPos(2),
                  aplica_descuento_mes_detal: true,
                  aplica_descuento_mes_mayor: true,
                  aplica_descuento_cantidad_detal: true,
                  aplica_descuento_cantidad_mayor: true,
                }));
              }
            }
          }
          if (platErr) throw platErr;
          plataformas = (plataformas || []).map((p) => {
            const descuentoMes = normalizarIdDescuento(
              p.id_descuento_mes,
              getDescuentoIdPorPos(1)
            );
            const descuentoCant = normalizarIdDescuento(
              p.id_descuento_cantidad,
              getDescuentoIdPorPos(2)
            );
            return {
              ...p,
              id_descuento_mes: descuentoMes,
              id_descuento_cantidad: descuentoCant,
              id_descuento_mes_detal: normalizarIdDescuento(p.id_descuento_mes_detal, descuentoMes),
              id_descuento_mes_mayor: normalizarIdDescuento(p.id_descuento_mes_mayor, descuentoMes),
              id_descuento_cantidad_detal: normalizarIdDescuento(
                p.id_descuento_cantidad_detal,
                descuentoCant
              ),
              id_descuento_cantidad_mayor: normalizarIdDescuento(
                p.id_descuento_cantidad_mayor,
                descuentoCant
              ),
            };
          });

          let precios = [];
          let priceErr = null;
          const selectPreciosConDescuentosGrupoChecks =
            "id_precio, id_plataforma, plan, cantidad, duracion, precio_usd_detal, precio_usd_mayor, completa, valor_tarjeta_de_regalo, moneda, region, id_descuento_mes, id_descuento_cantidad, id_descuento_mes_detal, id_descuento_mes_mayor, id_descuento_cantidad_detal, id_descuento_cantidad_mayor, aplica_descuento_mes_detal, aplica_descuento_mes_mayor, aplica_descuento_cantidad_detal, aplica_descuento_cantidad_mayor";
          const selectPreciosConDescuentosChecks =
            "id_precio, id_plataforma, plan, cantidad, duracion, precio_usd_detal, precio_usd_mayor, completa, valor_tarjeta_de_regalo, moneda, region, id_descuento_mes, id_descuento_cantidad, aplica_descuento_mes_detal, aplica_descuento_mes_mayor, aplica_descuento_cantidad_detal, aplica_descuento_cantidad_mayor";
          const selectPreciosConDescuentosGrupo =
            "id_precio, id_plataforma, plan, cantidad, duracion, precio_usd_detal, precio_usd_mayor, completa, valor_tarjeta_de_regalo, moneda, region, id_descuento_mes, id_descuento_cantidad, id_descuento_mes_detal, id_descuento_mes_mayor, id_descuento_cantidad_detal, id_descuento_cantidad_mayor";
          const selectPreciosConDescuentosBase =
            "id_precio, id_plataforma, plan, cantidad, duracion, precio_usd_detal, precio_usd_mayor, completa, valor_tarjeta_de_regalo, moneda, region, id_descuento_mes, id_descuento_cantidad";
          const selectPreciosBase =
            "id_precio, id_plataforma, plan, cantidad, duracion, precio_usd_detal, precio_usd_mayor, completa, valor_tarjeta_de_regalo, moneda, region";

          ({ data: precios, error: priceErr } = await supabase
            .from("precios")
            .select(selectPreciosConDescuentosGrupoChecks));

          if (priceErr) {
            const msg = String(priceErr.message || "");
            if (
              /id_descuento_mes_detal|id_descuento_mes_mayor|id_descuento_cantidad_detal|id_descuento_cantidad_mayor/i.test(
                msg
              )
            ) {
              soporteDescuentoFilaGrupo = false;
              ({ data: precios, error: priceErr } = await supabase
                .from("precios")
                .select(selectPreciosConDescuentosChecks));
            }
          }

          if (priceErr) {
            const msg = String(priceErr.message || "");
            if (
              /aplica_descuento_mes_detal|aplica_descuento_mes_mayor|aplica_descuento_cantidad_detal|aplica_descuento_cantidad_mayor/i.test(
                msg
              )
            ) {
              soporteDescuentoFilaChecks = false;
              const selectSinChecks = soporteDescuentoFilaGrupo
                ? selectPreciosConDescuentosGrupo
                : selectPreciosConDescuentosBase;
              ({ data: precios, error: priceErr } = await supabase
                .from("precios")
                .select(selectSinChecks));
            }
          }

          if (priceErr) {
            const msg = String(priceErr.message || "");
            if (/id_descuento_mes|id_descuento_cantidad/i.test(msg)) {
              soporteDescuentoFilaIds = false;
              soporteDescuentoFilaGrupo = false;
              soporteDescuentoFilaChecks = false;
              ({ data: precios, error: priceErr } = await supabase
                .from("precios")
                .select(selectPreciosBase));
            }
          }
          if (priceErr) throw priceErr;
          const planOptionsByPlat = (precios || []).reduce((acc, p) => {
            if (!acc[p.id_plataforma]) acc[p.id_plataforma] = new Set();
            if (p.plan) acc[p.id_plataforma].add(p.plan);
            return acc;
          }, {});

          if (!plataformas?.length) {
            setEstado("No hay plataformas.");
            return;
          }

          const priceByPlat = (precios || []).reduce((acc, p) => {
            if (!acc[p.id_plataforma]) acc[p.id_plataforma] = [];
            acc[p.id_plataforma].push(p);
            return acc;
          }, {});

          plataformas.sort((a, b) => Number(a.id_plataforma) - Number(b.id_plataforma));
          const blocks = plataformas.map((plat) => {
            const preciosPlat = priceByPlat[plat.id_plataforma] || [];
            const flags = {
              por_pantalla: plat.por_pantalla,
              por_acceso: plat.por_acceso,
            };
            const planOpts = Array.from(planOptionsByPlat[plat.id_plataforma] || []);
            return renderTabla(
              plat.nombre || `Plataforma ${plat.id_plataforma}`,
              preciosPlat,
              flags,
              plat,
              null,
              planOpts
            );
          });

          if (wrapper) {
            wrapper.innerHTML = blocks.join("");
          }
          const warnings = [];
          if (!soporteColumnasDescuentoPorGrupo) {
            warnings.push(
              "Faltan columnas por grupo en plataformas: id_descuento_*_detal/id_descuento_*_mayor."
            );
          }
          if (!soporteColumnasDescuentoPlataforma && !soporteChecksDescuentoPlataforma) {
            warnings.push("Faltan columnas en plataformas: id_descuento_* y aplica_descuento_*.");
          } else if (!soporteColumnasDescuentoPlataforma) {
            warnings.push("Faltan columnas en plataformas: id_descuento_mes y id_descuento_cantidad.");
          } else if (!soporteChecksDescuentoPlataforma) {
            warnings.push("Faltan columnas de check en plataformas: aplica_descuento_*.");
          }
          if (!soporteDescuentoFilaIds) {
            warnings.push("Faltan columnas en precios: id_descuento_mes/id_descuento_cantidad.");
          } else {
            if (!soporteDescuentoFilaGrupo) {
              warnings.push(
                "Faltan columnas por grupo en precios: id_descuento_*_detal/id_descuento_*_mayor."
              );
            }
            if (!soporteDescuentoFilaChecks) {
              warnings.push("Faltan columnas de check en precios: aplica_descuento_*.");
            }
          }
          setEstado(warnings.join(" "));
          attachPrecioEditors();
        } catch (err) {
          console.error("editar precios init error", err);
          setEstado("No se pudieron cargar las plataformas/precios.");
        }
      };

      const attachPrecioEditors = () => {
        wrapper?.addEventListener("change", async (e) => {
          const descuentoScope = e.target.closest('[data-descuento-scope="1"]');
          if (descuentoScope) {
            const idPlataforma = Number(descuentoScope.dataset.plat);
            const idPrecio = Number(descuentoScope.dataset.price);
            const field = String(descuentoScope.dataset.field || "");
            const target = String(descuentoScope.dataset.target || "plataformas");
            const nextValue = !!descuentoScope.checked;
            if (!field || (target === "precios" && !idPrecio) || (target !== "precios" && !idPlataforma)) {
              return;
            }
            try {
              const query =
                target === "precios"
                  ? supabase.from("precios").update({ [field]: nextValue }).eq("id_precio", idPrecio)
                  : supabase
                      .from("plataformas")
                      .update({ [field]: nextValue })
                      .eq("id_plataforma", idPlataforma);
              const { error } = await query;
              if (error) throw error;
              if (target !== "precios") {
                const rowAdds = wrapper?.querySelectorAll(`.row-add[data-plat="${idPlataforma}"]`) || [];
                rowAdds.forEach((row) => {
                  if (field === "aplica_descuento_mes_detal") row.dataset.aplicaDescuentoMesDetal = String(nextValue);
                  if (field === "aplica_descuento_mes_mayor") row.dataset.aplicaDescuentoMesMayor = String(nextValue);
                  if (field === "aplica_descuento_cantidad_detal")
                    row.dataset.aplicaDescuentoCantidadDetal = String(nextValue);
                  if (field === "aplica_descuento_cantidad_mayor")
                    row.dataset.aplicaDescuentoCantidadMayor = String(nextValue);
                });
                setEstado(`Actualizado ${field} en plataforma #${idPlataforma}.`);
              } else {
                setEstado(`Actualizado ${field} en precio #${idPrecio}.`);
              }
            } catch (err) {
              console.error("update descuento scope error", err);
              descuentoScope.checked = !nextValue;
              alert("No se pudo actualizar el check de descuento.");
            }
            return;
          }

          const descuentoSelect = e.target.closest('[data-descuento-select="1"]');
          if (!descuentoSelect) return;
          const idPlataforma = Number(descuentoSelect.dataset.plat);
          const idPrecio = Number(descuentoSelect.dataset.price);
          const field = String(descuentoSelect.dataset.field || "");
          const target = String(descuentoSelect.dataset.target || "plataformas");
          const group = String(descuentoSelect.dataset.group || "").trim().toLowerCase();
          const fallbackId = getDescuentoIdPorPos(fallbackPosByDiscountField(field));
          const nextValue = normalizarIdDescuento(descuentoSelect.value, fallbackId);
          const prevValue = normalizarIdDescuento(descuentoSelect.dataset.prev, fallbackId);
          if (!Number.isFinite(Number(nextValue))) {
            alert("No hay IDs de descuentos v√°lidos para guardar.");
            descuentoSelect.value = String(prevValue ?? "");
            return;
          }
          if (!field || !nextValue) return;
          if (target === "precios" && !idPrecio) return;
          if (target !== "precios" && !idPlataforma) return;
          try {
            const query =
              target === "precios"
                ? supabase.from("precios").update({ [field]: nextValue }).eq("id_precio", idPrecio)
                : supabase
                    .from("plataformas")
                    .update({ [field]: nextValue })
                    .eq("id_plataforma", idPlataforma);
            const { error } = await query;
            if (error) throw error;
            wrapper
              ?.querySelectorAll(
                target === "precios"
                  ? group
                    ? `[data-descuento-select="1"][data-target="precios"][data-price="${idPrecio}"][data-field="${field}"][data-group="${group}"]`
                    : `[data-descuento-select="1"][data-target="precios"][data-price="${idPrecio}"][data-field="${field}"]`
                  : group
                    ? `[data-descuento-select="1"][data-target="plataformas"][data-plat="${idPlataforma}"][data-field="${field}"][data-group="${group}"]`
                    : `[data-descuento-select="1"][data-target="plataformas"][data-plat="${idPlataforma}"][data-field="${field}"]`
              )
              .forEach((el) => {
                el.value = String(nextValue);
                el.dataset.prev = String(nextValue);
              });
            if (target !== "precios") {
              const rowAdds = wrapper?.querySelectorAll(`.row-add[data-plat="${idPlataforma}"]`) || [];
              rowAdds.forEach((row) => {
                if (field === "id_descuento_mes") {
                  row.dataset.descuentoMes = String(nextValue);
                  if (group === "detal") row.dataset.descuentoMesDetal = String(nextValue);
                  if (group === "mayor") row.dataset.descuentoMesMayor = String(nextValue);
                }
                if (field === "id_descuento_cantidad") {
                  row.dataset.descuentoCant = String(nextValue);
                  if (group === "detal") row.dataset.descuentoCantDetal = String(nextValue);
                  if (group === "mayor") row.dataset.descuentoCantMayor = String(nextValue);
                }
                if (field === "id_descuento_mes_detal") row.dataset.descuentoMesDetal = String(nextValue);
                if (field === "id_descuento_mes_mayor") row.dataset.descuentoMesMayor = String(nextValue);
                if (field === "id_descuento_cantidad_detal") row.dataset.descuentoCantDetal = String(nextValue);
                if (field === "id_descuento_cantidad_mayor") row.dataset.descuentoCantMayor = String(nextValue);
              });
              setEstado(`Actualizado ${field} en plataforma #${idPlataforma}.`);
            } else {
              setEstado(`Actualizado ${field} en precio #${idPrecio}.`);
            }
          } catch (err) {
            console.error("update descuento plataforma error", err);
            descuentoSelect.value = String(prevValue);
            if (String(err?.code || "") === "23503") {
              alert(
                "No se pudo guardar porque el id_descuento no existe en la tabla descuentos (FK 23503)."
              );
            } else {
              alert("No se pudo actualizar la columna de descuento.");
            }
          }
        });

        wrapper?.addEventListener("click", async (e) => {
          const descuentoHelpBtn = e.target.closest('[data-descuento-help="1"]');
          if (descuentoHelpBtn) {
            abrirModalDescuentos();
            return;
          }

          const planEditBtn = e.target.closest(".plan-edit");
          if (planEditBtn) {
            const editor = planEditBtn.closest(".plan-editor");
            const text = editor?.querySelector(".plan-text");
            const controls = editor?.querySelector(".plan-edit-controls");
            if (text) text.classList.add("hidden");
            if (controls) controls.classList.remove("hidden");
            planEditBtn.classList.add("hidden");
            const input = editor?.querySelector(".plan-input");
            if (input) input.focus();
            return;
          }
          const planCancelBtn = e.target.closest(".plan-cancel");
          if (planCancelBtn) {
            const editor = planCancelBtn.closest(".plan-editor");
            const text = editor?.querySelector(".plan-text");
            const controls = editor?.querySelector(".plan-edit-controls");
            const editBtn = editor?.querySelector(".plan-edit");
            if (controls) controls.classList.add("hidden");
            if (text) text.classList.remove("hidden");
            if (editBtn) editBtn.classList.remove("hidden");
            const input = editor?.querySelector(".plan-input");
            if (input) input.value = "";
            return;
          }
          const planSaveBtn = e.target.closest(".plan-save");
          if (planSaveBtn) {
            const editor = planSaveBtn.closest(".plan-editor");
            const input = editor?.querySelector(".plan-input");
            const select = editor?.querySelector(".plan-select");
            const text = editor?.querySelector(".plan-text");
            const controls = editor?.querySelector(".plan-edit-controls");
            const editBtn = editor?.querySelector(".plan-edit");
            const precioId = planSaveBtn.dataset.id;
            const typed = (input?.value || "").trim();
            const selected = (select?.value || "").trim();
            const newPlan = typed || selected;
            if (!precioId || !newPlan) {
              alert("Ingresa o selecciona un plan.");
              return;
            }
            (async () => {
              try {
                const { error } = await supabase
                  .from("precios")
                  .update({ plan: newPlan })
                  .eq("id_precio", precioId);
                if (error) throw error;
                if (input) input.value = "";
                if (select) select.value = newPlan;
                if (text) {
                  text.textContent = newPlan || "Sin plan";
                  text.classList.remove("hidden");
                }
                if (controls) controls.classList.add("hidden");
                if (editBtn) editBtn.classList.remove("hidden");
                setEstado("Plan actualizado.");
              } catch (err) {
                console.error("update plan error", err);
                alert("No se pudo actualizar el plan.");
              }
            })();
            return;
          }
          const exitEdit = (cell, newText) => {
            const displaySpan = cell.querySelector(".precio-text");
            if (displaySpan) displaySpan.textContent = newText;
            cell.querySelectorAll(".qty-popover").forEach((p) => p.remove());
          };

          const addRow = e.target.closest(".row-add");
          if (addRow) {
            (async () => {
              const platId = addRow.dataset.plat;
              const plan = addRow.dataset.plan || null;
              const esGift = addRow.dataset.gift === "true";
              const por_pantalla = addRow.dataset.porpantalla === "true";
              const por_acceso = addRow.dataset.poracceso === "true";
              const aplicaMesDetal = !isExplicitFalse(addRow.dataset.aplicaDescuentoMesDetal);
              const aplicaMesMayor = !isExplicitFalse(addRow.dataset.aplicaDescuentoMesMayor);
              const aplicaCantidadDetal = !isExplicitFalse(addRow.dataset.aplicaDescuentoCantidadDetal);
              const aplicaCantidadMayor = !isExplicitFalse(addRow.dataset.aplicaDescuentoCantidadMayor);
              const descuentoMes = normalizarIdDescuento(
                addRow.dataset.descuentoMes,
                getDescuentoIdPorPos(1)
              );
              const descuentoCant = normalizarIdDescuento(
                addRow.dataset.descuentoCant,
                getDescuentoIdPorPos(2)
              );
              const descuentoMesDetal = normalizarIdDescuento(
                addRow.dataset.descuentoMesDetal,
                descuentoMes
              );
              const descuentoMesMayor = normalizarIdDescuento(
                addRow.dataset.descuentoMesMayor,
                descuentoMes
              );
              const descuentoCantDetal = normalizarIdDescuento(
                addRow.dataset.descuentoCantDetal,
                descuentoCant
              );
              const descuentoCantMayor = normalizarIdDescuento(
                addRow.dataset.descuentoCantMayor,
                descuentoCant
              );
              const platMetaForRow = {
                id_plataforma: Number(platId),
                id_descuento_mes: descuentoMes,
                id_descuento_cantidad: descuentoCant,
                id_descuento_mes_detal: descuentoMesDetal,
                id_descuento_mes_mayor: descuentoMesMayor,
                id_descuento_cantidad_detal: descuentoCantDetal,
                id_descuento_cantidad_mayor: descuentoCantMayor,
                aplica_descuento_mes_detal: aplicaMesDetal,
                aplica_descuento_mes_mayor: aplicaMesMayor,
                aplica_descuento_cantidad_detal: aplicaCantidadDetal,
                aplica_descuento_cantidad_mayor: aplicaCantidadMayor,
              };
              try {
                const payload = {
                  id_plataforma: Number(platId),
                  plan: plan || null,
                  completa: false,
                };
                if (soporteDescuentoFilaIds) {
                  payload.id_descuento_mes = descuentoMes;
                  payload.id_descuento_cantidad = descuentoCant;
                  if (soporteDescuentoFilaGrupo) {
                    payload.id_descuento_mes_detal = descuentoMesDetal;
                    payload.id_descuento_mes_mayor = descuentoMesMayor;
                    payload.id_descuento_cantidad_detal = descuentoCantDetal;
                    payload.id_descuento_cantidad_mayor = descuentoCantMayor;
                  }
                }
                if (soporteDescuentoFilaChecks) {
                  payload.aplica_descuento_mes_detal = aplicaMesDetal;
                  payload.aplica_descuento_mes_mayor = aplicaMesMayor;
                  payload.aplica_descuento_cantidad_detal = aplicaCantidadDetal;
                  payload.aplica_descuento_cantidad_mayor = aplicaCantidadMayor;
                }
                const { data, error } = await supabase
                  .from("precios")
                  .insert(payload)
                  .select()
                  .single();
                if (error) throw error;
                const tbody = addRow.closest("tbody");
                if (!tbody) return;
                const tr = document.createElement("tr");
                const descuentoMetaNuevaFila = {
                  ...platMetaForRow,
                  id_precio: Number(data.id_precio),
                };
                if (esGift) {
                  tr.innerHTML = `
                    <td data-id="${data.id_precio}" data-field="cantidad" class="precio-cell" data-completa="${data.completa ? "true" : "false"}" data-porpantalla="${por_pantalla}" data-poracceso="${por_acceso}" data-cantidad="${data.cantidad ?? ""}">
                      <span class="precio-text">-</span>
                      ${renderActions({ editLabel: "Editar cantidad" })}
                    </td>
                    <td data-id="${data.id_precio}" data-field="valor_tarjeta_de_regalo" class="precio-cell" data-valor="${data.valor_tarjeta_de_regalo ?? ""}" data-moneda="${data.moneda || ""}">
                      <span class="precio-text">-</span>
                      ${renderActions({ editLabel: "Editar valor" })}
                    </td>
                    <td data-id="${data.id_precio}" data-field="region" class="precio-cell" data-region="${data.region || ""}">
                      <span class="precio-text">-</span>
                      ${renderActions({ editLabel: "Editar regi√≥n" })}
                    </td>
                    <td data-id="${data.id_precio}" data-field="precio_usd_detal" class="precio-cell">
                      <span class="precio-text">-</span>
                      ${renderActions({ editLabel: "Editar precio detal" })}
                    </td>
                    <td data-id="${data.id_precio}" data-field="precio_usd_mayor" class="precio-cell">
                      <span class="precio-text">-</span>
                      ${renderActions({ editLabel: "Editar precio mayor" })}
                    </td>
                    ${renderDescuentoCell(descuentoMetaNuevaFila, "id_descuento_mes", descuentoMes)}
                    ${renderDescuentoCell(descuentoMetaNuevaFila, "id_descuento_cantidad", descuentoCant)}
                  `;
                } else {
                  tr.innerHTML = `
                    <td data-id="${data.id_precio}" data-field="cantidad" class="precio-cell" data-completa="${data.completa ? "true" : "false"}" data-porpantalla="${por_pantalla}" data-poracceso="${por_acceso}" data-cantidad="${data.cantidad ?? ""}">
                      <span class="precio-text">-</span>
                      ${renderActions({ editLabel: "Editar cantidad" })}
                    </td>
                    <td class="plan-cell">
                      <div class="plan-editor" data-id="${data.id_precio}">
                        <span class="plan-text">Sin plan</span>
                        <button type="button" class="plan-edit" data-id="${data.id_precio}" aria-label="Editar plan">‚úèÔ∏è</button>
                        <div class="plan-edit-controls hidden">
                          <select class="plan-select">
                            <option value="">Seleccionar</option>
                          </select>
                          <span class="plan-input-wrap">
                            <input type="text" class="plan-input" placeholder="Nuevo plan" />
                            <button type="button" class="plan-save" data-id="${data.id_precio}" aria-label="Guardar plan">üíæ</button>
                            <button type="button" class="plan-cancel" aria-label="Cancelar">‚úñ</button>
                          </span>
                        </div>
                      </div>
                    </td>
                    <td data-id="${data.id_precio}" data-field="duracion" class="precio-cell">
                      <span class="precio-text">-</span>
                      ${renderActions({ editLabel: "Editar duraci√≥n" })}
                    </td>
                    <td data-id="${data.id_precio}" data-field="precio_usd_detal" class="precio-cell">
                      <span class="precio-text">-</span>
                      ${renderActions({ editLabel: "Editar precio detal" })}
                    </td>
                    <td data-id="${data.id_precio}" data-field="precio_usd_mayor" class="precio-cell">
                      <span class="precio-text">-</span>
                      ${renderActions({ editLabel: "Editar precio mayor" })}
                    </td>
                    ${renderDescuentoCell(descuentoMetaNuevaFila, "id_descuento_mes", descuentoMes)}
                    ${renderDescuentoCell(descuentoMetaNuevaFila, "id_descuento_cantidad", descuentoCant)}
                  `;
                }
                tbody.insertBefore(tr, addRow);
              } catch (err) {
                console.error("insert precio error", err);
                alert("No se pudo crear la fila.");
              }
            })();
            return;
          }

          const deleteBtn = e.target.closest(".precio-delete");
          if (deleteBtn) {
            const cell = deleteBtn.closest(".precio-cell");
            if (!cell) return;
            const precioId = cell.dataset.id;
            const field = cell.dataset.field;
            if (!precioId || !field) return;
            try {
              const updatePayload = { [field]: null };
              if (field === "valor_tarjeta_de_regalo") updatePayload.moneda = null;
              const { error } = await supabase
                .from("precios")
                .update(updatePayload)
                .eq("id_precio", precioId);
              if (error) throw error;
              if (field === "valor_tarjeta_de_regalo") {
                cell.dataset.valor = "";
                cell.dataset.moneda = "";
              }
              const span = cell.querySelector(".precio-text");
              if (span) span.textContent = "-";
              deleteBtn.remove();
              setEstado("Valor eliminado.");
            } catch (err) {
              console.error("delete precio error", err);
              alert("No se pudo eliminar el valor.");
            }
            return;
          }

          const btn = e.target.closest(".precio-edit");
          if (!btn) return;
          const cell = btn.closest(".precio-cell");
          if (!cell) return;
          const precioId = cell.dataset.id;
          const field = cell.dataset.field;
          if (!precioId || !field) return;

          // cerrar ediciones anteriores
          wrapper.querySelectorAll(".qty-popover").forEach((p) => p.remove());
          wrapper.querySelectorAll(".precio-cell input").forEach((inp) => {
            const spanText = inp.dataset.original || inp.value;
            const span = document.createElement("span");
            span.className = "precio-text";
            span.textContent = spanText;
            inp.replaceWith(span);
          });
          wrapper.querySelectorAll(".precio-edit").forEach((b) => (b.textContent = "‚úèÔ∏è"));

          const span = cell.querySelector(".precio-text");
          if (!span) return;

          // Cantidad
          if (field === "cantidad") {
            const existingPop = cell.querySelector(".qty-popover");
            if (existingPop) {
              existingPop.remove();
              btn.textContent = "‚úèÔ∏è";
              return;
            }
            const isCantidad = field === "cantidad";
            const labelBase =
              cell.dataset.porpantalla === "true"
                ? "Pantalla"
                : cell.dataset.poracceso === "true"
                ? "Dispositivo"
                : "Cantidad";
            const isCompleta = cell.dataset.completa === "true";
            const currentQty = parseInt(
              isCantidad ? cell.dataset.cantidad || "1" : span.textContent.replace(/\D/g, "") || "1",
              10
            ) || 1;
            const esGift = span.closest("table")?.querySelector(".row-add")?.dataset.gift === "true";

            const pop = document.createElement("div");
            pop.className = "qty-popover";
            pop.innerHTML = `
              <div class="qty-controls">
                <button type="button" data-act="minus">-</button>
                <input type="number" class="qty-input" value="${currentQty}" min="1" step="1" />
                <button type="button" data-act="plus">+</button>
              </div>
              ${
                isCantidad && !esGift
                  ? `<select class="qty-select">
                      <option value="unit" ${!isCompleta ? "selected" : ""}>${labelBase}</option>
                      <option value="full" ${isCompleta ? "selected" : ""}>Cuenta completa</option>
                    </select>`
                  : ""
              }
              <div class="qty-actions">
                <button type="button" class="btn-cancel">Cancelar</button>
                <button type="button" class="btn-save">Guardar</button>
              </div>
            `;
            cell.appendChild(pop);
            btn.textContent = "üíæ";

            const qtyInput = pop.querySelector(".qty-input");
            const selectEl = pop.querySelector(".qty-select");
            const updateQty = (delta) => {
              const current = parseInt(qtyInput.value, 10) || 1;
              const next = Math.max(1, current + delta);
              qtyInput.value = next;
            };
            pop.addEventListener("click", (ev) => {
              if (ev.target.dataset.act === "minus") updateQty(-1);
              else if (ev.target.dataset.act === "plus") updateQty(1);
            });

            const saveQty = async () => {
              const qty = parseInt(qtyInput.value, 10);
              if (!qty || qty <= 0) {
                alert("El valor debe ser mayor a 0.");
                return;
              }
              if (isCantidad) {
                const completaFlag = selectEl?.value === "full";
                try {
                  const { error } = await supabase
                    .from("precios")
                    .update({ cantidad: qty, completa: completaFlag })
                    .eq("id_precio", precioId);
                  if (error) throw error;
                  cell.dataset.cantidad = qty;
                  cell.dataset.completa = completaFlag ? "true" : "false";
                  const flags = {
                    por_pantalla: cell.dataset.porpantalla === "true",
                    por_acceso: cell.dataset.poracceso === "true",
                  };
                  const flagsFormat = { por_pantalla: flags.porpantalla, por_acceso: flags.poracceso };
                  exitEdit(cell, formatCantidad(qty, flagsFormat, completaFlag));
                  setEstado("Cantidad actualizada.");
                } catch (err) {
                  console.error("update cantidad error", err);
                  alert("No se pudo actualizar la cantidad.");
                  return;
                }
              } else {
                try {
                  const { error } = await supabase
                    .from("precios")
                    .update({ duracion: qty })
                    .eq("id_precio", precioId);
                  if (error) throw error;
                  exitEdit(cell, `${qty} mes${qty === 1 ? "" : "es"}`);
                  setEstado("Duraci√≥n actualizada.");
                } catch (err) {
                  console.error("update duraci√≥n error", err);
                  alert("No se pudo actualizar la duraci√≥n.");
                  return;
                }
              }
              pop.remove();
              btn.textContent = "‚úèÔ∏è";
            };

            pop.querySelector(".btn-save")?.addEventListener("click", saveQty);
            pop.querySelector(".btn-cancel")?.addEventListener("click", () => {
              pop.remove();
              btn.textContent = "‚úèÔ∏è";
            });
            const outsideHandler = (ev) => {
              if (!cell.contains(ev.target)) {
                pop.remove();
                btn.textContent = "‚úèÔ∏è";
                document.removeEventListener("click", outsideHandler);
              }
            };
            setTimeout(() => document.addEventListener("click", outsideHandler, { once: true }), 0);
            return;
          }

          // Duraci√≥n inline
          if (field === "duracion") {
            const currentVal = span.textContent.replace(/\D/g, "") || cell.dataset.duracion || "";
            const wrap = document.createElement("div");
            wrap.className = "inline-edit";
            wrap.innerHTML = `
              <input type="number" min="1" step="1" value="${currentVal}" />
              <button type="button" class="inline-save" aria-label="Guardar">üíæ</button>
            `;
            const input = wrap.querySelector("input");
            const saveBtn = wrap.querySelector(".inline-save");
            span.replaceWith(wrap);
            btn.classList.add("hidden");
            input?.focus();
            const save = async () => {
              const qty = parseInt(input.value, 10);
              if (!qty || qty <= 0) {
                alert("El valor debe ser mayor a 0.");
                return;
              }
              try {
                const { error } = await supabase
                  .from("precios")
                  .update({ duracion: qty })
                  .eq("id_precio", precioId);
                if (error) throw error;
                const spanText = document.createElement("span");
                spanText.className = "precio-text";
                spanText.textContent = `${qty} mes${qty === 1 ? "" : "es"}`;
                wrap.replaceWith(spanText);
                btn.classList.remove("hidden");
                setEstado("Duraci√≥n actualizada.");
              } catch (err) {
                console.error("update duraci√≥n error", err);
                alert("No se pudo actualizar la duraci√≥n.");
              }
            };
            saveBtn?.addEventListener("click", save);
            input?.addEventListener("keydown", (ev) => {
              if (ev.key === "Enter") save();
              if (ev.key === "Escape") {
                const spanText = document.createElement("span");
                spanText.className = "precio-text";
                spanText.textContent = span.textContent;
                wrap.replaceWith(spanText);
                btn.classList.remove("hidden");
              }
            });
            return;
          }

          // Valor tarjeta + moneda
          if (field === "valor_tarjeta_de_regalo") {
            const existingPop = cell.querySelector(".qty-popover");
            if (existingPop) {
              existingPop.remove();
              btn.textContent = "‚úèÔ∏è";
              return;
            }
            const currentVal = parseFloat(cell.dataset.valor || "0") || 0;
            const currentMon = cell.dataset.moneda || "";
            const pop = document.createElement("div");
            pop.className = "qty-popover";
            pop.innerHTML = `
              <div style="font-weight:600;font-size:13px;">Valor de tarjeta</div>
              <div class="qty-controls">
                <button type="button" data-act="minus">-</button>
                <input type="number" class="qty-input" value="${currentVal || 1}" min="1" step="0.01" />
                <button type="button" data-act="plus">+</button>
              </div>
              <div style="font-weight:600;font-size:13px;">Moneda</div>
              <input type="text" class="price-input moneda-input" value="${currentMon}" placeholder="USD, Bs, etc." />
              <div class="qty-actions">
                <button type="button" class="btn-cancel">Cancelar</button>
                <button type="button" class="btn-save">Guardar</button>
              </div>
            `;
            cell.appendChild(pop);
            btn.textContent = "üíæ";

            const qtyInput = pop.querySelector(".qty-input");
            const monedaEl = pop.querySelector(".moneda-input");
            const updateQty = (delta) => {
              const current = parseFloat(qtyInput.value) || 1;
              const next = Math.max(1, current + delta);
              qtyInput.value = next.toFixed(2).replace(/\.00$/, "");
            };
            pop.addEventListener("click", (ev) => {
              if (ev.target.dataset.act === "minus") updateQty(-1);
              else if (ev.target.dataset.act === "plus") updateQty(1);
            });

            const saveValor = async () => {
              const raw = (qtyInput.value || "").trim();
              if (!/^\d+(\.\d{1,2})?$/.test(raw)) {
                alert("Ingresa un n√∫mero v√°lido (m√°x. 2 decimales).");
                return;
              }
              const valNum = parseFloat(raw);
              if (!valNum || valNum <= 0) {
                alert("El valor debe ser mayor a 0.");
                return;
              }
              const mon = (monedaEl.value || "").trim();
              try {
                const { error } = await supabase
                  .from("precios")
                  .update({ valor_tarjeta_de_regalo: valNum, moneda: mon })
                  .eq("id_precio", precioId);
                if (error) throw error;
                cell.dataset.valor = valNum;
                cell.dataset.moneda = mon;
                exitEdit(cell, `${valNum} ${mon}`.trim());
                setEstado("Valor actualizado.");
                pop.remove();
                btn.textContent = "‚úèÔ∏è";
              } catch (err) {
                console.error("update valor error", err);
                alert("No se pudo actualizar el valor.");
              }
            };

            pop.querySelector(".btn-save")?.addEventListener("click", saveValor);
            pop.querySelector(".btn-cancel")?.addEventListener("click", () => {
              pop.remove();
              btn.textContent = "‚úèÔ∏è";
            });
            const outsideValor = (ev) => {
              if (!cell.contains(ev.target)) {
                pop.remove();
                btn.textContent = "‚úèÔ∏è";
                document.removeEventListener("click", outsideValor);
              }
            };
            setTimeout(() => document.addEventListener("click", outsideValor, { once: true }), 0);
            return;
          }

          // Regi√≥n
          if (field === "region") {
            const existingPop = cell.querySelector(".qty-popover");
            if (existingPop) {
              existingPop.remove();
              btn.textContent = "‚úèÔ∏è";
              return;
            }
            const pop = document.createElement("div");
            pop.className = "qty-popover";
            pop.innerHTML = `
              <input type="text" class="price-input" value="${cell.dataset.region || ""}" placeholder="Regi√≥n" />
              <div class="qty-actions">
                <button type="button" class="btn-cancel">Cancelar</button>
                <button type="button" class="btn-save">Guardar</button>
              </div>
            `;
            cell.appendChild(pop);
            btn.textContent = "üíæ";
            const inputReg = pop.querySelector("input");
            inputReg?.focus();
            inputReg?.select();

            const saveReg = async () => {
              const val = (inputReg.value || "").trim();
              try {
                const { error } = await supabase
                  .from("precios")
                  .update({ region: val })
                  .eq("id_precio", precioId);
                if (error) throw error;
                cell.dataset.region = val;
                exitEdit(cell, val || "-");
                setEstado("Regi√≥n actualizada.");
                pop.remove();
                btn.textContent = "‚úèÔ∏è";
              } catch (err) {
                console.error("update region error", err);
                alert("No se pudo actualizar la regi√≥n.");
              }
            };

            pop.querySelector(".btn-save")?.addEventListener("click", saveReg);
            pop.querySelector(".btn-cancel")?.addEventListener("click", () => {
              pop.remove();
              btn.textContent = "‚úèÔ∏è";
            });
            const outsideReg = (ev) => {
              if (!cell.contains(ev.target)) {
                pop.remove();
                btn.textContent = "‚úèÔ∏è";
                document.removeEventListener("click", outsideReg);
              }
            };
            setTimeout(() => document.addEventListener("click", outsideReg, { once: true }), 0);
            return;
          }

          // Editor precios (inline)
          const current = span.textContent.replace("$", "").trim();
          const wrap = document.createElement("div");
          wrap.className = "inline-edit";
          wrap.innerHTML = `
            <input type="text" inputmode="decimal" value="${current === "-" ? "" : current}" placeholder="0.00" />
            <button type="button" class="inline-save" aria-label="Guardar">üíæ</button>
          `;
          const input = wrap.querySelector("input");
          const saveBtn = wrap.querySelector(".inline-save");
          span.replaceWith(wrap);
          btn.classList.add("hidden");
          input?.focus();
          input?.select();
          const savePrice = async () => {
            let raw = input.value.trim();
            if (!/^\d+(\.\d{1,2})?$/.test(raw)) {
              alert("Ingresa un n√∫mero v√°lido (m√°x. 2 decimales, usa punto).");
              return;
            }
            if (!raw.includes(".")) raw = `${raw}.00`;
            const value = parseFloat(raw);
            if (!value || value <= 0) {
              alert("El precio debe ser mayor a 0.");
              return;
            }
            try {
              const { error } = await supabase
                .from("precios")
                .update({ [field]: value })
                .eq("id_precio", precioId);
              if (error) throw error;
              const spanText = document.createElement("span");
              spanText.className = "precio-text";
              spanText.textContent = `$${value.toFixed(2)}`;
              wrap.replaceWith(spanText);
              btn.classList.remove("hidden");
              setEstado("Precio actualizado.");
            } catch (err) {
              console.error("update precio error", err);
              alert("No se pudo actualizar el precio.");
            }
          };
          saveBtn?.addEventListener("click", savePrice);
          input?.addEventListener("keydown", (ev) => {
            if (ev.key === "Enter") savePrice();
            if (ev.key === "Escape") {
              const spanText = document.createElement("span");
              spanText.className = "precio-text";
              spanText.textContent = span.textContent;
              wrap.replaceWith(spanText);
              btn.classList.remove("hidden");
            }
          });
        });
      };

      descuentosModalCloseEl?.addEventListener("click", cerrarModalDescuentos);
      descuentosModalBackdropEl?.addEventListener("click", cerrarModalDescuentos);
      document.addEventListener("keydown", (ev) => {
        if (ev.key === "Escape" && !descuentosModalEl?.classList.contains("hidden")) {
          cerrarModalDescuentos();
        }
      });

      cargar();
    </script>
  </body>
</html>
