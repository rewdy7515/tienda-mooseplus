<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Importar cuentas</title>
    <link rel="stylesheet" href="../../styles/styles.css" />
  </head>
  <body>
    <div id="app-header" data-header-root="../../" data-header-pages="../"></div>
    <script src="../../scripts/header-loader.js"></script>

    <main class="categorias-dinamicas">
      <h2>Importar cuentas</h2>
      <div class="reporte-form">
        <label class="form-label" for="input-csv">Subir archivo CSV</label>
        <input id="input-csv" class="form-input" type="file" accept=".csv,text/csv" />
        <p class="status">Selecciona un archivo CSV para continuar.</p>
        <button id="btn-importar" class="btn-primary" type="button">Importar</button>
        <p id="import-status" class="status"></p>
      </div>
    </main>

    <script type="module">
      import { requireSession, attachLogout, attachLogoHome } from "../../scripts/session.js";
      import { clearServerSession, loadCurrentUser, startSession } from "../../scripts/api.js";

      requireSession();

      const usernameEl = document.querySelector(".username");
      const adminLink = document.querySelector(".admin-link");
      const isTrue = (v) => v === true || v === 1 || v === "1" || v === "true" || v === "t";
      const inputCsv = document.querySelector("#input-csv");
      const btnImportar = document.querySelector("#btn-importar");
      const statusEl = document.querySelector("#import-status");

      async function init() {
        try {
          const user = await loadCurrentUser();
          if (user && usernameEl) {
            const fullName = [user.nombre, user.apellido].filter(Boolean).join(" ").trim();
            usernameEl.textContent = fullName || user.correo || "Usuario";
          }
          const isAdmin = isTrue(user?.permiso_admin) || isTrue(user?.permiso_superadmin);
          if (adminLink) {
            adminLink.classList.toggle("hidden", !isAdmin);
            adminLink.style.display = isAdmin ? "block" : "none";
          }
        } catch (err) {
          console.error("importar cuentas init error", err);
        }
      }

      init();
      attachLogout(clearServerSession);
      attachLogoHome();

      const parseCsv = (text) => {
        const lines = text
          .split(/\r?\n/)
          .map((l) => l.trim())
          .filter(Boolean);
        if (!lines.length) return [];
        const sep = lines[0].includes(";") ? ";" : lines[0].includes("\t") ? "\t" : ",";
        const splitLine = (line) =>
          line
            .split(new RegExp(`${sep}(?=(?:[^"]*"[^"]*")*[^"]*$)`))
            .map((c) => c.replace(/^"(.*)"$/, "$1").trim());

        const headers = splitLine(lines[0]).map((h) => h.replace(/^\uFEFF/, "").toLowerCase());
        return lines.slice(1).map((line) => {
          const cols = splitLine(line);
          const row = {};
          headers.forEach((h, i) => {
            row[h] = cols[i];
          });
          return row;
        });
      };

      async function importar() {
        if (statusEl) statusEl.textContent = "";
        const file = inputCsv?.files?.[0];
        if (!file) {
          statusEl.textContent = "Selecciona un archivo CSV primero.";
          return;
        }
        const text = await file.text();
        console.log("[importar cuentas] raw text first 200 chars:", text.slice(0, 200));
        const parsed = parseCsv(text);
        console.log("[importar cuentas] parsed rows:", parsed.length, "sample:", parsed.slice(0, 3));
        if (!parsed.length) {
          statusEl.textContent = "No se encontraron filas válidas.";
          return;
        }
        const id_usuario = requireSession();
        await startSession(id_usuario);
        statusEl.textContent = "Importando...";
        const res = await fetch("/api/admin/import-cuentas", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ rows: parsed, id_usuario }),
        });
        const body = await res.json().catch(() => ({}));
        console.log("[importar cuentas] response", res.status, body);
        if (!res.ok || body?.error) {
          statusEl.textContent = body?.error || "Error al importar cuentas.";
          return;
        }
        statusEl.textContent = `Importación completada. Cuentas procesadas: ${body.cuentas}, nuevas: ${body.nuevas}, actualizadas: ${body.actualizadas}.`;
      }

      btnImportar?.addEventListener("click", importar);
    </script>
  </body>
</html>
