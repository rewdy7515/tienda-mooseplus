<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Administrar servicios</title>
    <link rel="stylesheet" href="../../styles/styles.css" />
    <style>
      .table-base tbody tr.spotify-soon-1,
      .table-base tbody tr.spotify-soon-1 td {
        background: #f59e0b33 !important;
      }
      .table-base tbody tr.spotify-soon-2,
      .table-base tbody tr.spotify-soon-2 td {
        background: #f59e0b22 !important;
      }
      .table-base tbody tr.spotify-soon-3,
      .table-base tbody tr.spotify-soon-3 td {
        background: #f59e0b14 !important;
      }
      .admin-actions.admin-group .admin-loading {
        display: none;
      }
      .admin-actions.admin-group[data-loading="true"] .admin-loading {
        display: block;
      }
      .admin-actions.admin-group[data-loading="true"] > :not(.admin-loading) {
        display: none;
      }
      #btn-dashboard.admin-action-dashboard {
        background: #a8e8e3;
        border-color: #a8e8e3;
        color: #1f5f5a;
        width: 100%;
        max-width: none;
      }
      #btn-dashboard.admin-action-dashboard:hover {
        background: #95ddd7;
        border-color: #95ddd7;
      }
      .admin-dashboard-action {
        grid-column: 1 / -1;
        display: block;
        margin-top: -2px;
      }
      #btn-dashboard .card-title {
        margin: 0;
        font-weight: 700;
        font-size: 15px;
        color: inherit;
      }
    </style>
  </head>
  <body>
    <div id="app-header" data-header-root="../../" data-header-pages="../"></div>
    <script src="../../scripts/header-loader.js"></script>

    <main class="categorias-dinamicas">
      <h2>Administrar servicios</h2>
      <div class="admin-dashboard">
        <div class="admin-card reportes" id="dash-reportes">
          <p class="card-title">Reportes</p>
          <div class="card-count" id="count-reportes">--</div>
          <p class="card-desc">reportes pendientes</p>
        </div>
        <div class="admin-card cortes" id="dash-cortes">
          <p class="card-title">Cortes</p>
          <div class="card-count" id="count-cortes">--</div>
          <p class="card-desc">ventas vencidas</p>
        </div>
        <div class="admin-card pedidos" id="dash-pedidos">
          <p class="card-title">Pedidos</p>
          <div class="card-count" id="count-pedidos">--</div>
          <p class="card-desc">ventas pendientes</p>
        </div>
        <div class="admin-card tareas" id="dash-tareas">
          <p class="card-title">Tareas</p>
          <div class="card-count" id="count-tareas">--</div>
          <p class="card-desc">Pendientes</p>
        </div>
        <div class="admin-dashboard-action hidden" id="dash-dashboard-action">
          <button class="btn-primary admin-action admin-action-dashboard" id="btn-dashboard">
            <span class="card-title">Dashboard</span>
          </button>
        </div>
      </div>
      <div class="admin-actions admin-group" data-loading="true">
        <div class="admin-loading status">Cargando...</div>
        <button class="btn-primary admin-action" id="btn-renovar-servicio">Renovar servicio cliente</button>
        <button class="btn-primary admin-action" id="btn-usuarios">Usuarios</button>
        <button class="btn-primary admin-action hidden" id="btn-ordenes">Ordenes</button>
      </div>
      <div class="admin-actions admin-group" data-loading="true">
        <div class="admin-loading status">Cargando...</div>
        <button class="btn-primary admin-action" id="btn-editar-precios">Editar precios</button>
        <button class="btn-primary admin-action" id="btn-importar-datos">Importar datos</button>
        <button class="btn-primary admin-action" id="btn-editar-logos">Editar logos</button>
      </div>
      <div class="admin-actions admin-group" data-loading="true">
        <div class="admin-loading status">Cargando...</div>
        <button class="btn-primary admin-action" id="btn-recordatorios">Recordatorios</button>
        <button class="btn-primary admin-action" id="btn-agregar-pines">Agregar pines</button>
      </div>
      <div class="admin-actions admin-group" data-loading="true">
        <div class="admin-loading status">Cargando...</div>
        <h3 style="margin: 0 0 6px 0;">Cuentas madre Spotify próximas a vencer</h3>
        <button class="btn-primary admin-action" id="btn-renovar-spotify" style="margin: 6px 0 8px 0;">Renovar</button>
        <div id="spotify-libres" class="status">Espacios libres: --</div>
        <div id="spotify-cuentas-status" class="status">Cargando...</div>
        <div class="cuenta-table-wrap">
          <table class="table-base" id="spotify-cuentas-table">
            <thead>
              <tr>
                <th></th>
                <th>Correo</th>
                <th>Fecha de corte</th>
                <th>Espacios</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
      <p class="status" id="pines-por-comprar">Pines por comprar: --</p>
      <p class="status">Selecciona una acción.</p>
    </main>

    <div id="modal-renovar-spotify" class="modal hidden">
      <div class="modal-backdrop"></div>
      <div class="modal-card modal-card-renovar">
        <button type="button" class="modal-close" aria-label="Cerrar">✖</button>
        <h3 style="margin: 0;">Renovar:</h3>
        <div id="spotify-renovar-list" class="modal-renovar-stack"></div>
        <input
          type="number"
          id="spotify-renovar-monto"
          placeholder="Monto"
          step="0.01"
          min="0"
          style="width: 100%;"
        />
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top: 8px;">
          <button type="button" class="btn-outline" id="spotify-renovar-copy">Copiar</button>
          <button type="button" class="btn-outline" id="spotify-renovar-no">Cancelar</button>
          <button type="button" class="btn-primary" id="spotify-renovar-yes">Renovar</button>
        </div>
      </div>
    </div>

    <script type="module">
      import { requireSession, attachLogout, attachLogoHome } from "../../scripts/session.js";
      import { clearServerSession, loadCurrentUser, supabase } from "../../scripts/api.js";

      requireSession();

      const usernameEl = document.querySelector(".username");
      const adminLink = document.querySelector(".admin-link");
      const isTrue = (v) => v === true || v === 1 || v === "1" || v === "true" || v === "t";
      const logo = document.querySelector(".logo");

      const countReportesEl = document.querySelector("#count-reportes");
      const countCortesEl = document.querySelector("#count-cortes");
      const countPedidosEl = document.querySelector("#count-pedidos");
      const countTareasEl = document.querySelector("#count-tareas");
      const pinesPorComprarEl = document.querySelector("#pines-por-comprar");
      const adminGroups = Array.from(
        document.querySelectorAll(".admin-actions.admin-group"),
      );
      const spotifyTable = document.querySelector("#spotify-cuentas-table tbody");
      const spotifyStatus = document.querySelector("#spotify-cuentas-status");
      const spotifyLibresEl = document.querySelector("#spotify-libres");
      const spotifyRenovarBtn = document.querySelector("#btn-renovar-spotify");
      const btnOrdenes = document.querySelector("#btn-ordenes");
      const dashDashboardAction = document.querySelector("#dash-dashboard-action");
      const modalRenovarSpotify = document.querySelector("#modal-renovar-spotify");
      const modalRenovarList = document.querySelector("#spotify-renovar-list");
      const modalRenovarYes = document.querySelector("#spotify-renovar-yes");
      const modalRenovarNo = document.querySelector("#spotify-renovar-no");
      const modalRenovarMonto = document.querySelector("#spotify-renovar-monto");
      const modalRenovarCopy = document.querySelector("#spotify-renovar-copy");
      const DASHBOARD_ALLOWED_USER_ID = 23;
      let currentUserId = null;

      const getMonthStart = () => {
        const now = new Date();
        const start = new Date(now.getFullYear(), now.getMonth(), 1);
        return start.toISOString().slice(0, 10);
      };
      const getTodayLocal = () => {
        const now = new Date();
        const pad = (n) => String(n).padStart(2, "0");
        return `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}`;
      };
      const getNextMonthStart = () => {
        const now = new Date();
        const start = new Date(now.getFullYear(), now.getMonth() + 1, 1);
        return start.toISOString().slice(0, 10);
      };

      const formatDDMMYYYY = (val) => {
        if (!val) return "-";
        const parts = String(val).split("-");
        if (parts.length !== 3) return val;
        return `${parts[2]}-${parts[1]}-${parts[0]}`;
      };
      const addMonthsKeepDay = (baseDate, months) => {
        const d = new Date(baseDate.getFullYear(), baseDate.getMonth(), 1);
        const day = baseDate.getDate();
        d.setMonth(d.getMonth() + months);
        const lastDay = new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate();
        d.setDate(Math.min(day, lastDay));
        return d;
      };

      const setAdminGroupsLoading = (isLoading) => {
        adminGroups.forEach((group) => {
          if (!group) return;
          group.dataset.loading = isLoading ? "true" : "false";
        });
      };

      async function loadCounts() {
        try {
          const today = getTodayLocal();
          const monthStart = getMonthStart();
          const nextMonthStart = getNextMonthStart();
          const [
            { count: repCount, error: repErr },
            { count: cortesVentasCount, error: cortesVentasErr },
            { count: cortesReemplazosCount, error: cortesReemplazosErr },
            { count: pedidosCount, error: pedidosErr },
            { count: tareasCount, error: tareasErr },
          ] = await Promise.all([
            supabase
              .from("reportes")
              .select("id_reporte", { count: "exact", head: true })
              .eq("solucionado", false),
            supabase
              .from("ventas")
              .select("id_venta, cuentas:cuentas!ventas_id_cuenta_fkey!inner(inactiva)", {
                count: "exact",
                head: true,
              })
              .lte("fecha_corte", today)
              .eq("recordatorio_enviado", true)
              .or("suspendido.is.null,suspendido.eq.false")
              .or("inactiva.is.null,inactiva.eq.false", { foreignTable: "cuentas" }),
            supabase
              .from("reemplazos")
              .select("id_reemplazo, cuentas:cuentas!inner(inactiva)", {
                count: "exact",
                head: true,
              })
              .or("inactiva.is.null,inactiva.eq.false", { foreignTable: "cuentas" }),
            supabase
              .from("ventas")
              .select("id_venta", { count: "exact", head: true })
              .eq("pendiente", true),
            supabase
              .from("tareas_asignadas")
              .select("id_tarea_asignada", { count: "exact", head: true }),
          ]);
          if (repErr) throw repErr;
          if (cortesVentasErr) throw cortesVentasErr;
          if (cortesReemplazosErr) throw cortesReemplazosErr;
          if (pedidosErr) throw pedidosErr;
          if (tareasErr) throw tareasErr;
          const cortesCount = (cortesVentasCount ?? 0) + (cortesReemplazosCount ?? 0);
          if (countReportesEl) countReportesEl.textContent = repCount ?? 0;
          if (countCortesEl) countCortesEl.textContent = cortesCount ?? 0;
          if (countPedidosEl) countPedidosEl.textContent = pedidosCount ?? 0;
          if (countTareasEl) countTareasEl.textContent = tareasCount ?? 0;

          if (pinesPorComprarEl) {
            const [
              { count: netflixCount, error: nfErr },
              { count: giftCount, error: giftErr },
            ] = await Promise.all([
              supabase
                .from("ventas")
                .select("id_venta, precios:precios!ventas_id_precio_fkey(id_plataforma)", {
                  count: "exact",
                  head: true,
                })
                .gte("fecha_pago", monthStart)
                .eq("precios.id_plataforma", 1),
              supabase
                .from("tarjetas_de_regalo")
                .select("id_tarjeta_de_regalo", { count: "exact", head: true })
                .eq("id_plataforma", 21)
                .eq("para_venta", false)
                .gte("fecha_compra", monthStart)
                .lt("fecha_compra", nextMonthStart),
            ]);
            if (nfErr) throw nfErr;
            if (giftErr) throw giftErr;
            const basePines = Math.floor((netflixCount ?? 0) / 7);
            const usados = giftCount ?? 0;
            const pines = Math.max(0, basePines - usados);
            pinesPorComprarEl.textContent = `Pines por comprar: ${pines}`;
          }
        } catch (err) {
          console.error("load dashboard counts error", err);
          if (countReportesEl) countReportesEl.textContent = "-";
          if (countCortesEl) countCortesEl.textContent = "-";
          if (countPedidosEl) countPedidosEl.textContent = "-";
          if (countTareasEl) countTareasEl.textContent = "-";
          if (pinesPorComprarEl) pinesPorComprarEl.textContent = "Pines por comprar: -";
        }
      }

      async function loadSpotifyMadres() {
        if (!spotifyTable || !spotifyStatus) return;
        try {
          const { data, error } = await supabase
            .from("cuentas")
            .select("id_cuenta, correo, clave, fecha_corte")
            .eq("id_plataforma", 9)
            .eq("cuenta_madre", true)
            .order("fecha_corte", { ascending: true });
          if (error) throw error;
          spotifyTable.innerHTML = "";
          if (!data?.length) {
            spotifyStatus.textContent = "Sin cuentas próximas.";
            if (spotifyLibresEl) spotifyLibresEl.textContent = "Espacios libres: 0";
            return;
          }
          spotifyStatus.textContent = "";
          const cuentasIds = data.map((r) => r.id_cuenta).filter(Boolean);
          let libres = 0;
          const libresByCuenta = new Map();
          if (cuentasIds.length) {
            const { data: perfiles, error: perfErr } = await supabase
              .from("perfiles")
              .select("id_perfil, id_cuenta")
              .in("id_cuenta", cuentasIds)
              .eq("ocupado", false)
              .eq("perfil_hogar", false);
            if (perfErr) throw perfErr;
            (perfiles || []).forEach((perfil) => {
              const idCuenta = Number(perfil?.id_cuenta);
              if (!Number.isFinite(idCuenta) || idCuenta <= 0) return;
              libresByCuenta.set(idCuenta, (libresByCuenta.get(idCuenta) || 0) + 1);
            });
            libres = (perfiles || []).length;
          }
          if (spotifyLibresEl) spotifyLibresEl.textContent = `Espacios libres: ${libres}`;
          data.forEach((row) => {
            const daysDiff = (() => {
              if (!row.fecha_corte) return null;
              const today = new Date();
              const base = new Date(today.getFullYear(), today.getMonth(), today.getDate());
              const [y, m, d] = row.fecha_corte.split("-").map(Number);
              if (!y || !m || !d) return null;
              const fcBase = new Date(y, m - 1, d);
              return Math.round((fcBase - base) / (1000 * 60 * 60 * 24));
            })();
            const rowClass =
              daysDiff !== null && daysDiff <= 1
                ? "spotify-soon-1"
                : daysDiff !== null && daysDiff <= 2
                ? "spotify-soon-2"
                : daysDiff !== null && daysDiff <= 3
                ? "spotify-soon-3"
                : "";
            const tr = document.createElement("tr");
            if (rowClass) tr.className = rowClass;
            const correoData = encodeURIComponent(row.correo || "");
            const claveData = encodeURIComponent(row.clave || "");
            tr.innerHTML = `
              <td><input type="checkbox" class="spotify-renovar-check" data-correo="${correoData}" data-clave="${claveData}" /></td>
              <td>${row.correo || "-"}</td>
              <td>${formatDDMMYYYY(row.fecha_corte) || "-"}</td>
              <td>${libresByCuenta.get(Number(row.id_cuenta)) || 0}</td>
            `;
            spotifyTable.appendChild(tr);
          });
        } catch (err) {
          console.error("load spotify madres error", err);
          spotifyStatus.textContent = "No se pudo cargar.";
        }
      }

      async function init() {
        setAdminGroupsLoading(true);
        try {
          const user = await loadCurrentUser();
          if (user && usernameEl) {
            const fullName = [user.nombre, user.apellido].filter(Boolean).join(" ").trim();
            usernameEl.textContent = fullName || user.correo || "Usuario";
          }
          currentUserId = user?.id_usuario || null;
          const isAdmin = isTrue(user?.permiso_admin) || isTrue(user?.permiso_superadmin);
          const isSuperAdmin = isTrue(user?.permiso_superadmin);
          const canViewDashboard = Number(currentUserId) === DASHBOARD_ALLOWED_USER_ID;
          if (adminLink) {
            adminLink.classList.toggle("hidden", !isAdmin);
            adminLink.style.display = isAdmin ? "block" : "none";
          }
          if (dashDashboardAction) {
            dashDashboardAction.classList.toggle("hidden", !canViewDashboard);
            dashDashboardAction.style.display = canViewDashboard ? "block" : "none";
          }
          if (btnOrdenes) {
            btnOrdenes.classList.toggle("hidden", !isSuperAdmin);
            btnOrdenes.style.display = isSuperAdmin ? "inline-flex" : "none";
          }
          if (!isAdmin) {
            document.querySelector("main .status").textContent =
              "No tienes permisos para administrar servicios.";
          }
          await loadCounts();
          await loadSpotifyMadres();
        } catch (err) {
          console.error("admin init error", err);
        } finally {
          setAdminGroupsLoading(false);
        }
      }

      document.querySelector("#dash-reportes")?.addEventListener("click", () => {
        window.location.href = "../reportes/revisar_reportes.html";
      });
      document.querySelector("#dash-cortes")?.addEventListener("click", () => {
        window.location.href = "cortes.html";
      });
      document.querySelector("#dash-pedidos")?.addEventListener("click", () => {
        window.location.href = "pedidos_pendientes.html";
      });
      document.querySelector("#dash-tareas")?.addEventListener("click", () => {
        window.location.href = "tareas.html";
      });

      init();
      attachLogout(clearServerSession);

      attachLogoHome();

      document.querySelector("#btn-agregar-servicios")?.addEventListener("click", () => {
        window.location.href = "admin/agregar_servicios.html";
      });

      document.querySelector("#btn-agregar-pines")?.addEventListener("click", () => {
        window.location.href = "agregar_pines.html";
      });

      document.querySelector("#btn-editar-precios")?.addEventListener("click", () => {
        window.location.href = "/src/frontend/pages/admin/editar_precios.html";
      });

      document.querySelector("#btn-importar-datos")?.addEventListener("click", () => {
        window.location.href = "importar.html";
      });
      
      document.querySelector("#btn-editar-logos")?.addEventListener("click", () => {
        window.location.href = "editar_logos.html";
      });

      document.getElementById("btn-renovar-servicio")?.addEventListener("click", () => {
        window.location.href = "renovar_cliente.html";
      });

      document.getElementById("btn-usuarios")?.addEventListener("click", () => {
        window.location.href = "usuarios.html";
      });
      document.getElementById("btn-ordenes")?.addEventListener("click", () => {
        window.location.href = "ordenes.html";
      });

      document.getElementById("btn-dashboard")?.addEventListener("click", () => {
        window.location.href = "dashboard.html";
      });

      document.getElementById("btn-registrar-proveedor")?.addEventListener("click", () => {
        window.location.href = "registrar_proveedor.html";
      });

      document.getElementById("btn-recordatorios")?.addEventListener("click", () => {
        window.location.href = "recordatorios.html";
      });

      document.getElementById("btn-renovar")?.addEventListener("click", () => {
        window.location.href = "renovar_cliente.html";
      });

      spotifyRenovarBtn?.addEventListener("click", () => {
        const checks = document.querySelectorAll(".spotify-renovar-check:checked");
        if (!checks.length) {
          alert("Selecciona al menos una cuenta.");
          return;
        }
        const correos = Array.from(checks)
          .map((c) => (c.dataset.correo ? decodeURIComponent(c.dataset.correo) : ""))
          .filter(Boolean);
        if (!modalRenovarSpotify || !modalRenovarList) return;
        modalRenovarList.innerHTML = "";
        correos.forEach((correo) => {
          const item = document.createElement("div");
          item.textContent = correo;
          modalRenovarList.appendChild(item);
        });
        if (modalRenovarMonto) modalRenovarMonto.value = "";
        modalRenovarSpotify.classList.remove("hidden");
      });

      modalRenovarCopy?.addEventListener("click", async () => {
        const checks = document.querySelectorAll(".spotify-renovar-check:checked");
        if (!checks.length) {
          alert("Selecciona al menos una cuenta.");
          return;
        }
        const lines = Array.from(checks)
          .map((c) => {
            const correo = c.dataset.correo ? decodeURIComponent(c.dataset.correo) : "";
            const clave = c.dataset.clave ? decodeURIComponent(c.dataset.clave) : "";
            return `correo: ${correo}\nclave: ${clave}`;
          })
          .join("\n\n");
        try {
          if (navigator?.clipboard?.writeText) {
            await navigator.clipboard.writeText(lines);
          } else {
            const ta = document.createElement("textarea");
            ta.value = lines;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand("copy");
            ta.remove();
          }
          alert("Copiado al portapapeles.");
        } catch (err) {
          console.error("copy renovar spotify error", err);
          alert("No se pudo copiar.");
        }
      });

      const hideRenovarSpotifyModal = () => {
        modalRenovarSpotify?.classList.add("hidden");
      };
      modalRenovarNo?.addEventListener("click", hideRenovarSpotifyModal);
      modalRenovarYes?.addEventListener("click", async () => {
        if (!modalRenovarList) return;
        const montoVal = Number(modalRenovarMonto?.value || 0);
        if (!Number.isFinite(montoVal) || montoVal <= 0) {
          alert("Ingresa un monto válido.");
          return;
        }
        const correos = Array.from(modalRenovarList.querySelectorAll("div"))
          .map((el) => el.textContent || "")
          .filter(Boolean);
        if (!correos.length) {
          alert("No hay correos seleccionados.");
          return;
        }
        try {
          const { data: cuentas, error: cErr } = await supabase
            .from("cuentas")
            .select("id_cuenta, id_plataforma, correo, fecha_corte")
            .in("correo", correos)
            .eq("id_plataforma", 9);
          if (cErr) throw cErr;
          const cuentaMap = (cuentas || []).reduce((acc, c) => {
            acc[c.correo] = c;
            return acc;
          }, {});
          const todayIso = new Date().toISOString().slice(0, 10);
          const updates = correos
            .map((correo) => cuentaMap[correo])
            .filter(Boolean)
            .map((c) => {
              const base = c.fecha_corte ? new Date(c.fecha_corte) : new Date();
              base.setHours(12, 0, 0, 0);
              const next = addMonthsKeepDay(base, 1);
              const nextIso = next.toISOString().slice(0, 10);
              return { id_cuenta: c.id_cuenta, id_plataforma: c.id_plataforma || 9, nextIso };
            });
          const rows = updates.map((u) => ({
            monto: montoVal,
            fecha_pago: todayIso,
            venta_cliente: false,
            renovacion: true,
            id_venta: null,
            id_plataforma: u.id_plataforma,
            id_cuenta: u.id_cuenta,
            registrado_por: currentUserId,
            referencia: null,
          }));
          if (!rows.length) {
            alert("No se encontraron cuentas válidas.");
            return;
          }
          const updateResults = await Promise.all(
            updates.map((u) =>
              supabase.from("cuentas").update({ fecha_corte: u.nextIso }).eq("id_cuenta", u.id_cuenta),
            ),
          );
          const updErr = updateResults.find((r) => r.error)?.error;
          if (updErr) throw updErr;
          const { error: histErr } = await supabase
            .from("historial_ventas")
            .insert(rows);
          if (histErr) throw histErr;
          hideRenovarSpotifyModal();
          await loadSpotifyMadres();
          alert("Renovación registrada.");
        } catch (err) {
          console.error("renovar spotify error", err);
          alert("No se pudo registrar la renovación.");
        }
      });
      modalRenovarSpotify?.addEventListener("click", (e) => {
        if (e.target?.classList?.contains("modal-backdrop")) {
          hideRenovarSpotifyModal();
        }
      });
      modalRenovarSpotify?.querySelector(".modal-close")?.addEventListener("click", hideRenovarSpotifyModal);

    </script>
  </body>
</html>
