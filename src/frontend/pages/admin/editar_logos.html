<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Editar logos</title>
    <link rel="stylesheet" href="../../styles/styles.css" />
    <style>
      main.categorias-dinamicas {
        max-width: none;
        width: auto;
      }
      .logos-wrapper {
        display: flex;
        flex-direction: column;
        gap: 16px;
        width: 100%;
        max-width: none;
      }
      .logos-field {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .logos-field select {
        width: 100%;
        box-sizing: border-box;
        padding: 8px 10px;
        border: 1px solid #d1d5db;
        border-radius: 10px;
        font-size: 14px;
      }
      .logo-editor {
        display: flex;
        gap: 20px;
        align-items: stretch;
        width: 100%;
      }
      .logo-editor.hidden {
        display: none;
      }
      .logo-editor.no-logo .logo-current {
        display: none;
      }
      .logo-editor.no-banner .banner-current {
        display: none;
      }
      .logo-editor.no-preview .preview-current {
        display: none;
      }
      .logo-current {
        flex: 1.3 1 0;
        min-width: 0;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 14px;
        padding: 14px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        position: relative;
      }
      .logo-current.is-import-target::after {
        content: "Suelta para importar";
        position: absolute;
        inset: 0;
        border-radius: 14px;
        background: rgba(0, 0, 0, 0.58);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 10px;
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.2px;
        z-index: 4;
        pointer-events: none;
      }
      .logo-current.is-busy::after {
        content: attr(data-busy-label);
        position: absolute;
        inset: 0;
        border-radius: 14px;
        background: rgba(0, 0, 0, 0.72);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 10px;
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.2px;
        z-index: 5;
        pointer-events: none;
      }
      .store-assets-grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 12px;
      }
      .store-asset-card {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        background: #f8fafc;
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .store-asset-title {
        margin: 0;
        font-size: 12px;
        font-weight: 700;
        color: #111827;
      }
      .store-asset-card input[type="file"] {
        padding: 0;
      }
      .store-asset-card .btn-primary {
        width: 100%;
      }
      .store-asset-card .btn-outline {
        width: 100%;
      }
      .logo-frame {
        width: 100%;
        height: 160px;
        border: 1px dashed #d1d5db;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        background: #fafafa;
        position: relative;
      }
      .logo-frame.is-drop-target::after {
        content: "Suelta para reemplazar";
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.54);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 8px;
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.2px;
        z-index: 3;
      }
      .logo-frame.is-busy::after {
        content: attr(data-busy-label);
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.72);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 8px;
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.2px;
        z-index: 4;
      }
      .banner-frame {
        width: 100%;
        aspect-ratio: 1650 / 828;
        min-height: 120px;
        border: 1px dashed #d1d5db;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        background: #fafafa;
        position: relative;
      }
      .logo-frame img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
      }
      .banner-frame img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .logo-upload {
        flex: 0.75 1 320px;
        max-width: 440px;
        min-width: 0;
        background: #fff;
        border: 1px solid #e5e7eb;
        border-radius: 14px;
        padding: 14px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      #home-banners-editor .logo-upload {
        flex: 0 1 260px;
        max-width: 300px;
      }
      .banner-upload-layout {
        display: grid;
        grid-template-columns: minmax(0, 1fr) minmax(220px, 280px);
        gap: 12px;
        align-items: start;
      }
      .banner-upload-fields {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .banner-upload-preview-card {
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        background: #f8fafc;
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 8px;
        min-width: 0;
      }
      .banner-upload-preview-name {
        margin: 0;
        font-size: 13px;
        font-weight: 700;
        color: #111827;
        word-break: break-word;
      }
      .banner-inline-frame {
        position: relative;
      }
      .banner-inline-frame img {
        display: none;
      }
      .banner-inline-frame.has-image img {
        display: block;
      }
      .banner-inline-frame:not(.has-image) .asset-ext-badge {
        display: none;
      }
      .banner-inline-empty {
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        font-size: 12px;
        font-weight: 600;
        color: #64748b;
        padding: 8px;
      }
      .banner-inline-frame.has-image .banner-inline-empty {
        display: none;
      }
      .logo-label {
        font-weight: 700;
        margin: 0;
        color: #111;
      }
      .logo-upload input[type="file"] {
        padding: 6px 0;
      }
      .logo-upload .form-input,
      .logo-upload .form-select {
        width: 100%;
        max-width: 100%;
        min-width: 0;
        box-sizing: border-box;
      }
      .logo-status {
        margin: 0;
      }
      .platform-logos-list {
        width: 100%;
        max-height: 420px;
        overflow: auto;
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding-right: 4px;
      }
      .platform-logo-row {
        display: grid;
        grid-template-columns: 74px 34px minmax(0, 1fr);
        gap: 10px;
        align-items: center;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 8px;
        background: #fff;
        cursor: pointer;
        transition: border-color 0.15s ease, background-color 0.15s ease;
        position: relative;
      }
      .platform-logo-row:hover {
        border-color: #94a3b8;
        background: #f8fafc;
      }
      .platform-logo-row.is-selected {
        border-color: #0f172a;
        background: #e2e8f0;
      }
      .platform-logo-row.is-dragging {
        opacity: 0.68;
      }
      .platform-logo-row.is-drop-target::after {
        content: "Suelta para reemplazar";
        position: absolute;
        inset: 0;
        border-radius: 10px;
        background: rgba(0, 0, 0, 0.54);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 8px;
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.2px;
      }
      .platform-logo-row.is-busy::after {
        content: attr(data-busy-label);
        position: absolute;
        inset: 0;
        border-radius: 10px;
        background: rgba(0, 0, 0, 0.72);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 8px;
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.2px;
        z-index: 3;
      }
      .platform-logo-thumb {
        width: 74px;
        height: 74px;
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        background: #f9fafb;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
      }
      .platform-logo-thumb::before {
        content: "";
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        height: 20%;
        background: linear-gradient(to top, rgba(0, 0, 0, 0.58), rgba(0, 0, 0, 0));
        pointer-events: none;
        z-index: 1;
      }
      .platform-logo-thumb img {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }
      .platform-logo-card-row {
        grid-template-columns: minmax(0, 1fr);
        align-items: start;
      }
      .platform-logo-main {
        display: flex;
        flex-direction: column;
        gap: 6px;
        min-width: 0;
      }
      .platform-logo-card-row .platform-logo-drag-col {
        justify-content: center;
        align-items: flex-start;
      }
      .platform-logo-card-row .platform-logo-thumb {
        width: 100%;
        height: auto;
        aspect-ratio: 4 / 5;
      }
      .platform-logo-drag-col {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .platform-logo-drag-handle {
        width: 24px;
        height: 24px;
      }
      .platform-logo-name {
        margin: 0;
        font-size: 14px;
        color: #111827;
        word-break: break-word;
      }
      .platform-logo-meta {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        min-width: 0;
      }
      .platform-banner-row {
        grid-template-columns: 110px minmax(0, 1fr);
      }
      .platform-banner-thumb {
        width: 110px;
        height: 62px;
      }
      .platform-banner-thumb img {
        object-fit: cover;
      }
      .platform-logo-group {
        display: flex;
        flex-direction: column;
        gap: 6px;
      }
      .platform-group-title {
        margin: 2px 2px 0;
        font-size: 13px;
        font-weight: 800;
        color: #1f2937;
        letter-spacing: 0.2px;
      }
      .platform-group-items {
        display: flex;
        flex-direction: row;
        flex-wrap: nowrap;
        gap: 10px;
        overflow-x: auto;
        overflow-y: hidden;
        padding-bottom: 2px;
      }
      .platform-group-items .platform-logo-row {
        flex: 0 0 170px;
      }
      .asset-ext-badge {
        position: absolute;
        top: 6px;
        right: 6px;
        z-index: 2;
        border-radius: 999px;
        padding: 2px 8px;
        font-size: 10px;
        font-weight: 700;
        line-height: 1.2;
        letter-spacing: 0.2px;
        text-transform: lowercase;
        pointer-events: none;
        border: 1px solid transparent;
      }
      .asset-ext-badge.is-webp {
        background: #bbf7d0;
        border-color: #86efac;
        color: #166534;
      }
      .asset-ext-badge.is-other {
        background: #fecaca;
        border-color: #fca5a5;
        color: #991b1b;
      }
      .preview-section {
        margin-top: 10px;
      }
      .preview-toggle {
        width: 100%;
      }
      .iconos-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(96px, 1fr));
        gap: 10px;
        width: 100%;
        max-height: 360px;
        overflow: auto;
        padding-right: 4px;
        position: relative;
      }
      .iconos-gallery.is-busy::after {
        content: attr(data-busy-label);
        position: absolute;
        inset: 0;
        border-radius: 10px;
        background: rgba(0, 0, 0, 0.72);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 10px;
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.2px;
        z-index: 4;
      }
      .icono-item {
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 6px;
        position: relative;
      }
      .icono-item.is-drop-target::after {
        content: "Suelta para reemplazar";
        position: absolute;
        inset: 0;
        border-radius: 10px;
        background: rgba(0, 0, 0, 0.58);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 8px;
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.2px;
        z-index: 4;
      }
      .icono-item.is-busy::after {
        content: attr(data-busy-label);
        position: absolute;
        inset: 0;
        border-radius: 10px;
        background: rgba(0, 0, 0, 0.72);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 8px;
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.2px;
        z-index: 5;
      }
      .icono-item img {
        width: 100%;
        aspect-ratio: 1 / 1;
        object-fit: cover;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
        background: #f9fafb;
      }
      .icono-thumb {
        position: relative;
      }
      .icono-item figcaption {
        font-size: 11px;
        color: #4b5563;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .icono-empty {
        margin: 0;
      }
      .home-banners-list {
        width: 100%;
        max-height: 420px;
        overflow: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding-right: 4px;
        position: relative;
      }
      .home-banners-groups {
        display: flex;
        flex-direction: column;
        gap: 14px;
      }
      .home-banners-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }
      .home-banners-group .logo-label {
        font-size: 13px;
      }
      .home-banners-list.is-busy::after {
        content: attr(data-busy-label);
        position: absolute;
        inset: 0;
        border-radius: 10px;
        background: rgba(0, 0, 0, 0.72);
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        padding: 10px;
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.2px;
        z-index: 4;
      }
      .home-banner-item {
        display: grid;
        grid-template-columns: 34px 52px minmax(180px, 240px) minmax(0, 1fr);
        gap: 10px;
        align-items: center;
        border: 1px solid #e5e7eb;
        border-radius: 12px;
        padding: 10px;
        background: #fff;
      }
      .home-banner-media-col {
        display: flex;
        flex-direction: column;
        gap: 6px;
        min-width: 0;
      }
      .home-banner-title {
        margin: 0;
        font-size: 13px;
        font-weight: 700;
        color: #111827;
        overflow-wrap: anywhere;
      }
      .home-banner-item.is-dragging {
        opacity: 0.65;
      }
      .home-banner-item.is-file-drop-target {
        border-color: #111827;
      }
      .home-banner-toggle-col {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .home-banner-drag-col {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .home-banner-drag-handle {
        width: 26px;
        height: 24px;
        border: none;
        background: transparent;
        border-radius: 6px;
        cursor: grab;
        position: relative;
      }
      .home-banner-drag-handle::before,
      .home-banner-drag-handle::after {
        content: "";
        position: absolute;
        left: 5px;
        right: 5px;
        height: 2px;
        background: #6b7280;
        border-radius: 999px;
      }
      .home-banner-drag-handle::before {
        top: 8px;
      }
      .home-banner-drag-handle::after {
        top: 14px;
      }
      .home-banner-drag-handle:active {
        cursor: grabbing;
      }
      .home-banner-toggle-label {
        position: relative;
        display: inline-flex;
        width: 40px;
        height: 24px;
      }
      .home-banner-visibility-toggle {
        opacity: 0;
        width: 0;
        height: 0;
        position: absolute;
      }
      .home-banner-toggle-slider {
        position: absolute;
        inset: 0;
        background: #cfd4dc;
        border-radius: 999px;
        transition: background-color 0.15s ease;
      }
      .home-banner-toggle-slider::before {
        content: "";
        position: absolute;
        width: 18px;
        height: 18px;
        left: 3px;
        top: 3px;
        border-radius: 50%;
        background: #fff;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        transition: transform 0.15s ease;
      }
      .home-banner-visibility-toggle:checked + .home-banner-toggle-slider {
        background: #10b981;
      }
      .home-banner-visibility-toggle:checked + .home-banner-toggle-slider::before {
        transform: translateX(16px);
      }
      .home-banner-thumb {
        margin: 0;
        position: relative;
      }
      .home-banner-item.is-file-drop-target .home-banner-thumb::after {
        content: "Suelta para reemplazar";
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.52);
        color: #fff;
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.2px;
        text-align: center;
        padding: 8px;
      }
      .home-banner-item.is-busy .home-banner-thumb::after {
        content: attr(data-busy-label);
        position: absolute;
        inset: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0, 0, 0, 0.72);
        color: #fff;
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.2px;
        text-align: center;
        padding: 8px;
        z-index: 4;
      }
      .home-banner-meta {
        display: flex;
        flex-direction: column;
        gap: 6px;
        min-width: 0;
      }
      .home-banner-mobile-item {
        display: block;
        padding: 8px;
      }
      #home-banners-mobile-list {
        gap: 8px;
      }
      .home-banner-mobile-item .home-banner-media-col {
        max-width: 190px;
      }
      .home-banner-mobile-item .home-banner-title {
        font-size: 12px;
      }
      .home-banner-mobile-item .home-banner-thumb {
        width: 100%;
        min-height: 72px;
        aspect-ratio: 16 / 7;
      }
      .home-banner-mobile-empty {
        margin: 0;
        font-size: 11px;
        color: #6b7280;
        text-align: center;
        padding: 4px;
      }
      .home-banner-meta-label {
        font-size: 12px;
        color: #4b5563;
        font-weight: 700;
      }
      .home-banner-link-input {
        width: 100%;
        min-width: 0;
        max-width: 100%;
        box-sizing: border-box;
        padding: 8px 10px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        font-size: 13px;
      }
      .home-banner-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }
      .home-banner-actions .btn-outline {
        padding: 6px 10px;
      }
      .home-banner-route-wrap {
        display: grid;
        grid-template-columns: auto minmax(0, 1fr);
        gap: 6px;
        align-items: center;
      }
      .home-banner-route-wrap > .home-banner-link-input {
        min-width: 0;
      }
      .home-banner-route-prefix {
        font-size: 12px;
        font-weight: 700;
        color: #374151;
        white-space: nowrap;
      }
      .home-banner-route-preview {
        margin: 0;
        font-size: 12px;
        color: #6b7280;
        word-break: break-all;
      }
      @media (max-width: 720px) {
        .logo-editor {
          flex-direction: column;
        }
        .store-assets-grid {
          grid-template-columns: 1fr;
        }
        .logo-upload {
          max-width: none;
        }
        .banner-upload-layout {
          grid-template-columns: 1fr;
        }
        .home-banner-item {
          grid-template-columns: 1fr;
        }
        .home-banner-toggle-col,
        .home-banner-drag-col {
          justify-content: flex-start;
        }
        .home-banner-route-wrap {
          grid-template-columns: 1fr;
          gap: 4px;
        }
        .platform-group-items .platform-logo-row {
          flex-basis: 150px;
        }
      }
    </style>
  </head>
  <body>
    <div id="app-header" data-header-root="../../" data-header-pages="../"></div>
    <script src="../../scripts/header-loader.js"></script>

    <main class="categorias-dinamicas">
      <h2>Editar logos</h2>
      <div class="logos-wrapper">
        <div class="preview-section">
          <button type="button" class="btn-outline preview-toggle" id="btn-platform-logos-toggle">
            Logos de plataformas
          </button>
          <div id="logo-editor" class="logo-editor hidden">
            <div class="logo-current" id="platform-logos-current">
              <p class="logo-label">Logos actuales: public_assets/logos/plataformas/tarjeta</p>
              <p class="status logo-status">
                Arrastra y suelta una imagen sobre la plataforma para reemplazarla. Suelta carpeta o múltiples imágenes aquí para importar.
              </p>
              <div id="platform-logos-list" class="platform-logos-list">
                <p class="status icono-empty">Sin plataformas cargadas.</p>
              </div>
              <p id="platform-selected-status" class="status logo-status">
                Plataforma: -
              </p>
              <p id="logo-status" class="status logo-status"></p>
            </div>
          </div>
        </div>

        <div class="preview-section">
          <button type="button" class="btn-outline preview-toggle" id="btn-metodos-pago-toggle">
            Metodos de pago
          </button>
          <div id="metodos-pago-editor" class="logo-editor hidden">
            <div class="logo-current">
              <p class="logo-label">Métodos de pago actuales</p>
              <p class="status logo-status">
                Arrastra y suelta una imagen sobre el método para reemplazarla.
              </p>
              <div id="metodos-pago-list" class="platform-logos-list">
                <p class="status icono-empty">Sin métodos de pago cargados.</p>
              </div>
              <p id="metodos-pago-selected-status" class="status logo-status">
                Método: -
              </p>
            </div>
            <div class="logo-upload">
              <p class="logo-label">Actualizar imagen del método seleccionado</p>
              <input type="file" id="metodo-pago-file" accept="image/*" />
              <button type="button" class="btn-primary" id="btn-metodo-pago-update">
                Guardar imagen
              </button>
              <p id="metodos-pago-status" class="status logo-status"></p>
            </div>
          </div>
        </div>

        <div class="preview-section">
          <button type="button" class="btn-outline preview-toggle" id="btn-store-logo-toggle">
            Logo tienda
          </button>
          <div id="store-logo-editor" class="logo-editor hidden">
            <div class="logo-current">
              <p class="logo-label">Archivos de tienda: <code>public_assets/logos/mooseplus</code></p>
              <div class="store-assets-grid">
                <article class="store-asset-card">
                  <p class="store-asset-title">Logo (<code>pagina.logo</code>)</p>
                  <div class="logo-frame" id="store-logo-frame">
                    <img id="store-logo-preview" src="" alt="Logo tienda actual" />
                    <span class="asset-ext-badge is-other hidden" id="store-logo-badge"></span>
                  </div>
                  <input type="file" id="store-logo-input" accept="image/*" />
                  <button type="button" class="btn-primary" id="btn-store-logo-upload">
                    Guardar logo
                  </button>
                </article>
                <article class="store-asset-card">
                  <p class="store-asset-title">Icono pestaña (<code>pagina.icono_pestana</code>)</p>
                  <div class="logo-frame" id="store-icon-frame">
                    <img id="store-icon-preview" src="" alt="Icono pestaña actual" />
                    <span class="asset-ext-badge is-other hidden" id="store-icon-badge"></span>
                  </div>
                  <input type="file" id="store-icon-input" accept="image/*" />
                  <button type="button" class="btn-primary" id="btn-store-icon-upload">
                    Guardar icono
                  </button>
                  <button type="button" class="btn-outline" id="btn-store-icon-refresh">
                    Refrescar favicon
                  </button>
                </article>
                <article class="store-asset-card">
                  <p class="store-asset-title">Preview (<code>pagina.preview</code>)</p>
                  <div class="logo-frame" id="store-preview-frame">
                    <img id="store-preview-preview" src="" alt="Preview actual" />
                    <span class="asset-ext-badge is-other hidden" id="store-preview-badge"></span>
                  </div>
                  <input type="file" id="store-preview-input" accept="image/*" />
                  <button type="button" class="btn-primary" id="btn-store-preview-upload">
                    Guardar preview
                  </button>
                </article>
              </div>
              <p class="status logo-status">
                Puedes arrastrar y soltar una imagen en cada cuadro o usar su input.
              </p>
              <p id="store-logo-status" class="status logo-status"></p>
            </div>
          </div>
        </div>

        <div class="preview-section">
          <button type="button" class="btn-outline preview-toggle" id="btn-platform-banners-toggle">
            Banners de plataformas
          </button>
          <div id="banner-editor" class="logo-editor hidden">
            <div class="logo-current banner-current" id="banner-current">
              <p class="logo-label">Banners actuales: public_assets/logos/plataformas/banner</p>
              <p class="logo-label">Plataformas</p>
              <div id="platform-banners-list" class="platform-logos-list">
                <p class="status icono-empty">Sin plataformas cargadas.</p>
              </div>
              <p id="banner-selected-status" class="status logo-status">Plataforma: -</p>
              <p id="banner-status" class="status logo-status"></p>
            </div>
          </div>
        </div>

        <div class="preview-section">
          <button type="button" class="btn-outline preview-toggle" id="btn-iconos-toggle">
            Iconos de perfil
          </button>
          <div id="iconos-editor" class="logo-editor hidden">
            <div class="logo-upload">
              <p class="logo-label">Importar iconos de perfil (carpeta o múltiples)</p>
              <input
                type="file"
                id="iconos-files"
                accept="image/*"
                multiple
                webkitdirectory
                directory
              />
              <button type="button" class="btn-primary" id="btn-iconos-upload">
                Subir iconos
              </button>
              <p id="iconos-status" class="status logo-status"></p>
            </div>
            <div class="logo-current">
              <p class="logo-label">Iconos en public_assets/icono-perfil</p>
              <div id="iconos-gallery" class="iconos-gallery">
                <p class="status icono-empty">Sin iconos cargados.</p>
              </div>
            </div>
          </div>
        </div>

        <div class="preview-section">
          <button type="button" class="btn-outline preview-toggle" id="btn-home-banners-toggle">
            Banners
          </button>
          <div id="home-banners-editor" class="logo-editor hidden">
            <div class="logo-upload">
              <p class="logo-label">Nuevo banner (public_assets/banners-index)</p>
              <input type="file" id="home-banner-file" accept="image/*" />
              <input
                type="text"
                id="home-banner-title"
                class="form-input"
                placeholder="Título del banner"
              />
              <input
                type="text"
                id="home-banner-redirect"
                class="form-input"
                placeholder="Ej: checkout.html o admin/ordenes.html"
              />
              <p class="home-banner-route-preview" id="home-banner-redirect-preview">
                Ruta final: /src/frontend/pages/
              </p>
              <button type="button" class="btn-primary" id="btn-home-banner-add">
                Añadir banner
              </button>
              <p id="home-banners-status" class="status logo-status"></p>
            </div>
            <div class="logo-current">
              <p class="logo-label">Banners actuales (public_assets/banners-index)</p>
              <div class="home-banners-groups">
                <section class="home-banners-group">
                  <p class="logo-label">banner.imagen</p>
                  <div id="home-banners-list" class="home-banners-list">
                    <p class="status icono-empty">Sin banners cargados.</p>
                  </div>
                </section>
                <section class="home-banners-group">
                  <p class="logo-label">banner.imagen_movil</p>
                  <div id="home-banners-mobile-list" class="home-banners-list">
                    <p class="status icono-empty">Sin banners móviles cargados.</p>
                  </div>
                </section>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <script type="module">
      import { requireSession, attachLogout, attachLogoHome } from "../../scripts/session.js";
      import {
        API_BASE,
        clearServerSession,
        createHomeBanner,
        deletePublicAssets,
        fetchHomeBanners,
        loadCurrentUser,
        supabase,
        updateHomeBanner,
        uploadPlatformLogos,
        startSession,
      } from "../../scripts/api.js";

      const sessionId = requireSession();
      console.log("[editar_logos] location", window.location.href);
      console.log("[editar_logos] online", navigator?.onLine);
      console.log("[editar_logos] sessionId", sessionId);
      attachLogoHome();

      const usernameEl = document.querySelector(".username");
      const adminLink = document.querySelector(".admin-link");
      const isTrue = (v) => v === true || v === 1 || v === "1" || v === "true" || v === "t";

      const platformLogosToggleBtn = document.querySelector("#btn-platform-logos-toggle");
      const metodosPagoToggleBtn = document.querySelector("#btn-metodos-pago-toggle");
      const platformBannersToggleBtn = document.querySelector("#btn-platform-banners-toggle");
      const storeLogoToggleBtn = document.querySelector("#btn-store-logo-toggle");
      const editor = document.querySelector("#logo-editor");
      const metodosPagoEditor = document.querySelector("#metodos-pago-editor");
      const platformLogosCurrentEl = document.querySelector("#platform-logos-current");
      const bannerEditor = document.querySelector("#banner-editor");
      const storeLogoEditor = document.querySelector("#store-logo-editor");
      const platformLogosListEl = document.querySelector("#platform-logos-list");
      const metodosPagoListEl = document.querySelector("#metodos-pago-list");
      const platformSelectedStatusEl = document.querySelector("#platform-selected-status");
      const metodosPagoSelectedStatusEl = document.querySelector("#metodos-pago-selected-status");
      const fileInput = document.querySelector("#logo-file");
      const btnUpdate = document.querySelector("#btn-logo-update");
      const statusEl = document.querySelector("#logo-status");
      const metodoPagoInput = document.querySelector("#metodo-pago-file");
      const btnMetodoPagoUpdate = document.querySelector("#btn-metodo-pago-update");
      const metodosPagoStatusEl = document.querySelector("#metodos-pago-status");
      const storeLogoInput = document.querySelector("#store-logo-input");
      const btnStoreLogoUpdate = document.querySelector("#btn-store-logo-upload");
      const storeIconInput = document.querySelector("#store-icon-input");
      const btnStoreIconUpdate = document.querySelector("#btn-store-icon-upload");
      const btnStoreIconRefresh = document.querySelector("#btn-store-icon-refresh");
      const storePreviewInput = document.querySelector("#store-preview-input");
      const btnStorePreviewUpdate = document.querySelector("#btn-store-preview-upload");
      const storeLogoStatusEl = document.querySelector("#store-logo-status");
      const storeLogoFrameEl = document.querySelector("#store-logo-frame");
      const storeLogoPreviewEl = document.querySelector("#store-logo-preview");
      const storeLogoBadgeEl = document.querySelector("#store-logo-badge");
      const storeIconFrameEl = document.querySelector("#store-icon-frame");
      const storeIconPreviewEl = document.querySelector("#store-icon-preview");
      const storeIconBadgeEl = document.querySelector("#store-icon-badge");
      const storePreviewFrameEl = document.querySelector("#store-preview-frame");
      const storePreviewPreviewEl = document.querySelector("#store-preview-preview");
      const storePreviewBadgeEl = document.querySelector("#store-preview-badge");
      const bannerCurrentWrap = document.querySelector("#banner-current");
      const bannerPreview = document.querySelector("#banner-preview");
      const platformBannersListEl = document.querySelector("#platform-banners-list");
      const bannerSelectedStatusEl = document.querySelector("#banner-selected-status");
      const bannerInput = document.querySelector("#banner-file");
      const btnBannerUpdate = document.querySelector("#btn-banner-update");
      const bannerInlineFrame = document.querySelector("#banner-inline-frame");
      const bannerInlinePreview = document.querySelector("#banner-inline-preview");
      const bannerInlineBadge = document.querySelector("#banner-inline-badge");
      const bannerInlinePlatformNameEl = document.querySelector("#banner-inline-platform-name");
      const bannerPreviewBadge = document.querySelector("#banner-preview-badge");
      const bannerTargetStatusEl = document.querySelector("#banner-target-status");
      const bannerStatusEl = document.querySelector("#banner-status");
      const previewToggleBtn = document.querySelector("#btn-preview-toggle");
      const previewEditor = document.querySelector("#preview-editor");
      const previewCurrentWrap = document.querySelector("#preview-current");
      const previewPageImg = document.querySelector("#preview-image");
      const previewImageBadge = document.querySelector("#preview-image-badge");
      const previewStatusEl = document.querySelector("#preview-status");
      const iconosToggleBtn = document.querySelector("#btn-iconos-toggle");
      const iconosEditor = document.querySelector("#iconos-editor");
      const iconosFilesInput = document.querySelector("#iconos-files");
      const btnIconosUpload = document.querySelector("#btn-iconos-upload");
      const iconosStatusEl = document.querySelector("#iconos-status");
      const iconosGalleryEl = document.querySelector("#iconos-gallery");
      const homeBannersToggleBtn = document.querySelector("#btn-home-banners-toggle");
      const homeBannersEditor = document.querySelector("#home-banners-editor");
      const homeBannerFileInput = document.querySelector("#home-banner-file");
      const homeBannerTitleInput = document.querySelector("#home-banner-title");
      const homeBannerRedirectInput = document.querySelector("#home-banner-redirect");
      const homeBannerRedirectPreview = document.querySelector("#home-banner-redirect-preview");
      const btnHomeBannerAdd = document.querySelector("#btn-home-banner-add");
      const homeBannersStatusEl = document.querySelector("#home-banners-status");
      const homeBannersListEl = document.querySelector("#home-banners-list");
      const homeBannersMobileListEl = document.querySelector("#home-banners-mobile-list");
      const HOME_BANNER_ROUTE_PREFIX = "/src/frontend/pages/";
      const PLATFORM_CARD_LOGOS_FOLDER = "logos/plataformas/tarjeta";
      const PLATFORM_MODAL_BANNERS_FOLDER = "logos/plataformas/banner";
      const PAYMENT_METHOD_LOGOS_FOLDER = "logos/metodos-pago";
      const STORE_LOGO_FOLDER = "logos/mooseplus";
      const STATIC_FAVICON_HREF = "/src/frontend/assets/favicon/logo-corto-blanco-icono.png";
      const PAGINA_TARGET_ID = 2;

      let plataformasMap = {};
      let metodosPagoMap = {};
      let selectedId = null;
      let selectedMetodoPagoId = null;
      let paginaPreview = null;
      let draggingHomeBannerRow = null;
      let homeBannerOrderSaving = false;
      let isPlatformBannersEditorOpen = false;
      let draggingPlatformLogoRow = null;
      let draggingPlatformLogoGroup = null;
      let platformLogoOrderSaving = false;
      let platformLogoOrderDirty = false;
      let platformLogosImporting = false;

      const setStatus = (msg, isError = false) => {
        if (!statusEl) return;
        statusEl.textContent = msg || "";
        statusEl.classList.toggle("is-error", isError);
        statusEl.classList.toggle("is-success", !isError && !!msg);
      };
      const setStoreLogoStatus = (msg, isError = false) => {
        if (!storeLogoStatusEl) return;
        storeLogoStatusEl.textContent = msg || "";
        storeLogoStatusEl.classList.toggle("is-error", isError);
        storeLogoStatusEl.classList.toggle("is-success", !isError && !!msg);
      };
      const setMetodosPagoStatus = (msg, isError = false) => {
        if (!metodosPagoStatusEl) return;
        metodosPagoStatusEl.textContent = msg || "";
        metodosPagoStatusEl.classList.toggle("is-error", isError);
        metodosPagoStatusEl.classList.toggle("is-success", !isError && !!msg);
      };

      const setBannerStatus = (msg, isError = false) => {
        if (!bannerStatusEl) return;
        bannerStatusEl.textContent = msg || "";
        bannerStatusEl.classList.toggle("is-error", isError);
        bannerStatusEl.classList.toggle("is-success", !isError && !!msg);
      };

      const setPreviewStatus = (msg, isError = false) => {
        if (!previewStatusEl) return;
        previewStatusEl.textContent = msg || "";
        previewStatusEl.classList.toggle("is-error", isError);
        previewStatusEl.classList.toggle("is-success", !isError && !!msg);
      };

      const setIconosStatus = (msg, isError = false) => {
        if (!iconosStatusEl) return;
        iconosStatusEl.textContent = msg || "";
        iconosStatusEl.classList.toggle("is-error", isError);
        iconosStatusEl.classList.toggle("is-success", !isError && !!msg);
      };

      const setHomeBannersStatus = (msg, isError = false) => {
        if (!homeBannersStatusEl) return;
        homeBannersStatusEl.textContent = msg || "";
        homeBannersStatusEl.classList.toggle("is-error", isError);
        homeBannersStatusEl.classList.toggle("is-success", !isError && !!msg);
      };

      const escapeHtml = (value) =>
        String(value ?? "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#39;");

      const isImageFile = (file) => {
        if (!file) return false;
        if (String(file.type || "").startsWith("image/")) return true;
        return /\.(png|jpe?g|webp|gif|bmp|svg|avif)$/i.test(String(file.name || ""));
      };
      const isWebpFile = (file) =>
        String(file?.type || "").toLowerCase() === "image/webp" ||
        /\.webp$/i.test(String(file?.name || ""));

      const normalizeNameKey = (value = "") =>
        String(value || "")
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .toLowerCase()
          .replace(/\.[^.]+$/, "")
          .replace(/\s+/g, " ")
          .trim();
      const getImageExtensionFromUrl = (value = "") => {
        const raw = String(value || "").trim();
        if (!raw) return "";
        const fromPathname = (pathname = "") => {
          const clean = String(pathname || "").split("/").pop() || "";
          let decoded = clean;
          try {
            decoded = decodeURIComponent(clean);
          } catch (_err) {
            decoded = clean;
          }
          const match = decoded.match(/\.([a-z0-9]+)$/i);
          return match?.[1] ? String(match[1]).toLowerCase() : "";
        };
        try {
          const parsed = new URL(raw, window.location.origin);
          return fromPathname(parsed.pathname || "");
        } catch (_err) {
          const noQuery = raw.split(/[?#]/)[0] || "";
          return fromPathname(noQuery);
        }
      };
      const extensionFromMimeType = (mime = "", fallback = "jpg") => {
        const normalized = String(mime || "").trim().toLowerCase();
        if (normalized === "image/webp") return "webp";
        if (normalized === "image/jpeg") return "jpg";
        if (normalized === "image/png") return "png";
        if (normalized === "image/gif") return "gif";
        if (normalized === "image/bmp") return "bmp";
        if (normalized === "image/avif") return "avif";
        if (normalized === "image/svg+xml") return "svg";
        return fallback;
      };
      const getExtensionMeta = (value = "") => {
        const ext = getImageExtensionFromUrl(value);
        const normalized = ext ? `.${ext}` : ".?";
        const badgeClass = ext === "webp" ? "is-webp" : "is-other";
        return { label: normalized, badgeClass };
      };
      const getExtensionBadgeHtml = (value = "") => {
        const meta = getExtensionMeta(value);
        return `<span class="asset-ext-badge ${meta.badgeClass}">${escapeHtml(meta.label)}</span>`;
      };
      const setExtensionBadge = (el, value = "") => {
        if (!el) return;
        const raw = String(value || "").trim();
        if (!raw) {
          el.textContent = "";
          el.classList.add("hidden");
          return;
        }
        const meta = getExtensionMeta(value);
        el.textContent = meta.label;
        el.classList.remove("is-webp", "is-other");
        el.classList.add(meta.badgeClass);
        el.classList.remove("hidden");
      };

      const isImageName = (name) => /\.(png|jpe?g|webp|gif|bmp|svg|avif)$/i.test(String(name || ""));
      const isFileDragEvent = (event) => {
        const types = Array.from(event?.dataTransfer?.types || []);
        return types.includes("Files");
      };

      const clearHomeBannerDropTargets = () => {
        [homeBannersListEl, homeBannersMobileListEl]
          .filter(Boolean)
          .forEach((listEl) => {
            listEl
              .querySelectorAll(".home-banner-item.is-file-drop-target")
              .forEach((row) => row.classList.remove("is-file-drop-target"));
          });
      };
      const clearIconoDropTargets = () => {
        if (!iconosGalleryEl) return;
        iconosGalleryEl
          .querySelectorAll(".icono-item.is-drop-target")
          .forEach((row) => row.classList.remove("is-drop-target"));
      };

      const clearPlatformDropTargets = () => {
        [platformLogosListEl, platformBannersListEl]
          .filter(Boolean)
          .forEach((listEl) => {
            listEl
              .querySelectorAll(".platform-logo-row.is-drop-target")
              .forEach((row) => row.classList.remove("is-drop-target"));
          });
      };
      const clearMetodosPagoDropTargets = () => {
        if (!metodosPagoListEl) return;
        metodosPagoListEl
          .querySelectorAll(".platform-logo-row.is-drop-target")
          .forEach((row) => row.classList.remove("is-drop-target"));
      };
      const clearStoreAssetDropTargets = () => {
        [storeLogoFrameEl, storeIconFrameEl, storePreviewFrameEl]
          .filter(Boolean)
          .forEach((el) => el.classList.remove("is-drop-target"));
      };
      const clearPlatformLogosImportTarget = () => {
        platformLogosCurrentEl?.classList.remove("is-import-target");
      };

      const getPlatformCategoryName = (row = {}) => {
        const rel = row?.categorias;
        const nameFromRel = Array.isArray(rel) ? rel?.[0]?.nombre : rel?.nombre;
        const name = String(row?.categoria_nombre || nameFromRel || "").trim();
        return name || "Sin categoría";
      };

      const setBusyOverlay = (el, label = "Procesando") => {
        if (!el) return;
        el.dataset.busyLabel = label;
        el.classList.add("is-busy");
      };

      const clearBusyOverlay = (el) => {
        if (!el) return;
        el.classList.remove("is-busy");
        delete el.dataset.busyLabel;
      };

      const normalizeRouteSuffix = (value = "") => {
        let raw = String(value || "").trim();
        if (!raw) return "";
        raw = raw.replace(/^https?:\/\/[^/]+/i, "");
        if (raw.startsWith(HOME_BANNER_ROUTE_PREFIX)) {
          raw = raw.slice(HOME_BANNER_ROUTE_PREFIX.length);
        }
        raw = raw.replace(/^\/+/, "");
        if (raw.startsWith("src/frontend/pages/")) {
          raw = raw.slice("src/frontend/pages/".length);
        }
        return raw;
      };

      const buildHomeBannerRoute = (suffix = "") => {
        const cleanSuffix = normalizeRouteSuffix(suffix);
        return cleanSuffix ? `${HOME_BANNER_ROUTE_PREFIX}${cleanSuffix}` : HOME_BANNER_ROUTE_PREFIX;
      };

      const updateNewRoutePreview = () => {
        if (!homeBannerRedirectPreview) return;
        const suffix = normalizeRouteSuffix(homeBannerRedirectInput?.value || "");
        homeBannerRedirectPreview.textContent = `Ruta final: ${buildHomeBannerRoute(suffix)}`;
      };

      // Exporta a 3x para mejor nitidez en el display 148x185
      const resizeImageIfNeeded = (file, targetW = 444, targetH = 555, maxBytes = 150000) => {
        return new Promise((resolve) => {
          if (!file || !file.type?.startsWith("image/")) return resolve(file);
          const sourceIsWebp = isWebpFile(file);
          const shouldResize = file.size > maxBytes;
          const img = new Image();
          const url = URL.createObjectURL(file);
          img.onload = () => {
            URL.revokeObjectURL(url);
            const { width, height } = img;
            if (!shouldResize && width === targetW && height === targetH) {
              resolve(file);
              return;
            }
            const canvas = document.createElement("canvas");
            canvas.width = targetW;
            canvas.height = targetH;
            const ctx = canvas.getContext("2d");
            if (!ctx) {
              resolve(file);
              return;
            }
            // Contener imagen dentro del tamaño objetivo manteniendo proporción
            const scale = Math.min(targetW / width, targetH / height);
            const drawW = Math.max(1, Math.round(width * scale));
            const drawH = Math.max(1, Math.round(height * scale));
            const offsetX = Math.round((targetW - drawW) / 2);
            const offsetY = Math.round((targetH - drawH) / 2);
            ctx.clearRect(0, 0, targetW, targetH);
            ctx.drawImage(img, offsetX, offsetY, drawW, drawH);

            const makeBlob = (type, quality) =>
              new Promise((res) => {
                canvas.toBlob((blob) => res(blob), type, quality);
              });

            (async () => {
              let quality = 0.92;
              let blob = await makeBlob("image/webp", quality);
              while (blob && blob.size > maxBytes && quality > 0.7) {
                quality = Math.max(0.7, quality - 0.05);
                blob = await makeBlob("image/webp", quality);
              }
              if (blob) {
                // Si el origen es WEBP y el navegador no lo respeta al exportar, conserva el archivo original.
                if (sourceIsWebp && String(blob.type || "").toLowerCase() !== "image/webp") {
                  resolve(file);
                  return;
                }
                const baseName = file.name.replace(/\.[^.]+$/, "");
                const ext = extensionFromMimeType(blob.type, sourceIsWebp ? "webp" : "jpg");
                const resized = new File([blob], `${baseName}.${ext}`, { type: blob.type || file.type });
                resolve(resized);
                return;
              }

              // Fallback a JPEG si WebP no está soportado (excepto cuando el origen ya era WEBP).
              if (sourceIsWebp) {
                resolve(file);
                return;
              }
              let jpegQuality = 0.9;
              let jpegBlob = await makeBlob("image/jpeg", jpegQuality);
              while (jpegBlob && jpegBlob.size > maxBytes && jpegQuality > 0.7) {
                jpegQuality = Math.max(0.7, jpegQuality - 0.05);
                jpegBlob = await makeBlob("image/jpeg", jpegQuality);
              }
              if (!jpegBlob) {
                resolve(file);
                return;
              }
              const baseName = file.name.replace(/\.[^.]+$/, "");
              const ext = extensionFromMimeType(jpegBlob.type, "jpg");
              const resized = new File([jpegBlob], `${baseName}.${ext}`, {
                type: jpegBlob.type || file.type,
              });
              resolve(resized);
            })().catch(() => resolve(file));
          };
          img.onerror = () => {
            URL.revokeObjectURL(url);
            resolve(file);
          };
          img.src = url;
        });
      };

      // Banner para index en alta calidad (base 3300x1656, 2x de 1650x828).
      const resizeBannerIfNeeded = (file, targetW = 3300, targetH = 1656, maxBytes = 1800000) => {
        return new Promise((resolve) => {
          if (!file || !file.type?.startsWith("image/")) return resolve(file);
          const sourceIsWebp = isWebpFile(file);
          const targetRatio = targetW / targetH;
          const img = new Image();
          const url = URL.createObjectURL(file);
          img.onload = () => {
            URL.revokeObjectURL(url);
            const { width, height } = img;
            const sourceRatio = width > 0 && height > 0 ? width / height : targetRatio;
            const sameRatio = Math.abs(sourceRatio - targetRatio) < 0.01;
            const isWithinTarget = width <= targetW && height <= targetH;
            const shouldResize = file.size > maxBytes || !sameRatio || !isWithinTarget;
            if (!shouldResize) {
              resolve(file);
              return;
            }

            // No escalar por encima del tamaño original: mantiene nitidez real.
            let outputW = Math.min(targetW, Math.max(1, width));
            let outputH = Math.round(outputW / targetRatio);
            if (outputH > height) {
              outputH = Math.max(1, height);
              outputW = Math.round(outputH * targetRatio);
            }
            const canvas = document.createElement("canvas");
            canvas.width = Math.max(1, outputW);
            canvas.height = Math.max(1, outputH);
            const ctx = canvas.getContext("2d");
            if (!ctx) {
              resolve(file);
              return;
            }
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = "high";
            const scale = Math.max(canvas.width / width, canvas.height / height);
            const drawW = Math.max(1, Math.round(width * scale));
            const drawH = Math.max(1, Math.round(height * scale));
            const offsetX = Math.round((canvas.width - drawW) / 2);
            const offsetY = Math.round((canvas.height - drawH) / 2);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, offsetX, offsetY, drawW, drawH);
            const makeBlob = (type, quality) =>
              new Promise((res) => {
                canvas.toBlob((blob) => res(blob), type, quality);
              });

            (async () => {
              let quality = 0.96;
              let blob = await makeBlob("image/webp", quality);
              while (blob && blob.size > maxBytes && quality > 0.82) {
                quality = Math.max(0.82, quality - 0.03);
                blob = await makeBlob("image/webp", quality);
              }
              if (blob) {
                // Si el origen es WEBP y el navegador no lo respeta al exportar, conserva el archivo original.
                if (sourceIsWebp && String(blob.type || "").toLowerCase() !== "image/webp") {
                  resolve(file);
                  return;
                }
                const baseName = file.name.replace(/\.[^.]+$/, "");
                const ext = extensionFromMimeType(blob.type, sourceIsWebp ? "webp" : "jpg");
                const resized = new File([blob], `${baseName}.${ext}`, {
                  type: blob.type || file.type,
                });
                resolve(resized);
                return;
              }
              resolve(file);
            })().catch(() => resolve(file));
          };
          img.onerror = () => {
            URL.revokeObjectURL(url);
            resolve(file);
          };
          img.src = url;
        });
      };

      const resizePreviewIfNeeded = (file, targetW = 1200, targetH = 630, maxBytes = 280000) => {
        return new Promise((resolve) => {
          if (!file || !file.type?.startsWith("image/")) return resolve(file);
          const sourceIsWebp = isWebpFile(file);
          const shouldResize = file.size > maxBytes;
          const img = new Image();
          const url = URL.createObjectURL(file);
          img.onload = () => {
            URL.revokeObjectURL(url);
            const { width, height } = img;
            if (!shouldResize && width === targetW && height === targetH) {
              resolve(file);
              return;
            }
            const canvas = document.createElement("canvas");
            canvas.width = targetW;
            canvas.height = targetH;
            const ctx = canvas.getContext("2d");
            if (!ctx) {
              resolve(file);
              return;
            }
            const scale = Math.max(targetW / width, targetH / height);
            const drawW = Math.max(1, Math.round(width * scale));
            const drawH = Math.max(1, Math.round(height * scale));
            const offsetX = Math.round((targetW - drawW) / 2);
            const offsetY = Math.round((targetH - drawH) / 2);
            ctx.clearRect(0, 0, targetW, targetH);
            ctx.drawImage(img, offsetX, offsetY, drawW, drawH);
            const makeBlob = (type, quality) =>
              new Promise((res) => {
                canvas.toBlob((blob) => res(blob), type, quality);
              });

            (async () => {
              let quality = 0.92;
              const targetMime = sourceIsWebp ? "image/webp" : "image/jpeg";
              let blob = await makeBlob(targetMime, quality);
              while (blob && blob.size > maxBytes && quality > 0.7) {
                quality = Math.max(0.7, quality - 0.05);
                blob = await makeBlob(targetMime, quality);
              }
              if (!blob) {
                resolve(file);
                return;
              }
              // Si el origen es WEBP y el navegador no lo respeta al exportar, conserva el archivo original.
              if (sourceIsWebp && String(blob.type || "").toLowerCase() !== "image/webp") {
                resolve(file);
                return;
              }
              const baseName = file.name.replace(/\.[^.]+$/, "");
              const ext = extensionFromMimeType(blob.type, sourceIsWebp ? "webp" : "jpg");
              const resized = new File([blob], `${baseName}.${ext}`, { type: blob.type || file.type });
              resolve(resized);
            })().catch(() => resolve(file));
          };
          img.onerror = () => {
            URL.revokeObjectURL(url);
            resolve(file);
          };
          img.src = url;
        });
      };

      const renderPlatformLogosList = () => {
        if (!platformLogosListEl) return;
        const rows = Object.values(plataformasMap || {}).filter((row) => row?.id_plataforma);
        if (!rows.length) {
          platformLogosListEl.innerHTML =
            '<p class="status icono-empty">Sin plataformas cargadas.</p>';
          return;
        }
        const sortedRows = [...rows].sort((a, b) => {
          const catA = getPlatformCategoryName(a);
          const catB = getPlatformCategoryName(b);
          const cmpCat = catA.localeCompare(catB, "es");
          if (cmpCat !== 0) return cmpCat;
          const posA = Number.isFinite(Number(a?.posicion))
            ? Number(a.posicion)
            : Number.MAX_SAFE_INTEGER;
          const posB = Number.isFinite(Number(b?.posicion))
            ? Number(b.posicion)
            : Number.MAX_SAFE_INTEGER;
          if (posA !== posB) return posA - posB;
          return String(a?.nombre || "").localeCompare(String(b?.nombre || ""), "es");
        });

        const grouped = sortedRows.reduce((acc, row) => {
          const category = getPlatformCategoryName(row);
          if (!acc.has(category)) acc.set(category, []);
          acc.get(category).push(row);
          return acc;
        }, new Map());

        platformLogosListEl.innerHTML = Array.from(grouped.entries())
          .map(([category, categoryRows]) => {
            const rowsHtml = categoryRows
              .map((row) => {
                const imgUrl = String(row?.imagen || "").trim();
                const hasImg = !!imgUrl;
                const rowId = Number(row?.id_plataforma || 0);
                const isSelected = rowId > 0 && rowId === Number(selectedId || 0);
                return `
                  <article class="platform-logo-row platform-logo-card-row ${isSelected ? "is-selected" : ""}" data-id-plataforma="${rowId}">
                    <div class="platform-logo-main">
                      <div class="platform-logo-drag-col" title="Arrastrar para ordenar">
                        <button
                          type="button"
                          class="home-banner-drag-handle platform-logo-drag-handle"
                          draggable="true"
                          aria-label="Arrastrar plataforma para ordenar"
                        ></button>
                      </div>
                      <div class="platform-logo-thumb">
                        ${
                          hasImg
                            ? `<img src="${escapeHtml(imgUrl)}" alt="${escapeHtml(row?.nombre || "Logo")}" loading="lazy" decoding="async" />
                               ${getExtensionBadgeHtml(imgUrl)}`
                            : '<span class="status" style="font-size:11px; padding:4px; text-align:center;">Sin logo</span>'
                        }
                      </div>
                      <p class="platform-logo-name">${escapeHtml(row?.nombre || "")}</p>
                    </div>
                  </article>
                `;
              })
              .join("");
            return `
              <section class="platform-logo-group">
                <p class="platform-group-title">${escapeHtml(category)}</p>
                <div class="platform-group-items">
                  ${rowsHtml}
                </div>
              </section>
            `;
          })
          .join("");
      };
      const renderMetodosPagoList = () => {
        if (!metodosPagoListEl) return;
        const rows = Object.values(metodosPagoMap || {})
          .filter((row) => Number.isFinite(Number(row?.id_metodo_de_pago)))
          .sort((a, b) => {
            const idA = Number(a?.id_metodo_de_pago) || 0;
            const idB = Number(b?.id_metodo_de_pago) || 0;
            if (idA !== idB) return idA - idB;
            return String(a?.nombre || "").localeCompare(String(b?.nombre || ""), "es");
          });
        if (!rows.length) {
          metodosPagoListEl.innerHTML =
            '<p class="status icono-empty">Sin métodos de pago cargados.</p>';
          if (metodosPagoSelectedStatusEl) metodosPagoSelectedStatusEl.textContent = "Método: -";
          return;
        }
        metodosPagoListEl.innerHTML = rows
          .map((row) => {
            const rowId = Number(row?.id_metodo_de_pago || 0);
            const isSelected = rowId > 0 && rowId === Number(selectedMetodoPagoId || 0);
            const nombre = String(row?.nombre || "").trim() || `Método #${rowId}`;
            const imgUrl = String(row?.imagen || "").trim();
            const extraInfo = [row?.correo, row?.telefono].filter(Boolean).join(" · ");
            return `
              <article class="platform-logo-row platform-banner-row ${isSelected ? "is-selected" : ""}" data-id-metodo="${rowId}">
                <div class="platform-logo-thumb platform-banner-thumb">
                  ${
                    imgUrl
                      ? `<img src="${escapeHtml(imgUrl)}" alt="${escapeHtml(nombre)}" loading="lazy" decoding="async" />
                         ${getExtensionBadgeHtml(imgUrl)}`
                      : '<span class="status" style="font-size:11px; padding:4px; text-align:center;">Sin imagen</span>'
                  }
                </div>
                <div class="platform-logo-meta">
                  <p class="platform-logo-name">${escapeHtml(nombre)}</p>
                  <p class="status" style="margin:0; font-size:11px;">ID método: ${rowId}${
                    extraInfo ? ` · ${escapeHtml(extraInfo)}` : ""
                  }</p>
                </div>
              </article>
            `;
          })
          .join("");
        const selectedMetodo =
          selectedMetodoPagoId != null ? metodosPagoMap[selectedMetodoPagoId] : null;
        if (metodosPagoSelectedStatusEl) {
          metodosPagoSelectedStatusEl.textContent = selectedMetodo?.nombre
            ? `Método: ${selectedMetodo.nombre}`
            : "Método: -";
        }
      };
      const renderPlatformBannersList = () => {
        if (!platformBannersListEl) return;
        const rows = Object.values(plataformasMap || {})
          .sort((a, b) => String(a?.nombre || "").localeCompare(String(b?.nombre || ""), "es"))
          .filter((row) => row?.id_plataforma);
        if (!rows.length) {
          platformBannersListEl.innerHTML =
            '<p class="status icono-empty">Sin plataformas cargadas.</p>';
          return;
        }
        platformBannersListEl.innerHTML = rows
          .map((row) => {
            const imgUrl = String(row?.banner || "").trim();
            const hasImg = !!imgUrl;
            const rowId = Number(row?.id_plataforma || 0);
            const isSelected = rowId > 0 && rowId === Number(selectedId || 0);
            return `
              <article class="platform-logo-row platform-banner-row ${isSelected ? "is-selected" : ""}" data-id-plataforma="${rowId}">
                <div class="platform-logo-thumb platform-banner-thumb">
                  ${
                    hasImg
                      ? `<img src="${escapeHtml(imgUrl)}" alt="${escapeHtml(row?.nombre || "Banner")}" loading="lazy" decoding="async" />
                         ${getExtensionBadgeHtml(imgUrl)}`
                      : '<span class="status" style="font-size:11px; padding:4px; text-align:center;">Sin banner</span>'
                  }
                </div>
                <div class="platform-logo-meta">
                  <p class="platform-logo-name">${escapeHtml(row?.nombre || "")}</p>
                </div>
              </article>
            `;
          })
          .join("");
      };

      const renderEditor = (plat) => {
        const hasBanner = !!plat?.banner;
        renderPlatformBannersList();
        if (platformSelectedStatusEl) {
          platformSelectedStatusEl.textContent = plat?.nombre
            ? `Plataforma: ${plat.nombre}`
            : "Plataforma: -";
        }
        if (bannerInlinePlatformNameEl) {
          bannerInlinePlatformNameEl.textContent = plat?.nombre
            ? `Plataforma: ${plat.nombre}`
            : "Plataforma: -";
        }
        if (bannerInlinePreview) {
          bannerInlinePreview.src = hasBanner ? plat?.banner : "";
          bannerInlinePreview.alt = plat?.nombre ? `Banner de ${plat.nombre}` : "Banner cargado";
        }
        setExtensionBadge(bannerInlineBadge, plat?.banner || "");
        setExtensionBadge(bannerPreviewBadge, plat?.banner || "");
        if (bannerInlineFrame) {
          bannerInlineFrame.classList.toggle("has-image", hasBanner);
        }
        if (bannerTargetStatusEl) {
          bannerTargetStatusEl.textContent = plat?.nombre
            ? `Plataforma: ${plat.nombre}`
            : "Plataforma: -";
        }
        if (bannerSelectedStatusEl) {
          bannerSelectedStatusEl.textContent = plat?.nombre
            ? `Plataforma: ${plat.nombre}`
            : "Plataforma: -";
        }
        if (bannerEditor) {
          if (!isPlatformBannersEditorOpen) {
            bannerEditor.classList.add("hidden");
            return;
          }
          bannerEditor.classList.remove("hidden");
          if (bannerCurrentWrap) bannerCurrentWrap.style.display = "flex";
          if (bannerPreview) bannerPreview.src = hasBanner ? plat?.banner : "";
        }
      };

      const renderPreview = () => {
        if (!previewEditor) return;
        const hasPreview = !!paginaPreview?.preview;
        previewEditor.classList.toggle("no-preview", !hasPreview);
        if (previewCurrentWrap) previewCurrentWrap.style.display = hasPreview ? "flex" : "none";
        if (previewPageImg) previewPageImg.src = hasPreview ? paginaPreview.preview : "";
        setExtensionBadge(previewImageBadge, paginaPreview?.preview || "");
      };
      const applyFavicon = (url = "") => {
        const iconUrl = String(url || "").trim();
        if (!iconUrl) {
          console.log("[editar_logos][favicon] icono_pestana vacío, aplicando favicon fijo.");
        }
        document
          .querySelectorAll(
            'link[rel="icon"], link[rel="shortcut icon"], link[rel~="icon"], link[rel="apple-touch-icon"], link[rel="mask-icon"]',
          )
          .forEach((el) => el.remove());
        const iconLink = document.createElement("link");
        iconLink.setAttribute("rel", "icon");
        iconLink.setAttribute("type", "image/png");
        iconLink.setAttribute("href", STATIC_FAVICON_HREF);
        document.head.appendChild(iconLink);
        const shortcutLink = document.createElement("link");
        shortcutLink.setAttribute("rel", "shortcut icon");
        shortcutLink.setAttribute("type", "image/png");
        shortcutLink.setAttribute("href", STATIC_FAVICON_HREF);
        document.head.appendChild(shortcutLink);
        console.log("[editar_logos][favicon] aplicando href fijo =", STATIC_FAVICON_HREF);
      };
      const renderStoreAssets = () => {
        const logoUrl = String(paginaPreview?.logo || "").trim();
        const iconUrl = String(paginaPreview?.icono_pestana || "").trim();
        const previewUrl = String(paginaPreview?.preview || "").trim();
        console.log("[editar_logos][favicon] fuente pagina.id =", PAGINA_TARGET_ID, {
          icono_pestana: paginaPreview?.icono_pestana || null,
          logo_pestana: paginaPreview?.logo_pestana || null,
          icono: paginaPreview?.icono || null,
        });
        console.log("[editar_logos][favicon] url final usada =", iconUrl || "(vacía)");
        if (storeLogoPreviewEl) storeLogoPreviewEl.src = logoUrl;
        setExtensionBadge(storeLogoBadgeEl, logoUrl);
        if (storeIconPreviewEl) storeIconPreviewEl.src = iconUrl;
        setExtensionBadge(storeIconBadgeEl, iconUrl);
        if (storePreviewPreviewEl) storePreviewPreviewEl.src = previewUrl;
        setExtensionBadge(storePreviewBadgeEl, previewUrl);
        applyFavicon(iconUrl);
      };

      const loadPreview = async () => {
        try {
          const { data, error } = await supabase
            .from("pagina")
            .select("*")
            .eq("id", PAGINA_TARGET_ID)
            .maybeSingle();
          if (error) throw error;
          if (!data) {
            throw new Error(`No existe la fila pagina.id = ${PAGINA_TARGET_ID}.`);
          }
          console.log("[editar_logos][favicon] row cargada de pagina =", {
            id: data?.id ?? null,
            icono_pestana: data?.icono_pestana || null,
            logo: data?.logo || null,
          });
          paginaPreview = data || null;
          renderPreview();
          renderStoreAssets();
        } catch (err) {
          console.error("load preview error", err);
          setPreviewStatus("No se pudo cargar el preview.", true);
          setStoreLogoStatus(`No se encontró pagina.id = ${PAGINA_TARGET_ID}.`, true);
        }
      };
      const upsertPaginaFields = async (fields = {}) => {
        const { data: row, error: selErr } = await supabase
          .from("pagina")
          .select("*")
          .eq("id", PAGINA_TARGET_ID)
          .maybeSingle();
        if (selErr) throw selErr;
        if (!row) {
          throw new Error(`No existe la fila pagina.id = ${PAGINA_TARGET_ID}.`);
        }
        const payload = { ...fields };
        if ("icono_pestana" in payload && !("icono_pestana" in row)) {
          if ("logo_pestana" in row) {
            payload.logo_pestana = payload.icono_pestana;
            delete payload.icono_pestana;
          } else if ("icono" in row) {
            payload.icono = payload.icono_pestana;
            delete payload.icono_pestana;
          }
        }
        const { error: updErr } = await supabase
          .from("pagina")
          .update(payload)
          .eq("id", PAGINA_TARGET_ID);
        if (updErr) throw updErr;
        paginaPreview = { ...row, ...payload };
      };

      const renderIconosGallery = (items = []) => {
        if (!iconosGalleryEl) return;
        const rows = Array.isArray(items)
          ? items
              .filter((it) => it?.publicUrl)
              .filter((it) => !String(it?.name || "").startsWith("."))
              .filter((it) => isImageName(it?.name))
          : [];
        if (!rows.length) {
          iconosGalleryEl.innerHTML = '<p class="status icono-empty">Sin iconos cargados.</p>';
          return;
        }
        iconosGalleryEl.innerHTML = rows
          .map(
            (item) => `
              <figure
                class="icono-item"
                data-public-url="${escapeHtml(item.publicUrl || "")}"
                data-name="${escapeHtml(item.name || "")}"
                title="${escapeHtml(item.name || "")}"
              >
                <div class="icono-thumb">
                  <img src="${escapeHtml(item.publicUrl)}" alt="${escapeHtml(item.name || "icono")}" loading="lazy" decoding="async" />
                  ${getExtensionBadgeHtml(item.name || item.publicUrl || "")}
                </div>
                <figcaption>${escapeHtml(item.name || "")}</figcaption>
              </figure>
            `,
          )
          .join("");
      };

      const loadIconos = async () => {
        try {
          const url = new URL(`${API_BASE}/api/logos/list`);
          url.searchParams.set("folder", "icono-perfil");
          if (sessionId) url.searchParams.set("id_usuario", String(sessionId));
          const res = await fetch(url.toString(), {
            credentials: "include",
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) {
            throw new Error(data?.error || "No se pudo listar iconos.");
          }
          renderIconosGallery(data?.items || []);
        } catch (err) {
          console.error("load iconos error", err);
          renderIconosGallery([]);
          setIconosStatus("No se pudieron cargar los iconos.", true);
        }
      };

      const replaceIconoImage = async (itemEl, file) => {
        if (!isImageFile(file)) {
          throw new Error("Solo se permiten archivos de imagen.");
        }
        const previousUrl = String(itemEl?.dataset?.publicUrl || "").trim();
        const previousName = String(itemEl?.dataset?.name || "").trim();
        const label = previousName || "icono";
        setIconosStatus(`Reemplazando ${label}...`);

        const { urls, error: uploadErr } = await uploadPlatformLogos([file], {
          folder: "icono-perfil",
        });
        if (uploadErr) throw uploadErr;
        const nextUrl = String(urls?.[0] || "").trim();
        if (!nextUrl) throw new Error("No se obtuvo URL del icono.");

        let deleteError = null;
        if (previousUrl && previousUrl !== nextUrl) {
          const deleted = await deletePublicAssets({
            public_urls: [previousUrl],
          });
          if (deleted?.error) {
            deleteError = deleted.error;
          }
        }

        return { nextUrl, deleteError, label };
      };

      const renderHomeBannersList = (items = []) => {
        if (!homeBannersListEl && !homeBannersMobileListEl) return;
        const rows = Array.isArray(items)
          ? items.filter((row) => Number.isFinite(Number(row?.id_banner)) && Number(row?.id_banner) > 0)
          : [];
        const desktopRows = rows.filter((row) => String(row?.image_url || "").trim());
        const getRowTitle = (row) =>
          String(row?.title || "").trim() || `Banner #${Number(row?.id_banner) || 0}`;

        if (homeBannersListEl) {
          if (!desktopRows.length) {
            homeBannersListEl.innerHTML =
              '<p class="status icono-empty">Sin banners cargados.</p>';
          } else {
            homeBannersListEl.innerHTML = desktopRows
              .map(
                (row) => {
                  const suffix = normalizeRouteSuffix(row?.redirect_url || "");
                  const routeValue = buildHomeBannerRoute(suffix);
                  const isVisible = row?.oculto !== true;
                  const toggleId = `banner-visible-${Number(row?.id_banner) || 0}`;
                  const title = getRowTitle(row);
                  return `
                  <article class="home-banner-item" data-id-banner="${Number(row?.id_banner) || 0}">
                    <div class="home-banner-drag-col" title="Arrastrar para ordenar">
                      <button
                        type="button"
                        class="home-banner-drag-handle"
                        draggable="true"
                        aria-label="Arrastrar banner para ordenar"
                      ></button>
                    </div>
                    <div class="home-banner-toggle-col" title="Mostrar/Ocultar banner">
                      <label class="home-banner-toggle-label" for="${toggleId}">
                        <input
                          id="${toggleId}"
                          type="checkbox"
                          class="home-banner-visibility-toggle"
                          ${isVisible ? "checked" : ""}
                        />
                        <span class="home-banner-toggle-slider"></span>
                      </label>
                    </div>
                    <div class="home-banner-media-col">
                      <p class="home-banner-title">${escapeHtml(title)}</p>
                      <figure class="banner-frame home-banner-thumb">
                        <img
                          src="${escapeHtml(row?.image_url || "")}"
                          alt="${escapeHtml(title)}"
                          loading="lazy"
                          decoding="async"
                        />
                        ${getExtensionBadgeHtml(row?.image_url || "")}
                      </figure>
                    </div>
                    <div class="home-banner-meta">
                      <span class="home-banner-meta-label">Dirección</span>
                      <div class="home-banner-route-wrap">
                        <span class="home-banner-route-prefix">${escapeHtml(HOME_BANNER_ROUTE_PREFIX)}</span>
                        <input
                          type="text"
                          class="home-banner-link-input"
                          value="${escapeHtml(suffix)}"
                          placeholder="checkout.html"
                        />
                      </div>
                      <p class="home-banner-route-preview">Ruta final: ${escapeHtml(routeValue)}</p>
                      <div class="home-banner-actions">
                        <button type="button" class="btn-outline btn-home-banner-save">
                          Guardar dirección
                        </button>
                      </div>
                    </div>
                  </article>
                `;
                },
              )
              .join("");
          }
        }

        if (homeBannersMobileListEl) {
          if (!rows.length) {
            homeBannersMobileListEl.innerHTML =
              '<p class="status icono-empty">Sin banners móviles cargados.</p>';
          } else {
            homeBannersMobileListEl.innerHTML = rows
              .map((row) => {
                const title = getRowTitle(row);
                const mobileImageUrl = String(row?.image_url_mobile || "").trim();
                return `
                  <article class="home-banner-item home-banner-mobile-item" data-id-banner="${Number(row?.id_banner) || 0}">
                    <div class="home-banner-media-col">
                      <p class="home-banner-title">${escapeHtml(title)}</p>
                      <figure class="banner-frame home-banner-thumb">
                        ${
                          mobileImageUrl
                            ? `
                              <img
                                src="${escapeHtml(mobileImageUrl)}"
                                alt="${escapeHtml(`${title} (móvil)`)}"
                                loading="lazy"
                                decoding="async"
                              />
                              ${getExtensionBadgeHtml(mobileImageUrl)}
                            `
                            : '<p class="home-banner-mobile-empty">Sin imagen móvil. Arrastra y suelta una imagen aquí.</p>'
                        }
                      </figure>
                    </div>
                  </article>
                `;
              })
              .join("");
          }
        }
      };

      const loadHomeBanners = async () => {
        try {
          setHomeBannersStatus("Cargando banners...");
          const data = await fetchHomeBanners({ includeInactive: true });
          if (data?.error) throw new Error(data.error);
          renderHomeBannersList(data?.items || []);
          if (data?.tableMissing) {
            setHomeBannersStatus(
              "Falta tabla banners en Supabase.",
              true,
            );
            return;
          }
          setHomeBannersStatus("");
        } catch (err) {
          console.error("load home banners error", err);
          renderHomeBannersList([]);
          setHomeBannersStatus("No se pudieron cargar los banners.", true);
        }
      };

      const savePlatformLogosOrder = async () => {
        if (platformLogoOrderSaving || !platformLogosListEl) return;
        const rows = Array.from(
          platformLogosListEl.querySelectorAll(".platform-logo-row[data-id-plataforma]"),
        );
        if (!rows.length) return;

        const updates = rows
          .map((row, idx) => ({
            idPlataforma: Number(row.dataset.idPlataforma || 0),
            posicion: idx + 1,
          }))
          .filter((row) => Number.isFinite(row.idPlataforma) && row.idPlataforma > 0);
        if (!updates.length) return;

        const changed = updates.filter((row) => {
          const current = Number(plataformasMap[row.idPlataforma]?.posicion);
          return current !== row.posicion;
        });
        if (!changed.length) return;

        platformLogoOrderSaving = true;
        try {
          setStatus("Guardando posiciones...");
          for (const row of changed) {
            const { error } = await supabase
              .from("plataformas")
              .update({ posicion: row.posicion })
              .eq("id_plataforma", row.idPlataforma);
            if (error) throw error;
            if (plataformasMap[row.idPlataforma]) {
              plataformasMap[row.idPlataforma].posicion = row.posicion;
            }
          }
          setStatus("Posiciones actualizadas.");
          renderPlatformLogosList();
        } catch (err) {
          console.error("save platform logos order error", err);
          setStatus("No se pudieron guardar posiciones.", true);
          await loadPlataformas();
        } finally {
          platformLogoOrderSaving = false;
        }
      };

      const saveHomeBannersOrder = async () => {
        if (homeBannerOrderSaving || !homeBannersListEl) return;
        const rows = Array.from(
          homeBannersListEl.querySelectorAll(".home-banner-item[data-id-banner]"),
        );
        if (rows.length <= 1) return;
        const updates = rows
          .map((row, idx) => ({
            idBanner: Number(row.dataset.idBanner),
            posicion: idx + 1,
          }))
          .filter((row) => Number.isFinite(row.idBanner) && row.idBanner > 0);
        if (!updates.length) return;

        homeBannerOrderSaving = true;
        try {
          setHomeBannersStatus("Guardando orden de banners...");
          for (const row of updates) {
            const updated = await updateHomeBanner(row.idBanner, {
              posicion: row.posicion,
            });
            if (updated?.error) throw new Error(updated.error);
          }
          setHomeBannersStatus("Orden de banners actualizado.");
          await loadHomeBanners();
        } catch (err) {
          console.error("save home banners order error", err);
          setHomeBannersStatus("No se pudo guardar el orden.", true);
          await loadHomeBanners();
        } finally {
          homeBannerOrderSaving = false;
        }
      };

      const replaceHomeBannerImage = async (
        idBanner,
        file,
        previousImageUrl = "",
        targetField = "image_url",
      ) => {
        if (!Number.isFinite(idBanner) || idBanner <= 0) {
          throw new Error("id_banner inválido.");
        }
        if (!isImageFile(file)) {
          throw new Error("Solo se permiten archivos de imagen.");
        }
        if (!["image_url", "image_url_mobile"].includes(String(targetField || ""))) {
          throw new Error("Campo de imagen inválido.");
        }

        setHomeBannersStatus(`Reemplazando banner #${idBanner}...`);
        let optimized = file;
        optimized = await resizeBannerIfNeeded(optimized);
        const { urls, error: uploadErr } = await uploadPlatformLogos([optimized], {
          folder: "banners-index",
        });
        if (uploadErr) throw uploadErr;
        const imageUrl = String(urls?.[0] || "").trim();
        if (!imageUrl) throw new Error("No se obtuvo URL del banner.");

        const updatePayload =
          targetField === "image_url_mobile"
            ? { image_url_mobile: imageUrl }
            : { image_url: imageUrl };
        const updated = await updateHomeBanner(idBanner, updatePayload);
        if (updated?.error) throw new Error(updated.error);

        let deleteError = null;
        const prevUrl = String(previousImageUrl || "").trim();
        if (prevUrl && prevUrl !== imageUrl) {
          const deleted = await deletePublicAssets({
            public_urls: [prevUrl],
          });
          if (deleted?.error) {
            deleteError = deleted.error;
          }
        }

        return {
          imageUrl,
          deleteError,
        };
      };

      const replacePlatformLogoImage = async (
        idPlataforma,
        file,
        previousImageUrl = "",
      ) => {
        if (!Number.isFinite(idPlataforma) || idPlataforma <= 0) {
          throw new Error("id_plataforma inválido.");
        }
        if (!isImageFile(file)) {
          throw new Error("Solo se permiten archivos de imagen.");
        }

        setStatus("Reemplazando logo...");
        let optimized = file;
        optimized = await resizeImageIfNeeded(optimized);
        const { urls, error: uploadErr } = await uploadPlatformLogos([optimized], {
          folder: PLATFORM_CARD_LOGOS_FOLDER,
        });
        if (uploadErr) throw uploadErr;
        const imageUrl = String(urls?.[0] || "").trim();
        if (!imageUrl) throw new Error("No se obtuvo URL del logo.");

        const { error: updErr } = await supabase
          .from("plataformas")
          .update({ imagen: imageUrl })
          .eq("id_plataforma", idPlataforma);
        if (updErr) throw updErr;

        let deleteError = null;
        const prevUrl = String(previousImageUrl || "").trim();
        if (prevUrl && prevUrl !== imageUrl) {
          const deleted = await deletePublicAssets({
            public_urls: [prevUrl],
          });
          if (deleted?.error) {
            deleteError = deleted.error;
          }
        }

        plataformasMap[idPlataforma] = {
          ...(plataformasMap[idPlataforma] || {}),
          id_plataforma: idPlataforma,
          imagen: imageUrl,
        };

        return {
          imageUrl,
          deleteError,
        };
      };

      const replaceMetodoPagoImage = async (
        idMetodoPago,
        file,
        previousImageUrl = "",
      ) => {
        if (!Number.isFinite(idMetodoPago) || idMetodoPago <= 0) {
          throw new Error("id_metodo_de_pago inválido.");
        }
        if (!isImageFile(file)) {
          throw new Error("Solo se permiten archivos de imagen.");
        }

        setMetodosPagoStatus("Reemplazando imagen...");
        let optimized = file;
        optimized = await resizeImageIfNeeded(optimized, 512, 512, 200000);
        const { urls, error: uploadErr } = await uploadPlatformLogos([optimized], {
          folder: PAYMENT_METHOD_LOGOS_FOLDER,
        });
        if (uploadErr) throw uploadErr;
        const imageUrl = String(urls?.[0] || "").trim();
        if (!imageUrl) throw new Error("No se obtuvo URL de la imagen.");

        const { error: updErr } = await supabase
          .from("metodos_de_pago")
          .update({ imagen: imageUrl })
          .eq("id_metodo_de_pago", idMetodoPago);
        if (updErr) throw updErr;

        let deleteError = null;
        const prevUrl = String(previousImageUrl || "").trim();
        if (prevUrl && prevUrl !== imageUrl) {
          const deleted = await deletePublicAssets({
            public_urls: [prevUrl],
          });
          if (deleted?.error) {
            deleteError = deleted.error;
          }
        }

        metodosPagoMap[idMetodoPago] = {
          ...(metodosPagoMap[idMetodoPago] || {}),
          id_metodo_de_pago: idMetodoPago,
          imagen: imageUrl,
        };

        return {
          imageUrl,
          deleteError,
        };
      };

      const replacePlatformBannerImage = async (
        idPlataforma,
        file,
        previousImageUrl = "",
      ) => {
        if (!Number.isFinite(idPlataforma) || idPlataforma <= 0) {
          throw new Error("id_plataforma inválido.");
        }
        if (!isImageFile(file)) {
          throw new Error("Solo se permiten archivos de imagen.");
        }

        setBannerStatus("Reemplazando banner...");
        let optimized = file;
        optimized = await resizeBannerIfNeeded(optimized);
        const { urls, error: uploadErr } = await uploadPlatformLogos([optimized], {
          folder: PLATFORM_MODAL_BANNERS_FOLDER,
        });
        if (uploadErr) throw uploadErr;
        const imageUrl = String(urls?.[0] || "").trim();
        if (!imageUrl) throw new Error("No se obtuvo URL del banner.");

        const { error: updErr } = await supabase
          .from("plataformas")
          .update({ banner: imageUrl })
          .eq("id_plataforma", idPlataforma);
        if (updErr) throw updErr;

        let deleteError = null;
        const prevUrl = String(previousImageUrl || "").trim();
        if (prevUrl && prevUrl !== imageUrl) {
          const deleted = await deletePublicAssets({
            public_urls: [prevUrl],
          });
          if (deleted?.error) {
            deleteError = deleted.error;
          }
        }

        plataformasMap[idPlataforma] = {
          ...(plataformasMap[idPlataforma] || {}),
          id_plataforma: idPlataforma,
          banner: imageUrl,
        };

        return {
          imageUrl,
          deleteError,
        };
      };

      const replaceStorePageAssetImage = async (file, field) => {
        if (!isImageFile(file)) {
          throw new Error("Solo se permiten archivos de imagen.");
        }
        if (!["logo", "icono_pestana", "preview"].includes(field)) {
          throw new Error("Campo de pagina inválido.");
        }

        const actionName =
          field === "logo"
            ? "logo"
            : field === "icono_pestana"
              ? "icono de pestaña"
              : "preview";
        setStoreLogoStatus(`Reemplazando ${actionName}...`);

        let optimized = file;
        if (field === "preview") {
          optimized = await resizePreviewIfNeeded(optimized);
        } else if (field === "icono_pestana") {
          optimized = await resizeImageIfNeeded(optimized, 256, 256, 120000);
        } else {
          optimized = await resizeImageIfNeeded(optimized, 900, 280, 220000);
        }

        const { urls, error: uploadErr } = await uploadPlatformLogos([optimized], {
          folder: STORE_LOGO_FOLDER,
        });
        if (uploadErr) throw uploadErr;
        const imageUrl = String(urls?.[0] || "").trim();
        if (!imageUrl) throw new Error("No se obtuvo URL de la imagen.");

        await upsertPaginaFields({ [field]: imageUrl });
        renderStoreAssets();
        renderPreview();
        return imageUrl;
      };

      const importPlatformLogosByName = async (selectedFiles = []) => {
        const imageFiles = Array.from(selectedFiles || []).filter((file) => isImageFile(file));
        if (!imageFiles.length) {
          setStatus("No se encontraron imágenes válidas para importar.", true);
          return { ok: false };
        }
        if (platformLogosImporting) {
          setStatus("Ya hay una importación en curso.", true);
          return { ok: false };
        }

        platformLogosImporting = true;
        clearPlatformLogosImportTarget();
        setBusyOverlay(platformLogosCurrentEl, "Importando");
        try {
          const byName = new Map();
          Object.values(plataformasMap || {}).forEach((plat) => {
            const key = normalizeNameKey(plat?.nombre || "");
            if (!key || byName.has(key)) return;
            byName.set(key, plat);
          });

          const matched = [];
          const skipped = [];
          imageFiles.forEach((file) => {
            const key = normalizeNameKey(file.name || "");
            const plat = byName.get(key);
            if (!plat?.id_plataforma) {
              skipped.push(file.name || "sin-nombre");
              return;
            }
            matched.push({ file, plat });
          });

          if (!matched.length) {
            setStatus(
              "No hubo coincidencias por nombre con plataformas. Usa archivos con el nombre exacto de la plataforma.",
              true,
            );
            return { ok: false };
          }

          const chunkSize = 10;
          let updatedCount = 0;
          let deletedOldCount = 0;
          for (let i = 0; i < matched.length; i += chunkSize) {
            const chunk = matched.slice(i, i + chunkSize);
            const processed = Math.min(i + chunk.length, matched.length);
            setStatus(`Importando logos (${processed}/${matched.length})...`);
            const optimizedChunk = await Promise.all(
              chunk.map(async (row) => ({
                ...row,
                file: await resizeImageIfNeeded(row.file),
              })),
            );
            const { urls, error: uploadErr } = await uploadPlatformLogos(
              optimizedChunk.map((row) => row.file),
              {
                folder: PLATFORM_CARD_LOGOS_FOLDER,
              },
            );
            if (uploadErr) throw uploadErr;
            const updates = optimizedChunk
              .map((row, idx) => ({
                id_plataforma: row.plat.id_plataforma,
                imagen: String(urls?.[idx] || "").trim(),
              }))
              .filter((row) => row.imagen);
            for (const row of updates) {
              const previousUrl = String(
                plataformasMap[row.id_plataforma]?.imagen || "",
              ).trim();
              const { error: updErr } = await supabase
                .from("plataformas")
                .update({ imagen: row.imagen })
                .eq("id_plataforma", row.id_plataforma);
              if (updErr) throw updErr;
              if (previousUrl && previousUrl !== row.imagen) {
                const delRes = await deletePublicAssets({
                  public_urls: [previousUrl],
                });
                if (!delRes?.error) {
                  deletedOldCount += 1;
                }
              }
              if (plataformasMap[row.id_plataforma]) {
                plataformasMap[row.id_plataforma].imagen = row.imagen;
              }
              updatedCount += 1;
            }
          }

          renderPlatformLogosList();
          const skippedText = skipped.length
            ? ` Se omitieron ${skipped.length} archivo(s) sin coincidencia.`
            : "";
          const deletedText = deletedOldCount
            ? ` Se eliminaron ${deletedOldCount} logo(s) anterior(es) del bucket.`
            : "";
          setStatus(`Se actualizaron ${updatedCount} logo(s).${deletedText}${skippedText}`);
          return { ok: true, updatedCount };
        } catch (err) {
          console.error("import platform logos error", err);
          setStatus("No se pudieron importar los logos.", true);
          return { ok: false };
        } finally {
          platformLogosImporting = false;
          clearBusyOverlay(platformLogosCurrentEl);
        }
      };

      const loadPlataformas = async () => {
        try {
          const { data, error } = await supabase
            .from("plataformas")
            .select("id_plataforma, nombre, imagen, banner, posicion, id_categoria, categorias(nombre)")
            .order("nombre", { ascending: true });
          if (error) throw error;
          plataformasMap = (data || []).reduce((acc, p) => {
            acc[p.id_plataforma] = {
              ...p,
              categoria_nombre: getPlatformCategoryName(p),
            };
            return acc;
          }, {});
          renderPlatformLogosList();
          const selectedPlat = selectedId ? plataformasMap[selectedId] : null;
          renderEditor(selectedPlat || null);
        } catch (err) {
          console.error("load plataformas error", err);
          setStatus("No se pudieron cargar las plataformas.", true);
        }
      };

      const loadMetodosPago = async () => {
        try {
          const { data, error } = await supabase
            .from("metodos_de_pago")
            .select("id_metodo_de_pago, nombre, imagen, correo, telefono")
            .order("id_metodo_de_pago", { ascending: true });
          if (error) throw error;
          metodosPagoMap = (data || []).reduce((acc, metodo) => {
            const idMetodo = Number(metodo?.id_metodo_de_pago || 0);
            if (!Number.isFinite(idMetodo) || idMetodo <= 0) return acc;
            acc[idMetodo] = metodo;
            return acc;
          }, {});
          if (selectedMetodoPagoId && !metodosPagoMap[selectedMetodoPagoId]) {
            selectedMetodoPagoId = null;
          }
          renderMetodosPagoList();
        } catch (err) {
          console.error("load metodos de pago error", err);
          metodosPagoMap = {};
          selectedMetodoPagoId = null;
          renderMetodosPagoList();
          setMetodosPagoStatus("No se pudieron cargar los métodos de pago.", true);
        }
      };

      platformLogosToggleBtn?.addEventListener("click", () => {
        if (!editor) return;
        const willOpen = editor.classList.contains("hidden");
        editor.classList.toggle("hidden");
        if (willOpen) {
          setStatus("");
          renderPlatformLogosList();
        }
      });
      metodosPagoToggleBtn?.addEventListener("click", async () => {
        if (!metodosPagoEditor) return;
        const willOpen = metodosPagoEditor.classList.contains("hidden");
        metodosPagoEditor.classList.toggle("hidden");
        if (willOpen) {
          setMetodosPagoStatus("");
          await loadMetodosPago();
        }
      });
      storeLogoToggleBtn?.addEventListener("click", () => {
        if (!storeLogoEditor) return;
        const willOpen = storeLogoEditor.classList.contains("hidden");
        storeLogoEditor.classList.toggle("hidden");
        if (willOpen) {
          setStoreLogoStatus("");
          renderStoreAssets();
        }
      });
      const bindStoreAssetDrop = (frameEl, field, successMsg) => {
        frameEl?.addEventListener("dragenter", (e) => {
          if (!isFileDragEvent(e)) return;
          e.preventDefault();
          frameEl.classList.add("is-drop-target");
        });
        frameEl?.addEventListener("dragleave", (e) => {
          if (!isFileDragEvent(e)) return;
          const nextTarget = e.relatedTarget;
          if (nextTarget && frameEl.contains(nextTarget)) return;
          frameEl.classList.remove("is-drop-target");
        });
        frameEl?.addEventListener("dragover", (e) => {
          if (!isFileDragEvent(e)) return;
          e.preventDefault();
          if (e.dataTransfer) e.dataTransfer.dropEffect = "copy";
          frameEl.classList.add("is-drop-target");
        });
        frameEl?.addEventListener("drop", async (e) => {
          const droppedFile = Array.from(e.dataTransfer?.files || []).find((file) =>
            isImageFile(file),
          );
          if (!droppedFile) return;
          e.preventDefault();
          clearStoreAssetDropTargets();
          setBusyOverlay(frameEl, "Reemplazando");
          try {
            await replaceStorePageAssetImage(droppedFile, field);
            setStoreLogoStatus(successMsg);
          } catch (err) {
            console.error(`replace store ${field} by drop error`, err);
            setStoreLogoStatus("No se pudo actualizar el archivo.", true);
          } finally {
            clearBusyOverlay(frameEl);
          }
        });
      };
      bindStoreAssetDrop(
        storeLogoFrameEl,
        "logo",
        "Logo de tienda actualizado correctamente en pagina.logo.",
      );
      bindStoreAssetDrop(
        storeIconFrameEl,
        "icono_pestana",
        "Icono de pestaña actualizado correctamente en pagina.icono_pestana.",
      );
      bindStoreAssetDrop(
        storePreviewFrameEl,
        "preview",
        "Preview actualizado correctamente en pagina.preview.",
      );

      platformBannersToggleBtn?.addEventListener("click", () => {
        if (!bannerEditor) return;
        isPlatformBannersEditorOpen = bannerEditor.classList.contains("hidden");
        if (!isPlatformBannersEditorOpen) {
          bannerEditor.classList.add("hidden");
          return;
        }
        setBannerStatus("");
        renderEditor(plataformasMap[selectedId] || null);
      });

      previewToggleBtn?.addEventListener("click", () => {
        if (!previewEditor) return;
        previewEditor.classList.toggle("hidden");
      });

      platformLogosCurrentEl?.addEventListener("dragenter", (e) => {
        if (!isFileDragEvent(e)) return;
        if (e.target.closest(".platform-logo-row[data-id-plataforma]")) return;
        e.preventDefault();
        platformLogosCurrentEl.classList.add("is-import-target");
      });
      platformLogosCurrentEl?.addEventListener("dragleave", (e) => {
        if (!isFileDragEvent(e)) return;
        const nextTarget = e.relatedTarget;
        if (nextTarget && platformLogosCurrentEl.contains(nextTarget)) return;
        clearPlatformLogosImportTarget();
      });
      platformLogosCurrentEl?.addEventListener("dragover", (e) => {
        if (!isFileDragEvent(e)) return;
        if (e.target.closest(".platform-logo-row[data-id-plataforma]")) return;
        e.preventDefault();
        if (e.dataTransfer) e.dataTransfer.dropEffect = "copy";
        platformLogosCurrentEl.classList.add("is-import-target");
      });
      platformLogosCurrentEl?.addEventListener("drop", async (e) => {
        const filesDropped = Array.from(e.dataTransfer?.files || []).filter((file) =>
          isImageFile(file),
        );
        if (!filesDropped.length) return;
        if (e.target.closest(".platform-logo-row[data-id-plataforma]")) return;
        e.preventDefault();
        clearPlatformLogosImportTarget();
        await importPlatformLogosByName(filesDropped);
      });

      platformLogosListEl?.addEventListener("click", (e) => {
        if (e.target.closest(".platform-logo-drag-handle")) return;
        const row = e.target.closest(".platform-logo-row[data-id-plataforma]");
        if (!row) return;
        const nextId = Number(row.dataset.idPlataforma || 0);
        if (!Number.isFinite(nextId) || nextId <= 0) return;
        selectedId = nextId;
        setBannerStatus("");
        setPreviewStatus("");
        if (bannerInput) bannerInput.value = "";
        renderPlatformLogosList();
        const plat = plataformasMap[selectedId] || null;
        renderEditor(plat);
      });
      platformLogosListEl?.addEventListener("dragstart", (e) => {
        if (isFileDragEvent(e)) return;
        const handle = e.target.closest(".platform-logo-drag-handle");
        if (!handle) return;
        const row = handle.closest(".platform-logo-row[data-id-plataforma]");
        if (!row) return;
        draggingPlatformLogoRow = row;
        draggingPlatformLogoGroup = row.closest(".platform-logo-group");
        platformLogoOrderDirty = false;
        row.classList.add("is-dragging");
        if (e.dataTransfer) {
          e.dataTransfer.effectAllowed = "move";
          e.dataTransfer.setData("text/plain", String(row.dataset.idPlataforma || ""));
        }
      });
      platformLogosListEl?.addEventListener("dragover", (e) => {
        if (isFileDragEvent(e)) return;
        if (!draggingPlatformLogoRow || !platformLogosListEl) return;
        const targetRow = e.target.closest(".platform-logo-row[data-id-plataforma]");
        if (!targetRow || targetRow === draggingPlatformLogoRow) return;
        const targetGroup = targetRow.closest(".platform-logo-group");
        if (!targetGroup || targetGroup !== draggingPlatformLogoGroup) return;
        e.preventDefault();
        const rect = targetRow.getBoundingClientRect();
        const insertAfter = e.clientX > rect.left + rect.width / 2;
        if (insertAfter) {
          targetRow.after(draggingPlatformLogoRow);
        } else {
          targetRow.before(draggingPlatformLogoRow);
        }
        platformLogoOrderDirty = true;
      });
      platformLogosListEl?.addEventListener("dragend", async () => {
        if (!draggingPlatformLogoRow) return;
        draggingPlatformLogoRow.classList.remove("is-dragging");
        draggingPlatformLogoRow = null;
        draggingPlatformLogoGroup = null;
        if (platformLogoOrderDirty) {
          await savePlatformLogosOrder();
        }
        platformLogoOrderDirty = false;
      });
      platformBannersListEl?.addEventListener("click", (e) => {
        const row = e.target.closest(".platform-logo-row[data-id-plataforma]");
        if (!row) return;
        const nextId = Number(row.dataset.idPlataforma || 0);
        if (!Number.isFinite(nextId) || nextId <= 0) return;
        selectedId = nextId;
        setBannerStatus("");
        setPreviewStatus("");
        if (bannerInput) bannerInput.value = "";
        renderPlatformLogosList();
        const plat = plataformasMap[selectedId] || null;
        renderEditor(plat);
      });

      metodosPagoListEl?.addEventListener("click", (e) => {
        const row = e.target.closest(".platform-logo-row[data-id-metodo]");
        if (!row) return;
        const nextId = Number(row.dataset.idMetodo || 0);
        if (!Number.isFinite(nextId) || nextId <= 0) return;
        selectedMetodoPagoId = nextId;
        renderMetodosPagoList();
      });

      metodosPagoListEl?.addEventListener("dragenter", (e) => {
        if (!isFileDragEvent(e)) return;
        const row = e.target.closest(".platform-logo-row[data-id-metodo]");
        if (!row) return;
        e.preventDefault();
        clearMetodosPagoDropTargets();
        row.classList.add("is-drop-target");
      });

      metodosPagoListEl?.addEventListener("dragleave", (e) => {
        if (!isFileDragEvent(e)) return;
        const row = e.target.closest(".platform-logo-row[data-id-metodo]");
        if (!row) return;
        const nextTarget = e.relatedTarget;
        if (nextTarget && row.contains(nextTarget)) return;
        row.classList.remove("is-drop-target");
      });

      metodosPagoListEl?.addEventListener("dragover", (e) => {
        if (!isFileDragEvent(e)) return;
        const row = e.target.closest(".platform-logo-row[data-id-metodo]");
        if (!row) return;
        e.preventDefault();
        if (e.dataTransfer) e.dataTransfer.dropEffect = "copy";
        clearMetodosPagoDropTargets();
        row.classList.add("is-drop-target");
      });

      metodosPagoListEl?.addEventListener("drop", async (e) => {
        if (!isFileDragEvent(e)) return;
        const filesDropped = Array.from(e.dataTransfer?.files || []).filter((file) =>
          isImageFile(file),
        );
        if (!filesDropped.length) return;
        e.preventDefault();
        const row = e.target.closest(".platform-logo-row[data-id-metodo]");
        clearMetodosPagoDropTargets();
        if (!row) {
          setMetodosPagoStatus("Suelta la imagen sobre un método de pago.", true);
          return;
        }
        const idMetodoPago = Number(row.dataset.idMetodo || 0);
        if (!Number.isFinite(idMetodoPago) || idMetodoPago <= 0) {
          setMetodosPagoStatus("Método de pago inválido.", true);
          return;
        }
        const droppedFile = filesDropped[0];
        const previousImageUrl = String(metodosPagoMap[idMetodoPago]?.imagen || "").trim();
        const metodoName =
          String(metodosPagoMap[idMetodoPago]?.nombre || "").trim() || `#${idMetodoPago}`;
        setBusyOverlay(row, "Reemplazando");
        try {
          const result = await replaceMetodoPagoImage(
            idMetodoPago,
            droppedFile,
            previousImageUrl,
          );
          selectedMetodoPagoId = idMetodoPago;
          renderMetodosPagoList();
          if (result?.deleteError) {
            setMetodosPagoStatus(
              `Imagen de ${metodoName} actualizada, pero no se pudo eliminar la imagen anterior.`,
              true,
            );
          } else {
            setMetodosPagoStatus(`Imagen de ${metodoName} actualizada correctamente.`);
          }
        } catch (err) {
          console.error("replace metodo pago by drop error", err);
          setMetodosPagoStatus("No se pudo reemplazar la imagen del método de pago.", true);
        } finally {
          clearBusyOverlay(row);
        }
      });

      platformLogosListEl?.addEventListener("dragenter", (e) => {
        if (!isFileDragEvent(e)) return;
        const row = e.target.closest(".platform-logo-row[data-id-plataforma]");
        if (!row) return;
        e.preventDefault();
        clearPlatformLogosImportTarget();
        clearPlatformDropTargets();
        row.classList.add("is-drop-target");
      });

      platformLogosListEl?.addEventListener("dragleave", (e) => {
        if (!isFileDragEvent(e)) return;
        const row = e.target.closest(".platform-logo-row[data-id-plataforma]");
        if (!row) return;
        const nextTarget = e.relatedTarget;
        if (nextTarget && row.contains(nextTarget)) return;
        row.classList.remove("is-drop-target");
      });

      platformLogosListEl?.addEventListener("dragover", (e) => {
        if (!isFileDragEvent(e)) return;
        const row = e.target.closest(".platform-logo-row[data-id-plataforma]");
        if (!row) return;
        e.preventDefault();
        if (e.dataTransfer) e.dataTransfer.dropEffect = "copy";
        clearPlatformLogosImportTarget();
        clearPlatformDropTargets();
        row.classList.add("is-drop-target");
      });

      platformLogosListEl?.addEventListener("drop", async (e) => {
        if (!isFileDragEvent(e)) {
          if (draggingPlatformLogoRow) e.preventDefault();
          return;
        }
        const filesDropped = Array.from(e.dataTransfer?.files || []).filter((file) =>
          isImageFile(file),
        );
        if (!filesDropped.length) return;
        e.preventDefault();
        clearPlatformLogosImportTarget();
        const row = e.target.closest(".platform-logo-row[data-id-plataforma]");
        clearPlatformDropTargets();
        if (!row || filesDropped.length > 1) {
          await importPlatformLogosByName(filesDropped);
          return;
        }
        const droppedFile = filesDropped[0];
        const idPlataforma = Number(row.dataset.idPlataforma || 0);
        if (!Number.isFinite(idPlataforma) || idPlataforma <= 0) {
          setStatus("Plataforma inválida.", true);
          return;
        }
        const previousImageUrl = String(plataformasMap[idPlataforma]?.imagen || "").trim();
        const platformName =
          String(plataformasMap[idPlataforma]?.nombre || "").trim() ||
          `#${idPlataforma}`;
        setBusyOverlay(row, "Reemplazando");
        try {
          const result = await replacePlatformLogoImage(
            idPlataforma,
            droppedFile,
            previousImageUrl,
          );
          selectedId = idPlataforma;
          renderPlatformLogosList();
          renderEditor(plataformasMap[idPlataforma] || null);
          if (result?.deleteError) {
            setStatus(
              `Logo de ${platformName} actualizado, pero no se pudo eliminar la imagen anterior.`,
              true,
            );
          } else {
            setStatus(`Logo de ${platformName} actualizado correctamente.`);
          }
        } catch (err) {
          console.error("replace platform logo by drop error", err);
          setStatus("No se pudo reemplazar el logo.", true);
        } finally {
          clearBusyOverlay(row);
        }
      });
      platformBannersListEl?.addEventListener("dragenter", (e) => {
        if (!isFileDragEvent(e)) return;
        const row = e.target.closest(".platform-logo-row[data-id-plataforma]");
        if (!row) return;
        e.preventDefault();
        clearPlatformDropTargets();
        row.classList.add("is-drop-target");
      });

      platformBannersListEl?.addEventListener("dragleave", (e) => {
        if (!isFileDragEvent(e)) return;
        const row = e.target.closest(".platform-logo-row[data-id-plataforma]");
        if (!row) return;
        const nextTarget = e.relatedTarget;
        if (nextTarget && row.contains(nextTarget)) return;
        row.classList.remove("is-drop-target");
      });

      platformBannersListEl?.addEventListener("dragover", (e) => {
        if (!isFileDragEvent(e)) return;
        const row = e.target.closest(".platform-logo-row[data-id-plataforma]");
        if (!row) return;
        e.preventDefault();
        if (e.dataTransfer) e.dataTransfer.dropEffect = "copy";
        clearPlatformDropTargets();
        row.classList.add("is-drop-target");
      });

      platformBannersListEl?.addEventListener("drop", async (e) => {
        const droppedFile = Array.from(e.dataTransfer?.files || []).find((file) =>
          isImageFile(file),
        );
        if (!droppedFile) return;
        e.preventDefault();
        const row = e.target.closest(".platform-logo-row[data-id-plataforma]");
        clearPlatformDropTargets();
        if (!row) {
          setBannerStatus("Suelta la imagen sobre una plataforma para reemplazar el banner.", true);
          return;
        }
        const idPlataforma = Number(row.dataset.idPlataforma || 0);
        if (!Number.isFinite(idPlataforma) || idPlataforma <= 0) {
          setBannerStatus("Plataforma inválida.", true);
          return;
        }
        const previousImageUrl = String(plataformasMap[idPlataforma]?.banner || "").trim();
        const platformName =
          String(plataformasMap[idPlataforma]?.nombre || "").trim() ||
          `#${idPlataforma}`;
        setBusyOverlay(row, "Reemplazando");
        try {
          const result = await replacePlatformBannerImage(
            idPlataforma,
            droppedFile,
            previousImageUrl,
          );
          selectedId = idPlataforma;
          renderPlatformLogosList();
          renderEditor(plataformasMap[idPlataforma] || null);
          if (result?.deleteError) {
            setBannerStatus(
              `Banner de ${platformName} actualizado, pero no se pudo eliminar la imagen anterior.`,
              true,
            );
          } else {
            setBannerStatus(`Banner de ${platformName} actualizado correctamente.`);
          }
        } catch (err) {
          console.error("replace platform banner by drop error", err);
          setBannerStatus("No se pudo reemplazar el banner.", true);
        } finally {
          clearBusyOverlay(row);
        }
      });
      document.addEventListener("dragend", clearPlatformDropTargets);
      document.addEventListener("dragend", clearMetodosPagoDropTargets);
      document.addEventListener("dragend", clearStoreAssetDropTargets);
      document.addEventListener("dragend", clearPlatformLogosImportTarget);
      document.addEventListener("dragend", clearIconoDropTargets);

      iconosToggleBtn?.addEventListener("click", async () => {
        if (!iconosEditor) return;
        const willOpen = iconosEditor.classList.contains("hidden");
        iconosEditor.classList.toggle("hidden");
        if (willOpen) {
          setIconosStatus("");
          await loadIconos();
        }
      });
      iconosGalleryEl?.addEventListener("dragenter", (e) => {
        if (!isFileDragEvent(e)) return;
        const itemEl = e.target.closest(".icono-item[data-public-url]");
        if (!itemEl) return;
        e.preventDefault();
        clearIconoDropTargets();
        itemEl.classList.add("is-drop-target");
      });
      iconosGalleryEl?.addEventListener("dragleave", (e) => {
        if (!isFileDragEvent(e)) return;
        const itemEl = e.target.closest(".icono-item[data-public-url]");
        if (!itemEl) return;
        const nextTarget = e.relatedTarget;
        if (nextTarget && itemEl.contains(nextTarget)) return;
        itemEl.classList.remove("is-drop-target");
      });
      iconosGalleryEl?.addEventListener("dragover", (e) => {
        if (!isFileDragEvent(e)) return;
        const itemEl = e.target.closest(".icono-item[data-public-url]");
        if (!itemEl) return;
        e.preventDefault();
        if (e.dataTransfer) e.dataTransfer.dropEffect = "copy";
        clearIconoDropTargets();
        itemEl.classList.add("is-drop-target");
      });
      iconosGalleryEl?.addEventListener("drop", async (e) => {
        const droppedFile = Array.from(e.dataTransfer?.files || []).find((file) =>
          isImageFile(file),
        );
        if (!droppedFile) return;
        e.preventDefault();
        const itemEl = e.target.closest(".icono-item[data-public-url]");
        clearIconoDropTargets();
        if (!itemEl) {
          setIconosStatus("Suelta la imagen encima de un icono para reemplazarlo.", true);
          return;
        }
        setBusyOverlay(itemEl, "Reemplazando");
        try {
          const result = await replaceIconoImage(itemEl, droppedFile);
          await loadIconos();
          if (result?.deleteError) {
            setIconosStatus(
              `${result.label} reemplazado, pero no se pudo eliminar la imagen anterior.`,
              true,
            );
          } else {
            setIconosStatus(`${result.label} reemplazado correctamente.`);
          }
        } catch (err) {
          console.error("replace icono by drop error", err);
          setIconosStatus("No se pudo reemplazar el icono.", true);
        } finally {
          clearBusyOverlay(itemEl);
        }
      });

      homeBannersToggleBtn?.addEventListener("click", async () => {
        if (!homeBannersEditor) return;
        const willOpen = homeBannersEditor.classList.contains("hidden");
        homeBannersEditor.classList.toggle("hidden");
        if (willOpen) {
          setHomeBannersStatus("");
          updateNewRoutePreview();
          await loadHomeBanners();
        }
      });

      homeBannerRedirectInput?.addEventListener("input", updateNewRoutePreview);

      btnIconosUpload?.addEventListener("click", async () => {
        const selected = Array.from(iconosFilesInput?.files || []);
        if (!selected.length) {
          setIconosStatus("Selecciona una carpeta o varias imágenes.", true);
          return;
        }
        const files = selected.filter((file) => isImageFile(file));
        if (!files.length) {
          setIconosStatus("No se encontraron imágenes válidas en la selección.", true);
          return;
        }
        setBusyOverlay(iconosGalleryEl, "Importando");
        try {
          const batchSize = 20;
          let uploadedCount = 0;
          for (let i = 0; i < files.length; i += batchSize) {
            const chunk = files.slice(i, i + batchSize);
            const processed = Math.min(i + chunk.length, files.length);
            setIconosStatus(`Subiendo iconos (${processed}/${files.length})...`);
            const { urls, error: uploadErr } = await uploadPlatformLogos(chunk, {
              folder: "icono-perfil",
            });
            if (uploadErr) throw uploadErr;
            uploadedCount += Array.isArray(urls) ? urls.length : 0;
          }
          if (!uploadedCount) throw new Error("No se subieron iconos.");
          const skipped = selected.length - files.length;
          const extraText = skipped > 0 ? ` Se omitieron ${skipped} archivos no válidos.` : "";
          setIconosStatus(`Se subieron ${uploadedCount} iconos correctamente.${extraText}`);
          if (iconosFilesInput) iconosFilesInput.value = "";
          await loadIconos();
        } catch (err) {
          console.error("subir iconos error", err);
          setIconosStatus("No se pudieron subir los iconos.", true);
        } finally {
          clearBusyOverlay(iconosGalleryEl);
        }
      });

      btnHomeBannerAdd?.addEventListener("click", async () => {
        let file = homeBannerFileInput?.files?.[0];
        const title = String(homeBannerTitleInput?.value || "").trim();
        const redirectSuffix = normalizeRouteSuffix(homeBannerRedirectInput?.value || "");
        const redirectUrl = buildHomeBannerRoute(redirectSuffix);
        if (!file) {
          setHomeBannersStatus("Selecciona una imagen de banner.", true);
          return;
        }
        if (!file.type?.startsWith("image/")) {
          setHomeBannersStatus("Solo se permiten archivos de imagen.", true);
          return;
        }
        if (!redirectSuffix) {
          setHomeBannersStatus("Escribe una dirección de redirección.", true);
          return;
        }

        try {
          if (btnHomeBannerAdd) btnHomeBannerAdd.disabled = true;
          setBusyOverlay(homeBannersListEl, "Importando");
          setHomeBannersStatus("Optimizando imagen...");
          file = await resizeBannerIfNeeded(file);
          setHomeBannersStatus("Subiendo imagen...");
          const { urls, error: uploadErr } = await uploadPlatformLogos([file], {
            folder: "banners-index",
          });
          if (uploadErr) throw uploadErr;
          const imageUrl = String(urls?.[0] || "").trim();
          if (!imageUrl) throw new Error("No se obtuvo URL del banner.");

          setHomeBannersStatus("Guardando dirección...");
          const created = await createHomeBanner({
            title: title || null,
            image_url: imageUrl,
            image_url_mobile: imageUrl,
            redirect_url: redirectUrl,
            oculto: false,
          });
          if (created?.error) throw new Error(created.error);

          setHomeBannersStatus("Banner agregado correctamente.");
          if (homeBannerFileInput) homeBannerFileInput.value = "";
          if (homeBannerTitleInput) homeBannerTitleInput.value = "";
          if (homeBannerRedirectInput) homeBannerRedirectInput.value = "";
          updateNewRoutePreview();
          await loadHomeBanners();
        } catch (err) {
          console.error("add home banner error", err);
          setHomeBannersStatus("No se pudo agregar el banner.", true);
        } finally {
          clearBusyOverlay(homeBannersListEl);
          if (btnHomeBannerAdd) btnHomeBannerAdd.disabled = false;
        }
      });

      homeBannersListEl?.addEventListener("click", async (e) => {
        const saveBtn = e.target.closest(".btn-home-banner-save");
        if (!saveBtn) return;
        const rowEl = saveBtn.closest(".home-banner-item[data-id-banner]");
        if (!rowEl) return;
        const idBanner = Number(rowEl.dataset.idBanner);
        if (!Number.isFinite(idBanner) || idBanner <= 0) return;
        const input = rowEl.querySelector(".home-banner-link-input");
        const redirectSuffix = normalizeRouteSuffix(input?.value || "");
        const redirectUrl = buildHomeBannerRoute(redirectSuffix);
        if (!redirectSuffix) {
          setHomeBannersStatus("La dirección no puede estar vacía.", true);
          return;
        }

        try {
          saveBtn.disabled = true;
          setHomeBannersStatus("Guardando dirección...");
          const updated = await updateHomeBanner(idBanner, {
            redirect_url: redirectUrl,
          });
          if (updated?.error) throw new Error(updated.error);
          setHomeBannersStatus("Dirección actualizada.");
          await loadHomeBanners();
        } catch (err) {
          console.error("save home banner redirect error", err);
          setHomeBannersStatus("No se pudo guardar la dirección.", true);
        } finally {
          saveBtn.disabled = false;
        }
      });

      homeBannersListEl?.addEventListener("input", (e) => {
        const input = e.target.closest(".home-banner-link-input");
        if (!input) return;
        const rowEl = input.closest(".home-banner-item");
        if (!rowEl) return;
        const previewEl = rowEl.querySelector(".home-banner-route-preview");
        if (!previewEl) return;
        const nextRoute = buildHomeBannerRoute(input.value || "");
        previewEl.textContent = `Ruta final: ${nextRoute}`;
      });

      homeBannersListEl?.addEventListener("change", async (e) => {
        const toggle = e.target.closest(".home-banner-visibility-toggle");
        if (!toggle) return;
        const rowEl = toggle.closest(".home-banner-item[data-id-banner]");
        if (!rowEl) return;
        const idBanner = Number(rowEl.dataset.idBanner);
        if (!Number.isFinite(idBanner) || idBanner <= 0) return;

        const isVisible = toggle.checked === true;
        try {
          toggle.disabled = true;
          setHomeBannersStatus("Actualizando visibilidad...");
          const updated = await updateHomeBanner(idBanner, {
            oculto: !isVisible,
          });
          if (updated?.error) throw new Error(updated.error);
          setHomeBannersStatus("Visibilidad actualizada.");
          await loadHomeBanners();
        } catch (err) {
          console.error("toggle home banner visibility error", err);
          setHomeBannersStatus("No se pudo actualizar visibilidad.", true);
          toggle.checked = !isVisible;
        } finally {
          toggle.disabled = false;
        }
      });

      homeBannersListEl?.addEventListener("dragstart", (e) => {
        const handle = e.target.closest(".home-banner-drag-handle");
        if (!handle) return;
        const rowEl = handle.closest(".home-banner-item[data-id-banner]");
        if (!rowEl) return;
        draggingHomeBannerRow = rowEl;
        rowEl.classList.add("is-dragging");
        if (e.dataTransfer) {
          e.dataTransfer.effectAllowed = "move";
          e.dataTransfer.setData("text/plain", String(rowEl.dataset.idBanner || ""));
        }
      });

      homeBannersListEl?.addEventListener("dragover", (e) => {
        if (isFileDragEvent(e)) return;
        if (!draggingHomeBannerRow || !homeBannersListEl) return;
        const targetRow = e.target.closest(".home-banner-item[data-id-banner]");
        if (!targetRow || targetRow === draggingHomeBannerRow) return;
        e.preventDefault();
        const rect = targetRow.getBoundingClientRect();
        const insertAfter = e.clientY > rect.top + rect.height / 2;
        if (insertAfter) {
          targetRow.after(draggingHomeBannerRow);
        } else {
          targetRow.before(draggingHomeBannerRow);
        }
      });

      homeBannersListEl?.addEventListener("dragenter", (e) => {
        if (!isFileDragEvent(e)) return;
        const rowEl = e.target.closest(".home-banner-item[data-id-banner]");
        if (!rowEl) return;
        e.preventDefault();
        clearHomeBannerDropTargets();
        rowEl.classList.add("is-file-drop-target");
      });

      homeBannersListEl?.addEventListener("dragleave", (e) => {
        if (!isFileDragEvent(e)) return;
        const rowEl = e.target.closest(".home-banner-item[data-id-banner]");
        if (!rowEl) return;
        const nextTarget = e.relatedTarget;
        if (nextTarget && rowEl.contains(nextTarget)) return;
        rowEl.classList.remove("is-file-drop-target");
      });

      homeBannersListEl?.addEventListener("dragover", (e) => {
        if (!isFileDragEvent(e)) return;
        const rowEl = e.target.closest(".home-banner-item[data-id-banner]");
        if (!rowEl) return;
        e.preventDefault();
        if (e.dataTransfer) e.dataTransfer.dropEffect = "copy";
        clearHomeBannerDropTargets();
        rowEl.classList.add("is-file-drop-target");
      });

      homeBannersListEl?.addEventListener("drop", async (e) => {
        const fileDropped = Array.from(e.dataTransfer?.files || []).find((file) =>
          isImageFile(file),
        );
        if (fileDropped) {
          e.preventDefault();
          const rowEl = e.target.closest(".home-banner-item[data-id-banner]");
          clearHomeBannerDropTargets();
          if (!rowEl) {
            setHomeBannersStatus("Suelta la imagen encima de un banner para reemplazarlo.", true);
            return;
          }
          const idBanner = Number(rowEl.dataset.idBanner);
          const previousImageUrl =
            rowEl.querySelector(".home-banner-thumb img")?.getAttribute("src") || "";
          setBusyOverlay(rowEl, "Reemplazando");
          try {
            const result = await replaceHomeBannerImage(idBanner, fileDropped, previousImageUrl);
            await loadHomeBanners();
            if (result?.deleteError) {
              setHomeBannersStatus(
                `Banner #${idBanner} reemplazado, pero no se pudo eliminar la imagen anterior.`,
                true,
              );
            } else {
              setHomeBannersStatus(`Banner #${idBanner} reemplazado correctamente.`);
            }
          } catch (err) {
            console.error("replace home banner image error", err);
            setHomeBannersStatus("No se pudo reemplazar la imagen del banner.", true);
          } finally {
            clearBusyOverlay(rowEl);
          }
          return;
        }

        if (!draggingHomeBannerRow) return;
        e.preventDefault();
      });

      homeBannersMobileListEl?.addEventListener("dragenter", (e) => {
        if (!isFileDragEvent(e)) return;
        const rowEl = e.target.closest(".home-banner-item[data-id-banner]");
        if (!rowEl) return;
        e.preventDefault();
        clearHomeBannerDropTargets();
        rowEl.classList.add("is-file-drop-target");
      });

      homeBannersMobileListEl?.addEventListener("dragleave", (e) => {
        if (!isFileDragEvent(e)) return;
        const rowEl = e.target.closest(".home-banner-item[data-id-banner]");
        if (!rowEl) return;
        const nextTarget = e.relatedTarget;
        if (nextTarget && rowEl.contains(nextTarget)) return;
        rowEl.classList.remove("is-file-drop-target");
      });

      homeBannersMobileListEl?.addEventListener("dragover", (e) => {
        if (!isFileDragEvent(e)) return;
        const rowEl = e.target.closest(".home-banner-item[data-id-banner]");
        if (!rowEl) return;
        e.preventDefault();
        if (e.dataTransfer) e.dataTransfer.dropEffect = "copy";
        clearHomeBannerDropTargets();
        rowEl.classList.add("is-file-drop-target");
      });

      homeBannersMobileListEl?.addEventListener("drop", async (e) => {
        const fileDropped = Array.from(e.dataTransfer?.files || []).find((file) =>
          isImageFile(file),
        );
        if (!fileDropped) return;

        e.preventDefault();
        const rowEl = e.target.closest(".home-banner-item[data-id-banner]");
        clearHomeBannerDropTargets();
        if (!rowEl) {
          setHomeBannersStatus("Suelta la imagen sobre un banner móvil para reemplazarlo.", true);
          return;
        }
        const idBanner = Number(rowEl.dataset.idBanner);
        const previousImageUrl =
          rowEl.querySelector(".home-banner-thumb img")?.getAttribute("src") || "";
        setBusyOverlay(rowEl, "Reemplazando");
        try {
          const result = await replaceHomeBannerImage(
            idBanner,
            fileDropped,
            previousImageUrl,
            "image_url_mobile",
          );
          await loadHomeBanners();
          if (result?.deleteError) {
            setHomeBannersStatus(
              `Banner móvil #${idBanner} reemplazado, pero no se pudo eliminar la imagen anterior.`,
              true,
            );
          } else {
            setHomeBannersStatus(`Banner móvil #${idBanner} reemplazado correctamente.`);
          }
        } catch (err) {
          console.error("replace home banner mobile image error", err);
          setHomeBannersStatus("No se pudo reemplazar la imagen móvil del banner.", true);
        } finally {
          clearBusyOverlay(rowEl);
        }
      });

      homeBannersListEl?.addEventListener("dragend", async () => {
        if (!draggingHomeBannerRow) return;
        draggingHomeBannerRow.classList.remove("is-dragging");
        draggingHomeBannerRow = null;
        clearHomeBannerDropTargets();
        await saveHomeBannersOrder();
      });

      btnMetodoPagoUpdate?.addEventListener("click", async () => {
        if (!selectedMetodoPagoId) {
          setMetodosPagoStatus("Selecciona un método de pago.", true);
          return;
        }
        let file = metodoPagoInput?.files?.[0];
        if (!file) {
          setMetodosPagoStatus("Selecciona una imagen.", true);
          return;
        }
        const rowEl = metodosPagoListEl?.querySelector(
          `.platform-logo-row[data-id-metodo="${selectedMetodoPagoId}"]`,
        );
        const previousImageUrl = String(metodosPagoMap[selectedMetodoPagoId]?.imagen || "").trim();
        const metodoName =
          String(metodosPagoMap[selectedMetodoPagoId]?.nombre || "").trim() ||
          `#${selectedMetodoPagoId}`;
        try {
          setBusyOverlay(rowEl, "Importando");
          const result = await replaceMetodoPagoImage(
            selectedMetodoPagoId,
            file,
            previousImageUrl,
          );
          renderMetodosPagoList();
          if (result?.deleteError) {
            setMetodosPagoStatus(
              `Imagen de ${metodoName} actualizada, pero no se pudo eliminar la imagen anterior.`,
              true,
            );
          } else {
            setMetodosPagoStatus(`Imagen de ${metodoName} actualizada correctamente.`);
          }
          if (metodoPagoInput) metodoPagoInput.value = "";
        } catch (err) {
          console.error("actualizar metodo pago error", err);
          setMetodosPagoStatus("No se pudo actualizar la imagen del método de pago.", true);
        } finally {
          clearBusyOverlay(rowEl);
        }
      });

      btnUpdate?.addEventListener("click", async () => {
        const selectedFiles = Array.from(fileInput?.files || []);
        if (!selectedFiles.length) {
          setStatus("Selecciona una carpeta o varias imágenes.", true);
          return;
        }
        await importPlatformLogosByName(selectedFiles);
        if (fileInput) fileInput.value = "";
      });

      btnBannerUpdate?.addEventListener("click", async () => {
        if (!selectedId) {
          setBannerStatus("Selecciona una plataforma.", true);
          return;
        }
        let file = bannerInput?.files?.[0];
        if (!file) {
          setBannerStatus("Selecciona una imagen.", true);
          return;
        }
        if (!file.type?.startsWith("image/")) {
          setBannerStatus("Solo se permiten archivos de imagen.", true);
          return;
        }
        try {
          console.log("[editar_logos] banner selectedId", selectedId);
          console.log("[editar_logos] banner file", { name: file.name, type: file.type, size: file.size });
          setBannerStatus("Optimizando imagen...");
          file = await resizeBannerIfNeeded(file);
          console.log("[editar_logos] optimized banner file", { name: file.name, type: file.type, size: file.size });
          setBannerStatus("Subiendo banner...");
          const { urls, error: uploadErr } = await uploadPlatformLogos([file], {
            folder: PLATFORM_MODAL_BANNERS_FOLDER,
          });
          console.log("[editar_logos] banner upload response", { urls, uploadErr });
          if (uploadErr) throw uploadErr;
          const url = urls?.[0];
          if (!url) throw new Error("No se obtuvo URL del banner.");
          console.log("[editar_logos] updating plataforma banner", { id_plataforma: selectedId, url });
          const { error: updErr } = await supabase
            .from("plataformas")
            .update({ banner: url })
            .eq("id_plataforma", selectedId);
          console.log("[editar_logos] banner update response", { updErr });
          if (updErr) throw updErr;
          plataformasMap[selectedId] = {
            ...plataformasMap[selectedId],
            banner: url,
          };
          renderEditor(plataformasMap[selectedId]);
          setBannerStatus("Banner actualizado correctamente.");
          if (bannerInput) bannerInput.value = "";
        } catch (err) {
          console.error("actualizar banner error", err);
          setBannerStatus("No se pudo actualizar el banner.", true);
        }
      });

      btnStoreLogoUpdate?.addEventListener("click", async () => {
        let file = storeLogoInput?.files?.[0];
        if (!file) {
          setStoreLogoStatus("Selecciona una imagen.", true);
          return;
        }
        try {
          setBusyOverlay(storeLogoFrameEl, "Importando");
          await replaceStorePageAssetImage(file, "logo");
          setStoreLogoStatus("Logo de tienda actualizado correctamente en pagina.logo.");
          if (storeLogoInput) storeLogoInput.value = "";
        } catch (err) {
          console.error("actualizar logo tienda error", err);
          setStoreLogoStatus("No se pudo actualizar el logo de tienda.", true);
        } finally {
          clearBusyOverlay(storeLogoFrameEl);
        }
      });

      btnStoreIconUpdate?.addEventListener("click", async () => {
        let file = storeIconInput?.files?.[0];
        if (!file) {
          setStoreLogoStatus("Selecciona una imagen de icono.", true);
          return;
        }
        try {
          setBusyOverlay(storeIconFrameEl, "Importando");
          await replaceStorePageAssetImage(file, "icono_pestana");
          setStoreLogoStatus("Icono de pestaña actualizado correctamente en pagina.icono_pestana.");
          if (storeIconInput) storeIconInput.value = "";
        } catch (err) {
          console.error("actualizar icono pestaña error", err);
          setStoreLogoStatus("No se pudo actualizar el icono de pestaña.", true);
        } finally {
          clearBusyOverlay(storeIconFrameEl);
        }
      });

      btnStoreIconRefresh?.addEventListener("click", async () => {
        try {
          setStoreLogoStatus("Recargando favicon desde pagina.id = 2...");
          const { data, error } = await supabase
            .from("pagina")
            .select("icono_pestana")
            .eq("id", PAGINA_TARGET_ID)
            .maybeSingle();
          if (error) throw error;
          if (!data) throw new Error(`No existe pagina.id = ${PAGINA_TARGET_ID}.`);

          const iconUrl = String(data?.icono_pestana || "").trim();
          if (!iconUrl) {
            setStoreLogoStatus("pagina.icono_pestana está vacío en id = 2.", true);
            return;
          }

          paginaPreview = {
            ...(paginaPreview || {}),
            id: PAGINA_TARGET_ID,
            icono_pestana: iconUrl,
          };
          if (storeIconPreviewEl) storeIconPreviewEl.src = iconUrl;
          setExtensionBadge(storeIconBadgeEl, iconUrl);
          applyFavicon(iconUrl);
          setStoreLogoStatus("Favicon recargado desde pagina.icono_pestana (id = 2).");
        } catch (err) {
          console.error("refresh favicon error", err);
          setStoreLogoStatus("No se pudo refrescar el favicon.", true);
        }
      });

      btnStorePreviewUpdate?.addEventListener("click", async () => {
        let file = storePreviewInput?.files?.[0];
        if (!file) {
          setStoreLogoStatus("Selecciona una imagen de preview.", true);
          return;
        }
        try {
          setBusyOverlay(storePreviewFrameEl, "Importando");
          await replaceStorePageAssetImage(file, "preview");
          renderPreview();
          setStoreLogoStatus("Preview actualizado correctamente en pagina.preview.");
          if (storePreviewInput) storePreviewInput.value = "";
        } catch (err) {
          console.error("actualizar preview tienda error", err);
          setStoreLogoStatus("No se pudo actualizar el preview.", true);
        } finally {
          clearBusyOverlay(storePreviewFrameEl);
        }
      });

      async function init() {
        try {
          if (sessionId) {
            const ss = await startSession(sessionId);
            console.log("[editar_logos] startSession", ss);
          }
          const user = await loadCurrentUser();
          if (user && usernameEl) {
            const fullName = [user.nombre, user.apellido].filter(Boolean).join(" ").trim();
            usernameEl.textContent = fullName || user.correo || "Usuario";
          }
          const isAdmin = isTrue(user?.permiso_admin) || isTrue(user?.permiso_superadmin);
          if (adminLink) {
            adminLink.classList.toggle("hidden", !isAdmin);
            adminLink.style.display = isAdmin ? "block" : "none";
          }
          if (!isAdmin) {
            setStatus("No tienes permisos para administrar servicios.", true);
          }
        } catch (err) {
          console.error("editar logos init error", err);
        }
      }

      init();
      loadPlataformas();
      loadMetodosPago();
      loadPreview();
      updateNewRoutePreview();
      attachLogout(clearServerSession);
    </script>
  </body>
</html>
