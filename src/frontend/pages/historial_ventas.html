<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Historial de Ventas</title>
    <link rel="stylesheet" href="../styles/styles.css" />
    <style>
      .historial-wrapper {
        margin-top: 12px;
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .historial-table {
        width: 100%;
        border-collapse: collapse;
      }
      .historial-table th,
      .historial-table td {
        border: 1px solid #e5e7eb;
        padding: 8px;
      }
      .historial-table th {
        background: #444;
        color: #fff;
      }
      .historial-table tbody tr:nth-child(odd) {
        background: #f5f5f5;
      }
      .historial-table tbody tr:nth-child(even) {
        background: #fff;
      }
      .status {
        margin: 0;
      }
    </style>
  </head>
  <body>
    <div id="app-header" data-header-root="../" data-header-pages=""></div>
    <script src="../scripts/header-loader.js"></script>

    <main class="categorias-dinamicas">
      <h2>Historial de Ventas</h2>
      <div class="historial-wrapper">
        <p id="historial-status" class="status">Cargando ventas...</p>
        <div class="historial-table-wrap">
          <table class="historial-table">
            <thead>
              <tr>
                <th>ID de Venta</th>
                <th>Cliente</th>
                <th>Plataforma</th>
                <th>Detalle</th>
                <th>Monto</th>
                <th>Método de pago</th>
                <th>Referencia</th>
                <th>Fecha</th>
                <th>Hora</th>
              </tr>
            </thead>
            <tbody id="historial-body"></tbody>
          </table>
        </div>
      </div>
    </main>

    <script type="module">
      import { requireSession, attachLogoHome, attachLogout } from "../scripts/session.js";
      import { clearServerSession, supabase } from "../scripts/api.js";
      import { formatDDMMYYYY } from "../scripts/date-format.js";

      requireSession();
      attachLogoHome();
      attachLogout(clearServerSession);

      const statusEl = document.querySelector("#historial-status");
      const tbodyEl = document.querySelector("#historial-body");

      const setStatus = (msg) => {
        if (statusEl) statusEl.textContent = msg || "";
      };

      const formatMonto = (monto) => {
        const num = Number(monto);
        if (!Number.isFinite(num)) return "-";
        return num.toFixed(2);
      };

      const buildDetalle = (precio) => {
        const cantidad = Number(precio?.cantidad) || 1;
        const plan = (precio?.plan || "").trim();
        return plan ? `${cantidad} ${plan}` : `${cantidad}`;
      };

      const truncateText = (value, max = 12) => {
        const raw = String(value ?? "").trim();
        if (!raw) return "-";
        if (raw.length <= max) return raw;
        return `${raw.slice(0, max)}...`;
      };

      const formatHora = (hora) => {
        if (!hora) return "-";
        const raw = String(hora).trim();
        const match = raw.match(/^(\d{1,2}):(\d{2})(?::\d{2}(?:\.\d+)?)?$/);
        if (!match) return raw;
        let hh = Number(match[1]);
        const mm = match[2];
        if (!Number.isFinite(hh)) return raw;
        const suffix = hh >= 12 ? "pm" : "am";
        hh = hh % 12;
        if (hh === 0) hh = 12;
        return `${hh}:${mm} ${suffix}`;
      };

      const init = async () => {
        try {
          const { data: historial, error } = await supabase
            .from("historial_ventas")
            .select(
              "id_historial_ventas, id_venta, id_plataforma, id_usuario_cliente, id_metodo_de_pago, referencia, monto, fecha_pago, hora_pago"
            )
            .order("id_venta", { ascending: false })
            .order("id_historial_ventas", { ascending: false });
          if (error) throw error;

          const rows = historial || [];
          if (!rows.length) {
            setStatus("No hay ventas registradas.");
            if (tbodyEl) tbodyEl.innerHTML = "";
            return;
          }

          const ventaIds = Array.from(new Set(rows.map((r) => r.id_venta).filter(Boolean)));
          const platIds = Array.from(new Set(rows.map((r) => r.id_plataforma).filter(Boolean)));
          const userIds = Array.from(new Set(rows.map((r) => r.id_usuario_cliente).filter(Boolean)));

          let ventasMap = {};
          if (ventaIds.length) {
            const { data: ventas, error: ventErr } = await supabase
              .from("ventas")
              .select("id_venta, id_precio")
              .in("id_venta", ventaIds);
            if (ventErr) throw ventErr;
            ventasMap = (ventas || []).reduce((acc, v) => {
              acc[v.id_venta] = v;
              return acc;
            }, {});
          }

          const precioIds = Array.from(
            new Set(Object.values(ventasMap).map((v) => v.id_precio).filter(Boolean))
          );
          let preciosMap = {};
          if (precioIds.length) {
            const { data: precios, error: precErr } = await supabase
              .from("precios")
              .select("id_precio, plan, cantidad")
              .in("id_precio", precioIds);
            if (precErr) throw precErr;
            preciosMap = (precios || []).reduce((acc, p) => {
              acc[p.id_precio] = p;
              return acc;
            }, {});
          }

          let platMap = {};
          if (platIds.length) {
            const { data: plats, error: platErr } = await supabase
              .from("plataformas")
              .select("id_plataforma, nombre")
              .in("id_plataforma", platIds);
            if (platErr) throw platErr;
            platMap = (plats || []).reduce((acc, p) => {
              acc[p.id_plataforma] = p.nombre || `Plataforma ${p.id_plataforma}`;
              return acc;
            }, {});
          }

          const metodoIds = Array.from(new Set(rows.map((r) => r.id_metodo_de_pago).filter(Boolean)));
          let metodoMap = {};
          if (metodoIds.length) {
            const { data: metodos, error: metErr } = await supabase
              .from("metodos_de_pago")
              .select("id_metodo_de_pago, nombre")
              .in("id_metodo_de_pago", metodoIds);
            if (metErr) throw metErr;
            metodoMap = (metodos || []).reduce((acc, m) => {
              acc[m.id_metodo_de_pago] = m.nombre || `Método ${m.id_metodo_de_pago}`;
              return acc;
            }, {});
          }

          let userMap = {};
          if (userIds.length) {
            const { data: users, error: userErr } = await supabase
              .from("usuarios")
              .select("id_usuario, nombre, apellido")
              .in("id_usuario", userIds);
            if (userErr) throw userErr;
            userMap = (users || []).reduce((acc, u) => {
              acc[u.id_usuario] = [u.nombre, u.apellido].filter(Boolean).join(" ").trim();
              return acc;
            }, {});
          }

          const html = rows
            .map((r) => {
              const cliente = userMap[r.id_usuario_cliente] || "-";
              const plataforma = platMap[r.id_plataforma] || `Plataforma ${r.id_plataforma || "-"}`;
              const venta = r.id_venta ? ventasMap[r.id_venta] : null;
              const precio = venta?.id_precio ? preciosMap[venta.id_precio] : null;
              const detalle = precio ? buildDetalle(precio) : "-";
              const metodoRaw = r.id_metodo_de_pago ? metodoMap[r.id_metodo_de_pago] || "-" : "-";
              const metodo = truncateText(metodoRaw, 12);
              const referencia = r.referencia ?? "-";
              const fecha = formatDDMMYYYY(r.fecha_pago) || r.fecha_pago || "-";
              const hora = formatHora(r.hora_pago);
              return `
                <tr>
                  <td>${r.id_venta ?? "-"}</td>
                  <td>${cliente || "-"}</td>
                  <td>${plataforma}</td>
                  <td>${detalle}</td>
                  <td>${formatMonto(r.monto)}</td>
                  <td>${metodo}</td>
                  <td>${referencia}</td>
                  <td>${fecha}</td>
                  <td>${hora}</td>
                </tr>
              `;
            })
            .join("");

          if (tbodyEl) tbodyEl.innerHTML = html;
          setStatus("");
        } catch (err) {
          console.error("historial ventas error", err);
          setStatus("No se pudieron cargar las ventas.");
        }
      };

      init();
    </script>
  </body>
</html>
